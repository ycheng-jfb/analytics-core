SET high_watermark_date = IFF(
        CONVERT_TIMEZONE('America/Los_Angeles', 'Europe/London', CURRENT_TIMESTAMP())::DATE > CURRENT_DATE(),
        DATEADD(DAY, 1, CURRENT_DATE()),
        CURRENT_DATE()
    );
set report_date = dateadd(day, -1, $high_watermark_date);
set current_month_date = date_trunc(month, $report_date);
set last_month_date = dateadd(month, -1, $current_month_date);
set same_month_last_year_start = dateadd(month, -12, $current_month_date);


create table if not exists reporting_media_prod.attribution.total_cac_output (
sequence	number(38,0)
,store_name	varchar(100)
,store_abbreviation	varchar(25)
,date	date
,primary_leads	number(30,0)
,secondary_leads	number(30,0)
,cross_brand_leads_per decimal(20,4)
,cpl	number(20,4)
,media_spend	number(20,4)
,vips_from_leads_30m	number(20,4)
,vips_from_leads_30m_cac	number(20,4)
,vips_from_leads_1d	number(20,4)
,vips_from_leads_1d_cac	number(20,4)
,vips_from_leads_7d	number(20,4)
,vips_from_leads_24h	number(20,4)
,vips_from_leads_24h_cac	number(20,4)
,vips_from_leads_m1	number(20,4)
,vips_from_leads_m1_cac	number(20,4)
,vips_on_date_m1	number(20,4)
,vips_on_date_m1_cac	number(20,4)
,total_vips_from_reactivated_leads	number(20,4)
,total_vips_on_date	number(20,4)
,total_vips_on_date_cac	number(20,4)
,vips_on_date_d1_d7	number(20,4)
,vips_on_date_d8_d90	number(20,4)
,vips_on_date_d90plus	number(20,4)
,reactivated_vips	number(20,4)
,reactivated_leads	number(20,4)
,retail_leads	number(20,4)
,vips_from_leads_30m_per	number(20,4)
,vips_from_leads_24h_per	number(20,4)
,vips_from_leads_m1_per	number(20,4)
,vips_from_reactivated_leads_24h_per	number(20,4)
,d1_d7_vips_per	number(20,4)
,d8_d90_vips_per	number(20,4)
,d90plus_vips_per	number(20,4)
,reactivated_leads_per	number(20,4)
,prospecting_spend	number(20,4)
,facebook_spend	number(20,4)
,snapchat_spend	number(20,4)
,pinterest_spend	number(20,4)
,applovin_spend	number(20,4)
,linkedin_spend	number(20,4)
,nift_spend	number(20,4)
,rokt_spend number(20,4)
,twitch_spend	number(20,4)
,google_other_spend	number(20,4)
,ooh_spend  number(20,4)
,celebrity_spend	number(20,4)
,non_branded_search_spend	number(20,4)
,branded_search_spend	number(20,4)
,shopping_spend	number(20,4)
,programmatic_spend	number(20,4)
,youtube_spend	number(20,4)
,tv_and_streaming_spend	number(20,4)
,testing_spend	number(20,4)
,print_spend	number(20,4)
,radio_podcast_spend	number(20,4)
,influencers_spend	number(20,4)
,affiliate_spend	number(20,4)
,physical_partnerships_spend	number(20,4)
,tiktok_spend	number(20,4)
,reddit_spend	number(20,4)
,twitter_spend number(20,4)
,prospecting_spend_per	number(20,4)
,facebook_spend_per	number(20,4)
,snapchat_spend_per	number(20,4)
,pinterest_spend_per	number(20,4)
,applovin_spend_per	number(20,4)
,linkedin_spend_per	number(20,4)
,nift_spend_per	number(20,4)
,rokt_spend_per number(20,4)
,twitch_spend_per	number(20,4)
,google_other_spend_per	number(20,4)
,ooh_spend_per  number(20,4)
,celebrity_spend_per	number(20,4)
,non_branded_search_spend_per	number(20,4)
,branded_search_spend_per	number(20,4)
,shopping_spend_per	number(20,4)
,programmatic_spend_per	number(20,4)
,youtube_spend_per	number(20,4)
,tv_and_streaming_spend_per	number(20,4)
,testing_spend_per	number(20,4)
,print_spend_per	number(20,4)
,radio_podcast_spend_per	number(20,4)
,influencers_spend_per	number(20,4)
,affiliate_spend_per	number(20,4)
,physical_partnerships_spend_per	number(20,4)
,tiktok_spend_per	number(20,4)
,reddit_spend_per	number(20,4)
,twitter_spend_per number(20,4)
,currency	varchar(25)
,source	varchar(25)
,version	varchar(500)
,channel_sequence	number(38,0)
,report_month	date
,retail_vips	number(38,0)
,varsity_vips	number(38,0)
,cancels_on_date number(20,4)
,passive_cancels_on_date number(20,4)
,vips_on_date_d1	number(38,0)
,vips_from_reactivated_leads_d1	number(38,0)
,vips_on_date_d1_excluding_reactivated_leads	number(38,0)
,vips_on_date_d1_reactivated_leads	number(38,0)
,vips_on_date_m1_reactivated_leads	number(38,0)
,vips_on_date_d2_d7	number(38,0)
,d1_vips_per	number(20,4)
,d1_vips_excluding_reactivated_leads_per	number(20,4)
,d1_vips_reactivated_leads_per	number(20,4)
,d2_d7_vips_per	number(20,4)
,reactivated_vips_per	number(20,4)
,first_guest_product_margin_pre_return number(20, 4)
,bop_vips number(20, 4)
,total_cancels_on_date number(20, 4)
,activating_acquisition_margin number(20, 4)
,product_order_count number(20, 4)
);

create table if not exists reporting_media_prod.snapshot.total_cac_output (
sequence	number(38,0)
,store_name	varchar(100)
,store_abbreviation	varchar(25)
,date	date
,primary_leads	number(30,0)
,secondary_leads	number(30,0)
,cross_brand_leads_per decimal(20,4)
,cpl	number(20,4)
,media_spend	number(20,4)
,vips_from_leads_30m	number(20,4)
,vips_from_leads_30m_cac	number(20,4)
,vips_from_leads_1d	number(20,4)
,vips_from_leads_1d_cac	number(20,4)
,vips_from_leads_7d	number(20,4)
,vips_from_leads_24h	number(20,4)
,vips_from_leads_24h_cac	number(20,4)
,vips_from_leads_m1	number(20,4)
,vips_from_leads_m1_cac	number(20,4)
,vips_on_date_m1	number(20,4)
,vips_on_date_m1_cac	number(20,4)
,total_vips_from_reactivated_leads	number(20,4)
,total_vips_on_date	number(20,4)
,total_vips_on_date_cac	number(20,4)
,vips_on_date_d1_d7	number(20,4)
,vips_on_date_d8_d90	number(20,4)
,vips_on_date_d90plus	number(20,4)
,reactivated_vips	number(20,4)
,reactivated_leads	number(20,4)
,retail_leads	number(20,4)
,vips_from_leads_30m_per	number(20,4)
,vips_from_leads_24h_per	number(20,4)
,vips_from_leads_m1_per	number(20,4)
,vips_from_reactivated_leads_24h_per	number(20,4)
,d1_d7_vips_per	number(20,4)
,d8_d90_vips_per	number(20,4)
,d90plus_vips_per	number(20,4)
,reactivated_leads_per	number(20,4)
,prospecting_spend	number(20,4)
,facebook_spend	number(20,4)
,snapchat_spend	number(20,4)
,pinterest_spend	number(20,4)
,applovin_spend	number(20,4)
,linkedin_spend	number(20,4)
,nift_spend	number(20,4)
,rokt_spend number(20,4)
,twitch_spend	number(20,4)
,google_other_spend	number(20,4)
,ooh_spend  number(20,4)
,celebrity_spend	number(20,4)
,non_branded_search_spend	number(20,4)
,branded_search_spend	number(20,4)
,shopping_spend	number(20,4)
,programmatic_spend	number(20,4)
,youtube_spend	number(20,4)
,tv_and_streaming_spend	number(20,4)
,testing_spend	number(20,4)
,print_spend	number(20,4)
,radio_podcast_spend	number(20,4)
,influencers_spend	number(20,4)
,affiliate_spend	number(20,4)
,physical_partnerships_spend	number(20,4)
,tiktok_spend	number(20,4)
,reddit_spend	number(20,4)
,twitter_spend number(20,4)
,prospecting_spend_per	number(20,4)
,facebook_spend_per	number(20,4)
,snapchat_spend_per	number(20,4)
,pinterest_spend_per	number(20,4)
,applovin_spend_per	number(20,4)
,linkedin_spend_per	number(20,4)
,nift_spend_per	number(20,4)
,rokt_spend_per number(20,4)
,twitch_spend_per	number(20,4)
,google_other_spend_per	number(20,4)
,ooh_spend_per  number(20,4)
,celebrity_spend_per	number(20,4)
,non_branded_search_spend_per	number(20,4)
,branded_search_spend_per	number(20,4)
,shopping_spend_per	number(20,4)
,programmatic_spend_per	number(20,4)
,youtube_spend_per	number(20,4)
,tv_and_streaming_spend_per	number(20,4)
,testing_spend_per	number(20,4)
,print_spend_per	number(20,4)
,radio_podcast_spend_per	number(20,4)
,influencers_spend_per	number(20,4)
,affiliate_spend_per	number(20,4)
,physical_partnerships_spend_per	number(20,4)
,tiktok_spend_per	number(20,4)
,reddit_spend_per	number(20,4)
,twitter_spend_per number(20,4)
,currency	varchar(25)
,source	varchar(25)
,version	varchar(500)
,channel_sequence	number(38,0)
,report_month	date
,retail_vips	number(38,0)
,varsity_vips	number(38,0)
,cancels_on_date number(20,4)
,passive_cancels_on_date number(20,4)
,vips_on_date_d1	number(38,0)
,vips_from_reactivated_leads_d1	number(38,0)
,vips_on_date_d1_excluding_reactivated_leads	number(38,0)
,vips_on_date_d1_reactivated_leads	number(38,0)
,vips_on_date_m1_reactivated_leads	number(38,0)
,vips_on_date_d2_d7	number(38,0)
,d1_vips_per	number(20,4)
,d1_vips_excluding_reactivated_leads_per	number(20,4)
,d1_vips_reactivated_leads_per	number(20,4)
,d2_d7_vips_per	number(20,4)
,reactivated_vips_per	number(20,4)
,first_guest_product_margin_pre_return number(20, 4)
,bop_vips number(20, 4)
,total_cancels_on_date number(20, 4)
,activating_acquisition_margin number(20, 4)
,product_order_count number(20, 4)
,datetime_added timestamp_ltz default current_timestamp::timestamp_ltz
);

------------------------------------------------------------------------------------

create or replace temporary table _total_cac_daily_by_segment as
----- JFB WW-----
------ global roll-up
select
    'JFB-GLOBAL' as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
where lower(store_brand) in ('justfab','shoedazzle','fabkids')
group by 1,2,3

union all
------ north america roll-up
select
    'JFB-NA' as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
where lower(store_brand) in ('justfab','shoedazzle','fabkids')
    and lower(store_region) = 'na'
group by 1,2,3

union all
------ justfab + shoedazzle roll-up
select
    'JFSD-NA' as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
where lower(store_brand) in ('justfab','shoedazzle')
    and lower(store_region) = 'na'
group by 1,2,3

union all
------ region roll-up
select
    case when cac.store_region = 'NA' then store_brand_abbr || '-NA' else store_brand_abbr || '-EU' end as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
join edw_prod.data_model_jfb.dim_store ds on ds.store_id = cac.store_id
where lower(cac.store_brand) in ('justfab','shoedazzle','fabkids')
group by 1,2,3

union all
------ country roll-up
select
    store_brand_abbr || '-' || (case when cac.store_country = 'AT' then 'DE'
                                     when cac.store_country = 'BE' then 'FR'
                                else cac.store_country end) as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
join edw_prod.data_model_jfb.dim_store ds on ds.store_id = cac.store_id
where lower(cac.store_brand) in ('justfab','shoedazzle','fabkids')
    and lower(cac.store_country) in ('us','ca','de','dk','es','fr','uk','se','nl','be','at')
group by 1,2,3

union all
------ fabkids, no free trial
select
    'FK-NFT-NA' as store_abbreviation,
    date,
    currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_d1) as vips_from_leads_1d,
    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(bop_vips) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
    sum(activating_vip_product_order_count) as product_order_count
from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
where lower(store_brand) in ('fabkids')
    and lower(store_region) = 'na'
    and is_fk_free_trial_flag = false
group by 1,2,3;

--union all
------- SAVAGE X WW -----
-------- global roll-up
--select
--    'SX-GLOBAL' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'savage x'
--group by 1,2,3

--union all
--
-------- region roll-up
--select
--    case when store_region = 'NA' then 'SX-NA' else 'SX-EU' end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'savage x'
--group by 1,2,3

--union all
--
-------- region roll-up, online only
--select
--    'SX-O-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'savage x'
--    and lower(store_region) = 'na'
--    and retail_customer = false
--group by 1,2,3

--union all
--
-------- country roll-up
--select
--    'SX-' || store_country as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'savage x'
--    and lower(store_country) in ('us','ca','de','es','fr','uk','eurem')
--group by 1,2,3

--union all
--
----- YITTY NA -----
------ region roll-up
--select
--    'YT-O-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'yitty'
--    and lower(store_region) = 'na'
--group by 1,2,3

--union all
----- FABLETICS CORP -----
------ global roll-up
--select
--    'FLC-GLOBAL' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) in ('fabletics','yitty')
--group by 1,2,3
--
--union all
--
-------- fabletics + scrubs global
--select
--    'FL+SC-GLOBAL' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--group by 1,2,3
--
--union all
--
-------- north america roll-up
--select
--    'FLC-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) in ('fabletics','yitty')
--    and lower(store_region) = 'na'
--group by 1,2,3
--
--union all
--
-------- north america roll-up, online only
--select
--    'FLC-O-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) in ('fabletics','yitty')
--    and lower(store_region) = 'na'
--    and retail_customer = false
--group by 1,2,3
--
--union all
--
------- FABLETICS ACTIVEWEAR -----
-------- fabletics region roll-up
--
--select
--    'FL-' || store_region as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) in ('na','eu')
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
--
-------- fabletics region roll-up by gender
--select
--    case when is_fl_mens_flag = true then 'FL-M-' || store_region else 'FL-W-' || store_region end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) in ('na','eu')
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
-------- country roll-up
--select
--    case when store_country = 'AT' then 'FL-DE'
--         when store_country = 'BE' then 'FL-FR'
--        else 'FL-' || store_country end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_country) in ('de','uk','dk','fr','es','nl','se','at','us','ca','be')
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
------ country roll-up by gender
--select
--    case when is_fl_mens_flag = true
--            then 'FL-M-' || iff(store_country = 'AT', 'DE', iff(store_country = 'BE', 'FR', store_country))
--        else 'FL-W-' || iff(store_country = 'AT', 'DE', iff(store_country = 'BE', 'FR', store_country))
--    end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_country) in ('de','uk','dk','fr','es','nl','se','at','us','ca','be')
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
-------- region roll-up by gender, online only
--select
--    case when is_fl_mens_flag = true then 'FL-M-O-' || store_region
--        else 'FL-W-O-' || store_region end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) in ('na','eu')
--    and retail_customer = false
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
-------- country roll-up by gender, online only
--select
--    case when is_fl_mens_flag = true then 'FL-M-O-' || iff(store_country = 'AT', 'DE', store_country)
--        else 'FL-W-O-' || iff(store_country = 'AT', 'DE', store_country) end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_country) in ('de','uk','at')
--    and retail_customer = false
--    and is_fl_scrubs_customer = false
--group by 1,2,3
--
--union all
------- FABLETICS & SCRUBS COMBINED -----
-------- fabletics + scrubs region roll-up
--select
--    'FL+SC-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) = 'na'
--group by 1,2,3
--
--union all
--
------ fabletics + scrubs region roll-up by gender
--select
--    case when is_fl_mens_flag = true then 'FL+SC-M-NA' else 'FL+SC-W-NA' end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) = 'na'
--group by 1,2,3
--
--union all
----- SCRUBS -----
-------- scrubs region roll-up
--select
--    'SC-O-NA' as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) = 'na'
--    and is_fl_scrubs_customer = true
--group by 1,2,3
--
--union all
--
-------- fabletics scrubs region roll-up by gender
--select
--    case when is_fl_mens_flag = true then 'SC-M-O-NA' else 'SC-W-O-NA' end as store_abbreviation,
--    date,
--    currency,
--    sum(primary_leads) as primary_leads,
--    sum(secondary_leads) as secondary_leads,
--    sum(reactivated_leads) as reactivated_leads,
--    sum(retail_leads) as retail_leads,
--    sum(vips_from_leads_30m) as vips_from_leads_30m,
--    sum(vips_from_leads_d1) as vips_from_leads_1d,
--    sum(vips_from_leads_d1 + vips_from_leads_d2 + vips_from_leads_d3 + vips_from_leads_d4 + vips_from_leads_d5 + vips_from_leads_d6 + vips_from_leads_d7) as vips_from_leads_7d,
--    sum(vips_from_leads_24h) as vips_from_leads_24h,
--    sum(vips_from_leads_m1) as vips_from_leads_m1,
--    sum(vips_on_date_m1) as vips_on_date_m1,
--    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
--    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
--    sum(total_vips_on_date) as total_vips_on_date,
--    sum(vips_on_date_d1) as vips_on_date_d1,
--    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
--    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
--    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
--    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
--    sum(reactivated_vips) as reactivated_vips,
--    sum(retail_vips) as retail_vips,
--    sum(varsity_vips) as varsity_vips,
--    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
--    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
--    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
--    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
--    sum(total_cancels_on_date) as cancels_on_date,
--    sum(passive_cancels_on_date) as passive_cancels_on_date,
--    sum(total_spend) as total_spend,
--    sum(prospecting_spend) as prospecting_spend,
--    sum(facebook_spend) as facebook_spend,
--    sum(snapchat_spend) as snapchat_spend,
--    sum(pinterest_spend) as pinterest_spend,
--    sum(applovin_spend) as applovin_spend,
--    sum(linkedin_spend) as linkedin_spend,
--    sum(nift_spend) as nift_spend,
--    sum(rokt_spend) as rokt_spend,
--    sum(twitch_spend) as twitch_spend,
--    sum(google_other_spend) as google_other_spend,
--    sum(ooh_spend) as ooh_spend,
--    sum(celebrity_spend) as celebrity_spend,
--    sum(non_branded_search_spend) as non_branded_search_spend,
--    sum(branded_search_spend) as branded_search_spend,
--    sum(shopping_spend) as shopping_spend,
--    sum(programmatic_spend) as programmatic_spend,
--    sum(youtube_spend) as youtube_spend,
--    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
--    sum(testing_spend) as testing_spend,
--    sum(print_spend) as print_spend,
--    sum(radio_podcast_spend) as radio_podcast_spend,
--    sum(influencers_spend) as influencers_spend,
--    sum(affiliate_spend) as affiliate_spend,
--    sum(physical_partnerships_spend) as physical_partnerships_spend,
--    sum(tiktok_spend) as tiktok_spend,
--    sum(reddit_spend) as reddit_spend,
--    sum(twitter_spend) as twitter_spend,
--    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
--    sum(bop_vips) as bop_vips,
--	sum(total_cancels_on_date) as total_cancels_on_date,
--    sum(activating_vip_product_margin_pre_return) as activating_acquisition_margin,
--    sum(activating_vip_product_order_count) as product_order_count
--from reporting_media_prod.attribution.acquisition_unattributed_total_cac cac
--where lower(store_brand) = 'fabletics'
--    and lower(store_region) = 'na'
--    and is_fl_scrubs_customer = true
--group by 1,2,3;


create or replace temporary table _total_cac_daily_output as
select b.tab_sequence as sequence,
       b.store_name_description as store_name,
       o.*
from reporting_media_prod.attribution.cac_tab_budget_store_lookup b
join _total_cac_daily_by_segment o on o.store_abbreviation = b.store_tab_abbreviation;


------------------------------------------------------------------------------------
-- get daily values for TY, LY, and LM
create or replace temporary table _daily_results as
select *,
       case when date_trunc('month',date) = $current_month_date then 'DailyTY'
            when date_trunc('month',date) = $last_month_date then 'DailyLM'
            when date_trunc('month',date) = $same_month_last_year_start then 'DailyLY' end as source
from _total_cac_daily_output
where date_trunc('month',date) in ($current_month_date, $last_month_date, $same_month_last_year_start);

-- get MTD comps for LY and LM
create or replace temporary table _daily_results_mtd_comp as
select
    sequence,
    store_name,
    store_abbreviation,
    date_trunc('month',cac.date) as date,
    cac.currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_1d) as vips_from_leads_1d,
    sum(vips_from_leads_7d) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(iff(day(cac.date)=1,bop_vips,0)) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_acquisition_margin) as activating_acquisition_margin,
    sum(product_order_count) as product_order_count,
    case when date between $last_month_date and dateadd('month', -1, $report_date) then 'LMMTDComp'
         when date between $same_month_last_year_start and dateadd('year', -1, $report_date) then 'LYMTDComp'
         end as source

from _total_cac_daily_output cac
where date between $last_month_date and dateadd('month', -1, $report_date) or
      date between $same_month_last_year_start and dateadd('year', -1, $report_date)
group by 1,2,3,4,5,source;


-- get aggregate monthly results
create or replace temporary table _monthly_results as
select
    sequence,
    store_name,
    store_abbreviation,
    date_trunc('month',cac.date) as date,
    cac.currency,
    sum(primary_leads) as primary_leads,
    sum(secondary_leads) as secondary_leads,
    sum(reactivated_leads) as reactivated_leads,
    sum(retail_leads) as retail_leads,
    sum(vips_from_leads_30m) as vips_from_leads_30m,
    sum(vips_from_leads_1d) as vips_from_leads_1d,
    sum(vips_from_leads_7d) as vips_from_leads_7d,
    sum(vips_from_leads_24h) as vips_from_leads_24h,
    sum(vips_from_leads_m1) as vips_from_leads_m1,
    sum(vips_on_date_m1) as vips_on_date_m1,
    sum(vips_from_reactivated_leads_24h) as vips_from_reactivated_leads_24h,
    sum(total_vips_from_reactivated_leads) as total_vips_from_reactivated_leads,
    sum(total_vips_on_date) as total_vips_on_date,
    sum(vips_on_date_d1) as vips_on_date_d1,
    sum(vips_on_date_d2_d7) as vips_on_date_d2_d7,
    sum(vips_on_date_d1_d7) as vips_on_date_d1_d7,
    sum(vips_on_date_d8_d90) as vips_on_date_d8_d90,
    sum(vips_on_date_d90plus) as vips_on_date_d90plus,
    sum(reactivated_vips) as reactivated_vips,
    sum(retail_vips) as retail_vips,
    sum(varsity_vips) as varsity_vips,
    sum(vips_from_reactivated_leads_d1) as vips_from_reactivated_leads_d1,
    sum(vips_on_date_d1_excluding_reactivated_leads) as vips_on_date_d1_excluding_reactivated_leads,
    sum(vips_on_date_d1_reactivated_leads) as vips_on_date_d1_reactivated_leads,
    sum(vips_on_date_m1_reactivated_leads) as vips_on_date_m1_reactivated_leads,
    sum(total_cancels_on_date) as cancels_on_date,
    sum(passive_cancels_on_date) as passive_cancels_on_date,
    sum(total_spend) as total_spend,
    sum(prospecting_spend) as prospecting_spend,
    sum(facebook_spend) as facebook_spend,
    sum(snapchat_spend) as snapchat_spend,
    sum(pinterest_spend) as pinterest_spend,
    sum(applovin_spend) as applovin_spend,
    sum(linkedin_spend) as linkedin_spend,
    sum(nift_spend) as nift_spend,
    sum(rokt_spend) as rokt_spend,
    sum(twitch_spend) as twitch_spend,
    sum(google_other_spend) as google_other_spend,
    sum(ooh_spend) as ooh_spend,
    sum(celebrity_spend) as celebrity_spend,
    sum(non_branded_search_spend) as non_branded_search_spend,
    sum(branded_search_spend) as branded_search_spend,
    sum(shopping_spend) as shopping_spend,
    sum(programmatic_spend) as programmatic_spend,
    sum(youtube_spend) as youtube_spend,
    sum(tv_and_streaming_spend) as tv_and_streaming_spend,
    sum(testing_spend) as testing_spend,
    sum(print_spend) as print_spend,
    sum(radio_podcast_spend) as radio_podcast_spend,
    sum(influencers_spend) as influencers_spend,
    sum(affiliate_spend) as affiliate_spend,
    sum(physical_partnerships_spend) as physical_partnerships_spend,
    sum(tiktok_spend) as tiktok_spend,
    sum(reddit_spend) as reddit_spend,
    sum(twitter_spend) as twitter_spend,
    sum(first_guest_product_margin_pre_return) as first_guest_product_margin_pre_return,
    sum(iff(day(cac.date)=1,bop_vips,0)) as bop_vips,
	sum(total_cancels_on_date) as total_cancels_on_date,
    sum(activating_acquisition_margin) as activating_acquisition_margin,
    sum(product_order_count) as product_order_count,
    cast('Monthly' as varchar(55)) as source
from _total_cac_daily_output cac
group by 1,2,3,4,5;

update _monthly_results
set source = cast('MTD' as varchar(55))
where date = $current_month_date;


-- get daily LY and LM
create or replace temporary table _daily_pop_results as
select *
from _monthly_results
where date in ($same_month_last_year_start, $last_month_date);

update _daily_pop_results
set source = case when date = $same_month_last_year_start then 'DailyLYTotal'
                  when date = $last_month_date then 'DailyLMTotal' end;


create or replace temporary table _report_output as
select *
from _daily_results
union all
select *
from _daily_results_mtd_comp
union all
select *
from _monthly_results
union all
select *
from _daily_pop_results;


------------------------------------------------------------------------------------

-- get run rates
create or replace temporary table _run_rate as
select sequence,
       store_name,
       store_abbreviation,
       date,
       currency,
       primary_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as primary_leads,
       secondary_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as secondary_leads,
       reactivated_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as reactivated_leads,
       retail_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as retail_leads,
       vips_from_leads_30m*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_leads_30m,
       vips_from_leads_1d*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_leads_1d,
       vips_from_leads_7d*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_leads_7d,
       vips_from_leads_24h*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_leads_24h,
       vips_from_leads_m1*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_leads_m1,
       vips_on_date_m1*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_m1,
       vips_from_reactivated_leads_24h*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_reactivated_leads_24h,
       total_vips_from_reactivated_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as total_vips_from_reactivated_leads,
       total_vips_on_date*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as total_vips_on_date,
       vips_on_date_d1*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d1,
       vips_on_date_d2_d7*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d2_d7,
       vips_on_date_d1_d7*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d1_d7,
       vips_on_date_d8_d90*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d8_d90,
       vips_on_date_d90plus*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d90plus,
       reactivated_vips*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as reactivated_vips,
       retail_vips*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as retail_vips,
       varsity_vips*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as varsity_vips,
       vips_from_reactivated_leads_d1*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_from_reactivated_leads_d1,
       vips_on_date_d1_excluding_reactivated_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d1_excluding_reactivated_leads,
       vips_on_date_d1_reactivated_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_d1_reactivated_leads,
       vips_on_date_m1_reactivated_leads*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as vips_on_date_m1_reactivated_leads,
       cancels_on_date*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as cancels_on_date,
       passive_cancels_on_date*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as passive_cancels_on_date,
       total_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as total_spend,
       prospecting_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as prospecting_spend,
       facebook_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as facebook_spend,
       snapchat_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as snapchat_spend,
       pinterest_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as pinterest_spend,
       applovin_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as applovin_spend,
       linkedin_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as linkedin_spend,
       nift_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as nift_spend,
       rokt_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as rokt_spend,
       twitch_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as twitch_spend,
       google_other_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as google_other_spend,
       ooh_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as ooh_spend,
       celebrity_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as celebrity_spend,
       non_branded_search_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as non_branded_search_spend,
       branded_search_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as branded_search_spend,
       shopping_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as shopping_spend,
       programmatic_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as programmatic_spend,
       youtube_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as youtube_spend,
       tv_and_streaming_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as tv_and_streaming_spend,
       testing_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as testing_spend,
       print_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as print_spend,
       radio_podcast_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as radio_podcast_spend,
       influencers_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as influencers_spend,
       affiliate_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as affiliate_spend,
       physical_partnerships_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as physical_partnerships_spend,
       tiktok_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as tiktok_spend,
       reddit_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as reddit_spend,
       twitter_spend*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as twitter_spend,
       first_guest_product_margin_pre_return*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as first_guest_product_margin_pre_return,
       bop_vips*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as bop_vips,
       total_cancels_on_date*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as total_cancels_on_date,
       activating_acquisition_margin*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as activating_acquisition_margin,
       product_order_count*(1.0 * day(last_day($high_watermark_date))/day($high_watermark_date-1)) as product_order_count,
       'RR' as source
from _report_output
where source = 'MTD';


------------------------------------------------------------------------------------
-- bring in budget / forecast targets

create or replace temporary table _budget_btfx as
select sequence,
       store_name,
       store_abbreviation,
       date,
       currency,
       null as primary_leads,
       null as secondary_leads,
       null as reactivated_leads,
       null as retail_leads,
       null as vips_from_leads_30m,
       null as vips_from_leads_1d,
       null as vips_from_leads_7d,
       null as vips_from_leads_24h,
       null as vips_from_leads_m1,
       null as vips_on_date_m1,
       null as vips_from_reactivated_leads_24h,
       null as total_vips_from_reactivated_leads,
       null as total_vips_on_date,
       null as vips_on_date_d1,
       null as vips_on_date_d2_d7,
       null as vips_on_date_d1_d7,
       null as vips_on_date_d8_d90,
       null as vips_on_date_d90plus,
       null as reactivated_vips,
       null as retail_vips,
       null as varsity_vips,
       null as vips_from_reactivated_leads_d1,
       null as vips_on_date_d1_reactivated_leads,
       null as vips_on_date_d1_excluding_reactivated_leads,
       null as vips_on_date_m1_reactivated_leads,
       null as cancels_on_date,
       null as passive_cancels_on_date,
       null as total_spend,
       null as prospecting_spend,
       null as facebook_spend,
       null as snapchat_spend,
       null as pinterest_spend,
       null as applovin_spend,
       null as linkedin_spend,
       null as nift_spend,
       null as rokt_spend,
       null as twitch_spend,
       null as google_other_spend,
       null as ooh_spend,
       null as celebrity_spend,
       null as non_branded_search_spend,
       null as branded_search_spend,
       null as shopping_spend,
       null as programmatic_spend,
       null as youtube_spend,
       null as tv_and_streaming_spend,
       null as testing_spend,
       null as print_spend,
       null as radio_podcast_spend,
       null as influencers_spend,
       null as affiliate_spend,
       null as physical_partnerships_spend,
       null as tiktok_spend,
       null as reddit_spend,
       null as twitter_spend,
       null as first_guest_product_margin_pre_return,
       null as bop_vips,
       null as total_cancels_on_date,
       null as activating_acquisition_margin,
       null as product_order_count,
       cast('Budget-BTFX' as varchar(55)) as source
from _report_output
where source = 'MTD';

create or replace temporary table _budget_currfx AS
select *
from _budget_btfx;
update _budget_currfx
set source = 'Budget-CURRFX';

create or replace temporary table _forecast_btfx as
select *
from _budget_btfx;
update _forecast_btfx
set source = 'Forecast-BTFX';

create or replace temporary table _forecast_currfx as
select *
from _budget_btfx;
update _forecast_currfx
set source = 'Forecast-CURRFX';

create or replace temporary table _final_output as
select *
from _report_output
union all
select *
from _run_rate
union all
select *
from _budget_btfx
union all
select *
from _budget_currfx
union all
select *
from _forecast_btfx
union all
select *
from _forecast_currfx;

------------------------------------------------------------------------------------
-- report versions:
-- FL GLOBAL by Country - USD
-- FL GLOBAL by Region - USD
-- FLEU - Local
-- JFB GLOBAL - USD
-- JFEU - Local
-- SXF GLOBAL - USD
-- SXEU - Local

create or replace temporary table _total_cac (
    sequence int,
    store_name varchar(100),
    store_abbreviation varchar(25),
    date date,
    primary_leads decimal(20,4),
    secondary_leads decimal(20,4),
    cross_brand_leads_per decimal(20,4),
    cpl decimal(20,4),
    media_spend decimal(20,4),
    vips_from_leads_30m decimal(20,4),
    vips_from_leads_30m_cac decimal(20,4),
    vips_from_leads_1d decimal(20,4),
    vips_from_leads_1d_cac decimal(20,4),
    vips_from_leads_7d decimal(20,4),
    vips_from_leads_24h decimal(20,4),
    vips_from_leads_24h_cac decimal(20,4),
    vips_from_leads_m1 decimal(20,4),
    vips_from_leads_m1_cac decimal(20,4),
    vips_on_date_m1 decimal(20,4),
    vips_on_date_m1_cac decimal(20,4),
    total_vips_from_reactivated_leads decimal(20,4),
    total_vips_on_date decimal(20,4),
    total_vips_on_date_cac decimal(20,4),
    vips_on_date_d1 decimal(20,4),
    vips_on_date_d2_d7 decimal(20,4),
    vips_on_date_d1_d7 decimal(20,4),
    vips_on_date_d8_d90 decimal(20,4),
    vips_on_date_d90plus decimal(20,4),
    reactivated_vips decimal(20,4),
    reactivated_vips_per decimal(20,4),
    retail_vips decimal(20,4),
    varsity_vips decimal(20,4),
    vips_from_reactivated_leads_d1 decimal(20,4),
    vips_on_date_d1_reactivated_leads decimal(20,4),
    vips_on_date_d1_excluding_reactivated_leads decimal(20,4),
    vips_on_date_m1_reactivated_leads decimal(20,4),
    reactivated_leads decimal(20,4),
    retail_leads decimal(20,4),
    cancels_on_date decimal(20,4),
    passive_cancels_on_date decimal(20,4),
    vips_from_leads_30m_per decimal(20,4),
    vips_from_leads_24h_per decimal(20,4),
    vips_from_leads_m1_per decimal(20,4),
    vips_from_reactivated_leads_24h_per decimal(20,4),
    d1_vips_per decimal(20,4),
    d1_vips_excluding_reactivated_leads_per decimal(20,4),
    d1_vips_reactivated_leads_per decimal(20,4),
    d2_d7_vips_per decimal(20,4),
    d1_d7_vips_per decimal(20,4),
    d8_d90_vips_per decimal(20,4),
    d90plus_vips_per decimal(20,4),
    reactivated_leads_per decimal(20,4),
    prospecting_spend decimal(20,4),
    facebook_spend decimal(20,4),
    snapchat_spend decimal(20,4),
    pinterest_spend decimal(20,4),
    applovin_spend decimal(20,4),
    linkedin_spend decimal(20,4),
    nift_spend decimal(20,4),
    rokt_spend decimal(20,4),
    twitch_spend decimal(20,4),
    google_other_spend decimal(20,4),
    ooh_spend decimal(20,4),
    celebrity_spend decimal(20,4),
    non_branded_search_spend decimal(20,4),
    branded_search_spend decimal(20,4),
    shopping_spend decimal(20,4),
    programmatic_spend decimal(20,4),
    youtube_spend decimal(20,4),
    tv_and_streaming_spend decimal(20,4),
    testing_spend decimal(20,4),
    print_spend decimal(20,4),
    radio_podcast_spend decimal(20,4),
    influencers_spend decimal(20,4),
    affiliate_spend decimal(20,4),
    physical_partnerships_spend decimal(20,4),
    tiktok_spend decimal(20,4),
    reddit_spend decimal(20,4),
    twitter_spend decimal(20,4),
    prospecting_spend_per decimal(20,4),
    facebook_spend_per decimal(20,4),
    snapchat_spend_per decimal(20,4),
    pinterest_spend_per decimal(20,4),
    applovin_spend_per	decimal(20,4),
    linkedin_spend_per	decimal(20,4),
    nift_spend_per	decimal(20,4),
    rokt_spend_per decimal(20,4),
    twitch_spend_per	decimal(20,4),
    google_other_spend_per	decimal(20,4),
    ooh_spend_per  decimal(20,4),
    celebrity_spend_per	decimal(20,4),
    non_branded_search_spend_per decimal(20,4),
    branded_search_spend_per decimal(20,4),
    shopping_spend_per decimal(20,4),
    programmatic_spend_per decimal(20,4),
    youtube_spend_per decimal(20,4),
    tv_and_streaming_spend_per decimal(20,4),
    testing_spend_per decimal(20,4),
    print_spend_per decimal(20,4),
    radio_podcast_spend_per decimal(20,4),
    influencers_spend_per decimal(20,4),
    affiliate_spend_per decimal(20,4),
    physical_partnerships_spend_per decimal(20,4),
    tiktok_spend_per decimal(20,4),
    reddit_spend_per decimal(20,4),
    twitter_spend_per decimal(20,4),
    first_guest_product_margin_pre_return number(20, 4),
    bop_vips number(20, 4),
    total_cancels_on_date number(20, 4),
    activating_acquisition_margin number(20, 4),
    product_order_count number(20, 4),
    currency varchar(25),
    source varchar(25),
    version varchar(100)
);

create or replace temporary table _report_versions as
-- report versions excluding fabletics
select sequence,
       store_name,
       store_abbreviation,
       date as date,
       primary_leads as primary_leads,
       secondary_leads as secondary_leads,
       (secondary_leads/nullif((primary_leads + secondary_leads),0)) as cross_brand_leads_per,
       (total_spend/nullif(primary_leads,0)) as cpl,
       total_spend as media_spend,
       vips_from_leads_30m as vips_from_leads_30m,
       total_spend/nullif(vips_from_leads_30m,0) as vips_from_leads_30m_cac,
       vips_from_leads_1d as vips_from_leads_1d,
       total_spend/nullif(vips_from_leads_1d,0) as vips_from_leads_1d_cac,
       vips_from_leads_7d as vips_from_leads_7d,
       vips_from_leads_24h as vips_from_leads_24h,
       total_spend/nullif(vips_from_leads_24h,0) as vips_from_leads_24h_cac,
       vips_from_leads_m1 as vips_from_leads_m1,
       total_spend/nullif(vips_from_leads_m1,0) as vips_from_leads_m1_cac,
       vips_on_date_m1 as vips_on_date_m1,
       total_spend/nullif(vips_on_date_m1,0) as vips_on_date_m1_cac,
       total_vips_from_reactivated_leads as total_vips_from_reactivated_leads,
       total_vips_on_date as total_vips_on_date,
       total_spend/nullif(total_vips_on_date,0) as total_vips_on_date_cac,
       vips_on_date_d1 as vips_on_date_d1,
       vips_on_date_d2_d7 as vips_on_date_d2_d7,
       vips_on_date_d1_d7 as vips_on_date_d1_d7,
       vips_on_date_d8_d90 as vips_on_date_d8_d90,
       vips_on_date_d90plus as vips_on_date_d90plus,
       reactivated_vips as reactivated_vips,
       (reactivated_vips/nullif(total_vips_on_date,0)) as reactivated_vips_per,
       retail_vips  as retail_vips,
       varsity_vips as varsity_vips,
       vips_from_reactivated_leads_d1 as vips_from_reactivated_leads_d1,
       vips_on_date_d1_excluding_reactivated_leads as vips_on_date_d1_excluding_reactivated_leads,
       vips_on_date_d1_reactivated_leads as vips_on_date_d1_reactivated_leads,
       vips_on_date_m1_reactivated_leads as vips_on_date_m1_reactivated_leads,
       reactivated_leads as reactivated_leads,
       retail_leads as retail_leads,
       cancels_on_date,
       passive_cancels_on_date,
       (vips_from_leads_30m/nullif(primary_leads,0)) as vips_from_leads_30m_per,
       (vips_from_leads_24h/nullif(primary_leads,0)) as vips_from_leads_24h_per,
       (vips_from_leads_m1/nullif(primary_leads,0)) as vips_from_leads_m1_per,
       (vips_from_reactivated_leads_24h/nullif(reactivated_leads,0)) as vips_from_reactivated_leads_24h_per,
       (vips_on_date_d1/nullif(total_vips_on_date,0)) as d1_vips_per,
       (vips_on_date_d1_excluding_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_excluding_reactivated_leads_per,
       (vips_on_date_d1_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_reactivated_leads_per,
       (vips_on_date_d2_d7/nullif(total_vips_on_date ,0)) as d2_d7_vips_per,
       (vips_on_date_d1_d7/nullif(total_vips_on_date ,0)) as d1_d7_vips_per,
       (vips_on_date_d8_d90/nullif(total_vips_on_date,0)) as d8_d90_vips_per,
       (vips_on_date_d90plus/nullif(total_vips_on_date,0)) as d90plus_vips_per,
       (reactivated_leads/nullif(primary_leads,0)) as reactivated_leads_per,
       prospecting_spend as prospecting_spend,
       facebook_spend as facebook_spend,
       snapchat_spend as snapchat_spend,
       pinterest_spend as pinterest_spend,
       applovin_spend as applovin_spend,
       linkedin_spend as linkedin_spend,
       nift_spend as nift_spend,
       rokt_spend as rokt_spend,
       twitch_spend as twitch_spend,
       google_other_spend as google_other_spend,
       ooh_spend as ooh_spend,
       celebrity_spend as celebrity_spend,
       non_branded_search_spend as non_branded_search_spend,
       branded_search_spend as branded_search_spend,
       shopping_spend as shopping_spend,
       programmatic_spend as programmatic_spend,
       youtube_spend as youtube_spend,
       tv_and_streaming_spend as tv_and_streaming_spend,
       testing_spend as testing_spend,
       print_spend as print_spend,
       radio_podcast_spend as radio_podcast_spend,
       influencers_spend as influencers_spend,
       affiliate_spend as affiliate_spend,
       physical_partnerships_spend as physical_partnerships_spend,
       tiktok_spend as tiktok_spend,
       reddit_spend as reddit_spend,
       twitter_spend as twitter_spend,
       (prospecting_spend/nullif(total_spend,0)) as prospecting_spend_per,
       (facebook_spend/nullif(total_spend,0)) as facebook_spend_per,
       (snapchat_spend/nullif(total_spend,0)) as snapchat_spend_per,
       (pinterest_spend/nullif(total_spend,0)) as pinterest_spend_per,
       (applovin_spend/nullif(total_spend,0)) as applovin_spend_per,
       (linkedin_spend/nullif(total_spend,0)) as linkedin_spend_per,
       (nift_spend/nullif(total_spend,0)) as nift_spend_per,
       (rokt_spend/nullif(total_spend,0)) as rokt_spend_per,
       (twitch_spend/nullif(total_spend,0)) as twitch_spend_per,
       (google_other_spend/nullif(total_spend,0)) as google_other_spend_per,
       (ooh_spend/nullif(total_spend,0)) as ooh_spend_per,
       (celebrity_spend/nullif(total_spend,0)) as celebrity_spend_per,
       (non_branded_search_spend/nullif(total_spend,0)) as non_branded_search_spend_per,
       (branded_search_spend/nullif(total_spend,0)) as branded_search_spend_per,
       (shopping_spend/nullif(total_spend,0)) as shopping_spend_per,
       (programmatic_spend/nullif(total_spend,0)) as programmatic_spend_per,
       (youtube_spend/nullif(total_spend,0)) as youtube_spend_per,
       (tv_and_streaming_spend/nullif(total_spend,0)) as tv_and_streaming_spend_per,
       (testing_spend/nullif(total_spend,0)) as testing_spend_per,
       (print_spend/nullif(total_spend,0)) as print_spend_per,
       (radio_podcast_spend/nullif(total_spend,0)) as radio_podcast_spend_per,
       (influencers_spend/nullif(total_spend,0)) as influencers_spend_per,
       (affiliate_spend/nullif(total_spend,0)) as affiliate_spend_per,
       (physical_partnerships_spend/nullif(total_spend,0)) as physical_partnerships_spend_per,
       (tiktok_spend/nullif(total_spend,0)) as tiktok_spend_per,
       (reddit_spend/nullif(total_spend,0)) as reddit_spend_per,
       (twitter_spend/nullif(total_spend,0)) as twitter_spend_per,
       first_guest_product_margin_pre_return,
       bop_vips,
       total_cancels_on_date,
       activating_acquisition_margin,
       product_order_count,
       currency as currency,
       source as source,
       case when store_name ilike '%savage%' and currency = 'USD' then 'SXF GLOBAL - USD'
            when store_name ilike '%savage%'
                     and not (store_abbreviation ilike any ('%-GLOBAL','%-NA','%-US','%-CA'))
                     and currency = 'Local' then 'SXEU - Local'

            when store_name ilike any ('%justfab%', '%shoedazzle%', '%fabkids%') and currency = 'USD' then 'JFB GLOBAL - USD'
            when store_name ilike any ('%justfab%', '%shoedazzle%', '%fabkids%')
                     and not (store_abbreviation ilike any ('%-GLOBAL','%-NA','%-US','%-CA'))
                     and currency = 'Local' then 'JFEU - Local'

            else 'No Report Reference'
            end as version
from _final_output
where store_name not ilike '%fabletics%'
    and store_name not ilike '%yitty%';

--union all
--
---- fabletics global by region and country versions
--select sequence,
--       store_name,
--       store_abbreviation,
--       date as date,
--       primary_leads as primary_leads,
--       secondary_leads as secondary_leads,
--       (secondary_leads/nullif((primary_leads + secondary_leads),0)) as cross_brand_leads_per,
--       (total_spend/nullif(primary_leads,0)) as cpl,
--       total_spend as media_spend,
--       vips_from_leads_30m as vips_from_leads_30m,
--       total_spend/nullif(vips_from_leads_30m,0) as vips_from_leads_30m_cac,
--       vips_from_leads_1d as vips_from_leads_1d,
--       total_spend/nullif(vips_from_leads_1d,0) as vips_from_leads_1d_cac,
--       vips_from_leads_7d as vips_from_leads_7d,
--       vips_from_leads_24h as vips_from_leads_24h,
--       total_spend/nullif(vips_from_leads_24h,0) as vips_from_leads_24h_cac,
--       vips_from_leads_m1 as vips_from_leads_m1,
--       total_spend/nullif(vips_from_leads_m1,0) as vips_from_leads_m1_cac,
--       vips_on_date_m1 as vips_on_date_m1,
--       total_spend/nullif(vips_on_date_m1,0) as vips_on_date_m1_cac,
--       total_vips_from_reactivated_leads as total_vips_from_reactivated_leads,
--       total_vips_on_date as total_vips_on_date,
--       total_spend/nullif(total_vips_on_date,0) as total_vips_on_date_cac,
--       vips_on_date_d1 as vips_on_date_d1,
--       vips_on_date_d2_d7 as vips_on_date_d2_d7,
--       vips_on_date_d1_d7 as vips_on_date_d1_d7,
--       vips_on_date_d8_d90 as vips_on_date_d8_d90,
--       vips_on_date_d90plus as vips_on_date_d90plus,
--       reactivated_vips as reactivated_vips,
--       (reactivated_vips/nullif(total_vips_on_date,0)) as reactivated_vips_per,
--       retail_vips  as retail_vips,
--       varsity_vips as varsity_vips,
--       vips_from_reactivated_leads_d1 as vips_from_reactivated_leads_d1,
--       vips_on_date_d1_excluding_reactivated_leads as vips_on_date_d1_excluding_reactivated_leads,
--       vips_on_date_d1_reactivated_leads as vips_on_date_d1_reactivated_leads,
--       vips_on_date_m1_reactivated_leads as vips_on_date_m1_reactivated_leads,
--       reactivated_leads as reactivated_leads,
--       retail_leads as retail_leads,
--       cancels_on_date,
--       passive_cancels_on_date,
--       (vips_from_leads_30m/nullif(primary_leads,0)) as vips_from_leads_30m_per,
--       (vips_from_leads_24h/nullif(primary_leads,0)) as vips_from_leads_24h_per,
--       (vips_from_leads_m1/nullif(primary_leads,0)) as vips_from_leads_m1_per,
--       (vips_from_reactivated_leads_24h/nullif(reactivated_leads,0)) as vips_from_reactivated_leads_24h_per,
--       (vips_on_date_d1/nullif(total_vips_on_date,0)) as d1_vips_per,
--       (vips_on_date_d1_excluding_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_excluding_reactivated_leads_per,
--       (vips_on_date_d1_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_reactivated_leads_per,
--       (vips_on_date_d2_d7/nullif(total_vips_on_date ,0)) as d2_d7_vips_per,
--       (vips_on_date_d1_d7/nullif(total_vips_on_date ,0)) as d1_d7_vips_per,
--       (vips_on_date_d8_d90/nullif(total_vips_on_date,0)) as d8_d90_vips_per,
--       (vips_on_date_d90plus/nullif(total_vips_on_date,0)) as d90plus_vips_per,
--       (reactivated_leads/nullif(primary_leads,0)) as reactivated_leads_per,
--       prospecting_spend as prospecting_spend,
--       facebook_spend as facebook_spend,
--       snapchat_spend as snapchat_spend,
--       pinterest_spend as pinterest_spend,
--       applovin_spend as applovin_spend,
--       linkedin_spend as linkedin_spend,
--       nift_spend as nift_spend,
--       rokt_spend as rokt_spend,
--       twitch_spend as twitch_spend,
--       google_other_spend as google_other_spend,
--       ooh_spend as ooh_spend,
--       celebrity_spend as celebrity_spend,
--       non_branded_search_spend as non_branded_search_spend,
--       branded_search_spend as branded_search_spend,
--       shopping_spend as shopping_spend,
--       programmatic_spend as programmatic_spend,
--       youtube_spend as youtube_spend,
--       tv_and_streaming_spend as tv_and_streaming_spend,
--       testing_spend as testing_spend,
--       print_spend as print_spend,
--       radio_podcast_spend as radio_podcast_spend,
--       influencers_spend as influencers_spend,
--       affiliate_spend as affiliate_spend,
--       physical_partnerships_spend as physical_partnerships_spend,
--       tiktok_spend as tiktok_spend,
--       reddit_spend as reddit_spend,
--       twitter_spend as twitter_spend,
--       (prospecting_spend/nullif(total_spend,0)) as prospecting_spend_per,
--       (facebook_spend/nullif(total_spend,0)) as facebook_spend_per,
--       (snapchat_spend/nullif(total_spend,0)) as snapchat_spend_per,
--       (pinterest_spend/nullif(total_spend,0)) as pinterest_spend_per,
--       (applovin_spend/nullif(total_spend,0)) as applovin_spend_per,
--       (linkedin_spend/nullif(total_spend,0)) as linkedin_spend_per,
--       (nift_spend/nullif(total_spend,0)) as nift_spend_per,
--       (rokt_spend/nullif(total_spend,0)) as rokt_spend_per,
--       (twitch_spend/nullif(total_spend,0)) as twitch_spend_per,
--       (google_other_spend/nullif(total_spend,0)) as google_other_spend_per,
--       (ooh_spend/nullif(total_spend,0)) as ooh_spend_per,
--       (celebrity_spend/nullif(total_spend,0)) as celebrity_spend_per,
--       (non_branded_search_spend/nullif(total_spend,0)) as non_branded_search_spend_per,
--       (branded_search_spend/nullif(total_spend,0)) as branded_search_spend_per,
--       (shopping_spend/nullif(total_spend,0)) as shopping_spend_per,
--       (programmatic_spend/nullif(total_spend,0)) as programmatic_spend_per,
--       (youtube_spend/nullif(total_spend,0)) as youtube_spend_per,
--       (tv_and_streaming_spend/nullif(total_spend,0)) as tv_and_streaming_spend_per,
--       (testing_spend/nullif(total_spend,0)) as testing_spend_per,
--       (print_spend/nullif(total_spend,0)) as print_spend_per,
--       (radio_podcast_spend/nullif(total_spend,0)) as radio_podcast_spend_per,
--       (influencers_spend/nullif(total_spend,0)) as influencers_spend_per,
--       (affiliate_spend/nullif(total_spend,0)) as affiliate_spend_per,
--       (physical_partnerships_spend/nullif(total_spend,0)) as physical_partnerships_spend_per,
--       (tiktok_spend/nullif(total_spend,0)) as tiktok_spend_per,
--       (reddit_spend/nullif(total_spend,0)) as reddit_spend_per,
--       (twitter_spend/nullif(total_spend,0)) as twitter_spend_per,
--       first_guest_product_margin_pre_return,
--       bop_vips,
--       total_cancels_on_date,
--       activating_acquisition_margin,
--       product_order_count,
--       currency as currency,
--       source as source,
--       case when store_abbreviation ilike any ('%-GLOBAL','%-NA','%-EU') then 'FL GLOBAL by Region - USD'
--            else 'FL GLOBAL by Country - USD'
--            end as version
--from _final_output
--where store_name ilike any ('%fabletics%', '%yitty%')
--    and currency = 'USD'
--
--union all
--
---- fabletics eu local version
--select sequence,
--       store_name,
--       store_abbreviation,
--       date as date,
--       primary_leads as primary_leads,
--       secondary_leads as secondary_leads,
--       (secondary_leads/nullif((primary_leads + secondary_leads),0)) as cross_brand_leads_per,
--       (total_spend/nullif(primary_leads,0)) as cpl,
--       total_spend as media_spend,
--       vips_from_leads_30m as vips_from_leads_30m,
--       total_spend/nullif(vips_from_leads_30m,0) as vips_from_leads_30m_cac,
--       vips_from_leads_1d as vips_from_leads_1d,
--       total_spend/nullif(vips_from_leads_1d,0) as vips_from_leads_1d_cac,
--       vips_from_leads_7d as vips_from_leads_7d,
--       vips_from_leads_24h as vips_from_leads_24h,
--       total_spend/nullif(vips_from_leads_24h,0) as vips_from_leads_24h_cac,
--       vips_from_leads_m1 as vips_from_leads_m1,
--       total_spend/nullif(vips_from_leads_m1,0) as vips_from_leads_m1_cac,
--       vips_on_date_m1 as vips_on_date_m1,
--       total_spend/nullif(vips_on_date_m1,0) as vips_on_date_m1_cac,
--       total_vips_from_reactivated_leads as total_vips_from_reactivated_leads,
--       total_vips_on_date as total_vips_on_date,
--       total_spend/nullif(total_vips_on_date,0) as total_vips_on_date_cac,
--       vips_on_date_d1 as vips_on_date_d1,
--       vips_on_date_d2_d7 as vips_on_date_d2_d7,
--       vips_on_date_d1_d7 as vips_on_date_d1_d7,
--       vips_on_date_d8_d90 as vips_on_date_d8_d90,
--       vips_on_date_d90plus as vips_on_date_d90plus,
--       reactivated_vips as reactivated_vips,
--       (reactivated_vips/nullif(total_vips_on_date,0)) as reactivated_vips_per,
--       retail_vips  as retail_vips,
--       varsity_vips as varsity_vips,
--       vips_from_reactivated_leads_d1 as vips_from_reactivated_leads_d1,
--       vips_on_date_d1_excluding_reactivated_leads as vips_on_date_d1_excluding_reactivated_leads,
--       vips_on_date_d1_reactivated_leads as vips_on_date_d1_reactivated_leads,
--       vips_on_date_m1_reactivated_leads as vips_on_date_m1_reactivated_leads,
--       reactivated_leads as reactivated_leads,
--       retail_leads as retail_leads,
--       cancels_on_date,
--       passive_cancels_on_date,
--       (vips_from_leads_30m/nullif(primary_leads,0)) as vips_from_leads_30m_per,
--       (vips_from_leads_24h/nullif(primary_leads,0)) as vips_from_leads_24h_per,
--       (vips_from_leads_m1/nullif(primary_leads,0)) as vips_from_leads_m1_per,
--       (vips_from_reactivated_leads_24h/nullif(reactivated_leads,0)) as vips_from_reactivated_leads_24h_per,
--       (vips_on_date_d1/nullif(total_vips_on_date,0)) as d1_vips_per,
--       (vips_on_date_d1_excluding_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_excluding_reactivated_leads_per,
--       (vips_on_date_d1_reactivated_leads/nullif(total_vips_on_date,0)) as d1_vips_reactivated_leads_per,
--       (vips_on_date_d2_d7/nullif(total_vips_on_date ,0)) as d2_d7_vips_per,
--       (vips_on_date_d1_d7/nullif(total_vips_on_date ,0)) as d1_d7_vips_per,
--       (vips_on_date_d8_d90/nullif(total_vips_on_date,0)) as d8_d90_vips_per,
--       (vips_on_date_d90plus/nullif(total_vips_on_date,0)) as d90plus_vips_per,
--       (reactivated_leads/nullif(primary_leads,0)) as reactivated_leads_per,
--       prospecting_spend as prospecting_spend,
--       facebook_spend as facebook_spend,
--       snapchat_spend as snapchat_spend,
--       pinterest_spend as pinterest_spend,
--       applovin_spend as applovin_spend,
--       linkedin_spend as linkedin_spend,
--       nift_spend as nift_spend,
--       rokt_spend as rokt_spend,
--       twitch_spend as twitch_spend,
--       google_other_spend as google_other_spend,
--       ooh_spend as ooh_spend,
--       celebrity_spend as celebrity_spend,
--       non_branded_search_spend as non_branded_search_spend,
--       branded_search_spend as branded_search_spend,
--       shopping_spend as shopping_spend,
--       programmatic_spend as programmatic_spend,
--       youtube_spend as youtube_spend,
--       tv_and_streaming_spend as tv_and_streaming_spend,
--       testing_spend as testing_spend,
--       print_spend as print_spend,
--       radio_podcast_spend as radio_podcast_spend,
--       influencers_spend as influencers_spend,
--       affiliate_spend as affiliate_spend,
--       physical_partnerships_spend as physical_partnerships_spend,
--       tiktok_spend as tiktok_spend,
--       reddit_spend as reddit_spend,
--       twitter_spend as twitter_spend,
--       (prospecting_spend/nullif(total_spend,0)) as prospecting_spend_per,
--       (facebook_spend/nullif(total_spend,0)) as facebook_spend_per,
--       (snapchat_spend/nullif(total_spend,0)) as snapchat_spend_per,
--       (pinterest_spend/nullif(total_spend,0)) as pinterest_spend_per,
--       (applovin_spend/nullif(total_spend,0)) as applovin_spend_per,
--       (linkedin_spend/nullif(total_spend,0)) as linkedin_spend_per,
--       (nift_spend/nullif(total_spend,0)) as nift_spend_per,
--       (rokt_spend/nullif(total_spend,0)) as rokt_spend_per,
--       (twitch_spend/nullif(total_spend,0)) as twitch_spend_per,
--       (google_other_spend/nullif(total_spend,0)) as google_other_spend_per,
--       (ooh_spend/nullif(total_spend,0)) as ooh_spend_per,
--       (celebrity_spend/nullif(total_spend,0)) as celebrity_spend_per,
--       (non_branded_search_spend/nullif(total_spend,0)) as non_branded_search_spend_per,
--       (branded_search_spend/nullif(total_spend,0)) as branded_search_spend_per,
--       (shopping_spend/nullif(total_spend,0)) as shopping_spend_per,
--       (programmatic_spend/nullif(total_spend,0)) as programmatic_spend_per,
--       (youtube_spend/nullif(total_spend,0)) as youtube_spend_per,
--       (tv_and_streaming_spend/nullif(total_spend,0)) as tv_and_streaming_spend_per,
--       (testing_spend/nullif(total_spend,0)) as testing_spend_per,
--       (print_spend/nullif(total_spend,0)) as print_spend_per,
--       (radio_podcast_spend/nullif(total_spend,0)) as radio_podcast_spend_per,
--       (influencers_spend/nullif(total_spend,0)) as influencers_spend_per,
--       (affiliate_spend/nullif(total_spend,0)) as affiliate_spend_per,
--       (physical_partnerships_spend/nullif(total_spend,0)) as physical_partnerships_spend_per,
--       (tiktok_spend/nullif(total_spend,0)) as tiktok_spend_per,
--       (reddit_spend/nullif(total_spend,0)) as reddit_spend_per,
--       (twitter_spend/nullif(total_spend,0)) as twitter_spend_per,
--       first_guest_product_margin_pre_return,
--       bop_vips,
--       total_cancels_on_date,
--       activating_acquisition_margin,
--       product_order_count,
--       currency as currency,
--       source as source,
--       'FLEU - Local' as version
--from _final_output
--where store_name ilike '%fabletics%'
--    and (sequence = 4 or sequence >= 24)
--    and currency = 'Local';

insert into _total_cac
select * from _report_versions
where version != 'No Report Reference';

------------------------------------------------------------------------------------

-- include RR LM
insert into _total_cac (
select rr.sequence,
       rr.store_name,
       rr.store_abbreviation,
       rr.date,
       1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
       1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
       1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
       1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
       1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
       1.00*(rr.vips_from_leads_30m-b.vips_from_leads_30m)/nullif(b.vips_from_leads_30m,0) as vips_from_leads_30m,
       1.00*(rr.vips_from_leads_30m_cac-b.vips_from_leads_30m_cac)/nullif(b.vips_from_leads_30m_cac,0) as vips_from_leads_30m_cac,
       1.00*(rr.vips_from_leads_1d-b.vips_from_leads_1d)/nullif(b.vips_from_leads_1d,0) as vips_from_leads_1d,
       1.00*(rr.vips_from_leads_1d_cac-b.vips_from_leads_1d_cac)/nullif(b.vips_from_leads_1d_cac,0) as vips_from_leads_1d_cac,
       1.00*(rr.vips_from_leads_7d-b.vips_from_leads_7d)/nullif(b.vips_from_leads_7d,0) as vips_from_leads_7d,
       1.00*(rr.vips_from_leads_24h-b.vips_from_leads_24h)/nullif(b.vips_from_leads_24h,0) as vips_from_leads_24h,
       1.00*(rr.vips_from_leads_24h_cac-b.vips_from_leads_24h_cac)/nullif(b.vips_from_leads_24h_cac,0) as vips_from_leads_24h_cac,
       1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0) as vips_from_leads_m1,
       1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
       1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0) as vips_on_date_m1,
       1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
       1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
       1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
       1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
       1.00*(rr.vips_on_date_d1-b.vips_on_date_d1)/nullif(b.vips_on_date_d1,0) as vips_on_date_d1,
       1.00*(rr.vips_on_date_d2_d7-b.vips_on_date_d2_d7)/nullif(b.vips_on_date_d2_d7,0) as vips_on_date_d2_d7,
       1.00*(rr.vips_on_date_d1_d7-b.vips_on_date_d1_d7)/nullif(b.vips_on_date_d1_d7,0) as vips_on_date_d1_d7,
       1.00*(rr.vips_on_date_d8_d90-b.vips_on_date_d8_d90)/nullif(b.vips_on_date_d8_d90,0) as vips_on_date_d8_d90,
       1.00*(rr.vips_on_date_d90plus-b.vips_on_date_d90plus)/nullif(b.vips_on_date_d90plus,0) as vips_on_date_d90plus,
       1.00*(rr.reactivated_vips-b.reactivated_vips)/nullif(b.reactivated_vips,0) as reactivated_vips,
       1.00*(rr.reactivated_vips_per-b.reactivated_vips_per)/nullif(b.reactivated_vips_per,0) as reactivated_vips_per,
       1.00*(rr.retail_vips-b.retail_vips)/nullif(b.retail_vips,0) as retail_vips,
       1.00*(rr.varsity_vips-b.varsity_vips)/nullif(b.varsity_vips,0) as varsity_vips,
       1.00*(rr.vips_from_reactivated_leads_d1-b.vips_from_reactivated_leads_d1)/nullif(b.vips_from_reactivated_leads_d1,0) as vips_from_reactivated_leads_d1,
       1.00*(rr.vips_on_date_d1_excluding_reactivated_leads-b.vips_on_date_d1_excluding_reactivated_leads)/nullif(b.vips_on_date_d1_excluding_reactivated_leads,0) as vips_on_date_d1_excluding_reactivated_leads,
       1.00*(rr.vips_on_date_d1_reactivated_leads-b.vips_on_date_d1_reactivated_leads)/nullif(b.vips_on_date_d1_reactivated_leads,0) as vips_on_date_d1_reactivated_leads,
       1.00*(rr.vips_on_date_m1_reactivated_leads-b.vips_on_date_m1_reactivated_leads)/nullif(b.vips_on_date_m1_reactivated_leads,0) as vips_on_date_m1_reactivated_leads,
       1.00*(rr.reactivated_leads-b.reactivated_leads)/nullif(b.reactivated_leads,0) as reactivated_leads,
       1.00*(rr.retail_leads-b.retail_leads)/nullif(b.retail_leads,0) as retail_leads,
       1.00*(rr.cancels_on_date-b.cancels_on_date)/nullif(b.cancels_on_date,0) as cancels_on_date,
       1.00*(rr.passive_cancels_on_date-b.passive_cancels_on_date)/nullif(b.passive_cancels_on_date,0) as passive_cancels_on_date,
       1.00*(rr.vips_from_leads_30m_per-b.vips_from_leads_30m_per)/nullif(b.vips_from_leads_30m_per,0) as vips_from_leads_30m_per,
       1.00*(rr.vips_from_leads_24h_per-b.vips_from_leads_24h_per)/nullif(b.vips_from_leads_24h_per,0) as vips_from_leads_24h_per,
       1.00*(rr.vips_from_leads_m1_per-b.vips_from_leads_m1_per)/nullif(b.vips_from_leads_m1_per,0) as vips_from_leads_m1_per,
       1.00*(rr.vips_from_reactivated_leads_24h_per-b.vips_from_reactivated_leads_24h_per)/nullif(b.vips_from_reactivated_leads_24h_per,0) as vips_from_reactivated_leads_24h_per,
       1.00*(rr.d1_vips_per-b.d1_vips_per)/nullif(b.d1_vips_per,0) as d1_vips_per,
       1.00*(rr.d1_vips_excluding_reactivated_leads_per-b.d1_vips_excluding_reactivated_leads_per)/nullif(b.d1_vips_excluding_reactivated_leads_per,0) as d1_vips_excluding_reactivated_leads_per,
       1.00*(rr.d1_vips_reactivated_leads_per-b.d1_vips_reactivated_leads_per)/nullif(b.d1_vips_reactivated_leads_per,0) as d1_vips_reactivated_leads_per,
       1.00*(rr.d2_d7_vips_per-b.d2_d7_vips_per)/nullif(b.d2_d7_vips_per,0) as d2_d7_vips_per,
       1.00*(rr.d1_d7_vips_per-b.d1_d7_vips_per)/nullif(b.d1_d7_vips_per,0) as d1_d7_vips_per,
       1.00*(rr.d8_d90_vips_per-b.d8_d90_vips_per)/nullif(b.d8_d90_vips_per,0) as d8_d90_vips_per,
       1.00*(rr.d90plus_vips_per-b.d90plus_vips_per)/nullif(b.d90plus_vips_per,0) as d90plus_vips_per,
       1.00*(rr.reactivated_leads_per-b.reactivated_leads_per)/nullif(b.reactivated_leads_per,0) as reactivated_leads_per,
       1.00*(rr.prospecting_spend-b.prospecting_spend)/nullif(b.prospecting_spend,0) as prospecting_spend,
       1.00*(rr.facebook_spend-b.facebook_spend)/nullif(b.facebook_spend,0) as facebook_spend,
       1.00*(rr.snapchat_spend-b.snapchat_spend)/nullif(b.snapchat_spend,0) as snapchat_spend,
       1.00*(rr.pinterest_spend-b.pinterest_spend)/nullif(b.pinterest_spend,0) as pinterest_spend,
       1.00*(rr.applovin_spend-b.applovin_spend)/nullif(b.applovin_spend,0) as applovin_spend,
       1.00*(rr.linkedin_spend-b.linkedin_spend)/nullif(b.linkedin_spend,0) as linkedin_spend,
       1.00*(rr.nift_spend-b.nift_spend)/nullif(b.nift_spend,0) as nift_spend,
       1.00*(rr.rokt_spend-b.rokt_spend)/nullif(b.rokt_spend,0) as rokt_spend,
       1.00*(rr.twitch_spend-b.twitch_spend)/nullif(b.twitch_spend,0) as twitch_spend,
       1.00*(rr.google_other_spend-b.google_other_spend)/nullif(b.google_other_spend,0) as google_other_spend,
       1.00*(rr.ooh_spend-b.ooh_spend)/nullif(b.ooh_spend,0) as ooh_spend,
       1.00*(rr.celebrity_spend-b.celebrity_spend)/nullif(b.celebrity_spend,0) as celebrity_spend,
       1.00*(rr.non_branded_search_spend-b.non_branded_search_spend)/nullif(b.non_branded_search_spend,0) as non_branded_search_spend,
       1.00*(rr.branded_search_spend-b.branded_search_spend)/nullif(b.branded_search_spend,0) as branded_search_spend,
       1.00*(rr.shopping_spend-b.shopping_spend)/nullif(b.shopping_spend,0) as shopping_spend,
       1.00*(rr.programmatic_spend-b.programmatic_spend)/nullif(b.programmatic_spend,0) as programmatic_spend,
       1.00*(rr.youtube_spend-b.youtube_spend)/nullif(b.youtube_spend,0) as youtube_spend,
       1.00*(rr.tv_and_streaming_spend-b.tv_and_streaming_spend)/nullif(b.tv_and_streaming_spend,0) as tv_and_streaming_spend,
       1.00*(rr.testing_spend-b.testing_spend)/nullif(b.testing_spend,0) as testing_spend,
       1.00*(rr.print_spend-b.print_spend)/nullif(b.print_spend,0) as print_spend,
       1.00*(rr.radio_podcast_spend-b.radio_podcast_spend)/nullif(b.radio_podcast_spend,0) as radio_podcast_spend,
       1.00*(rr.influencers_spend-b.influencers_spend)/nullif(b.influencers_spend,0) as influencers_spend,
       1.00*(rr.affiliate_spend-b.affiliate_spend)/nullif(b.affiliate_spend,0) as affiliate_spend,
       1.00*(rr.physical_partnerships_spend-b.physical_partnerships_spend)/nullif(b.physical_partnerships_spend,0) as physical_partnerships_spend,
       1.00*(rr.tiktok_spend-b.tiktok_spend)/nullif(b.tiktok_spend,0) as tiktok_spend,
       1.00*(rr.reddit_spend-b.reddit_spend)/nullif(b.reddit_spend,0) as reddit_spend,
       1.00*(rr.twitter_spend-b.twitter_spend)/nullif(b.twitter_spend,0) as twitter_spend,
       1.00*(rr.prospecting_spend_per-b.prospecting_spend_per)/nullif(b.prospecting_spend_per,0) as prospecting_spend_per,
       1.00*(rr.facebook_spend_per-b.facebook_spend_per)/nullif(b.facebook_spend_per,0) as facebook_spend_per,
       1.00*(rr.snapchat_spend_per-b.snapchat_spend_per)/nullif(b.snapchat_spend_per,0) as snapchat_spend_per,
       1.00*(rr.pinterest_spend_per-b.pinterest_spend_per)/nullif(b.pinterest_spend_per,0) as pinterest_spend_per,
       1.00*(rr.applovin_spend_per-b.applovin_spend_per)/nullif(b.applovin_spend_per,0) as applovin_spend_per,
       1.00*(rr.linkedin_spend_per-b.linkedin_spend_per)/nullif(b.linkedin_spend_per,0) as linkedin_spend_per,
       1.00*(rr.nift_spend_per-b.nift_spend_per)/nullif(b.nift_spend_per,0) as nift_spend_per,
       1.00*(rr.rokt_spend_per-b.rokt_spend_per)/nullif(b.rokt_spend_per,0) as rokt_spend_per,
       1.00*(rr.twitch_spend_per-b.twitch_spend_per)/nullif(b.twitch_spend_per,0) as twitch_spend_per,
       1.00*(rr.google_other_spend_per-b.google_other_spend_per)/nullif(b.google_other_spend_per,0) as google_other_spend_per,
       1.00*(rr.ooh_spend_per-b.ooh_spend_per)/nullif(b.ooh_spend_per,0) as ooh_spend_per,
       1.00*(rr.celebrity_spend_per-b.celebrity_spend_per)/nullif(b.celebrity_spend_per,0) as celebrity_spend_per,
       1.00*(rr.non_branded_search_spend_per-b.non_branded_search_spend_per)/nullif(b.non_branded_search_spend_per,0) as non_branded_search_spend_per,
       1.00*(rr.branded_search_spend_per-b.branded_search_spend_per)/nullif(b.branded_search_spend_per,0) as branded_search_spend_per,
       1.00*(rr.shopping_spend_per-b.shopping_spend_per)/nullif(b.shopping_spend_per,0) as shopping_spend_per,
       1.00*(rr.programmatic_spend_per-b.programmatic_spend_per)/nullif(b.programmatic_spend_per,0) as programmatic_spend_per,
       1.00*(rr.youtube_spend_per-b.youtube_spend_per)/nullif(b.youtube_spend_per,0) as youtube_spend_per,
       1.00*(rr.tv_and_streaming_spend_per-b.tv_and_streaming_spend_per)/nullif(b.tv_and_streaming_spend_per,0) as tv_and_streaming_spend_per,
       1.00*(rr.testing_spend_per-b.testing_spend_per)/nullif(b.testing_spend_per,0) as testing_spend_per,
       1.00*(rr.print_spend_per-b.print_spend_per)/nullif(b.print_spend_per,0) as print_spend_per,
       1.00*(rr.radio_podcast_spend_per-b.radio_podcast_spend_per)/nullif(b.radio_podcast_spend_per,0) as radio_podcast_spend_per,
       1.00*(rr.influencers_spend_per-b.influencers_spend_per)/nullif(b.influencers_spend_per,0) as influencers_spend_per,
       1.00*(rr.affiliate_spend_per-b.affiliate_spend_per)/nullif(b.affiliate_spend_per,0) as affiliate_spend_per,
       1.00*(rr.physical_partnerships_spend_per-b.physical_partnerships_spend_per)/nullif(b.physical_partnerships_spend_per,0) as physical_partnerships_spend_per,
       1.00*(rr.tiktok_spend_per-b.tiktok_spend_per)/nullif(b.tiktok_spend_per,0) as tiktok_spend_per,
       1.00*(rr.reddit_spend_per-b.reddit_spend_per)/nullif(b.reddit_spend_per,0) as reddit_spend_per,
       1.00*(rr.twitter_spend_per-b.twitter_spend_per)/nullif(b.twitter_spend_per,0) as twitter_spend_per,
       1.00*(rr.first_guest_product_margin_pre_return-b.first_guest_product_margin_pre_return)/nullif(b.first_guest_product_margin_pre_return,0) as first_guest_product_margin_pre_return,
       1.00*(rr.bop_vips-b.bop_vips)/nullif(b.bop_vips,0) as bop_vips,
       1.00*(rr.total_cancels_on_date-b.total_cancels_on_date)/nullif(b.total_cancels_on_date,0) as total_cancels_on_date,
       1.00*(rr.activating_acquisition_margin-b.activating_acquisition_margin)/nullif(b.activating_acquisition_margin,0) as activating_acquisition_margin,
       1.00*(rr.product_order_count-b.product_order_count)/nullif(b.product_order_count,0) as product_order_count,
       rr.currency,
       'RRLM' as source,
       rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
                     and rr.currency = b.currency
                     and rr.version = b.version
                     and b.source = 'DailyLMTotal'
where rr.source = 'RR');


-- include run rate LY
insert into _total_cac (
select rr.sequence,
       rr.store_name,
       rr.store_abbreviation,
       rr.date,
       1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
       1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
       1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
       1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
       1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
       1.00*(rr.vips_from_leads_30m-b.vips_from_leads_30m)/nullif(b.vips_from_leads_30m,0) as vips_from_leads_30m,
       1.00*(rr.vips_from_leads_30m_cac-b.vips_from_leads_30m_cac)/nullif(b.vips_from_leads_30m_cac,0) as vips_from_leads_30m_cac,
       1.00*(rr.vips_from_leads_1d-b.vips_from_leads_1d)/nullif(b.vips_from_leads_1d,0) as vips_from_leads_1d,
       1.00*(rr.vips_from_leads_1d_cac-b.vips_from_leads_1d_cac)/nullif(b.vips_from_leads_1d_cac,0) as vips_from_leads_1d_cac,
       1.00*(rr.vips_from_leads_7d-b.vips_from_leads_7d)/nullif(b.vips_from_leads_7d,0) as vips_from_leads_7d,
       1.00*(rr.vips_from_leads_24h-b.vips_from_leads_24h)/nullif(b.vips_from_leads_24h,0) as vips_from_leads_24h,
       1.00*(rr.vips_from_leads_24h_cac-b.vips_from_leads_24h_cac)/nullif(b.vips_from_leads_24h_cac,0) as vips_from_leads_24h_cac,
       1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0) as vips_from_leads_m1,
       1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
       1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0) as vips_on_date_m1,
       1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
       1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
       1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
       1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
       1.00*(rr.vips_on_date_d1-b.vips_on_date_d1)/nullif(b.vips_on_date_d1,0) as vips_on_date_d1,
       1.00*(rr.vips_on_date_d2_d7-b.vips_on_date_d2_d7)/nullif(b.vips_on_date_d2_d7,0) as vips_on_date_d2_d7,
       1.00*(rr.vips_on_date_d1_d7-b.vips_on_date_d1_d7)/nullif(b.vips_on_date_d1_d7,0) as vips_on_date_d1_d7,
       1.00*(rr.vips_on_date_d8_d90-b.vips_on_date_d8_d90)/nullif(b.vips_on_date_d8_d90,0) as vips_on_date_d8_d90,
       1.00*(rr.vips_on_date_d90plus-b.vips_on_date_d90plus)/nullif(b.vips_on_date_d90plus,0) as vips_on_date_d90plus,
       1.00*(rr.reactivated_vips-b.reactivated_vips)/nullif(b.reactivated_vips,0) as reactivated_vips,
       1.00*(rr.reactivated_vips_per-b.reactivated_vips_per)/nullif(b.reactivated_vips_per,0) as reactivated_vips_per,
       1.00*(rr.retail_vips-b.retail_vips)/nullif(b.retail_vips,0) as retail_vips,
       1.00*(rr.varsity_vips-b.varsity_vips)/nullif(b.varsity_vips,0) as varsity_vips,
       1.00*(rr.vips_from_reactivated_leads_d1-b.vips_from_reactivated_leads_d1)/nullif(b.vips_from_reactivated_leads_d1,0) as vips_from_reactivated_leads_d1,
       1.00*(rr.vips_on_date_d1_excluding_reactivated_leads-b.vips_on_date_d1_excluding_reactivated_leads)/nullif(b.vips_on_date_d1_excluding_reactivated_leads,0) as vips_on_date_d1_excluding_reactivated_leads,
       1.00*(rr.vips_on_date_d1_reactivated_leads-b.vips_on_date_d1_reactivated_leads)/nullif(b.vips_on_date_d1_reactivated_leads,0) as vips_on_date_d1_reactivated_leads,
       1.00*(rr.vips_on_date_m1_reactivated_leads-b.vips_on_date_m1_reactivated_leads)/nullif(b.vips_on_date_m1_reactivated_leads,0) as vips_on_date_m1_reactivated_leads,
       1.00*(rr.reactivated_leads-b.reactivated_leads)/nullif(b.reactivated_leads,0) as reactivated_leads,
       1.00*(rr.retail_leads-b.retail_leads)/nullif(b.retail_leads,0) as retail_leads,
       1.00*(rr.cancels_on_date-b.cancels_on_date)/nullif(b.cancels_on_date,0) as cancels_on_date,
       1.00*(rr.passive_cancels_on_date-b.passive_cancels_on_date)/nullif(b.passive_cancels_on_date,0) as passive_cancels_on_date,
       1.00*(rr.vips_from_leads_30m_per-b.vips_from_leads_30m_per)/nullif(b.vips_from_leads_30m_per,0) as vips_from_leads_30m_per,
       1.00*(rr.vips_from_leads_24h_per-b.vips_from_leads_24h_per)/nullif(b.vips_from_leads_24h_per,0) as vips_from_leads_24h_per,
       1.00*(rr.vips_from_leads_m1_per-b.vips_from_leads_m1_per)/nullif(b.vips_from_leads_m1_per,0) as vips_from_leads_m1_per,
       1.00*(rr.vips_from_reactivated_leads_24h_per-b.vips_from_reactivated_leads_24h_per)/nullif(b.vips_from_reactivated_leads_24h_per,0) as vips_from_reactivated_leads_24h_per,
       1.00*(rr.d1_vips_per-b.d1_vips_per)/nullif(b.d1_vips_per,0) as d1_vips_per,
       1.00*(rr.d1_vips_excluding_reactivated_leads_per-b.d1_vips_excluding_reactivated_leads_per)/nullif(b.d1_vips_excluding_reactivated_leads_per,0) as d1_vips_excluding_reactivated_leads_per,
       1.00*(rr.d1_vips_reactivated_leads_per-b.d1_vips_reactivated_leads_per)/nullif(b.d1_vips_reactivated_leads_per,0) as d1_vips_reactivated_leads_per,
       1.00*(rr.d2_d7_vips_per-b.d2_d7_vips_per)/nullif(b.d2_d7_vips_per,0) as d2_d7_vips_per,
       1.00*(rr.d1_d7_vips_per-b.d1_d7_vips_per)/nullif(b.d1_d7_vips_per,0) as d1_d7_vips_per,
       1.00*(rr.d8_d90_vips_per-b.d8_d90_vips_per)/nullif(b.d8_d90_vips_per,0) as d8_d90_vips_per,
       1.00*(rr.d90plus_vips_per-b.d90plus_vips_per)/nullif(b.d90plus_vips_per,0) as d90plus_vips_per,
       1.00*(rr.reactivated_leads_per-b.reactivated_leads_per)/nullif(b.reactivated_leads_per,0) as reactivated_leads_per,
       1.00*(rr.prospecting_spend-b.prospecting_spend)/nullif(b.prospecting_spend,0) as prospecting_spend,
       1.00*(rr.facebook_spend-b.facebook_spend)/nullif(b.facebook_spend,0) as facebook_spend,
       1.00*(rr.snapchat_spend-b.snapchat_spend)/nullif(b.snapchat_spend,0) as snapchat_spend,
       1.00*(rr.pinterest_spend-b.pinterest_spend)/nullif(b.pinterest_spend,0) as pinterest_spend,
       1.00*(rr.applovin_spend-b.applovin_spend)/nullif(b.applovin_spend,0) as applovin_spend,
       1.00*(rr.linkedin_spend-b.linkedin_spend)/nullif(b.linkedin_spend,0) as linkedin_spend,
       1.00*(rr.nift_spend-b.nift_spend)/nullif(b.nift_spend,0) as nift_spend,
       1.00*(rr.rokt_spend-b.rokt_spend)/nullif(b.rokt_spend,0) as rokt_spend,
       1.00*(rr.twitch_spend-b.twitch_spend)/nullif(b.twitch_spend,0) as twitch_spend,
       1.00*(rr.google_other_spend-b.google_other_spend)/nullif(b.google_other_spend,0) as google_other_spend,
       1.00*(rr.ooh_spend-b.ooh_spend)/nullif(b.ooh_spend,0) as ooh_spend,
       1.00*(rr.celebrity_spend-b.celebrity_spend)/nullif(b.celebrity_spend,0) as celebrity_spend,
       1.00*(rr.non_branded_search_spend-b.non_branded_search_spend)/nullif(b.non_branded_search_spend,0) as non_branded_search_spend,
       1.00*(rr.branded_search_spend-b.branded_search_spend)/nullif(b.branded_search_spend,0) as branded_search_spend,
       1.00*(rr.shopping_spend-b.shopping_spend)/nullif(b.shopping_spend,0) as shopping_spend,
       1.00*(rr.programmatic_spend-b.programmatic_spend)/nullif(b.programmatic_spend,0) as programmatic_spend,
       1.00*(rr.youtube_spend-b.youtube_spend)/nullif(b.youtube_spend,0) as youtube_spend,
       1.00*(rr.tv_and_streaming_spend-b.tv_and_streaming_spend)/nullif(b.tv_and_streaming_spend,0) as tv_and_streaming_spend,
       1.00*(rr.testing_spend-b.testing_spend)/nullif(b.testing_spend,0) as testing_spend,
       1.00*(rr.print_spend-b.print_spend)/nullif(b.print_spend,0) as print_spend,
       1.00*(rr.radio_podcast_spend-b.radio_podcast_spend)/nullif(b.radio_podcast_spend,0) as radio_podcast_spend,
       1.00*(rr.influencers_spend-b.influencers_spend)/nullif(b.influencers_spend,0) as influencers_spend,
       1.00*(rr.affiliate_spend-b.affiliate_spend)/nullif(b.affiliate_spend,0) as affiliate_spend,
       1.00*(rr.physical_partnerships_spend-b.physical_partnerships_spend)/nullif(b.physical_partnerships_spend,0) as physical_partnerships_spend,
       1.00*(rr.tiktok_spend-b.tiktok_spend)/nullif(b.tiktok_spend,0) as tiktok_spend,
       1.00*(rr.reddit_spend-b.reddit_spend)/nullif(b.reddit_spend,0) as reddit_spend,
       1.00*(rr.twitter_spend-b.twitter_spend)/nullif(b.twitter_spend,0) as twitter_spend,
       1.00*(rr.prospecting_spend_per-b.prospecting_spend_per)/nullif(b.prospecting_spend_per,0) as prospecting_spend_per,
       1.00*(rr.facebook_spend_per-b.facebook_spend_per)/nullif(b.facebook_spend_per,0) as facebook_spend_per,
       1.00*(rr.snapchat_spend_per-b.snapchat_spend_per)/nullif(b.snapchat_spend_per,0) as snapchat_spend_per,
       1.00*(rr.pinterest_spend_per-b.pinterest_spend_per)/nullif(b.pinterest_spend_per,0) as pinterest_spend_per,
       1.00*(rr.applovin_spend_per-b.applovin_spend_per)/nullif(b.applovin_spend_per,0) as applovin_spend_per,
       1.00*(rr.linkedin_spend_per-b.linkedin_spend_per)/nullif(b.linkedin_spend_per,0) as linkedin_spend_per,
       1.00*(rr.nift_spend_per-b.nift_spend_per)/nullif(b.nift_spend_per,0) as nift_spend_per,
       1.00*(rr.rokt_spend_per-b.rokt_spend_per)/nullif(b.rokt_spend_per,0) as rokt_spend_per,
       1.00*(rr.twitch_spend_per-b.twitch_spend_per)/nullif(b.twitch_spend_per,0) as twitch_spend_per,
       1.00*(rr.google_other_spend_per-b.google_other_spend_per)/nullif(b.google_other_spend_per,0) as google_other_spend_per,
       1.00*(rr.ooh_spend_per-b.ooh_spend_per)/nullif(b.ooh_spend_per,0) as ooh_spend_per,
       1.00*(rr.celebrity_spend_per-b.celebrity_spend_per)/nullif(b.celebrity_spend_per,0) as celebrity_spend_per,
       1.00*(rr.non_branded_search_spend_per-b.non_branded_search_spend_per)/nullif(b.non_branded_search_spend_per,0) as non_branded_search_spend_per,
       1.00*(rr.branded_search_spend_per-b.branded_search_spend_per)/nullif(b.branded_search_spend_per,0) as branded_search_spend_per,
       1.00*(rr.shopping_spend_per-b.shopping_spend_per)/nullif(b.shopping_spend_per,0) as shopping_spend_per,
       1.00*(rr.programmatic_spend_per-b.programmatic_spend_per)/nullif(b.programmatic_spend_per,0) as programmatic_spend_per,
       1.00*(rr.youtube_spend_per-b.youtube_spend_per)/nullif(b.youtube_spend_per,0) as youtube_spend_per,
       1.00*(rr.tv_and_streaming_spend_per-b.tv_and_streaming_spend_per)/nullif(b.tv_and_streaming_spend_per,0) as tv_and_streaming_spend_per,
       1.00*(rr.testing_spend_per-b.testing_spend_per)/nullif(b.testing_spend_per,0) as testing_spend_per,
       1.00*(rr.print_spend_per-b.print_spend_per)/nullif(b.print_spend_per,0) as print_spend_per,
       1.00*(rr.radio_podcast_spend_per-b.radio_podcast_spend_per)/nullif(b.radio_podcast_spend_per,0) as radio_podcast_spend_per,
       1.00*(rr.influencers_spend_per-b.influencers_spend_per)/nullif(b.influencers_spend_per,0) as influencers_spend_per,
       1.00*(rr.affiliate_spend_per-b.affiliate_spend_per)/nullif(b.affiliate_spend_per,0) as affiliate_spend_per,
       1.00*(rr.physical_partnerships_spend_per-b.physical_partnerships_spend_per)/nullif(b.physical_partnerships_spend_per,0) as physical_partnerships_spend_per,
       1.00*(rr.tiktok_spend_per-b.tiktok_spend_per)/nullif(b.tiktok_spend_per,0) as tiktok_spend_per,
       1.00*(rr.reddit_spend_per-b.reddit_spend_per)/nullif(b.reddit_spend_per,0) as reddit_spend_per,
       1.00*(rr.twitter_spend_per-b.twitter_spend_per)/nullif(b.twitter_spend_per,0) as twitter_spend_per,
       1.00*(rr.first_guest_product_margin_pre_return-b.first_guest_product_margin_pre_return)/nullif(b.first_guest_product_margin_pre_return,0) as first_guest_product_margin_pre_return,
       1.00*(rr.bop_vips-b.bop_vips)/nullif(b.bop_vips,0) as bop_vips,
       1.00*(rr.total_cancels_on_date-b.total_cancels_on_date)/nullif(b.total_cancels_on_date,0) as total_cancels_on_date,
       1.00*(rr.activating_acquisition_margin-b.activating_acquisition_margin)/nullif(b.activating_acquisition_margin,0) as activating_acquisition_margin,
       1.00*(rr.product_order_count-b.product_order_count)/nullif(b.product_order_count,0) as product_order_count,
       rr.currency,
       'RRLY' as source,
       rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
    and rr.currency = b.currency
    and rr.version = b.version
    and b.source = 'DailyLYTotal'
where rr.source = 'RR');

------------------------------------------------------------------------------------

create or replace temporary table _budget_targets as
select store_tab_abbreviation,
       date,
       currency,
       source,
       media_spend,
       leads,
       cpl,
       vips_from_leads_m1,
       m1_vip_cac,
       total_vips_on_date,
       total_vip_cac,
       bop_vips,
       total_cancels_on_date
from reporting_media_prod.attribution.acquisition_budget_targets_cac;


update _total_cac t
set media_spend = b.media_spend,
    primary_leads = b.leads,
    cpl = b.cpl,
    vips_from_leads_m1 = b.vips_from_leads_m1,
    vips_from_leads_m1_cac = b.m1_vip_cac,
    total_vips_on_date = b.total_vips_on_date,
    bop_vips = b.bop_vips,
    total_cancels_on_date = b.total_cancels_on_date,
    total_vips_on_date_cac = b.total_vip_cac
from _budget_targets b
where lower(t.store_abbreviation) = lower(b.store_tab_abbreviation)
    and t.date = b.date
    and lower(t.currency) = lower(b.currency)
    and lower(t.source) = lower(b.source);


------------------------------------------------------------------------------------
-- run rate budget targets

insert into _total_cac (
select
  rr.sequence,
  rr.store_name,
  rr.store_abbreviation,
  rr.date,
  1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
  1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
  1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
  1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
  1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
  null as vips_from_leads_30m,
  null as vips_from_leads_30m_cac,
  null as vips_from_leads_1d,
  null as vips_from_leads_1d_cac,
  null as vips_from_leads_7d,
  null as vips_from_leads_24h,
  null as vips_from_leads_24h_cac,
  1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0) as vips_from_leads_m1,
  1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
  1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0) as vips_on_date_m1,
  1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
  1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
  1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
  1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
  null as vips_on_date_d1,
  null as vips_on_date_d2_d7,
  null as vips_on_date_d1_d7,
  null as vips_on_date_d8_d90,
  null as vips_on_date_d90plus,
  null as reactivated_vips,
  null as reactivated_vips_per,
  null as retail_vips,
  null as varsity_vips,
  null as vips_from_reactivated_leads_d1,
  null as vips_on_date_d1_excluding_reactivated_leads,
  null as vips_on_date_d1_reactivated_leads,
  null as vips_on_date_m1_reactivated_leads,
  null as reactivated_leads,
  null as retail_leads,
  null as cancels_on_date,
  null as passive_cancels_on_date,
  null as vips_from_leads_30m_per,
  null as vips_from_leads_24h_per,
  null as vips_from_leads_m1_per,
  null as vips_from_reactivated_leads_24h_per,
  null as d1_vips_per,
  null as d1_vips_excluding_reactivated_leads_per,
  null as d1_vips_reactivated_leads_per,
  null as d2_d7_vips_per,
  null as d1_d7_vips_per,
  null as d8_d90_vips_per,
  null as d90plus_vips_per,
  null as reactivated_leads_per,
  null as prospecting_spend,
  null as facebook_spend,
  null as snapchat_spend,
  null as pinterest_spend,
  null as applovin_spend,
  null as linkedin_spend,
  null as nift_spend,
  null as rokt_spend,
  null as twitch_spend,
  null as google_other_spend,
  null as ooh_spend,
  null as celebrity_spend,
  null as non_branded_search_spend,
  null as branded_search_spend,
  null as shopping_spend,
  null as programmatic_spend,
  null as youtube_spend,
  null as tv_and_streaming_spend,
  null as testing_spend,
  null as print_spend,
  null as radio_podcast_spend,
  null as influencers_spend,
  null as affiliate_spend,
  null as physical_partnerships_spend,
  null as tiktok_spend,
  null as reddit_spend,
  null as twitter_spend,
  null as prospecting_spend_per,
  null as facebook_spend_per,
  null as snapchat_spend_per,
  null as pinterest_spend_per,
  null as applovin_spend_per,
  null as linkedin_spend_per,
  null as nift_spend_per,
  null as rokt_spend_per,
  null as twitch_spend_per,
  null as google_other_spend_per,
  null as ooh_spend_per,
  null as celebrity_spend_per,
  null as non_branded_search_spend_per,
  null as branded_search_spend_per,
  null as shopping_spend_per,
  null as programmatic_spend_per,
  null as youtube_spend_per,
  null as tv_and_streaming_spend_per,
  null as testing_spend_per,
  null as print_spend_per,
  null as radio_podcast_spend_per,
  null as influencers_spend_per,
  null as affiliate_spend_per,
  null as physical_partnerships_spend_per,
  null as tiktok_spend_per,
  null as reddit_spend_per,
  null as twitter_spend_per,
  null as first_guest_product_margin_pre_return,
  null as bop_vips,
  null as total_cancels_on_date,
  null as activating_acquisition_margin,
  null as product_order_count,
  rr.currency,
  'RRBudget-BTFX' as source,
  rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
    and rr.date = b.date
    and rr.currency = b.currency
    and rr.version = b.version
    and b.source = 'Budget-BTFX'
where rr.source = 'RR'
    );


insert into _total_cac (
select
    rr.sequence,
        rr.store_name,
        rr.store_abbreviation,
        rr.date,
        1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
        1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
        1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
        1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
        1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
        null as vips_from_leads_30m,
        null as vips_from_leads_30m_cac,
        null as vips_from_leads_1d,
        null as vips_from_leads_1d_cac,
        null as vips_from_leads_7d,
        null as vips_from_leads_24h,
        null as vips_from_leads_24h_cac,
        1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0)as vips_from_leads_m1,
        1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
        1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0)as vips_on_date_m1,
        1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
        1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
        1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
        1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
        null as vips_on_date_d1,
        null as vips_on_date_d2_d7,
        null as vips_on_date_d1_d7,
        null as vips_on_date_d8_d90,
        null as vips_on_date_d90plus,
        null as reactivated_vips,
        null as reactivated_vips_per,
        null as retail_vips,
        null as varsity_vips,
        null as vips_from_reactivated_leads_d1,
        null as vips_on_date_d1_excluding_reactivated_leads,
        null as vips_on_date_d1_reactivated_leads,
        null as vips_on_date_m1_reactivated_leads,
        null as reactivated_leads,
        null as retail_leads,
        null as cancels_on_date,
        null as passive_cancels_on_date,
        null as vips_from_leads_30m_per,
        null as vips_from_leads_24h_per,
        null as vips_from_leads_m1_per,
        null as vips_from_reactivated_leads_24h_per,
        null as d1_vips_per,
        null as d1_vips_excluding_reactivated_leads_per,
        null as d1_vips_reactivated_leads_per,
        null as d2_d7_vips_per,
        null as d1_d7_vips_per,
        null as d8_d90_vips_per,
        null as d90plus_vips_per,
        null as reactivated_leads_per,
        null as prospecting_spend,
        null as facebook_spend,
        null as snapchat_spend,
        null as pinterest_spend,
        null as applovin_spend,
        null as linkedin_spend,
        null as nift_spend,
        null as rokt_spend,
        null as twitch_spend,
        null as google_other_spend,
        null as ooh_spend,
        null as celebrity_spend,
        null as non_branded_search_spend,
        null as branded_search_spend,
        null as shopping_spend,
        null as programmatic_spend,
        null as youtube_spend,
        null as tv_and_streaming_spend,
        null as testing_spend,
        null as print_spend,
        null as radio_podcast_spend,
        null as influencers_spend,
        null as affiliate_spend,
        null as physical_partnerships_spend,
        null as tiktok_spend,
        null as reddit_spend,
        null as twitter_spend,
        null as prospecting_spend_per,
        null as facebook_spend_per,
        null as snapchat_spend_per,
        null as pinterest_spend_per,
        null as applovin_spend_per,
        null as linkedin_spend_per,
        null as nift_spend_per,
        null as rokt_spend_per,
        null as twitch_spend_per,
        null as google_other_spend_per,
        null as ooh_spend_per,
        null as celebrity_spend_per,
        null as non_branded_search_spend_per,
        null as branded_search_spend_per,
        null as shopping_spend_per,
        null as programmatic_spend_per,
        null as youtube_spend_per,
        null as tv_and_streaming_spend_per,
        null as testing_spend_per,
        null as print_spend_per,
        null as radio_podcast_spend_per,
        null as influencers_spend_per,
        null as affiliate_spend_per,
        null as physical_partnerships_spend_per,
        null as tiktok_spend_per,
        null as reddit_spend_per,
        null as twitter_spend_per,
        null as first_guest_product_margin_pre_return,
        null as bop_vips,
		null as total_cancels_on_date,
        null as activating_acquisition_margin,
        null as product_order_count,
        rr.currency,
        'RRBudget-CURRFX' as source,
        rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
    and rr.date = b.date
    and rr.currency = b.currency
    and rr.version = b.version
    and b.source = 'Budget-CURRFX'
where rr.source = 'RR'
    );


insert into _total_cac (
select
    rr.sequence,
    rr.store_name,
    rr.store_abbreviation,
    rr.date,
    1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
    1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
    1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
    1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
    1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
    null as vips_from_leads_30m,
    null as vips_from_leads_30m_cac,
    null as vips_from_leads_1d,
    null as vips_from_leads_1d_cac,
    null as vips_from_leads_7d,
    null as vips_from_leads_24h,
    null as vips_from_leads_24h_cac,
    1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0) as vips_from_leads_m1,
    1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
    1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0) as vips_on_date_m1,
    1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
    1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
    1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
    1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
    null as vips_on_date_d1,
    null as vips_on_date_d2_d7,
    null as vips_on_date_d1_d7,
    null as vips_on_date_d8_d90,
    null as vips_on_date_d90plus,
    null as reactivated_vips,
    null as reactivated_vips_per,
    null as retail_vips,
    null as varsity_vips,
    null as vips_from_reactivated_leads_d1,
    null as vips_on_date_d1_excluding_reactivated_leads,
    null as vips_on_date_d1_reactivated_leads,
    null as vips_on_date_m1_reactivated_leads,
    null as reactivated_leads,
    null as retail_leads,
    null as cancels_on_date,
    null as passive_cancels_on_date,
    null as vips_from_leads_30m_per,
    null as vips_from_leads_24h_per,
    null as vips_from_leads_m1_per,
    null as vips_from_reactivated_leads_24h_per,
    null as d1_vips_per,
    null as d1_vips_excluding_reactivated_leads_per,
    null as d1_vips_reactivated_leads_per,
    null as d2_d7_vips_per,
    null as d1_d7_vips_per,
    null as d8_d90_vips_per,
    null as d90plus_vips_per,
    null as reactivated_leads_per,
    null as prospecting_spend,
    null as facebook_spend,
    null as snapchat_spend,
    null as pinterest_spend,
    null as applovin_spend,
    null as linkedin_spend,
    null as nift_spend,
    null as rokt_spend,
    null as twitch_spend,
    null as google_other_spend,
    null as ooh_spend,
    null as celebrity_spend,
    null as non_branded_search_spend,
    null as branded_search_spend,
    null as shopping_spend,
    null as programmatic_spend,
    null as youtube_spend,
    null as tv_and_streaming_spend,
    null as testing_spend,
    null as print_spend,
    null as radio_podcast_spend,
    null as influencers_spend,
    null as affiliate_spend,
    null as physical_partnerships_spend,
    null as tiktok_spend,
    null as reddit_spend,
    null as twitter_spend,
    null as prospecting_spend_per,
    null as facebook_spend_per,
    null as snapchat_spend_per,
    null as pinterest_spend_per,
    null as applovin_spend_per,
    null as linkedin_spend_per,
    null as nift_spend_per,
    null as rokt_spend_per,
    null as twitch_spend_per,
    null as google_other_spend_per,
    null as ooh_spend_per,
    null as celebrity_spend_per,
    null as non_branded_search_spend_per,
    null as branded_search_spend_per,
    null as shopping_spend_per,
    null as programmatic_spend_per,
    null as youtube_spend_per,
    null as tv_and_streaming_spend_per,
    null as testing_spend_per,
    null as print_spend_per,
    null as radio_podcast_spend_per,
    null as influencers_spend_per,
    null as affiliate_spend_per,
    null as physical_partnerships_spend_per,
    null as tiktok_spend_per,
    null as reddit_spend_per,
    null as twitter_spend_per,
    null as first_guest_product_margin_pre_return,
    null as bop_vips,
	null as total_cancels_on_date,
    null as activating_acquisition_margin,
    null as product_order_count,
    rr.currency,
    'RRForecast-BTFX' as source,
    rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
    and rr.date = b.date
    and rr.currency = b.currency
    and rr.version = b.version
    and b.source = 'Forecast-BTFX'
where rr.source = 'RR'
    );


insert into _total_cac (
select
    rr.sequence,
    rr.store_name,
    rr.store_abbreviation,
    rr.date,
    1.00*(rr.primary_leads-b.primary_leads)/nullif(b.primary_leads,0) as primary_leads,
    1.00*(rr.secondary_leads-b.secondary_leads)/nullif(b.secondary_leads,0) as secondary_leads,
    1.00*(rr.cross_brand_leads_per-b.cross_brand_leads_per)/nullif(b.cross_brand_leads_per,0) as cross_brand_leads_per,
    1.00*(rr.cpl-b.cpl)/nullif(b.cpl,0) as cpl,
    1.00*(rr.media_spend-b.media_spend)/nullif(b.media_spend,0) as media_spend,
    null as vips_from_leads_30m,
    null as vips_from_leads_30m_cac,
    null as vips_from_leads_1d,
    null as vips_from_leads_1d_cac,
    null as vips_from_leads_7d,
    null as vips_from_leads_24h,
    null as vips_from_leads_24h_cac,
    1.00*(rr.vips_from_leads_m1-b.vips_from_leads_m1)/nullif(b.vips_from_leads_m1,0) as vips_from_leads_m1,
    1.00*(rr.vips_from_leads_m1_cac-b.vips_from_leads_m1_cac)/nullif(b.vips_from_leads_m1_cac,0) as vips_from_leads_m1_cac,
    1.00*(rr.vips_on_date_m1-b.vips_on_date_m1)/nullif(b.vips_on_date_m1,0) as vips_on_date_m1,
    1.00*(rr.vips_on_date_m1_cac-b.vips_on_date_m1_cac)/nullif(b.vips_on_date_m1_cac,0) as vips_on_date_m1_cac,
    1.00*(rr.total_vips_from_reactivated_leads-b.total_vips_from_reactivated_leads)/nullif(b.total_vips_from_reactivated_leads,0) as total_vips_from_reactivated_leads,
    1.00*(rr.total_vips_on_date-b.total_vips_on_date)/nullif(b.total_vips_on_date,0) as total_vips_on_date,
    1.00*(rr.total_vips_on_date_cac-b.total_vips_on_date_cac)/nullif(b.total_vips_on_date_cac,0) as total_vips_on_date_cac,
    null as vips_on_date_d1,
    null as vips_on_date_d2_d7,
    null as vips_on_date_d1_d7,
    null as vips_on_date_d8_d90,
    null as vips_on_date_d90plus,
    null as reactivated_vips,
    null as reactivated_vips_per,
    null as retail_vips,
    null as varsity_vips,
    null as vips_from_reactivated_leads_d1,
    null as vips_on_date_d1_excluding_reactivated_leads,
    null as vips_on_date_d1_reactivated_leads,
    null as vips_on_date_m1_reactivated_leads,
    null as reactivated_leads,
    null as retail_leads,
    null as cancels_on_date,
    null as passive_cancels_on_date,
    null as vips_from_leads_30m_per,
    null as vips_from_leads_24h_per,
    null as vips_from_leads_m1_per,
    null as vips_from_reactivated_leads_24h_per,
    null as d1_vips_per,
    null as d1_vips_excluding_reactivated_leads_per,
    null as d1_vips_reactivated_leads_per,
    null as d2_d7_vips_per,
    null as d1_d7_vips_per,
    null as d8_d90_vips_per,
    null as d90plus_vips_per,
    null as reactivated_leads_per,
    null as prospecting_spend,
    null as facebook_spend,
    null as snapchat_spend,
    null as pinterest_spend,
    null as applovin_spend,
    null as linkedin_spend,
    null as nift_spend,
    null as rokt_spend,
    null as twitch_spend,
    null as google_other_spend,
    null as ooh_spend,
    null as celebrity_spend,
    null as non_branded_search_spend,
    null as branded_search_spend,
    null as shopping_spend,
    null as programmatic_spend,
    null as youtube_spend,
    null as tv_and_streaming_spend,
    null as testing_spend,
    null as print_spend,
    null as radio_podcast_spend,
    null as influencers_spend,
    null as affiliate_spend,
    null as physical_partnerships_spend,
    null as tiktok_spend,
    null as reddit_spend,
    null as twitter_spend,
    null as prospecting_spend_per,
    null as facebook_spend_per,
    null as snapchat_spend_per,
    null as pinterest_spend_per,
    null as applovin_spend_per,
    null as linkedin_spend_per,
    null as nift_spend_per,
    null as rokt_spend_per,
    null as twitch_spend_per,
    null as google_other_spend_per,
    null as ooh_spend_per,
    null as celebrity_spend_per,
    null as non_branded_search_spend_per,
    null as branded_search_spend_per,
    null as shopping_spend_per,
    null as programmatic_spend_per,
    null as youtube_spend_per,
    null as tv_and_streaming_spend_per,
    null as testing_spend_per,
    null as print_spend_per,
    null as radio_podcast_spend_per,
    null as influencers_spend_per,
    null as affiliate_spend_per,
    null as physical_partnerships_spend_per,
    null as tiktok_spend_per,
    null as reddit_spend_per,
    null as twitter_spend_per,
    null as first_guest_product_margin_pre_return,
    null as bop_vips,
	null as total_cancels_on_date,
    null as activating_acquisition_margin,
    null as product_order_count,
    rr.currency,
    'RRForecast-CURRFX' as source,
    rr.version
from _total_cac rr
full join _total_cac b on rr.store_name = b.store_name
    and rr.date = b.date
    and rr.currency = b.currency
    and rr.version = b.version
    and b.source = 'Forecast-CURRFX'
where rr.source = 'RR'
    );


---------------------------------- EU versions with metrics in USD currency

insert into _total_cac
select
    sequence,
    store_name,
    store_abbreviation,
    date,
    primary_leads,
    secondary_leads,
    cross_brand_leads_per,
    cpl,
    media_spend,
    vips_from_leads_30m,
    vips_from_leads_30m_cac,
    vips_from_leads_1d,
    vips_from_leads_1d_cac,
    vips_from_leads_7d,
    vips_from_leads_24h,
    vips_from_leads_24h_cac,
    vips_from_leads_m1,
    vips_from_leads_m1_cac,
    vips_on_date_m1,
    vips_on_date_m1_cac,
    total_vips_from_reactivated_leads,
    total_vips_on_date,
    total_vips_on_date_cac,
    vips_on_date_d1,
    vips_on_date_d2_d7,
    vips_on_date_d1_d7,
    vips_on_date_d8_d90,
    vips_on_date_d90plus,
    reactivated_vips,
    reactivated_vips_per,
    retail_vips,
    varsity_vips,
    vips_from_reactivated_leads_d1,
    vips_on_date_d1_excluding_reactivated_leads,
    vips_on_date_d1_reactivated_leads,
    vips_on_date_m1_reactivated_leads,
    reactivated_leads,
    retail_leads,
    cancels_on_date,
    passive_cancels_on_date,
    vips_from_leads_30m_per,
    vips_from_leads_24h_per,
    vips_from_leads_m1_per,
    vips_from_reactivated_leads_24h_per,
    d1_vips_per,
    d1_vips_excluding_reactivated_leads_per,
    d1_vips_reactivated_leads_per,
    d2_d7_vips_per,
    d1_d7_vips_per,
    d8_d90_vips_per,
    d90plus_vips_per,
    reactivated_leads_per,
    prospecting_spend,
    facebook_spend,
    snapchat_spend,
    pinterest_spend,
    applovin_spend,
    linkedin_spend,
    nift_spend,
    rokt_spend,
    twitch_spend,
    google_other_spend,
    ooh_spend,
    celebrity_spend,
    non_branded_search_spend,
    branded_search_spend,
    shopping_spend,
    programmatic_spend,
    youtube_spend,
    tv_and_streaming_spend,
    testing_spend,
    print_spend,
    radio_podcast_spend,
    influencers_spend,
    affiliate_spend,
    physical_partnerships_spend,
    tiktok_spend,
    reddit_spend,
    twitter_spend,
    prospecting_spend_per,
    facebook_spend_per,
    snapchat_spend_per,
    pinterest_spend_per,
    applovin_spend_per,
    linkedin_spend_per,
    nift_spend_per,
    rokt_spend_per,
    twitch_spend_per,
    google_other_spend_per,
    ooh_spend_per,
    celebrity_spend_per,
    non_branded_search_spend_per,
    branded_search_spend_per,
    shopping_spend_per,
    programmatic_spend_per,
    youtube_spend_per,
    tv_and_streaming_spend_per,
    testing_spend_per,
    print_spend_per,
    radio_podcast_spend_per,
    influencers_spend_per,
    affiliate_spend_per,
    physical_partnerships_spend_per,
    tiktok_spend_per,
    reddit_spend_per,
    twitter_spend_per,
    first_guest_product_margin_pre_return,
    bop_vips,
    total_cancels_on_date,
    activating_acquisition_margin,
    product_order_count,
    currency,
    source,
    case when version='SXF GLOBAL - USD' then 'SXEU - USD'
         when version='JFB GLOBAL - USD' then 'JFEU - USD'
         when version in ('FL GLOBAL by Region - USD', 'FL GLOBAL by Country - USD') then 'FLEU - USD'
    end as version
from _total_cac n
where version ilike '%- usd'
    and store_abbreviation in(
        select distinct store_abbreviation
        from _total_cac
        where version ilike '%- local');

------------------------------------------------------------------------------------
-- final output

truncate table reporting_media_prod.attribution.total_cac_output;

delete
from reporting_media_prod.snapshot.total_cac_output
where datetime_added < dateadd(day, -3, current_timestamp());

insert all
into reporting_media_prod.attribution.total_cac_output (
        sequence ,
        store_name ,
        store_abbreviation ,
        date ,
        primary_leads,
        secondary_leads,
        cross_brand_leads_per,
        cpl ,
        media_spend ,
        vips_from_leads_30m ,
        vips_from_leads_30m_cac ,
        vips_from_leads_1d ,
        vips_from_leads_1d_cac ,
        vips_from_leads_7d ,
        vips_from_leads_24h ,
        vips_from_leads_24h_cac ,
        vips_from_leads_m1 ,
        vips_from_leads_m1_cac ,
        vips_on_date_m1 ,
        vips_on_date_m1_cac ,
        total_vips_from_reactivated_leads,
        total_vips_on_date ,
        total_vips_on_date_cac ,
        vips_on_date_d1_d7 ,
        vips_on_date_d8_d90 ,
        vips_on_date_d90plus ,
        reactivated_vips ,
        reactivated_leads,
        retail_leads,
        cancels_on_date,
        passive_cancels_on_date,
        vips_from_leads_30m_per ,
        vips_from_leads_24h_per ,
        vips_from_leads_m1_per ,
        vips_from_reactivated_leads_24h_per ,
        d1_d7_vips_per ,
        d8_d90_vips_per ,
        d90plus_vips_per ,
        reactivated_leads_per ,
        prospecting_spend ,
        facebook_spend ,
        snapchat_spend ,
        pinterest_spend ,
        applovin_spend,
        linkedin_spend,
        nift_spend,
        rokt_spend,
        twitch_spend,
        google_other_spend,
        ooh_spend,
        celebrity_spend,
        non_branded_search_spend ,
        branded_search_spend ,
        shopping_spend ,
        programmatic_spend ,
        youtube_spend ,
        tv_and_streaming_spend ,
        testing_spend ,
        print_spend ,
        radio_podcast_spend ,
        influencers_spend ,
        affiliate_spend ,
        physical_partnerships_spend ,
        tiktok_spend ,
        reddit_spend ,
        twitter_spend ,
        prospecting_spend_per ,
        facebook_spend_per ,
        snapchat_spend_per ,
        pinterest_spend_per ,
        applovin_spend_per,
        linkedin_spend_per,
        nift_spend_per,
        rokt_spend_per,
        twitch_spend_per,
        google_other_spend_per,
        ooh_spend_per,
        celebrity_spend_per,
        non_branded_search_spend_per ,
        branded_search_spend_per ,
        shopping_spend_per ,
        programmatic_spend_per ,
        youtube_spend_per ,
        tv_and_streaming_spend_per ,
        testing_spend_per ,
        print_spend_per ,
        radio_podcast_spend_per ,
        influencers_spend_per ,
        affiliate_spend_per ,
        physical_partnerships_spend_per ,
        tiktok_spend_per ,
        reddit_spend_per ,
        twitter_spend_per ,
        currency ,
        source ,
        version,
        channel_sequence,
        report_month,
        retail_vips ,
        varsity_vips ,
        vips_on_date_d1 ,
        vips_from_reactivated_leads_d1 ,
        vips_on_date_d1_excluding_reactivated_leads ,
        vips_on_date_d1_reactivated_leads ,
        vips_on_date_m1_reactivated_leads ,
        vips_on_date_d2_d7 ,
        d1_vips_per ,
        d1_vips_excluding_reactivated_leads_per,
        d1_vips_reactivated_leads_per,
        d2_d7_vips_per,
        reactivated_vips_per,
        first_guest_product_margin_pre_return,
        bop_vips,
		total_cancels_on_date,
        activating_acquisition_margin,
        product_order_count
    )
    into reporting_media_prod.snapshot.total_cac_output (
        sequence ,
        store_name ,
        store_abbreviation ,
        date ,
        primary_leads,
        secondary_leads,
        cross_brand_leads_per,
        cpl ,
        media_spend ,
        vips_from_leads_30m ,
        vips_from_leads_30m_cac ,
        vips_from_leads_1d ,
        vips_from_leads_1d_cac ,
        vips_from_leads_7d ,
        vips_from_leads_24h ,
        vips_from_leads_24h_cac ,
        vips_from_leads_m1 ,
        vips_from_leads_m1_cac ,
        vips_on_date_m1 ,
        vips_on_date_m1_cac ,
        total_vips_from_reactivated_leads,
        total_vips_on_date ,
        total_vips_on_date_cac ,
        vips_on_date_d1_d7 ,
        vips_on_date_d8_d90 ,
        vips_on_date_d90plus ,
        reactivated_vips ,
        reactivated_leads ,
        retail_leads,
        cancels_on_date ,
        passive_cancels_on_date ,
        vips_from_leads_30m_per ,
        vips_from_leads_24h_per ,
        vips_from_leads_m1_per ,
        vips_from_reactivated_leads_24h_per ,
        d1_d7_vips_per ,
        d8_d90_vips_per ,
        d90plus_vips_per ,
        reactivated_leads_per ,
        prospecting_spend ,
        facebook_spend ,
        snapchat_spend ,
        pinterest_spend ,
        applovin_spend,
        linkedin_spend,
        nift_spend,
        rokt_spend,
        twitch_spend,
        google_other_spend,
        ooh_spend,
        celebrity_spend,
        non_branded_search_spend ,
        branded_search_spend ,
        shopping_spend ,
        programmatic_spend ,
        youtube_spend ,
        tv_and_streaming_spend ,
        testing_spend ,
        print_spend ,
        radio_podcast_spend ,
        influencers_spend ,
        affiliate_spend ,
        physical_partnerships_spend ,
        tiktok_spend ,
        reddit_spend ,
        twitter_spend ,
        prospecting_spend_per ,
        facebook_spend_per ,
        snapchat_spend_per ,
        pinterest_spend_per ,
        applovin_spend_per,
        linkedin_spend_per,
        nift_spend_per,
        rokt_spend_per,
        twitch_spend_per,
        google_other_spend_per,
        ooh_spend_per,
        celebrity_spend_per,
        non_branded_search_spend_per ,
        branded_search_spend_per ,
        shopping_spend_per ,
        programmatic_spend_per ,
        youtube_spend_per ,
        tv_and_streaming_spend_per ,
        testing_spend_per ,
        print_spend_per ,
        radio_podcast_spend_per ,
        influencers_spend_per ,
        affiliate_spend_per ,
        physical_partnerships_spend_per ,
        tiktok_spend_per ,
        reddit_spend_per ,
        twitter_spend_per ,
        currency ,
        source ,
        version,
        channel_sequence,
        report_month,
        retail_vips ,
        varsity_vips ,
        vips_on_date_d1 ,
        vips_from_reactivated_leads_d1 ,
        vips_on_date_d1_excluding_reactivated_leads ,
        vips_on_date_d1_reactivated_leads ,
        vips_on_date_m1_reactivated_leads ,
        vips_on_date_d2_d7 ,
        d1_vips_per ,
        d1_vips_excluding_reactivated_leads_per,
        d1_vips_reactivated_leads_per,
        d2_d7_vips_per,
        reactivated_vips_per,
        first_guest_product_margin_pre_return,
        bop_vips,
		total_cancels_on_date,
        activating_acquisition_margin,
        product_order_count
    )

select c.sequence ,
    c.store_name ,
    c.store_abbreviation ,
    c.date ,
    c.primary_leads ,
    c.secondary_leads,
    c.cross_brand_leads_per,
    c.cpl ,
    c.media_spend ,
    c.vips_from_leads_30m ,
    c.vips_from_leads_30m_cac ,
    c.vips_from_leads_1d ,
    c.vips_from_leads_1d_cac ,
    c.vips_from_leads_7d ,
    c.vips_from_leads_24h ,
    c.vips_from_leads_24h_cac ,
    c.vips_from_leads_m1 ,
    c.vips_from_leads_m1_cac ,
    c.vips_on_date_m1 ,
    c.vips_on_date_m1_cac ,
    c.total_vips_from_reactivated_leads,
    c.total_vips_on_date ,
    c.total_vips_on_date_cac ,
    c.vips_on_date_d1_d7 ,
    c.vips_on_date_d8_d90 ,
    c.vips_on_date_d90plus ,
    c.reactivated_vips ,
    c.reactivated_leads ,
    c.retail_leads,
    c.cancels_on_date,
    c.passive_cancels_on_date,
    c.vips_from_leads_30m_per ,
    c.vips_from_leads_24h_per ,
    c.vips_from_leads_m1_per ,
    c.vips_from_reactivated_leads_24h_per ,
    c.d1_d7_vips_per ,
    c.d8_d90_vips_per ,
    c.d90plus_vips_per ,
    c.reactivated_leads_per ,
    c.prospecting_spend ,
    c.facebook_spend ,
    c.snapchat_spend ,
    c.pinterest_spend ,
    c.applovin_spend,
    c.linkedin_spend,
    c.nift_spend,
    c.rokt_spend,
    c.twitch_spend,
    c.google_other_spend,
    c.ooh_spend,
    c.celebrity_spend,
    c.non_branded_search_spend ,
    c.branded_search_spend ,
    c.shopping_spend ,
    c.programmatic_spend ,
    c.youtube_spend ,
    c.tv_and_streaming_Spend ,
    c.testing_spend ,
    c.print_spend ,
    c.radio_podcast_spend ,
    c.influencers_spend ,
    c.affiliate_spend ,
    c.physical_partnerships_spend ,
    c.tiktok_spend ,
    c.reddit_spend ,
    c.twitter_spend ,
    c.prospecting_spend_per ,
    c.facebook_spend_per ,
    c.snapchat_spend_per ,
    c.pinterest_spend_per ,
    c.applovin_spend_per,
    c.linkedin_spend_per,
    c.nift_spend_per,
    c.rokt_spend_per,
    c.twitch_spend_per,
    c.google_other_spend_per,
    c.ooh_spend_per,
    c.celebrity_spend_per,
    c.non_branded_search_spend_per ,
    c.branded_search_spend_per ,
    c.shopping_spend_per ,
    c.programmatic_spend_per ,
    c.youtube_spend_per ,
    c.tv_and_streaming_Spend_per ,
    c.testing_spend_per ,
    c.print_spend_per ,
    c.radio_podcast_spend_per ,
    c.influencers_spend_per ,
    c.affiliate_spend_per ,
    c.physical_partnerships_spend_per ,
    c.tiktok_spend_per ,
    c.reddit_spend_per ,
    c.twitter_spend_per ,
    c.currency ,
    c.source ,
    c.version,
    0 as channel_sequence,
    date_trunc('month', dateadd(day, -1, $high_watermark_date)) as report_month,
    c.retail_vips ,
    c.varsity_vips ,
    c.vips_on_date_d1 ,
    c.vips_from_reactivated_leads_d1 ,
    c.vips_on_date_d1_excluding_reactivated_leads ,
    c.vips_on_date_d1_reactivated_leads ,
    c.vips_on_date_m1_reactivated_leads ,
    c.vips_on_date_d2_d7 ,
    c.d1_vips_per ,
    c.d1_vips_excluding_reactivated_leads_per ,
    c.d1_vips_reactivated_leads_per ,
    c.d2_d7_vips_per,
    c.reactivated_vips_per,
    c.first_guest_product_margin_pre_return,
    c.bop_vips,
	c.total_cancels_on_date,
    c.activating_acquisition_margin,
    c.product_order_count
FROM _total_cac c;


update reporting_media_prod.attribution.total_cac_output
set sequence = (select max(sequence) + 1
from reporting_media_prod.attribution.total_cac_output)
where store_abbreviation is null;
