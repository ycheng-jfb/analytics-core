CREATE OR REPLACE VIEW data_model.dim_customer (
    customer_id,
    first_name,
    last_name,
    email,
    store_id,
    primary_registration_store_id,
    secondary_registration_store_id,
    is_secondary_registration_after_vip,
    default_address_id,
    default_address1,
    default_address2,
    default_city,
    default_state_province,
    default_postal_code,
    country_code,
    specialty_country_code,
    finance_specialty_store,
    birth_day,
    birth_year,
    birth_month,
    quiz_zip,
    top_size,
    bottom_size,
    bra_size,
    onepiece_size,
    denim_size,
    dress_size,
    shoe_size,
    gender,
    first_gender,
    is_friend_referral,
    membership_level,
    how_did_you_hear,
    how_did_you_hear_parent,
    registration_local_datetime,
    secondary_registration_local_datetime,
    is_blacklisted,
    blacklist_reason,
    is_free_trial,
    is_free_trial_promo,
    is_free_trial_gift_order,
    is_cross_promo,
    is_metanav,
    is_scrubs_customer,
    is_test_customer,
    is_opt_out,
    email_opt_in_datetime,
    sms_opt_in_datetime,
    membership_state,
    bralette_size,
    undie_size,
    lingerie_sleep_size,
    emp_optin_datetime,
    first_mobile_app_session_local_datetime,
    first_mobile_app_session_id,
    first_mobile_app_order_local_datetime,
    first_mobile_app_order_id,
    mobile_app_cohort_month_date,
    mobile_app_cohort_os,
	onetrust_consent_strictlynecessary,
	onetrust_consent_performance,
	onetrust_consent_functional,
	onetrust_consent_targeting,
	onetrust_consent_social,
	onetrust_update_datetime,
    registration_type,
    current_membership_type,
    membership_price,
    membership_plan_id,
    customer_bucket_group,
    meta_create_datetime,
    meta_update_datetime
    ) AS
SELECT
    c.customer_id,
    c.first_name,
    c.last_name,
    c.email,
    c.store_id,
    c.primary_registration_store_id,
    c.secondary_registration_store_id,
    c.is_secondary_registration_after_vip,
    c.default_address_id,
    c.default_address1,
    c.default_address2,
    c.default_city,
    c.default_state_province,
    c.default_postal_code,
    --c.default_country_code,
    --c.detail_country_code,
    COALESCE(c.specialty_country_code, c.default_country_code, c.detail_country_code, 'Unknown') AS country_code,
    c.specialty_country_code,
    c.finance_specialty_store,
    c.birth_day,
    c.birth_year,
    c.birth_month,
    c.quiz_zip,
    c.top_size,
    c.bottom_size,
    c.bra_size,
    c.onepiece_size,
    c.denim_size,
    c.dress_size,
    c.shoe_size,
    c.gender,
    c.first_gender,
    c.is_friend_referral,
    c.membership_level,
    c.how_did_you_hear,
    c.how_did_you_hear_parent,
    c.registration_local_datetime,
    c.secondary_registration_local_datetime,
    c.is_blacklisted,
    c.blacklist_reason,
    c.is_free_trial,
    c.is_free_trial_promo,
    c.is_free_trial_gift_order,
    c.is_cross_promo,
    c.is_metanav,
    c.is_scrubs_customer,
    c.is_test_customer,
    c.is_opt_out,
    c.email_opt_in_datetime,
    c.sms_opt_in_datetime,
    c.membership_state,
    c.bralette_size,
    c.undie_size,
    c.lingerie_sleep_size,
    c.emp_optin_datetime,
    c.first_mobile_app_session_local_datetime,
    c.first_mobile_app_session_id,
    c.first_mobile_app_order_local_datetime,
    c.first_mobile_app_order_id,
    c.mobile_app_cohort_month_date,
    CASE WHEN c.mobile_app_cohort_os ilike 'Mac%%' OR c.mobile_app_cohort_os ilike 'iOS'
            THEN 'Apple'
        WHEN c.mobile_app_cohort_os IS NULL OR c.mobile_app_cohort_os ='Unknown'
            THEN 'Unknown'
        ELSE 'Android'
        END AS mobile_app_cohort_os,
	c.onetrust_consent_strictlynecessary,
    c.onetrust_consent_performance,
    c.onetrust_consent_functional,
    c.onetrust_consent_targeting,
    c.onetrust_consent_social,
    c.onetrust_update_datetime,
    c.registration_type,
    c.current_membership_type,
    c.membership_price,
    c.membership_plan_id,
    c.customer_bucket_group,
    c.meta_create_datetime,
    c.meta_update_datetime
FROM stg.dim_customer AS c
    LEFT JOIN stg.dim_store AS ds
        ON ds.store_id = c.store_id
WHERE ds.store_brand NOT IN ('Legacy')
    AND NOT NVL(c.is_test_customer, FALSE)
    AND NOT NVL(c.is_deleted, FALSE);
