CREATE OR REPLACE VIEW data_model_fl.fact_registration (
    registration_key,
    membership_event_key,
    store_id,
    customer_id,
    registration_local_datetime,
    session_id,
    registration_channel_type,
    registration_channel,
    registration_subchannel,
    is_reactivated_lead,
    uri,
    hdyh_values_shown,
    cdetail_lead_type,
    cdetail_origin,
    cdetail_initial_medium,
    has_membership_password,
    has_membership_password_first_value,
    is_fake_retail_registration,
    is_retail_registration,
    retail_location,
    how_did_you_hear_parent,
    how_did_you_hear,
    dm_gateway_id,
    dm_site_id,
    utm_medium,
    utm_source,
    utm_campaign,
    utm_content,
    utm_term,
    ccode,
    pcode,
    scode,
    acode,
    master_product_id,
    device,
    browser,
    uri_utm_medium,
    uri_utm_source,
    uri_utm_campaign,
    uri_utm_content,
    uri_utm_term,
    uri_device,
    uri_browser,
    rpt_utm_medium,
    rpt_utm_source,
    rpt_utm_campaign,
    rpt_utm_content,
    rpt_utm_term,
    rpt_device,
    rpt_browser,
    operating_system,
    is_secondary_registration,
    is_secondary_registration_after_vip,
    meta_create_datetime,
    meta_update_datetime
    )
AS
SELECT
    fr.registration_key,
    fr.membership_event_key,
    fr.store_id,
    stg.udf_unconcat_brand(fr.customer_id) AS customer_id,
    fr.registration_local_datetime,
    stg.udf_unconcat_brand(fr.session_id) AS session_id,
    fr.registration_channel_type,
    fr.registration_channel,
    fr.registration_subchannel,
    fr.is_reactivated_lead,
    fr.uri,
    fr.hdyh_values_shown,
    fr.cdetail_lead_type,
    fr.cdetail_origin,
    fr.cdetail_initial_medium,
    fr.has_membership_password,
    fr.has_membership_password_first_value,
    fr.is_fake_retail_registration,
    fr.is_retail_registration,
    fr.retail_location,
    fr.how_did_you_hear_parent,
    fr.how_did_you_hear,
    fr.dm_gateway_id,
    fr.dm_site_id,
    fr.utm_medium,
    fr.utm_source,
    fr.utm_campaign,
    fr.utm_content,
    fr.utm_term,
    fr.ccode,
    fr.pcode,
    fr.scode,
    fr.acode,
    fr.master_product_id,
    fr.device,
    fr.browser,
    fr.uri_utm_medium,
    fr.uri_utm_source,
    fr.uri_utm_campaign,
    fr.uri_utm_content,
    fr.uri_utm_term,
    fr.uri_device,
    fr.uri_browser,
    fr.rpt_utm_medium,
    fr.rpt_utm_source,
    fr.rpt_utm_campaign,
    fr.rpt_utm_content,
    fr.rpt_utm_term,
    fr.rpt_device,
    fr.rpt_browser,
    fr.operating_system,
    fr.is_secondary_registration,
    fr.is_secondary_registration_after_vip,
    fr.meta_create_datetime,
    fr.meta_update_datetime
FROM stg.fact_registration AS fr
    LEFT JOIN stg.dim_store AS ds
        ON ds.store_id = fr.store_id
WHERE NOT fr.is_deleted
    AND NOT NVL(fr.is_test_customer, FALSE)
    AND ds.store_brand NOT IN ('Legacy')
    AND (substring(fr.customer_id, -2) = '20' OR fr.customer_id = -1);
