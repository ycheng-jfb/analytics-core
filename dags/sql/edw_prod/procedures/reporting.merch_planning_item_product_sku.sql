/*
Incremental Logic
    Variables:
        inventory_last_update_datetime: Maximum meta_update_datetime from merch_planning_item_product_sku in
                                        Inventory data. 1900-01-01 if null
        inventory_from_date: MIN(date) from merch_planning_item_sku in Inventory data where
                                    meta_update_datetime > inventory_last_update_datetime. 2019-01-01 if null
        sales_last_update_datetime: Maximum meta_update_datetime from merch_planning_item_product_sku in
                                    Sales data. 1900-01-01 if null
        sales_from_date: Month date of MIN(date) from merch_planning_item_sku for Sales where
                                meta_update_datetime > sales_last_update_datetime. 2019-01-01 if null
    Inventory Data: Data will be reprocessed from inventory_from_date
    Sales Data: Data will be reprocessed from sales_from_date

    Update from Item Sku stage and it should now include 2018 data. So now it calculates for 2018 and later. This may
    change as the dataset gets larger and larger.
*/

SET target_table = 'reporting.merch_planning_item_product_sku';
SET is_full_refresh = (SELECT CASE
                                  WHEN stg.udf_get_watermark($target_table, NULL) = '1900-01-01' THEN TRUE
                                  WHEN MAX(full_date) = CURRENT_DATE THEN TRUE
                                  ELSE FALSE END
                       FROM data_model.dim_date
                       WHERE month_date = DATE_TRUNC('month', CURRENT_DATE)
                         AND day_name_of_week = 'Friday');

MERGE INTO stg.meta_table_dependency_watermark AS w
USING (
    SELECT
        $target_table AS table_name,
        NULL AS dependent_table_name,
        (
            SELECT MAX(meta_update_datetime) AS new_high_watermark_datetime
            FROM reporting.merch_planning_item_product_sku
        ) AS new_high_watermark_datetime
    ) AS s
    ON w.table_name = s.table_name
    AND w.dependent_table_name IS NOT DISTINCT FROM s.dependent_table_name
WHEN NOT MATCHED THEN
    INSERT (
        table_name,
        dependent_table_name,
        high_watermark_datetime,
        new_high_watermark_datetime
        )
    VALUES (
        s.table_name,
        s.dependent_table_name,
        '1900-01-01', -- current high_watermark_datetime
        s.new_high_watermark_datetime
        )
WHEN MATCHED AND w.new_high_watermark_datetime IS DISTINCT FROM s.new_high_watermark_datetime THEN
    UPDATE
    SET w.new_high_watermark_datetime = s.new_high_watermark_datetime,
        w.meta_update_datetime = CURRENT_TIMESTAMP::TIMESTAMP_LTZ(3);


SET inventory_last_update_datetime = (
    SELECT COALESCE(MAX(meta_update_datetime), '1900-01-01'::TIMESTAMP)
    FROM reporting.merch_planning_item_product_sku
    WHERE date_type = 'Inventory');

SET inventory_from_date = (
    SELECT CASE WHEN $is_full_refresh = TRUE THEN '1900-01-01'
        ELSE COALESCE(MIN(date), '1900-01-01'::TIMESTAMP) END
    FROM reporting.merch_planning_item_sku
    WHERE date_type = 'Inventory'
        AND meta_update_datetime > $inventory_last_update_datetime);

SET sales_last_update_datetime = (
    SELECT COALESCE(MAX(meta_update_datetime), '1900-01-01'::TIMESTAMP)
    FROM reporting.merch_planning_item_product_sku
    WHERE date_type <> 'Inventory');

SET sales_from_date = (
    SELECT CASE WHEN $is_full_refresh = TRUE THEN '1900-01-01'
        ELSE COALESCE(DATE_TRUNC('MONTH', MIN(date)),'1900-01-01') END
    FROM reporting.merch_planning_item_sku
    WHERE date_type <> 'Inventory'
        AND meta_update_datetime > $sales_last_update_datetime);

SET warehouse_to_be_used = IFF($is_full_refresh = TRUE , 'da_wh_adhoc_large', CURRENT_WAREHOUSE());
USE WAREHOUSE IDENTIFIER ($warehouse_to_be_used);

BEGIN TRANSACTION;

CREATE OR REPLACE TEMPORARY TABLE _base_calculations AS
SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    SUM(ty_total_unit_count) AS ty_total_unit_count,
    SUM(ty_unit_count_activating) AS ty_unit_count_activating,
    SUM(ty_unit_count_nonactivating) AS ty_unit_count_nonactivating,
    SUM(ty_unit_count_repeat) AS ty_unit_count_repeat,
    SUM(ty_unit_count_guest) AS ty_unit_count_guest,
    SUM(ty_total_product_subtotal) AS ty_total_product_subtotal,
    SUM(ty_product_subtotal_activating) AS ty_product_subtotal_activating,
    SUM(ty_product_subtotal_nonactivating) AS ty_product_subtotal_nonactivating,
    SUM(ty_product_subtotal_repeat) AS ty_product_subtotal_repeat,
    SUM(ty_product_subtotal_guest) AS ty_product_subtotal_guest,
    SUM(ty_total_product_discount) AS ty_total_product_discount,
    SUM(ty_product_discount_activating) AS ty_product_discount_activating,
    SUM(ty_product_discount_nonactivating) AS ty_product_discount_nonactivating,
    SUM(ty_product_discount_repeat) AS ty_product_discount_repeat,
    SUM(ty_product_discount_guest) AS ty_product_discount_guest,
    SUM(ty_total_product_gross_revenue_excl_shipping) AS ty_total_product_gross_revenue_excl_shipping,
    SUM(ty_product_gross_revenue_excl_shipping_activating) AS ty_product_gross_revenue_excl_shipping_activating,
    SUM(ty_product_gross_revenue_excl_shipping_nonactivating) AS ty_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ty_product_gross_revenue_excl_shipping_repeat) AS ty_product_gross_revenue_excl_shipping_repeat,
    SUM(ty_product_gross_revenue_excl_shipping_guest) AS ty_product_gross_revenue_excl_shipping_guest,
    SUM(ty_total_product_margin_pre_return_excl_shipping) AS ty_total_product_margin_pre_return_excl_shipping,
    SUM(ty_product_margin_pre_return_excl_shipping_activating) AS ty_product_margin_pre_return_excl_shipping_activating,
    SUM(ty_product_margin_pre_return_excl_shipping_nonactivating) AS ty_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ty_product_margin_pre_return_excl_shipping_repeat) AS ty_product_margin_pre_return_excl_shipping_repeat,
    SUM(ty_product_margin_pre_return_excl_shipping_guest) AS ty_product_margin_pre_return_excl_shipping_guest,
    SUM(ty_total_product_cost) AS ty_total_product_cost,
    SUM(ty_product_cost_activating) AS ty_product_cost_activating,
    SUM(ty_product_cost_nonactivating) AS ty_product_cost_nonactivating,
    SUM(ty_product_cost_repeat) AS ty_product_cost_repeat,
    SUM(ty_product_cost_guest) AS ty_product_cost_guest,
    SUM(ty_total_product_cost_c) AS ty_total_product_cost_c,
    SUM(ty_product_cost_activating_c) AS ty_product_cost_activating_c,
    SUM(ty_product_cost_nonactivating_c) AS ty_product_cost_nonactivating_c,
    SUM(ty_product_cost_repeat_c) AS ty_product_cost_repeat_c,
    SUM(ty_product_cost_guest_c) AS ty_product_cost_guest_c,
    SUM(ty_total_non_reduced_vip_price) AS ty_total_non_reduced_vip_price,
    SUM(ty_non_reduced_vip_price_activating) AS ty_non_reduced_vip_price_activating,
    SUM(ty_non_reduced_vip_price_nonactivating) AS ty_non_reduced_vip_price_nonactivating,
    SUM(ty_non_reduced_vip_price_repeat) AS ty_non_reduced_vip_price_repeat,
    SUM(ty_non_reduced_vip_price_guest) AS ty_non_reduced_vip_price_guest,
    SUM(ty_total_return_unit_count) AS ty_total_return_unit_count,
    SUM(ty_return_unit_count_activating) AS ty_return_unit_count_activating,
    SUM(ty_return_unit_count_nonactivating) AS ty_return_unit_count_nonactivating,
    SUM(ty_return_unit_count_repeat) AS ty_return_unit_count_repeat,
    SUM(ty_return_unit_count_guest) AS ty_return_unit_count_guest,
    SUM(ty_total_returned_product_gross_rev_excluding_shipping) AS ty_total_returned_product_gross_rev_excluding_shipping,
    SUM(ty_returned_product_gross_rev_excluding_shipping_activating) AS ty_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_nonactivating) AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_repeat) AS ty_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ty_returned_product_gross_rev_excluding_shipping_guest) AS ty_returned_product_gross_rev_excluding_shipping_guest,
    SUM(ly_day_total_unit_count) AS ly_day_total_unit_count,
    SUM(ly_day_unit_count_activating) AS ly_day_unit_count_activating,
    SUM(ly_day_unit_count_nonactivating) AS ly_day_unit_count_nonactivating,
    SUM(ly_day_unit_count_repeat) AS ly_day_unit_count_repeat,
    SUM(ly_day_unit_count_guest) AS ly_day_unit_count_guest,
    SUM(ly_day_total_product_subtotal) AS ly_day_total_product_subtotal,
    SUM(ly_day_product_subtotal_activating) AS ly_day_product_subtotal_activating,
    SUM(ly_day_product_subtotal_nonactivating) AS ly_day_product_subtotal_nonactivating,
    SUM(ly_day_product_subtotal_repeat) AS ly_day_product_subtotal_repeat,
    SUM(ly_day_product_subtotal_guest) AS ly_day_product_subtotal_guest,
    SUM(ly_day_total_product_discount) AS ly_day_total_product_discount,
    SUM(ly_day_product_discount_activating) AS ly_day_product_discount_activating,
    SUM(ly_day_product_discount_nonactivating) AS ly_day_product_discount_nonactivating,
    SUM(ly_day_product_discount_repeat) AS ly_day_product_discount_repeat,
    SUM(ly_day_product_discount_guest) AS ly_day_product_discount_guest,
    SUM(ly_day_total_product_gross_revenue_excl_shipping) AS ly_day_total_product_gross_revenue_excl_shipping,
    SUM(ly_day_product_gross_revenue_excl_shipping_activating) AS ly_day_product_gross_revenue_excl_shipping_activating,
    SUM(ly_day_product_gross_revenue_excl_shipping_nonactivating) AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ly_day_product_gross_revenue_excl_shipping_repeat) AS ly_day_product_gross_revenue_excl_shipping_repeat,
    SUM(ly_day_product_gross_revenue_excl_shipping_guest) AS ly_day_product_gross_revenue_excl_shipping_guest,
    SUM(ly_day_total_product_margin_pre_return_excl_shipping) AS ly_day_total_product_margin_pre_return_excl_shipping,
    SUM(ly_day_product_margin_pre_return_excl_shipping_activating) AS ly_day_product_margin_pre_return_excl_shipping_activating,
    SUM(ly_day_product_margin_pre_return_excl_shipping_nonactivating) AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ly_day_product_margin_pre_return_excl_shipping_repeat) AS ly_day_product_margin_pre_return_excl_shipping_repeat,
    SUM(ly_day_product_margin_pre_return_excl_shipping_guest) AS ly_day_product_margin_pre_return_excl_shipping_guest,
    SUM(ly_day_total_product_cost) AS ly_day_total_product_cost,
    SUM(ly_day_product_cost_activating) AS ly_day_product_cost_activating,
    SUM(ly_day_product_cost_nonactivating) AS ly_day_product_cost_nonactivating,
    SUM(ly_day_product_cost_repeat) AS ly_day_product_cost_repeat,
    SUM(ly_day_product_cost_guest) AS ly_day_product_cost_guest,
    SUM(ly_day_total_product_cost_c) AS ly_day_total_product_cost_c,
    SUM(ly_day_product_cost_activating_c) AS ly_day_product_cost_activating_c,
    SUM(ly_day_product_cost_nonactivating_c) AS ly_day_product_cost_nonactivating_c,
    SUM(ly_day_product_cost_repeat_c) AS ly_day_product_cost_repeat_c,
    SUM(ly_day_product_cost_guest_c) AS ly_day_product_cost_guest_c,
    SUM(ly_day_total_non_reduced_vip_price) AS ly_day_total_non_reduced_vip_price,
    SUM(ly_day_non_reduced_vip_price_activating) AS ly_day_non_reduced_vip_price_activating,
    SUM(ly_day_non_reduced_vip_price_nonactivating) AS ly_day_non_reduced_vip_price_nonactivating,
    SUM(ly_day_non_reduced_vip_price_repeat) AS ly_day_non_reduced_vip_price_repeat,
    SUM(ly_day_non_reduced_vip_price_guest) AS ly_day_non_reduced_vip_price_guest,
    SUM(ly_day_total_return_unit_count) AS ly_day_total_return_unit_count,
    SUM(ly_day_return_unit_count_activating) AS ly_day_return_unit_count_activating,
    SUM(ly_day_return_unit_count_nonactivating) AS ly_day_return_unit_count_nonactivating,
    SUM(ly_day_return_unit_count_repeat) AS ly_day_return_unit_count_repeat,
    SUM(ly_day_return_unit_count_guest) AS ly_day_return_unit_count_guest,
    SUM(ly_day_total_returned_product_gross_rev_excluding_shipping) AS ly_day_total_returned_product_gross_rev_excluding_shipping,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_activating) AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_nonactivating) AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_repeat) AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_guest) AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
    SUM(ly_date_total_unit_count) AS ly_date_total_unit_count,
    SUM(ly_date_unit_count_activating) AS ly_date_unit_count_activating,
    SUM(ly_date_unit_count_nonactivating) AS ly_date_unit_count_nonactivating,
    SUM(ly_date_unit_count_repeat) AS ly_date_unit_count_repeat,
    SUM(ly_date_unit_count_guest) AS ly_date_unit_count_guest,
    SUM(ly_date_total_product_subtotal) AS ly_date_total_product_subtotal,
    SUM(ly_date_product_subtotal_activating) AS ly_date_product_subtotal_activating,
    SUM(ly_date_product_subtotal_nonactivating) AS ly_date_product_subtotal_nonactivating,
    SUM(ly_date_product_subtotal_repeat) AS ly_date_product_subtotal_repeat,
    SUM(ly_date_product_subtotal_guest) AS ly_date_product_subtotal_guest,
    SUM(ly_date_total_product_discount) AS ly_date_total_product_discount,
    SUM(ly_date_product_discount_activating) AS ly_date_product_discount_activating,
    SUM(ly_date_product_discount_nonactivating) AS ly_date_product_discount_nonactivating,
    SUM(ly_date_product_discount_repeat) AS ly_date_product_discount_repeat,
    SUM(ly_date_product_discount_guest) AS ly_date_product_discount_guest,
    SUM(ly_date_total_product_gross_revenue_excl_shipping) AS ly_date_total_product_gross_revenue_excl_shipping,
    SUM(ly_date_product_gross_revenue_excl_shipping_activating) AS ly_date_product_gross_revenue_excl_shipping_activating,
    SUM(ly_date_product_gross_revenue_excl_shipping_nonactivating) AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ly_date_product_gross_revenue_excl_shipping_repeat) AS ly_date_product_gross_revenue_excl_shipping_repeat,
    SUM(ly_date_product_gross_revenue_excl_shipping_guest) AS ly_date_product_gross_revenue_excl_shipping_guest,
    SUM(ly_date_total_product_margin_pre_return_excl_shipping) AS ly_date_total_product_margin_pre_return_excl_shipping,
    SUM(ly_date_product_margin_pre_return_excl_shipping_activating) AS ly_date_product_margin_pre_return_excl_shipping_activating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_nonactivating) AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_repeat) AS ly_date_product_margin_pre_return_excl_shipping_repeat,
    SUM(ly_date_product_margin_pre_return_excl_shipping_guest) AS ly_date_product_margin_pre_return_excl_shipping_guest,
    SUM(ly_date_total_product_cost) AS ly_date_total_product_cost,
    SUM(ly_date_product_cost_activating) AS ly_date_product_cost_activating,
    SUM(ly_date_product_cost_nonactivating) AS ly_date_product_cost_nonactivating,
    SUM(ly_date_product_cost_repeat) AS ly_date_product_cost_repeat,
    SUM(ly_date_product_cost_guest) AS ly_date_product_cost_guest,
    SUM(ly_date_total_product_cost_c) AS ly_date_total_product_cost_c,
    SUM(ly_date_product_cost_activating_c) AS ly_date_product_cost_activating_c,
    SUM(ly_date_product_cost_nonactivating_c) AS ly_date_product_cost_nonactivating_c,
    SUM(ly_date_product_cost_repeat_c) AS ly_date_product_cost_repeat_c,
    SUM(ly_date_product_cost_guest_c) AS ly_date_product_cost_guest_c,
    SUM(ly_date_total_non_reduced_vip_price) AS ly_date_total_non_reduced_vip_price,
    SUM(ly_date_non_reduced_vip_price_activating) AS ly_date_non_reduced_vip_price_activating,
    SUM(ly_date_non_reduced_vip_price_nonactivating) AS ly_date_non_reduced_vip_price_nonactivating,
    SUM(ly_date_non_reduced_vip_price_repeat) AS ly_date_non_reduced_vip_price_repeat,
    SUM(ly_date_non_reduced_vip_price_guest) AS ly_date_non_reduced_vip_price_guest,
    SUM(ly_date_total_return_unit_count) AS ly_date_total_return_unit_count,
    SUM(ly_date_return_unit_count_activating) AS ly_date_return_unit_count_activating,
    SUM(ly_date_return_unit_count_nonactivating) AS ly_date_return_unit_count_nonactivating,
    SUM(ly_date_return_unit_count_repeat) AS ly_date_return_unit_count_repeat,
    SUM(ly_date_return_unit_count_guest) AS ly_date_return_unit_count_guest,
    SUM(ly_date_total_returned_product_gross_rev_excluding_shipping) AS ly_date_total_returned_product_gross_rev_excluding_shipping,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_activating) AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_nonactivating) AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_repeat) AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_guest) AS ly_date_returned_product_gross_rev_excluding_shipping_guest
FROM reporting.merch_planning_item_sku
WHERE date_type <> 'Inventory'
    AND date >= DATEADD('DAY', -1, DATE_TRUNC('WEEK', $sales_from_date))
GROUP BY date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail;

CREATE OR REPLACE TEMPORARY TABLE _week_full_date AS
SELECT month_date,
    IFF(full_date > CURRENT_DATE() - 1, CURRENT_DATE() - 1, full_date) AS full_date
FROM data_model.dim_date
WHERE full_date >= $sales_from_date
    AND full_date < DATEADD('WEEK', 1, CURRENT_DATE())
    AND day_name_of_week = 'Saturday';

CREATE OR REPLACE TEMPORARY TABLE _product_skus AS
SELECT DATE_TRUNC('MONTH', date) AS month_date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    MIN(date) AS date
FROM _base_calculations
WHERE date_type <> 'Inventory'
GROUP BY DATE_TRUNC('MONTH', date),
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail;

CREATE OR REPLACE TEMPORARY TABLE _missing_week_data AS
SELECT DISTINCT wfd.full_date AS date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail
FROM _product_skus ps
JOIN _week_full_date wfd ON wfd.month_date = ps.month_date
    AND wfd.full_date >= ps.date
WHERE date_type <> 'Inventory'
;

CREATE OR REPLACE TEMPORARY TABLE _final_data AS
SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    ty_total_unit_count,
    ty_unit_count_activating,
    ty_unit_count_nonactivating,
    ty_unit_count_repeat,
    ty_unit_count_guest,
    ty_total_product_subtotal,
    ty_product_subtotal_activating,
    ty_product_subtotal_nonactivating,
    ty_product_subtotal_repeat,
    ty_product_subtotal_guest,
    ty_total_product_discount,
    ty_product_discount_activating,
    ty_product_discount_nonactivating,
    ty_product_discount_repeat,
    ty_product_discount_guest,
    ty_total_product_gross_revenue_excl_shipping,
    ty_product_gross_revenue_excl_shipping_activating,
    ty_product_gross_revenue_excl_shipping_nonactivating,
    ty_product_gross_revenue_excl_shipping_repeat,
    ty_product_gross_revenue_excl_shipping_guest,
    ty_total_product_margin_pre_return_excl_shipping,
    ty_product_margin_pre_return_excl_shipping_activating,
    ty_product_margin_pre_return_excl_shipping_nonactivating,
    ty_product_margin_pre_return_excl_shipping_repeat,
    ty_product_margin_pre_return_excl_shipping_guest,
    ty_total_product_cost,
    ty_product_cost_activating,
    ty_product_cost_nonactivating,
    ty_product_cost_repeat,
    ty_product_cost_guest,
    ty_total_product_cost_c,
    ty_product_cost_activating_c,
    ty_product_cost_nonactivating_c,
    ty_product_cost_repeat_c,
    ty_product_cost_guest_c,
    ty_total_non_reduced_vip_price,
    ty_non_reduced_vip_price_activating,
    ty_non_reduced_vip_price_nonactivating,
    ty_non_reduced_vip_price_repeat,
    ty_non_reduced_vip_price_guest,
    ty_total_return_unit_count,
    ty_return_unit_count_activating,
    ty_return_unit_count_nonactivating,
    ty_return_unit_count_repeat,
    ty_return_unit_count_guest,
    ty_total_returned_product_gross_rev_excluding_shipping,
    ty_returned_product_gross_rev_excluding_shipping_activating,
    ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    ty_returned_product_gross_rev_excluding_shipping_repeat,
    ty_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_total_unit_count,
    ly_day_unit_count_activating,
    ly_day_unit_count_nonactivating,
    ly_day_unit_count_repeat,
    ly_day_unit_count_guest,
    ly_day_total_product_subtotal,
    ly_day_product_subtotal_activating,
    ly_day_product_subtotal_nonactivating,
    ly_day_product_subtotal_repeat,
    ly_day_product_subtotal_guest,
    ly_day_total_product_discount,
    ly_day_product_discount_activating,
    ly_day_product_discount_nonactivating,
    ly_day_product_discount_repeat,
    ly_day_product_discount_guest,
    ly_day_total_product_gross_revenue_excl_shipping,
    ly_day_product_gross_revenue_excl_shipping_activating,
    ly_day_product_gross_revenue_excl_shipping_nonactivating,
    ly_day_product_gross_revenue_excl_shipping_repeat,
    ly_day_product_gross_revenue_excl_shipping_guest,
    ly_day_total_product_margin_pre_return_excl_shipping,
    ly_day_product_margin_pre_return_excl_shipping_activating,
    ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    ly_day_product_margin_pre_return_excl_shipping_repeat,
    ly_day_product_margin_pre_return_excl_shipping_guest,
    ly_day_total_product_cost,
    ly_day_product_cost_activating,
    ly_day_product_cost_nonactivating,
    ly_day_product_cost_repeat,
    ly_day_product_cost_guest,
    ly_day_total_product_cost_c,
    ly_day_product_cost_activating_c,
    ly_day_product_cost_nonactivating_c,
    ly_day_product_cost_repeat_c,
    ly_day_product_cost_guest_c,
    ly_day_total_non_reduced_vip_price,
    ly_day_non_reduced_vip_price_activating,
    ly_day_non_reduced_vip_price_nonactivating,
    ly_day_non_reduced_vip_price_repeat,
    ly_day_non_reduced_vip_price_guest,
    ly_day_total_return_unit_count,
    ly_day_return_unit_count_activating,
    ly_day_return_unit_count_nonactivating,
    ly_day_return_unit_count_repeat,
    ly_day_return_unit_count_guest,
    ly_day_total_returned_product_gross_rev_excluding_shipping,
    ly_day_returned_product_gross_rev_excluding_shipping_activating,
    ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    ly_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_total_unit_count,
    ly_date_unit_count_activating,
    ly_date_unit_count_nonactivating,
    ly_date_unit_count_repeat,
    ly_date_unit_count_guest,
    ly_date_total_product_subtotal,
    ly_date_product_subtotal_activating,
    ly_date_product_subtotal_nonactivating,
    ly_date_product_subtotal_repeat,
    ly_date_product_subtotal_guest,
    ly_date_total_product_discount,
    ly_date_product_discount_activating,
    ly_date_product_discount_nonactivating,
    ly_date_product_discount_repeat,
    ly_date_product_discount_guest,
    ly_date_total_product_gross_revenue_excl_shipping,
    ly_date_product_gross_revenue_excl_shipping_activating,
    ly_date_product_gross_revenue_excl_shipping_nonactivating,
    ly_date_product_gross_revenue_excl_shipping_repeat,
    ly_date_product_gross_revenue_excl_shipping_guest,
    ly_date_total_product_margin_pre_return_excl_shipping,
    ly_date_product_margin_pre_return_excl_shipping_activating,
    ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    ly_date_product_margin_pre_return_excl_shipping_repeat,
    ly_date_product_margin_pre_return_excl_shipping_guest,
    ly_date_total_product_cost,
    ly_date_product_cost_activating,
    ly_date_product_cost_nonactivating,
    ly_date_product_cost_repeat,
    ly_date_product_cost_guest,
    ly_date_total_product_cost_c,
    ly_date_product_cost_activating_c,
    ly_date_product_cost_nonactivating_c,
    ly_date_product_cost_repeat_c,
    ly_date_product_cost_guest_c,
    ly_date_total_non_reduced_vip_price,
    ly_date_non_reduced_vip_price_activating,
    ly_date_non_reduced_vip_price_nonactivating,
    ly_date_non_reduced_vip_price_repeat,
    ly_date_non_reduced_vip_price_guest,
    ly_date_total_return_unit_count,
    ly_date_return_unit_count_activating,
    ly_date_return_unit_count_nonactivating,
    ly_date_return_unit_count_repeat,
    ly_date_return_unit_count_guest,
    ly_date_total_returned_product_gross_rev_excluding_shipping,
    ly_date_returned_product_gross_rev_excluding_shipping_activating,
    ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    ly_date_returned_product_gross_rev_excluding_shipping_guest
FROM _base_calculations

UNION ALL

SELECT mwd.date,
    mwd.date_type,
    mwd.store_id,
    mwd.store_name,
    mwd.store_full_name,
    mwd.store_brand,
    mwd.store_type,
    mwd.country,
    mwd.finance_specialty_store,
    mwd.region,
    mwd.product_brand,
    mwd.product_sku,
    mwd.base_sku,
    mwd.is_retail,
    0 AS ty_total_unit_count,
    0 AS ty_unit_count_activating,
    0 AS ty_unit_count_nonactivating,
    0 AS ty_unit_count_repeat,
    0 AS ty_unit_count_guest,
    0 AS ty_total_product_subtotal,
    0 AS ty_product_subtotal_activating,
    0 AS ty_product_subtotal_nonactivating,
    0 AS ty_product_subtotal_repeat,
    0 AS ty_product_subtotal_guest,
    0 AS ty_total_product_discount,
    0 AS ty_product_discount_activating,
    0 AS ty_product_discount_nonactivating,
    0 AS ty_product_discount_repeat,
    0 AS ty_product_discount_guest,
    0 AS ty_total_product_gross_revenue_excl_shipping,
    0 AS ty_product_gross_revenue_excl_shipping_activating,
    0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ty_product_gross_revenue_excl_shipping_repeat,
    0 AS ty_product_gross_revenue_excl_shipping_guest,
    0 AS ty_total_product_margin_pre_return_excl_shipping,
    0 AS ty_product_margin_pre_return_excl_shipping_activating,
    0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ty_product_margin_pre_return_excl_shipping_repeat,
    0 AS ty_product_margin_pre_return_excl_shipping_guest,
    0 AS ty_total_product_cost,
    0 AS ty_product_cost_activating,
    0 AS ty_product_cost_nonactivating,
    0 AS ty_product_cost_repeat,
    0 AS ty_product_cost_guest,
    0 AS ty_total_product_cost_c,
    0 AS ty_product_cost_activating_c,
    0 AS ty_product_cost_nonactivating_c,
    0 AS ty_product_cost_repeat_c,
    0 AS ty_product_cost_guest_c,
    0 AS ty_total_non_reduced_vip_price,
    0 AS ty_non_reduced_vip_price_activating,
    0 AS ty_non_reduced_vip_price_nonactivating,
    0 AS ty_non_reduced_vip_price_repeat,
    0 AS ty_non_reduced_vip_price_guest,
    0 AS ty_total_return_unit_count,
    0 AS ty_return_unit_count_activating,
    0 AS ty_return_unit_count_nonactivating,
    0 AS ty_return_unit_count_repeat,
    0 AS ty_return_unit_count_guest,
    0 AS ty_total_returned_product_gross_rev_excluding_shipping,
    0 AS ty_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ty_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_day_total_unit_count,
    0 AS ly_day_unit_count_activating,
    0 AS ly_day_unit_count_nonactivating,
    0 AS ly_day_unit_count_repeat,
    0 AS ly_day_unit_count_guest,
    0 AS ly_day_total_product_subtotal,
    0 AS ly_day_product_subtotal_activating,
    0 AS ly_day_product_subtotal_nonactivating,
    0 AS ly_day_product_subtotal_repeat,
    0 AS ly_day_product_subtotal_guest,
    0 AS ly_day_total_product_discount,
    0 AS ly_day_product_discount_activating,
    0 AS ly_day_product_discount_nonactivating,
    0 AS ly_day_product_discount_repeat,
    0 AS ly_day_product_discount_guest,
    0 AS ly_day_total_product_gross_revenue_excl_shipping,
    0 AS ly_day_product_gross_revenue_excl_shipping_activating,
    0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_day_product_gross_revenue_excl_shipping_guest,
    0 AS ly_day_total_product_margin_pre_return_excl_shipping,
    0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_day_total_product_cost,
    0 AS ly_day_product_cost_activating,
    0 AS ly_day_product_cost_nonactivating,
    0 AS ly_day_product_cost_repeat,
    0 AS ly_day_product_cost_guest,
    0 AS ly_day_total_product_cost_c,
    0 AS ly_day_product_cost_activating_c,
    0 AS ly_day_product_cost_nonactivating_c,
    0 AS ly_day_product_cost_repeat_c,
    0 AS ly_day_product_cost_guest_c,
    0 AS ly_day_total_non_reduced_vip_price,
    0 AS ly_day_non_reduced_vip_price_activating,
    0 AS ly_day_non_reduced_vip_price_nonactivating,
    0 AS ly_day_non_reduced_vip_price_repeat,
    0 AS ly_day_non_reduced_vip_price_guest,
    0 AS ly_day_total_return_unit_count,
    0 AS ly_day_return_unit_count_activating,
    0 AS ly_day_return_unit_count_nonactivating,
    0 AS ly_day_return_unit_count_repeat,
    0 AS ly_day_return_unit_count_guest,
    0 AS ly_day_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_date_total_unit_count,
    0 AS ly_date_unit_count_activating,
    0 AS ly_date_unit_count_nonactivating,
    0 AS ly_date_unit_count_repeat,
    0 AS ly_date_unit_count_guest,
    0 AS ly_date_total_product_subtotal,
    0 AS ly_date_product_subtotal_activating,
    0 AS ly_date_product_subtotal_nonactivating,
    0 AS ly_date_product_subtotal_repeat,
    0 AS ly_date_product_subtotal_guest,
    0 AS ly_date_total_product_discount,
    0 AS ly_date_product_discount_activating,
    0 AS ly_date_product_discount_nonactivating,
    0 AS ly_date_product_discount_repeat,
    0 AS ly_date_product_discount_guest,
    0 AS ly_date_total_product_gross_revenue_excl_shipping,
    0 AS ly_date_product_gross_revenue_excl_shipping_activating,
    0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_date_product_gross_revenue_excl_shipping_guest,
    0 AS ly_date_total_product_margin_pre_return_excl_shipping,
    0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_date_total_product_cost,
    0 AS ly_date_product_cost_activating,
    0 AS ly_date_product_cost_nonactivating,
    0 AS ly_date_product_cost_repeat,
    0 AS ly_date_product_cost_guest,
    0 AS ly_date_total_product_cost_c,
    0 AS ly_date_product_cost_activating_c,
    0 AS ly_date_product_cost_nonactivating_c,
    0 AS ly_date_product_cost_repeat_c,
    0 AS ly_date_product_cost_guest_c,
    0 AS ly_date_total_non_reduced_vip_price,
    0 AS ly_date_non_reduced_vip_price_activating,
    0 AS ly_date_non_reduced_vip_price_nonactivating,
    0 AS ly_date_non_reduced_vip_price_repeat,
    0 AS ly_date_non_reduced_vip_price_guest,
    0 AS ly_date_total_return_unit_count,
    0 AS ly_date_return_unit_count_activating,
    0 AS ly_date_return_unit_count_nonactivating,
    0 AS ly_date_return_unit_count_repeat,
    0 AS ly_date_return_unit_count_guest,
    0 AS ly_date_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_guest
FROM _missing_week_data mwd
LEFT JOIN _base_calculations bc ON bc.date = mwd.date
    AND bc.date_type = mwd.date_type
    AND bc.store_id = mwd.store_id
    AND bc.finance_specialty_store = mwd.finance_specialty_store
    AND bc.product_sku = mwd.product_sku
    AND bc.is_retail = mwd.is_retail
WHERE bc.date IS NULL;

CREATE OR REPLACE TEMPORARY TABLE _base_calculations_inventory AS
SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    SUM(ty_bop_onhand_qty) AS ty_bop_onhand_qty,
    SUM(ty_bop_available_to_sell_qty) AS ty_bop_available_to_sell_qty,
    SUM(ty_bop_open_to_buy_qty) AS ty_bop_open_to_buy_qty,
    SUM(ty_bop_open_to_buy_qty_incl_in_transit) AS ty_bop_open_to_buy_qty_incl_in_transit,
    SUM(ty_bop_retail_reserve) AS ty_bop_retail_reserve,
    SUM(ty_bop_inventory_cost) AS ty_bop_inventory_cost,
    SUM(ty_eop_onhand_qty) AS ty_eop_onhand_qty,
    SUM(ty_eop_available_to_sell_qty) AS ty_eop_available_to_sell_qty,
    SUM(ty_eop_open_to_buy_qty) AS ty_eop_open_to_buy_qty,
    SUM(ty_eop_open_to_buy_qty_incl_in_transit) AS ty_eop_open_to_buy_qty_incl_in_transit,
    SUM(ty_eop_retail_reserve) AS ty_eop_retail_reserve,
    SUM(ty_eop_inventory_cost) AS ty_eop_inventory_cost,
    SUM(ly_day_bop_onhand_qty) AS ly_day_bop_onhand_qty,
    SUM(ly_day_bop_available_to_sell_qty) AS ly_day_bop_available_to_sell_qty,
    SUM(ly_day_bop_open_to_buy_qty) AS ly_day_bop_open_to_buy_qty,
    SUM(ly_day_bop_open_to_buy_qty_incl_in_transit) AS ly_day_bop_open_to_buy_qty_incl_in_transit,
    SUM(ly_day_bop_retail_reserve) AS ly_day_bop_retail_reserve,
    SUM(ly_day_bop_inventory_cost) AS ly_day_bop_inventory_cost,
    SUM(ly_day_eop_onhand_qty) AS ly_day_eop_onhand_qty,
    SUM(ly_day_eop_available_to_sell_qty) AS ly_day_eop_available_to_sell_qty,
    SUM(ly_day_eop_open_to_buy_qty) AS ly_day_eop_open_to_buy_qty,
    SUM(ly_day_eop_open_to_buy_qty_incl_in_transit) AS ly_day_eop_open_to_buy_qty_incl_in_transit,
    SUM(ly_day_eop_retail_reserve) AS ly_day_eop_retail_reserve,
    SUM(ly_day_eop_inventory_cost) AS ly_day_eop_inventory_cost,
    SUM(ly_date_bop_onhand_qty) AS ly_date_bop_onhand_qty,
    SUM(ly_date_bop_available_to_sell_qty) AS ly_date_bop_available_to_sell_qty,
    SUM(ly_date_bop_open_to_buy_qty) AS ly_date_bop_open_to_buy_qty,
    SUM(ly_date_bop_open_to_buy_qty_incl_in_transit) AS ly_date_bop_open_to_buy_qty_incl_in_transit,
    SUM(ly_date_bop_retail_reserve) AS ly_date_bop_retail_reserve,
    SUM(ly_date_bop_inventory_cost) AS ly_date_bop_inventory_cost,
    SUM(ly_date_eop_onhand_qty) AS ly_date_eop_onhand_qty,
    SUM(ly_date_eop_available_to_sell_qty) AS ly_date_eop_available_to_sell_qty,
    SUM(ly_date_eop_open_to_buy_qty) AS ly_date_eop_open_to_buy_qty,
    SUM(ly_date_eop_open_to_buy_qty_incl_in_transit) AS ly_date_eop_open_to_buy_qty_incl_in_transit,
    SUM(ly_date_eop_retail_reserve) AS ly_date_eop_retail_reserve,
    SUM(ly_date_eop_inventory_cost) AS ly_date_eop_inventory_cost
FROM reporting.merch_planning_item_sku
WHERE date >= $inventory_from_date
    AND date_type = 'Inventory'
GROUP BY date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail;

DELETE FROM reporting.merch_planning_item_product_sku
WHERE date_type <> 'Inventory'
    AND date >= $sales_from_date;

DELETE FROM reporting.merch_planning_item_product_sku
WHERE date_type = 'Inventory'
    AND date >= $inventory_from_date;


SET meta_create_datetime = (SELECT MAX(meta_create_datetime)  FROM reporting.merch_planning_item_sku);
SET meta_update_datetime = (SELECT MAX(meta_update_datetime)  FROM reporting.merch_planning_item_sku);

INSERT INTO reporting.merch_planning_item_product_sku(
    date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    ty_total_unit_count,
    ty_unit_count_activating,
    ty_unit_count_nonactivating,
    ty_unit_count_repeat,
    ty_unit_count_guest,
    ty_total_product_subtotal,
    ty_product_subtotal_activating,
    ty_product_subtotal_nonactivating,
    ty_product_subtotal_repeat,
    ty_product_subtotal_guest,
    ty_total_product_discount,
    ty_product_discount_activating,
    ty_product_discount_nonactivating,
    ty_product_discount_repeat,
    ty_product_discount_guest,
    ty_total_product_gross_revenue_excl_shipping,
    ty_product_gross_revenue_excl_shipping_activating,
    ty_product_gross_revenue_excl_shipping_nonactivating,
    ty_product_gross_revenue_excl_shipping_repeat,
    ty_product_gross_revenue_excl_shipping_guest,
    ty_total_product_margin_pre_return_excl_shipping,
    ty_product_margin_pre_return_excl_shipping_activating,
    ty_product_margin_pre_return_excl_shipping_nonactivating,
    ty_product_margin_pre_return_excl_shipping_repeat,
    ty_product_margin_pre_return_excl_shipping_guest,
    ty_total_product_cost,
    ty_product_cost_activating,
    ty_product_cost_nonactivating,
    ty_product_cost_repeat,
    ty_product_cost_guest,
    ty_total_product_cost_c,
    ty_product_cost_activating_c,
    ty_product_cost_nonactivating_c,
    ty_product_cost_repeat_c,
    ty_product_cost_guest_c,
    ty_total_non_reduced_vip_price,
    ty_non_reduced_vip_price_activating,
    ty_non_reduced_vip_price_nonactivating,
    ty_non_reduced_vip_price_repeat,
    ty_non_reduced_vip_price_guest,
    ty_total_return_unit_count,
    ty_return_unit_count_activating,
    ty_return_unit_count_nonactivating,
    ty_return_unit_count_repeat,
    ty_return_unit_count_guest,
    ty_total_returned_product_gross_rev_excluding_shipping,
    ty_returned_product_gross_rev_excluding_shipping_activating,
    ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    ty_returned_product_gross_rev_excluding_shipping_repeat,
    ty_returned_product_gross_rev_excluding_shipping_guest,
    ty_bop_onhand_qty,
    ty_bop_available_to_sell_qty,
    ty_bop_open_to_buy_qty,
    ty_bop_open_to_buy_qty_incl_in_transit,
    ty_bop_retail_reserve,
    ty_bop_inventory_cost,
    ty_eop_onhand_qty,
    ty_eop_available_to_sell_qty,
    ty_eop_open_to_buy_qty,
    ty_eop_open_to_buy_qty_incl_in_transit,
    ty_eop_retail_reserve,
    ty_eop_inventory_cost,
    mtd_total_unit_count,
    mtd_unit_count_activating,
    mtd_unit_count_nonactivating,
    mtd_unit_count_repeat,
    mtd_unit_count_guest,
    mtd_total_product_subtotal,
    mtd_product_subtotal_activating,
    mtd_product_subtotal_nonactivating,
    mtd_product_subtotal_repeat,
    mtd_product_subtotal_guest,
    mtd_total_product_discount,
    mtd_product_discount_activating,
    mtd_product_discount_nonactivating,
    mtd_product_discount_repeat,
    mtd_product_discount_guest,
    mtd_total_product_gross_revenue_excl_shipping,
    mtd_product_gross_revenue_excl_shipping_activating,
    mtd_product_gross_revenue_excl_shipping_nonactivating,
    mtd_product_gross_revenue_excl_shipping_repeat,
    mtd_product_gross_revenue_excl_shipping_guest,
    mtd_total_product_margin_pre_return_excl_shipping,
    mtd_product_margin_pre_return_excl_shipping_activating,
    mtd_product_margin_pre_return_excl_shipping_nonactivating,
    mtd_product_margin_pre_return_excl_shipping_repeat,
    mtd_product_margin_pre_return_excl_shipping_guest,
    mtd_total_product_cost,
    mtd_product_cost_activating,
    mtd_product_cost_nonactivating,
    mtd_product_cost_repeat,
    mtd_product_cost_guest,
    mtd_total_product_cost_c,
    mtd_product_cost_activating_c,
    mtd_product_cost_nonactivating_c,
    mtd_product_cost_repeat_c,
    mtd_product_cost_guest_c,
    mtd_total_non_reduced_vip_price,
    mtd_non_reduced_vip_price_activating,
    mtd_non_reduced_vip_price_nonactivating,
    mtd_non_reduced_vip_price_repeat,
    mtd_non_reduced_vip_price_guest,
    mtd_total_return_unit_count,
    mtd_return_unit_count_activating,
    mtd_return_unit_count_nonactivating,
    mtd_return_unit_count_repeat,
    mtd_return_unit_count_guest,
    mtd_total_returned_product_gross_rev_excluding_shipping,
    mtd_returned_product_gross_rev_excluding_shipping_activating,
    mtd_returned_product_gross_rev_excluding_shipping_nonactivating,
    mtd_returned_product_gross_rev_excluding_shipping_repeat,
    mtd_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_total_unit_count,
    ly_day_unit_count_activating,
    ly_day_unit_count_nonactivating,
    ly_day_unit_count_repeat,
    ly_day_unit_count_guest,
    ly_day_total_product_subtotal,
    ly_day_product_subtotal_activating,
    ly_day_product_subtotal_nonactivating,
    ly_day_product_subtotal_repeat,
    ly_day_product_subtotal_guest,
    ly_day_total_product_discount,
    ly_day_product_discount_activating,
    ly_day_product_discount_nonactivating,
    ly_day_product_discount_repeat,
    ly_day_product_discount_guest,
    ly_day_total_product_gross_revenue_excl_shipping,
    ly_day_product_gross_revenue_excl_shipping_activating,
    ly_day_product_gross_revenue_excl_shipping_nonactivating,
    ly_day_product_gross_revenue_excl_shipping_repeat,
    ly_day_product_gross_revenue_excl_shipping_guest,
    ly_day_total_product_margin_pre_return_excl_shipping,
    ly_day_product_margin_pre_return_excl_shipping_activating,
    ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    ly_day_product_margin_pre_return_excl_shipping_repeat,
    ly_day_product_margin_pre_return_excl_shipping_guest,
    ly_day_total_product_cost,
    ly_day_product_cost_activating,
    ly_day_product_cost_nonactivating,
    ly_day_product_cost_repeat,
    ly_day_product_cost_guest,
    ly_day_total_product_cost_c,
    ly_day_product_cost_activating_c,
    ly_day_product_cost_nonactivating_c,
    ly_day_product_cost_repeat_c,
    ly_day_product_cost_guest_c,
    ly_day_total_non_reduced_vip_price,
    ly_day_non_reduced_vip_price_activating,
    ly_day_non_reduced_vip_price_nonactivating,
    ly_day_non_reduced_vip_price_repeat,
    ly_day_non_reduced_vip_price_guest,
    ly_day_total_return_unit_count,
    ly_day_return_unit_count_activating,
    ly_day_return_unit_count_nonactivating,
    ly_day_return_unit_count_repeat,
    ly_day_return_unit_count_guest,
    ly_day_total_returned_product_gross_rev_excluding_shipping,
    ly_day_returned_product_gross_rev_excluding_shipping_activating,
    ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    ly_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_bop_onhand_qty,
    ly_day_bop_available_to_sell_qty,
    ly_day_bop_open_to_buy_qty,
    ly_day_bop_open_to_buy_qty_incl_in_transit,
    ly_day_bop_retail_reserve,
    ly_day_bop_inventory_cost,
    ly_day_eop_onhand_qty,
    ly_day_eop_available_to_sell_qty,
    ly_day_eop_open_to_buy_qty,
    ly_day_eop_open_to_buy_qty_incl_in_transit,
    ly_day_eop_retail_reserve,
    ly_day_eop_inventory_cost,
    lymtd_day_total_unit_count,
    lymtd_day_unit_count_activating,
    lymtd_day_unit_count_nonactivating,
    lymtd_day_unit_count_repeat,
    lymtd_day_unit_count_guest,
    lymtd_day_total_product_subtotal,
    lymtd_day_product_subtotal_activating,
    lymtd_day_product_subtotal_nonactivating,
    lymtd_day_product_subtotal_repeat,
    lymtd_day_product_subtotal_guest,
    lymtd_day_total_product_discount,
    lymtd_day_product_discount_activating,
    lymtd_day_product_discount_nonactivating,
    lymtd_day_product_discount_repeat,
    lymtd_day_product_discount_guest,
    lymtd_day_total_product_gross_revenue_excl_shipping,
    lymtd_day_product_gross_revenue_excl_shipping_activating,
    lymtd_day_product_gross_revenue_excl_shipping_nonactivating,
    lymtd_day_product_gross_revenue_excl_shipping_repeat,
    lymtd_day_product_gross_revenue_excl_shipping_guest,
    lymtd_day_total_product_margin_pre_return_excl_shipping,
    lymtd_day_product_margin_pre_return_excl_shipping_activating,
    lymtd_day_product_margin_pre_return_excl_shipping_nonactivating,
    lymtd_day_product_margin_pre_return_excl_shipping_repeat,
    lymtd_day_product_margin_pre_return_excl_shipping_guest,
    lymtd_day_total_product_cost,
    lymtd_day_product_cost_activating,
    lymtd_day_product_cost_nonactivating,
    lymtd_day_product_cost_repeat,
    lymtd_day_product_cost_guest,
    lymtd_day_total_product_cost_c,
    lymtd_day_product_cost_activating_c,
    lymtd_day_product_cost_nonactivating_c,
    lymtd_day_product_cost_repeat_c,
    lymtd_day_product_cost_guest_c,
    lymtd_day_total_non_reduced_vip_price,
    lymtd_day_non_reduced_vip_price_activating,
    lymtd_day_non_reduced_vip_price_nonactivating,
    lymtd_day_non_reduced_vip_price_repeat,
    lymtd_day_non_reduced_vip_price_guest,
    lymtd_day_total_return_unit_count,
    lymtd_day_return_unit_count_activating,
    lymtd_day_return_unit_count_nonactivating,
    lymtd_day_return_unit_count_repeat,
    lymtd_day_return_unit_count_guest,
    lymtd_day_total_returned_product_gross_rev_excluding_shipping,
    lymtd_day_returned_product_gross_rev_excluding_shipping_activating,
    lymtd_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    lymtd_day_returned_product_gross_rev_excluding_shipping_repeat,
    lymtd_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_total_unit_count,
    ly_date_unit_count_activating,
    ly_date_unit_count_nonactivating,
    ly_date_unit_count_repeat,
    ly_date_unit_count_guest,
    ly_date_total_product_subtotal,
    ly_date_product_subtotal_activating,
    ly_date_product_subtotal_nonactivating,
    ly_date_product_subtotal_repeat,
    ly_date_product_subtotal_guest,
    ly_date_total_product_discount,
    ly_date_product_discount_activating,
    ly_date_product_discount_nonactivating,
    ly_date_product_discount_repeat,
    ly_date_product_discount_guest,
    ly_date_total_product_gross_revenue_excl_shipping,
    ly_date_product_gross_revenue_excl_shipping_activating,
    ly_date_product_gross_revenue_excl_shipping_nonactivating,
    ly_date_product_gross_revenue_excl_shipping_repeat,
    ly_date_product_gross_revenue_excl_shipping_guest,
    ly_date_total_product_margin_pre_return_excl_shipping,
    ly_date_product_margin_pre_return_excl_shipping_activating,
    ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    ly_date_product_margin_pre_return_excl_shipping_repeat,
    ly_date_product_margin_pre_return_excl_shipping_guest,
    ly_date_total_product_cost,
    ly_date_product_cost_activating,
    ly_date_product_cost_nonactivating,
    ly_date_product_cost_repeat,
    ly_date_product_cost_guest,
    ly_date_total_product_cost_c,
    ly_date_product_cost_activating_c,
    ly_date_product_cost_nonactivating_c,
    ly_date_product_cost_repeat_c,
    ly_date_product_cost_guest_c,
    ly_date_total_non_reduced_vip_price,
    ly_date_non_reduced_vip_price_activating,
    ly_date_non_reduced_vip_price_nonactivating,
    ly_date_non_reduced_vip_price_repeat,
    ly_date_non_reduced_vip_price_guest,
    ly_date_total_return_unit_count,
    ly_date_return_unit_count_activating,
    ly_date_return_unit_count_nonactivating,
    ly_date_return_unit_count_repeat,
    ly_date_return_unit_count_guest,
    ly_date_total_returned_product_gross_rev_excluding_shipping,
    ly_date_returned_product_gross_rev_excluding_shipping_activating,
    ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    ly_date_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_bop_onhand_qty,
    ly_date_bop_available_to_sell_qty,
    ly_date_bop_open_to_buy_qty,
    ly_date_bop_open_to_buy_qty_incl_in_transit,
    ly_date_bop_retail_reserve,
    ly_date_bop_inventory_cost,
    ly_date_eop_onhand_qty,
    ly_date_eop_available_to_sell_qty,
    ly_date_eop_open_to_buy_qty,
    ly_date_eop_open_to_buy_qty_incl_in_transit,
    ly_date_eop_retail_reserve,
    ly_date_eop_inventory_cost,
    meta_create_datetime,
    meta_update_datetime
)
SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    ty_total_unit_count,
    ty_unit_count_activating,
    ty_unit_count_nonactivating,
    ty_unit_count_repeat,
    ty_unit_count_guest,
    ty_total_product_subtotal,
    ty_product_subtotal_activating,
    ty_product_subtotal_nonactivating,
    ty_product_subtotal_repeat,
    ty_product_subtotal_guest,
    ty_total_product_discount,
    ty_product_discount_activating,
    ty_product_discount_nonactivating,
    ty_product_discount_repeat,
    ty_product_discount_guest,
    ty_total_product_gross_revenue_excl_shipping,
    ty_product_gross_revenue_excl_shipping_activating,
    ty_product_gross_revenue_excl_shipping_nonactivating,
    ty_product_gross_revenue_excl_shipping_repeat,
    ty_product_gross_revenue_excl_shipping_guest,
    ty_total_product_margin_pre_return_excl_shipping,
    ty_product_margin_pre_return_excl_shipping_activating,
    ty_product_margin_pre_return_excl_shipping_nonactivating,
    ty_product_margin_pre_return_excl_shipping_repeat,
    ty_product_margin_pre_return_excl_shipping_guest,
    ty_total_product_cost,
    ty_product_cost_activating,
    ty_product_cost_nonactivating,
    ty_product_cost_repeat,
    ty_product_cost_guest,
    ty_total_product_cost_c,
    ty_product_cost_activating_c,
    ty_product_cost_nonactivating_c,
    ty_product_cost_repeat_c,
    ty_product_cost_guest_c,
    ty_total_non_reduced_vip_price,
    ty_non_reduced_vip_price_activating,
    ty_non_reduced_vip_price_nonactivating,
    ty_non_reduced_vip_price_repeat,
    ty_non_reduced_vip_price_guest,
    ty_total_return_unit_count,
    ty_return_unit_count_activating,
    ty_return_unit_count_nonactivating,
    ty_return_unit_count_repeat,
    ty_return_unit_count_guest,
    ty_total_returned_product_gross_rev_excluding_shipping,
    ty_returned_product_gross_rev_excluding_shipping_activating,
    ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    ty_returned_product_gross_rev_excluding_shipping_repeat,
    ty_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ty_bop_onhand_qty,
    0 AS ty_bop_available_to_sell_qty,
    0 AS ty_bop_open_to_buy_qty,
    0 AS ty_bop_open_to_buy_qty_incl_in_transit,
    0 AS ty_bop_retail_reserve,
    0 AS ty_bop_inventory_cost,
    0 AS ty_eop_onhand_qty,
    0 AS ty_eop_available_to_sell_qty,
    0 AS ty_eop_open_to_buy_qty,
    0 AS ty_eop_open_to_buy_qty_incl_in_transit,
    0 AS ty_eop_retail_reserve,
    0 AS ty_eop_inventory_cost,
    SUM(ty_total_unit_count) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_unit_count,
    SUM(ty_unit_count_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_unit_count_activating,
    SUM(ty_unit_count_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_unit_count_nonactivating,
    SUM(ty_unit_count_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_unit_count_repeat,
    SUM(ty_unit_count_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_unit_count_guest,
    SUM(ty_total_product_subtotal) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_subtotal,
    SUM(ty_product_subtotal_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_subtotal_activating,
    SUM(ty_product_subtotal_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_subtotal_nonactivating,
    SUM(ty_product_subtotal_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_subtotal_repeat,
    SUM(ty_product_subtotal_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_subtotal_guest,
    SUM(ty_total_product_discount) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_discount,
    SUM(ty_product_discount_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_discount_activating,
    SUM(ty_product_discount_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_discount_nonactivating,
    SUM(ty_product_discount_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_discount_repeat,
    SUM(ty_product_discount_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_discount_guest,
    SUM(ty_total_product_gross_revenue_excl_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_gross_revenue_excl_shipping,
    SUM(ty_product_gross_revenue_excl_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_activating,
    SUM(ty_product_gross_revenue_excl_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ty_product_gross_revenue_excl_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_repeat,
    SUM(ty_product_gross_revenue_excl_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_guest,
    SUM(ty_total_product_margin_pre_return_excl_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_margin_pre_return_excl_shipping,
    SUM(ty_product_margin_pre_return_excl_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_activating,
    SUM(ty_product_margin_pre_return_excl_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ty_product_margin_pre_return_excl_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_repeat,
    SUM(ty_product_margin_pre_return_excl_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_guest,
    SUM(ty_total_product_cost) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_cost,
    SUM(ty_product_cost_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_activating,
    SUM(ty_product_cost_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_nonactivating,
    SUM(ty_product_cost_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_repeat,
    SUM(ty_product_cost_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_guest,
    SUM(ty_total_product_cost_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_product_cost_c,
    SUM(ty_product_cost_activating_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_activating_c,
    SUM(ty_product_cost_nonactivating_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_nonactivating_c,
    SUM(ty_product_cost_repeat_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_repeat_c,
    SUM(ty_product_cost_guest_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_product_cost_guest_c,
    SUM(ty_total_non_reduced_vip_price) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_non_reduced_vip_price,
    SUM(ty_non_reduced_vip_price_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_non_reduced_vip_price_activating,
    SUM(ty_non_reduced_vip_price_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_non_reduced_vip_price_nonactivating,
    SUM(ty_non_reduced_vip_price_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_non_reduced_vip_price_repeat,
    SUM(ty_non_reduced_vip_price_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_non_reduced_vip_price_guest,
    SUM(ty_total_return_unit_count) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_return_unit_count,
    SUM(ty_return_unit_count_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_return_unit_count_activating,
    SUM(ty_return_unit_count_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_return_unit_count_nonactivating,
    SUM(ty_return_unit_count_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_return_unit_count_repeat,
    SUM(ty_return_unit_count_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_return_unit_count_guest,
    SUM(ty_total_returned_product_gross_rev_excluding_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_total_returned_product_gross_rev_excluding_shipping,
    SUM(ty_returned_product_gross_rev_excluding_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ty_returned_product_gross_rev_excluding_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS mtd_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_total_unit_count,
    ly_day_unit_count_activating,
    ly_day_unit_count_nonactivating,
    ly_day_unit_count_repeat,
    ly_day_unit_count_guest,
    ly_day_total_product_subtotal,
    ly_day_product_subtotal_activating,
    ly_day_product_subtotal_nonactivating,
    ly_day_product_subtotal_repeat,
    ly_day_product_subtotal_guest,
    ly_day_total_product_discount,
    ly_day_product_discount_activating,
    ly_day_product_discount_nonactivating,
    ly_day_product_discount_repeat,
    ly_day_product_discount_guest,
    ly_day_total_product_gross_revenue_excl_shipping,
    ly_day_product_gross_revenue_excl_shipping_activating,
    ly_day_product_gross_revenue_excl_shipping_nonactivating,
    ly_day_product_gross_revenue_excl_shipping_repeat,
    ly_day_product_gross_revenue_excl_shipping_guest,
    ly_day_total_product_margin_pre_return_excl_shipping,
    ly_day_product_margin_pre_return_excl_shipping_activating,
    ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    ly_day_product_margin_pre_return_excl_shipping_repeat,
    ly_day_product_margin_pre_return_excl_shipping_guest,
    ly_day_total_product_cost,
    ly_day_product_cost_activating,
    ly_day_product_cost_nonactivating,
    ly_day_product_cost_repeat,
    ly_day_product_cost_guest,
    ly_day_total_product_cost_c,
    ly_day_product_cost_activating_c,
    ly_day_product_cost_nonactivating_c,
    ly_day_product_cost_repeat_c,
    ly_day_product_cost_guest_c,
    ly_day_total_non_reduced_vip_price,
    ly_day_non_reduced_vip_price_activating,
    ly_day_non_reduced_vip_price_nonactivating,
    ly_day_non_reduced_vip_price_repeat,
    ly_day_non_reduced_vip_price_guest,
    ly_day_total_return_unit_count,
    ly_day_return_unit_count_activating,
    ly_day_return_unit_count_nonactivating,
    ly_day_return_unit_count_repeat,
    ly_day_return_unit_count_guest,
    ly_day_total_returned_product_gross_rev_excluding_shipping,
    ly_day_returned_product_gross_rev_excluding_shipping_activating,
    ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    ly_day_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_day_bop_onhand_qty,
    0 AS ly_day_bop_available_to_sell_qty,
    0 AS ly_day_bop_open_to_buy_qty,
    0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
    0 AS ly_day_bop_retail_reserve,
    0 AS ly_day_bop_inventory_cost,
    0 AS ly_day_eop_onhand_qty,
    0 AS ly_day_eop_available_to_sell_qty,
    0 AS ly_day_eop_open_to_buy_qty,
    0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
    0 AS ly_day_eop_retail_reserve,
    0 AS ly_day_eop_inventory_cost,
    /* Replace SUM(ly_day_) to SUM(ly_date_) to calculate LYMTD in the final output based on DATE and not DAY; naming conventions stayed the same to maintain consistency */
    SUM(ly_date_total_unit_count) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_unit_count,
    SUM(ly_date_unit_count_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_unit_count_activating,
    SUM(ly_date_unit_count_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_unit_count_nonactivating,
    SUM(ly_date_unit_count_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_unit_count_repeat,
    SUM(ly_date_unit_count_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_unit_count_guest,
    SUM(ly_date_total_product_subtotal) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_subtotal,
    SUM(ly_date_product_subtotal_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_subtotal_activating,
    SUM(ly_date_product_subtotal_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_subtotal_nonactivating,
    SUM(ly_date_product_subtotal_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_subtotal_repeat,
    SUM(ly_date_product_subtotal_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_subtotal_guest,
    SUM(ly_date_total_product_discount) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_discount,
    SUM(ly_date_product_discount_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_discount_activating,
    SUM(ly_date_product_discount_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_discount_nonactivating,
    SUM(ly_date_product_discount_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_discount_repeat,
    SUM(ly_date_product_discount_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_discount_guest,
    SUM(ly_date_total_product_gross_revenue_excl_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_gross_revenue_excl_shipping,
    SUM(ly_date_product_gross_revenue_excl_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_activating,
    SUM(ly_date_product_gross_revenue_excl_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ly_date_product_gross_revenue_excl_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_repeat,
    SUM(ly_date_product_gross_revenue_excl_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_guest,
    SUM(ly_date_total_product_margin_pre_return_excl_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_margin_pre_return_excl_shipping,
    SUM(ly_date_product_margin_pre_return_excl_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_activating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_repeat,
    SUM(ly_date_product_margin_pre_return_excl_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_guest,
    SUM(ly_date_total_product_cost) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_cost,
    SUM(ly_date_product_cost_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_activating,
    SUM(ly_date_product_cost_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_nonactivating,
    SUM(ly_date_product_cost_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_repeat,
    SUM(ly_date_product_cost_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_guest,
    SUM(ly_date_total_product_cost_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_product_cost_c,
    SUM(ly_date_product_cost_activating_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_activating_c,
    SUM(ly_date_product_cost_nonactivating_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_nonactivating_c,
    SUM(ly_date_product_cost_repeat_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_repeat_c,
    SUM(ly_date_product_cost_guest_c) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_product_cost_guest_c,
    SUM(ly_date_total_non_reduced_vip_price) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_non_reduced_vip_price,
    SUM(ly_date_non_reduced_vip_price_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_non_reduced_vip_price_activating,
    SUM(ly_date_non_reduced_vip_price_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_non_reduced_vip_price_nonactivating,
    SUM(ly_date_non_reduced_vip_price_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_non_reduced_vip_price_repeat,
    SUM(ly_date_non_reduced_vip_price_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_non_reduced_vip_price_guest,
    SUM(ly_date_total_return_unit_count) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_return_unit_count,
    SUM(ly_date_return_unit_count_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_return_unit_count_activating,
    SUM(ly_date_return_unit_count_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_return_unit_count_nonactivating,
    SUM(ly_date_return_unit_count_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_return_unit_count_repeat,
    SUM(ly_date_return_unit_count_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_return_unit_count_guest,
    SUM(ly_date_total_returned_product_gross_rev_excluding_shipping) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_total_returned_product_gross_rev_excluding_shipping,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_activating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_nonactivating) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_repeat) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_guest) OVER(PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, store_type, country, finance_specialty_store, region, product_brand, product_sku, base_sku, is_retail ORDER BY date) AS lymtd_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_total_unit_count,
    ly_date_unit_count_activating,
    ly_date_unit_count_nonactivating,
    ly_date_unit_count_repeat,
    ly_date_unit_count_guest,
    ly_date_total_product_subtotal,
    ly_date_product_subtotal_activating,
    ly_date_product_subtotal_nonactivating,
    ly_date_product_subtotal_repeat,
    ly_date_product_subtotal_guest,
    ly_date_total_product_discount,
    ly_date_product_discount_activating,
    ly_date_product_discount_nonactivating,
    ly_date_product_discount_repeat,
    ly_date_product_discount_guest,
    ly_date_total_product_gross_revenue_excl_shipping,
    ly_date_product_gross_revenue_excl_shipping_activating,
    ly_date_product_gross_revenue_excl_shipping_nonactivating,
    ly_date_product_gross_revenue_excl_shipping_repeat,
    ly_date_product_gross_revenue_excl_shipping_guest,
    ly_date_total_product_margin_pre_return_excl_shipping,
    ly_date_product_margin_pre_return_excl_shipping_activating,
    ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    ly_date_product_margin_pre_return_excl_shipping_repeat,
    ly_date_product_margin_pre_return_excl_shipping_guest,
    ly_date_total_product_cost,
    ly_date_product_cost_activating,
    ly_date_product_cost_nonactivating,
    ly_date_product_cost_repeat,
    ly_date_product_cost_guest,
    ly_date_total_product_cost_c,
    ly_date_product_cost_activating_c,
    ly_date_product_cost_nonactivating_c,
    ly_date_product_cost_repeat_c,
    ly_date_product_cost_guest_c,
    ly_date_total_non_reduced_vip_price,
    ly_date_non_reduced_vip_price_activating,
    ly_date_non_reduced_vip_price_nonactivating,
    ly_date_non_reduced_vip_price_repeat,
    ly_date_non_reduced_vip_price_guest,
    ly_date_total_return_unit_count,
    ly_date_return_unit_count_activating,
    ly_date_return_unit_count_nonactivating,
    ly_date_return_unit_count_repeat,
    ly_date_return_unit_count_guest,
    ly_date_total_returned_product_gross_rev_excluding_shipping,
    ly_date_returned_product_gross_rev_excluding_shipping_activating,
    ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    ly_date_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_date_bop_onhand_qty,
    0 AS ly_date_bop_available_to_sell_qty,
    0 AS ly_date_bop_open_to_buy_qty,
    0 AS ly_date_bop_open_to_buy_qty_incl_in_transit,
    0 AS ly_date_bop_retail_reserve,
    0 AS ly_date_bop_inventory_cost,
    0 AS ly_date_eop_onhand_qty,
    0 AS ly_date_eop_available_to_sell_qty,
    0 AS ly_date_eop_open_to_buy_qty,
    0 AS ly_date_eop_open_to_buy_qty_incl_in_transit,
    0 AS ly_date_eop_retail_reserve,
    0 AS ly_date_eop_inventory_cost,
    $meta_create_datetime AS meta_create_datetime,
    $meta_update_datetime AS meta_update_datetime
FROM _final_data
WHERE date >= $sales_from_date
    AND date < CURRENT_DATE()

UNION ALL

SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    0 AS ty_total_unit_count,
    0 AS ty_unit_count_activating,
    0 AS ty_unit_count_nonactivating,
    0 AS ty_unit_count_repeat,
    0 AS ty_unit_count_guest,
    0 AS ty_total_product_subtotal,
    0 AS ty_product_subtotal_activating,
    0 AS ty_product_subtotal_nonactivating,
    0 AS ty_product_subtotal_repeat,
    0 AS ty_product_subtotal_guest,
    0 AS ty_total_product_discount,
    0 AS ty_product_discount_activating,
    0 AS ty_product_discount_nonactivating,
    0 AS ty_product_discount_repeat,
    0 AS ty_product_discount_guest,
    0 AS ty_total_product_gross_revenue_excl_shipping,
    0 AS ty_product_gross_revenue_excl_shipping_activating,
    0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ty_product_gross_revenue_excl_shipping_repeat,
    0 AS ty_product_gross_revenue_excl_shipping_guest,
    0 AS ty_total_product_margin_pre_return_excl_shipping,
    0 AS ty_product_margin_pre_return_excl_shipping_activating,
    0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ty_product_margin_pre_return_excl_shipping_repeat,
    0 AS ty_product_margin_pre_return_excl_shipping_guest,
    0 AS ty_total_product_cost,
    0 AS ty_product_cost_activating,
    0 AS ty_product_cost_nonactivating,
    0 AS ty_product_cost_repeat,
    0 AS ty_product_cost_guest,
    0 AS ty_total_product_cost_c,
    0 AS ty_product_cost_activating_c,
    0 AS ty_product_cost_nonactivating_c,
    0 AS ty_product_cost_repeat_c,
    0 AS ty_product_cost_guest_c,
    0 AS ty_total_non_reduced_vip_price,
    0 AS ty_non_reduced_vip_price_activating,
    0 AS ty_non_reduced_vip_price_nonactivating,
    0 AS ty_non_reduced_vip_price_repeat,
    0 AS ty_non_reduced_vip_price_guest,
    0 AS ty_total_return_unit_count,
    0 AS ty_return_unit_count_activating,
    0 AS ty_return_unit_count_nonactivating,
    0 AS ty_return_unit_count_repeat,
    0 AS ty_return_unit_count_guest,
    0 AS ty_total_returned_product_gross_rev_excluding_shipping,
    0 AS ty_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ty_returned_product_gross_rev_excluding_shipping_guest,
    ty_bop_onhand_qty,
    ty_bop_available_to_sell_qty,
    ty_bop_open_to_buy_qty,
    ty_bop_open_to_buy_qty_incl_in_transit,
    ty_bop_retail_reserve,
    ty_bop_inventory_cost,
    ty_eop_onhand_qty,
    ty_eop_available_to_sell_qty,
    ty_eop_open_to_buy_qty,
    ty_eop_open_to_buy_qty_incl_in_transit,
    ty_eop_retail_reserve,
    ty_eop_inventory_cost,
    0 AS mtd_total_unit_count,
    0 AS mtd_unit_count_activating,
    0 AS mtd_unit_count_nonactivating,
    0 AS mtd_unit_count_repeat,
    0 AS mtd_unit_count_guest,
    0 AS mtd_total_product_subtotal,
    0 AS mtd_product_subtotal_activating,
    0 AS mtd_product_subtotal_nonactivating,
    0 AS mtd_product_subtotal_repeat,
    0 AS mtd_product_subtotal_guest,
    0 AS mtd_total_product_discount,
    0 AS mtd_product_discount_activating,
    0 AS mtd_product_discount_nonactivating,
    0 AS mtd_product_discount_repeat,
    0 AS mtd_product_discount_guest,
    0 AS mtd_total_product_gross_revenue_excl_shipping,
    0 AS mtd_product_gross_revenue_excl_shipping_activating,
    0 AS mtd_product_gross_revenue_excl_shipping_nonactivating,
    0 AS mtd_product_gross_revenue_excl_shipping_repeat,
    0 AS mtd_product_gross_revenue_excl_shipping_guest,
    0 AS mtd_total_product_margin_pre_return_excl_shipping,
    0 AS mtd_product_margin_pre_return_excl_shipping_activating,
    0 AS mtd_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS mtd_product_margin_pre_return_excl_shipping_repeat,
    0 AS mtd_product_margin_pre_return_excl_shipping_guest,
    0 AS mtd_total_product_cost,
    0 AS mtd_product_cost_activating,
    0 AS mtd_product_cost_nonactivating,
    0 AS mtd_product_cost_repeat,
    0 AS mtd_product_cost_guest,
    0 AS mtd_total_product_cost_c,
    0 AS mtd_product_cost_activating_c,
    0 AS mtd_product_cost_nonactivating_c,
    0 AS mtd_product_cost_repeat_c,
    0 AS mtd_product_cost_guest_c,
    0 AS mtd_total_non_reduced_vip_price,
    0 AS mtd_non_reduced_vip_price_activating,
    0 AS mtd_non_reduced_vip_price_nonactivating,
    0 AS mtd_non_reduced_vip_price_repeat,
    0 AS mtd_non_reduced_vip_price_guest,
    0 AS mtd_total_return_unit_count,
    0 AS mtd_return_unit_count_activating,
    0 AS mtd_return_unit_count_nonactivating,
    0 AS mtd_return_unit_count_repeat,
    0 AS mtd_return_unit_count_guest,
    0 AS mtd_total_returned_product_gross_rev_excluding_shipping,
    0 AS mtd_returned_product_gross_rev_excluding_shipping_activating,
    0 AS mtd_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS mtd_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS mtd_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_day_total_unit_count,
    0 AS ly_day_unit_count_activating,
    0 AS ly_day_unit_count_nonactivating,
    0 AS ly_day_unit_count_repeat,
    0 AS ly_day_unit_count_guest,
    0 AS ly_day_total_product_subtotal,
    0 AS ly_day_product_subtotal_activating,
    0 AS ly_day_product_subtotal_nonactivating,
    0 AS ly_day_product_subtotal_repeat,
    0 AS ly_day_product_subtotal_guest,
    0 AS ly_day_total_product_discount,
    0 AS ly_day_product_discount_activating,
    0 AS ly_day_product_discount_nonactivating,
    0 AS ly_day_product_discount_repeat,
    0 AS ly_day_product_discount_guest,
    0 AS ly_day_total_product_gross_revenue_excl_shipping,
    0 AS ly_day_product_gross_revenue_excl_shipping_activating,
    0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_day_product_gross_revenue_excl_shipping_guest,
    0 AS ly_day_total_product_margin_pre_return_excl_shipping,
    0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_day_total_product_cost,
    0 AS ly_day_product_cost_activating,
    0 AS ly_day_product_cost_nonactivating,
    0 AS ly_day_product_cost_repeat,
    0 AS ly_day_product_cost_guest,
    0 AS ly_day_total_product_cost_c,
    0 AS ly_day_product_cost_activating_c,
    0 AS ly_day_product_cost_nonactivating_c,
    0 AS ly_day_product_cost_repeat_c,
    0 AS ly_day_product_cost_guest_c,
    0 AS ly_day_total_non_reduced_vip_price,
    0 AS ly_day_non_reduced_vip_price_activating,
    0 AS ly_day_non_reduced_vip_price_nonactivating,
    0 AS ly_day_non_reduced_vip_price_repeat,
    0 AS ly_day_non_reduced_vip_price_guest,
    0 AS ly_day_total_return_unit_count,
    0 AS ly_day_return_unit_count_activating,
    0 AS ly_day_return_unit_count_nonactivating,
    0 AS ly_day_return_unit_count_repeat,
    0 AS ly_day_return_unit_count_guest,
    0 AS ly_day_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_bop_onhand_qty,
    ly_day_bop_available_to_sell_qty,
    ly_day_bop_open_to_buy_qty,
    ly_day_bop_open_to_buy_qty_incl_in_transit,
    ly_day_bop_retail_reserve,
    ly_day_bop_inventory_cost,
    ly_day_eop_onhand_qty,
    ly_day_eop_available_to_sell_qty,
    ly_day_eop_open_to_buy_qty,
    ly_day_eop_open_to_buy_qty_incl_in_transit,
    ly_day_eop_retail_reserve,
    ly_day_eop_inventory_cost,
    0 AS lymtd_day_total_unit_count,
    0 AS lymtd_day_unit_count_activating,
    0 AS lymtd_day_unit_count_nonactivating,
    0 AS lymtd_day_unit_count_repeat,
    0 AS lymtd_day_unit_count_guest,
    0 AS lymtd_day_total_product_subtotal,
    0 AS lymtd_day_product_subtotal_activating,
    0 AS lymtd_day_product_subtotal_nonactivating,
    0 AS lymtd_day_product_subtotal_repeat,
    0 AS lymtd_day_product_subtotal_guest,
    0 AS lymtd_day_total_product_discount,
    0 AS lymtd_day_product_discount_activating,
    0 AS lymtd_day_product_discount_nonactivating,
    0 AS lymtd_day_product_discount_repeat,
    0 AS lymtd_day_product_discount_guest,
    0 AS lymtd_day_total_product_gross_revenue_excl_shipping,
    0 AS lymtd_day_product_gross_revenue_excl_shipping_activating,
    0 AS lymtd_day_product_gross_revenue_excl_shipping_nonactivating,
    0 AS lymtd_day_product_gross_revenue_excl_shipping_repeat,
    0 AS lymtd_day_product_gross_revenue_excl_shipping_guest,
    0 AS lymtd_day_total_product_margin_pre_return_excl_shipping,
    0 AS lymtd_day_product_margin_pre_return_excl_shipping_activating,
    0 AS lymtd_day_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS lymtd_day_product_margin_pre_return_excl_shipping_repeat,
    0 AS lymtd_day_product_margin_pre_return_excl_shipping_guest,
    0 AS lymtd_day_total_product_cost,
    0 AS lymtd_day_product_cost_activating,
    0 AS lymtd_day_product_cost_nonactivating,
    0 AS lymtd_day_product_cost_repeat,
    0 AS lymtd_day_product_cost_guest,
    0 AS lymtd_day_total_product_cost_c,
    0 AS lymtd_day_product_cost_activating_c,
    0 AS lymtd_day_product_cost_nonactivating_c,
    0 AS lymtd_day_product_cost_repeat_c,
    0 AS lymtd_day_product_cost_guest_c,
    0 AS lymtd_day_total_non_reduced_vip_price,
    0 AS lymtd_day_non_reduced_vip_price_activating,
    0 AS lymtd_day_non_reduced_vip_price_nonactivating,
    0 AS lymtd_day_non_reduced_vip_price_repeat,
    0 AS lymtd_day_non_reduced_vip_price_guest,
    0 AS lymtd_day_total_return_unit_count,
    0 AS lymtd_day_return_unit_count_activating,
    0 AS lymtd_day_return_unit_count_nonactivating,
    0 AS lymtd_day_return_unit_count_repeat,
    0 AS lymtd_day_return_unit_count_guest,
    0 AS lymtd_day_total_returned_product_gross_rev_excluding_shipping,
    0 AS lymtd_day_returned_product_gross_rev_excluding_shipping_activating,
    0 AS lymtd_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS lymtd_day_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS lymtd_day_returned_product_gross_rev_excluding_shipping_guest,
    0 AS ly_date_total_unit_count,
    0 AS ly_date_unit_count_activating,
    0 AS ly_date_unit_count_nonactivating,
    0 AS ly_date_unit_count_repeat,
    0 AS ly_date_unit_count_guest,
    0 AS ly_date_total_product_subtotal,
    0 AS ly_date_product_subtotal_activating,
    0 AS ly_date_product_subtotal_nonactivating,
    0 AS ly_date_product_subtotal_repeat,
    0 AS ly_date_product_subtotal_guest,
    0 AS ly_date_total_product_discount,
    0 AS ly_date_product_discount_activating,
    0 AS ly_date_product_discount_nonactivating,
    0 AS ly_date_product_discount_repeat,
    0 AS ly_date_product_discount_guest,
    0 AS ly_date_total_product_gross_revenue_excl_shipping,
    0 AS ly_date_product_gross_revenue_excl_shipping_activating,
    0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_date_product_gross_revenue_excl_shipping_guest,
    0 AS ly_date_total_product_margin_pre_return_excl_shipping,
    0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_date_total_product_cost,
    0 AS ly_date_product_cost_activating,
    0 AS ly_date_product_cost_nonactivating,
    0 AS ly_date_product_cost_repeat,
    0 AS ly_date_product_cost_guest,
    0 AS ly_date_total_product_cost_c,
    0 AS ly_date_product_cost_activating_c,
    0 AS ly_date_product_cost_nonactivating_c,
    0 AS ly_date_product_cost_repeat_c,
    0 AS ly_date_product_cost_guest_c,
    0 AS ly_date_total_non_reduced_vip_price,
    0 AS ly_date_non_reduced_vip_price_activating,
    0 AS ly_date_non_reduced_vip_price_nonactivating,
    0 AS ly_date_non_reduced_vip_price_repeat,
    0 AS ly_date_non_reduced_vip_price_guest,
    0 AS ly_date_total_return_unit_count,
    0 AS ly_date_return_unit_count_activating,
    0 AS ly_date_return_unit_count_nonactivating,
    0 AS ly_date_return_unit_count_repeat,
    0 AS ly_date_return_unit_count_guest,
    0 AS ly_date_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_bop_onhand_qty,
    ly_date_bop_available_to_sell_qty,
    ly_date_bop_open_to_buy_qty,
    ly_date_bop_open_to_buy_qty_incl_in_transit,
    ly_date_bop_retail_reserve,
    ly_date_bop_inventory_cost,
    ly_date_eop_onhand_qty,
    ly_date_eop_available_to_sell_qty,
    ly_date_eop_open_to_buy_qty,
    ly_date_eop_open_to_buy_qty_incl_in_transit,
    ly_date_eop_retail_reserve,
    ly_date_eop_inventory_cost,
    $meta_create_datetime AS meta_create_datetime,
    $meta_update_datetime AS meta_update_datetime
FROM _base_calculations_inventory
WHERE date >= $inventory_from_date
    AND date < CURRENT_DATE();

COMMIT;

UPDATE stg.meta_table_dependency_watermark
SET high_watermark_datetime = IFF(dependent_table_name IS NOT NULL, new_high_watermark_datetime,
        (SELECT MAX(meta_update_datetime) AS new_high_watermark_datetime FROM reporting.merch_planning_item_product_sku)),
    meta_update_datetime = CURRENT_TIMESTAMP()
WHERE table_name = $target_table;
