SET execution_start_time = CURRENT_TIMESTAMP :: TIMESTAMP_LTZ(3);
SET target_table = 'reporting.merch_planning_item_sku';
SET is_full_refresh = (SELECT CASE
                                  WHEN stg.udf_get_watermark($target_table, NULL) = '1900-01-01' THEN TRUE
                                  WHEN MAX(full_date) = CURRENT_DATE THEN TRUE
                                  ELSE FALSE END
                       FROM data_model.dim_date
                       WHERE month_date = DATE_TRUNC('month', CURRENT_DATE)
                         AND day_name_of_week = 'Friday');

MERGE INTO stg.meta_table_dependency_watermark AS w
USING (
    SELECT
        $target_table AS table_name,
        NULL AS dependent_table_name,
        (
            SELECT MAX(meta_update_datetime) AS new_high_watermark_datetime
            FROM reporting.merch_planning_item_sku
        ) AS new_high_watermark_datetime
    ) AS s
    ON w.table_name = s.table_name
    AND w.dependent_table_name IS NOT DISTINCT FROM s.dependent_table_name
WHEN NOT MATCHED THEN
    INSERT (
        table_name,
        dependent_table_name,
        high_watermark_datetime,
        new_high_watermark_datetime
        )
    VALUES (
        s.table_name,
        s.dependent_table_name,
        '1900-01-01', -- current high_watermark_datetime
        s.new_high_watermark_datetime
        )
WHEN MATCHED AND w.new_high_watermark_datetime IS DISTINCT FROM s.new_high_watermark_datetime THEN
    UPDATE
    SET w.new_high_watermark_datetime = s.new_high_watermark_datetime,
        w.meta_update_datetime = CURRENT_TIMESTAMP::TIMESTAMP_LTZ(3);

/*
Incremental Logic
    Variables:
        inventory_date = Next day of Maximum date for Inventory data in the merch_planning_item_sku.
                        2019-01-01 if null
        sales_date: Minimum date in Max date for each date_type (Placed, Shipped, Returns)
        process_from_date: month date of sales_date - 3 months. 2019-01-01 if null
    Inventory Logic: Processes the data from inventory_date
    Sales Logic: Processes the data from process_from_date

    Change made on Oct 18, 2023:
    Changing the minimum dates to 2018-01-01 instead of 2019-01-01 so that Savage Team has historic visibility.

*/
-- SET is_full_refresh =
--     (SELECT CASE WHEN CURRENT_DATE() = MAX(full_date) THEN TRUE ELSE FALSE END
--      FROM data_model.dim_date
--      WHERE day_name_of_week = 'Friday'
--        AND month_date = DATE_TRUNC('month', CURRENT_DATE)
--     );

SET inventory_date = (
    SELECT CASE WHEN $is_full_refresh = TRUE THEN '2018-01-01' ELSE  COALESCE(MAX(date), '2018-01-01'::DATE) END
    FROM reporting.merch_planning_item_sku
    WHERE date_type = 'Inventory'
);

DELETE FROM reporting.merch_planning_item_sku
WHERE date_type = 'Inventory'
    AND date >= $inventory_date;

SET sales_date = (
    SELECT MIN(max_date) AS date
    FROM (
        SELECT date_type, MAX(date) AS max_date
        FROM reporting.merch_planning_item_sku
        WHERE date_type <> 'Inventory'
        GROUP BY date_type
    )a
);


SET process_from_date = (SELECT CASE WHEN $is_full_refresh = TRUE THEN '2018-01-01'
    ELSE COALESCE(DATEADD('MONTH', -3, DATE_TRUNC('MONTH', $sales_date))::DATE, '2018-01-01'::DATE) END );

BEGIN TRANSACTION;

DELETE FROM reporting.merch_planning_item_sku
WHERE date_type <> 'Inventory'
    AND date >= $process_from_date;

SET warehouse_to_be_used = IFF($process_from_date = '2018-01-01', 'da_wh_adhoc_large', CURRENT_WAREHOUSE());
USE WAREHOUSE IDENTIFIER ($warehouse_to_be_used);


INSERT INTO reporting.merch_planning_item_sku(
    date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    ty_total_unit_count,
    ty_unit_count_activating,
    ty_unit_count_nonactivating,
    ty_unit_count_repeat,
    ty_unit_count_guest,
    ty_total_product_subtotal,
    ty_product_subtotal_activating,
    ty_product_subtotal_nonactivating,
    ty_product_subtotal_repeat,
    ty_product_subtotal_guest,
    ty_total_product_discount,
    ty_product_discount_activating,
    ty_product_discount_nonactivating,
    ty_product_discount_repeat,
    ty_product_discount_guest,
    ty_total_product_gross_revenue_excl_shipping,
    ty_product_gross_revenue_excl_shipping_activating,
    ty_product_gross_revenue_excl_shipping_nonactivating,
    ty_product_gross_revenue_excl_shipping_repeat,
    ty_product_gross_revenue_excl_shipping_guest,
    ty_total_product_margin_pre_return_excl_shipping,
    ty_product_margin_pre_return_excl_shipping_activating,
    ty_product_margin_pre_return_excl_shipping_nonactivating,
    ty_product_margin_pre_return_excl_shipping_repeat,
    ty_product_margin_pre_return_excl_shipping_guest,
    ty_total_product_cost,
    ty_product_cost_activating,
    ty_product_cost_nonactivating,
    ty_product_cost_repeat,
    ty_product_cost_guest,
    ty_total_product_cost_c,
    ty_product_cost_activating_c,
    ty_product_cost_nonactivating_c,
    ty_product_cost_repeat_c,
    ty_product_cost_guest_c,
    ty_total_non_reduced_vip_price,
    ty_non_reduced_vip_price_activating,
    ty_non_reduced_vip_price_nonactivating,
    ty_non_reduced_vip_price_repeat,
    ty_non_reduced_vip_price_guest,
    ty_total_return_unit_count,
    ty_return_unit_count_activating,
    ty_return_unit_count_nonactivating,
    ty_return_unit_count_repeat,
    ty_return_unit_count_guest,
    ty_total_returned_product_gross_rev_excluding_shipping,
    ty_returned_product_gross_rev_excluding_shipping_activating,
    ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    ty_returned_product_gross_rev_excluding_shipping_repeat,
    ty_returned_product_gross_rev_excluding_shipping_guest,
    ty_bop_onhand_qty,
    ty_bop_available_to_sell_qty,
    ty_bop_open_to_buy_qty,
    ty_bop_open_to_buy_qty_incl_in_transit,
    ty_bop_retail_reserve,
    ty_bop_inventory_cost,
    ty_eop_onhand_qty,
    ty_eop_available_to_sell_qty,
    ty_eop_open_to_buy_qty,
    ty_eop_open_to_buy_qty_incl_in_transit,
    ty_eop_retail_reserve,
    ty_eop_inventory_cost,
    ly_day_total_unit_count,
    ly_day_unit_count_activating,
    ly_day_unit_count_nonactivating,
    ly_day_unit_count_repeat,
    ly_day_unit_count_guest,
    ly_day_total_product_subtotal,
    ly_day_product_subtotal_activating,
    ly_day_product_subtotal_nonactivating,
    ly_day_product_subtotal_repeat,
    ly_day_product_subtotal_guest,
    ly_day_total_product_discount,
    ly_day_product_discount_activating,
    ly_day_product_discount_nonactivating,
    ly_day_product_discount_repeat,
    ly_day_product_discount_guest,
    ly_day_total_product_gross_revenue_excl_shipping,
    ly_day_product_gross_revenue_excl_shipping_activating,
    ly_day_product_gross_revenue_excl_shipping_nonactivating,
    ly_day_product_gross_revenue_excl_shipping_repeat,
    ly_day_product_gross_revenue_excl_shipping_guest,
    ly_day_total_product_margin_pre_return_excl_shipping,
    ly_day_product_margin_pre_return_excl_shipping_activating,
    ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    ly_day_product_margin_pre_return_excl_shipping_repeat,
    ly_day_product_margin_pre_return_excl_shipping_guest,
    ly_day_total_product_cost,
    ly_day_product_cost_activating,
    ly_day_product_cost_nonactivating,
    ly_day_product_cost_repeat,
    ly_day_product_cost_guest,
    ly_day_total_product_cost_c,
    ly_day_product_cost_activating_c,
    ly_day_product_cost_nonactivating_c,
    ly_day_product_cost_repeat_c,
    ly_day_product_cost_guest_c,
    ly_day_total_non_reduced_vip_price,
    ly_day_non_reduced_vip_price_activating,
    ly_day_non_reduced_vip_price_nonactivating,
    ly_day_non_reduced_vip_price_repeat,
    ly_day_non_reduced_vip_price_guest,
    ly_day_total_return_unit_count,
    ly_day_return_unit_count_activating,
    ly_day_return_unit_count_nonactivating,
    ly_day_return_unit_count_repeat,
    ly_day_return_unit_count_guest,
    ly_day_total_returned_product_gross_rev_excluding_shipping,
    ly_day_returned_product_gross_rev_excluding_shipping_activating,
    ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    ly_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_bop_onhand_qty,
    ly_day_bop_available_to_sell_qty,
    ly_day_bop_open_to_buy_qty,
    ly_day_bop_open_to_buy_qty_incl_in_transit,
    ly_day_bop_retail_reserve,
    ly_day_bop_inventory_cost,
    ly_day_eop_onhand_qty,
    ly_day_eop_available_to_sell_qty,
    ly_day_eop_open_to_buy_qty,
    ly_day_eop_open_to_buy_qty_incl_in_transit,
    ly_day_eop_retail_reserve,
    ly_day_eop_inventory_cost,
    ly_date_total_unit_count,
    ly_date_unit_count_activating,
    ly_date_unit_count_nonactivating,
    ly_date_unit_count_repeat,
    ly_date_unit_count_guest,
    ly_date_total_product_subtotal,
    ly_date_product_subtotal_activating,
    ly_date_product_subtotal_nonactivating,
    ly_date_product_subtotal_repeat,
    ly_date_product_subtotal_guest,
    ly_date_total_product_discount,
    ly_date_product_discount_activating,
    ly_date_product_discount_nonactivating,
    ly_date_product_discount_repeat,
    ly_date_product_discount_guest,
    ly_date_total_product_gross_revenue_excl_shipping,
    ly_date_product_gross_revenue_excl_shipping_activating,
    ly_date_product_gross_revenue_excl_shipping_nonactivating,
    ly_date_product_gross_revenue_excl_shipping_repeat,
    ly_date_product_gross_revenue_excl_shipping_guest,
    ly_date_total_product_margin_pre_return_excl_shipping,
    ly_date_product_margin_pre_return_excl_shipping_activating,
    ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    ly_date_product_margin_pre_return_excl_shipping_repeat,
    ly_date_product_margin_pre_return_excl_shipping_guest,
    ly_date_total_product_cost,
    ly_date_product_cost_activating,
    ly_date_product_cost_nonactivating,
    ly_date_product_cost_repeat,
    ly_date_product_cost_guest,
    ly_date_total_product_cost_c,
    ly_date_product_cost_activating_c,
    ly_date_product_cost_nonactivating_c,
    ly_date_product_cost_repeat_c,
    ly_date_product_cost_guest_c,
    ly_date_total_non_reduced_vip_price,
    ly_date_non_reduced_vip_price_activating,
    ly_date_non_reduced_vip_price_nonactivating,
    ly_date_non_reduced_vip_price_repeat,
    ly_date_non_reduced_vip_price_guest,
    ly_date_total_return_unit_count,
    ly_date_return_unit_count_activating,
    ly_date_return_unit_count_nonactivating,
    ly_date_return_unit_count_repeat,
    ly_date_return_unit_count_guest,
    ly_date_total_returned_product_gross_rev_excluding_shipping,
    ly_date_returned_product_gross_rev_excluding_shipping_activating,
    ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    ly_date_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_bop_onhand_qty,
    ly_date_bop_available_to_sell_qty,
    ly_date_bop_open_to_buy_qty,
    ly_date_bop_open_to_buy_qty_incl_in_transit,
    ly_date_bop_retail_reserve,
    ly_date_bop_inventory_cost,
    ly_date_eop_onhand_qty,
    ly_date_eop_available_to_sell_qty,
    ly_date_eop_open_to_buy_qty,
    ly_date_eop_open_to_buy_qty_incl_in_transit,
    ly_date_eop_retail_reserve,
    ly_date_eop_inventory_cost,
    meta_create_datetime,
    meta_update_datetime
)
with _basic_aggregation AS
(
    SELECT date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        store_brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        SUM(COALESCE(unit_count, 0)) AS total_unit_count,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(unit_count, 0), 0)) AS unit_count_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(unit_count, 0), 0)) AS unit_count_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(unit_count, 0), 0)) AS unit_count_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(unit_count, 0), 0)) AS unit_count_guest,
        SUM(COALESCE(product_order_subtotal, 0)) AS total_product_subtotal,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_order_subtotal, 0), 0)) AS product_subtotal_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_order_subtotal, 0), 0)) AS product_subtotal_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_order_subtotal, 0), 0)) AS product_subtotal_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_order_subtotal, 0), 0)) AS product_subtotal_guest,
        SUM(COALESCE(product_order_discount, 0)) AS total_product_discount,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_order_discount, 0), 0)) AS product_discount_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_order_discount, 0), 0)) AS product_discount_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_order_discount, 0), 0)) AS product_discount_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_order_discount, 0), 0)) AS product_discount_guest,
        SUM(COALESCE(product_order_gross_revenue_excl_shipping, 0)) AS total_product_gross_revenue_excl_shipping,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_order_gross_revenue_excl_shipping, 0), 0)) AS product_gross_revenue_excl_shipping_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_order_gross_revenue_excl_shipping, 0), 0)) AS product_gross_revenue_excl_shipping_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_order_gross_revenue_excl_shipping, 0), 0)) AS product_gross_revenue_excl_shipping_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_order_gross_revenue_excl_shipping, 0), 0)) AS product_gross_revenue_excl_shipping_guest,
        SUM(COALESCE(product_order_margin_pre_return_excl_shipping, 0)) AS total_product_margin_pre_return_excl_shipping,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_order_margin_pre_return_excl_shipping, 0), 0)) AS product_margin_pre_return_excl_shipping_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_order_margin_pre_return_excl_shipping, 0), 0)) AS product_margin_pre_return_excl_shipping_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_order_margin_pre_return_excl_shipping, 0), 0)) AS product_margin_pre_return_excl_shipping_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_order_margin_pre_return_excl_shipping, 0), 0)) AS product_margin_pre_return_excl_shipping_guest,
        SUM(COALESCE(product_cost, 0)) AS total_product_cost,
        SUM(COALESCE(product_cost_c, 0)) AS total_product_cost_c,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_cost, 0), 0)) AS product_cost_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_cost, 0), 0)) AS product_cost_nonactivating,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(product_cost_c, 0), 0)) AS product_cost_activating_c,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(product_cost_c, 0), 0)) AS product_cost_nonactivating_c,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_cost, 0), 0)) AS product_cost_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(product_cost_c, 0), 0)) AS product_cost_repeat_c,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_cost, 0), 0)) AS product_cost_guest,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(product_cost_c, 0), 0)) AS product_cost_guest_c,
        SUM(COALESCE(non_reduced_vip_price, 0)) AS total_non_reduced_vip_price,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(non_reduced_vip_price, 0), 0)) AS non_reduced_vip_price_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(non_reduced_vip_price, 0), 0)) AS non_reduced_vip_price_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(non_reduced_vip_price, 0), 0)) AS non_reduced_vip_price_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(non_reduced_vip_price, 0), 0)) AS non_reduced_vip_price_guest,
        SUM(COALESCE(return_unit_count, 0)) AS total_return_unit_count,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(return_unit_count, 0), 0)) AS return_unit_count_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(return_unit_count, 0), 0)) AS return_unit_count_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(return_unit_count, 0), 0)) AS return_unit_count_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(return_unit_count, 0), 0)) AS return_unit_count_guest,
        SUM(COALESCE(returned_product_gross_rev_excluding_shipping, 0)) AS total_returned_product_gross_rev_excluding_shipping,
        SUM(IFF(membership_order_type_l2 = 'Activating VIP', COALESCE(returned_product_gross_rev_excluding_shipping, 0), 0)) AS returned_product_gross_rev_excluding_shipping_activating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP','Guest'), COALESCE(returned_product_gross_rev_excluding_shipping, 0), 0)) AS returned_product_gross_rev_excluding_shipping_nonactivating,
        SUM(IFF(membership_order_type_l2 IN ('Repeat VIP'), COALESCE(returned_product_gross_rev_excluding_shipping, 0), 0)) AS returned_product_gross_rev_excluding_shipping_repeat,
        SUM(IFF(membership_order_type_l2 IN ('Guest'), COALESCE(returned_product_gross_rev_excluding_shipping, 0), 0)) AS returned_product_gross_rev_excluding_shipping_guest,
        0 AS bop_onhand_qty,
        0 AS bop_available_to_sell_qty,
        0 AS bop_open_to_buy_qty,
        0 AS bop_open_to_buy_qty_incl_in_transit,
        0 AS bop_retail_reserve,
        0 AS bop_inventory_cost,
        0 AS eop_onhand_qty,
        0 AS eop_available_to_sell_qty,
        0 AS eop_open_to_buy_qty,
        0 AS eop_open_to_buy_qty_incl_in_transit,
        0 AS eop_retail_reserve,
        0 AS eop_inventory_cost
    FROM analytics_base.sales_returns_agg
    WHERE date IN (
        WITH _reprocessing_date AS(
            SELECT full_date
            FROM data_model.dim_date
            WHERE full_date >= $process_from_date
                AND full_date <= CURRENT_DATE()
        )
        SELECT full_date
        FROM _reprocessing_date
        UNION
        SELECT full_date - 364
        FROM _reprocessing_date
        UNION
        SELECT DATEADD(YEAR, -1, full_date)
        FROM _reprocessing_date
    )
    GROUP BY date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        store_brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail
),
_ly_ty_metrics AS(
    SELECT date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        store_brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        total_unit_count AS ty_total_unit_count,
        unit_count_activating AS ty_unit_count_activating,
        unit_count_nonactivating AS ty_unit_count_nonactivating,
        unit_count_repeat AS ty_unit_count_repeat,
        unit_count_guest AS ty_unit_count_guest,
        total_product_subtotal AS ty_total_product_subtotal,
        product_subtotal_activating AS ty_product_subtotal_activating,
        product_subtotal_nonactivating AS ty_product_subtotal_nonactivating,
        product_subtotal_repeat AS ty_product_subtotal_repeat,
        product_subtotal_guest AS ty_product_subtotal_guest,
        total_product_discount AS ty_total_product_discount,
        product_discount_activating AS ty_product_discount_activating,
        product_discount_nonactivating AS ty_product_discount_nonactivating,
        product_discount_repeat AS ty_product_discount_repeat,
        product_discount_guest AS ty_product_discount_guest,
        total_product_gross_revenue_excl_shipping AS ty_total_product_gross_revenue_excl_shipping,
        product_gross_revenue_excl_shipping_activating AS ty_product_gross_revenue_excl_shipping_activating,
        product_gross_revenue_excl_shipping_nonactivating AS ty_product_gross_revenue_excl_shipping_nonactivating,
        product_gross_revenue_excl_shipping_repeat AS ty_product_gross_revenue_excl_shipping_repeat,
        product_gross_revenue_excl_shipping_guest AS ty_product_gross_revenue_excl_shipping_guest,
        total_product_margin_pre_return_excl_shipping AS ty_total_product_margin_pre_return_excl_shipping,
        product_margin_pre_return_excl_shipping_activating AS ty_product_margin_pre_return_excl_shipping_activating,
        product_margin_pre_return_excl_shipping_nonactivating AS ty_product_margin_pre_return_excl_shipping_nonactivating,
        product_margin_pre_return_excl_shipping_repeat AS ty_product_margin_pre_return_excl_shipping_repeat,
        product_margin_pre_return_excl_shipping_guest AS ty_product_margin_pre_return_excl_shipping_guest,
        total_product_cost AS ty_total_product_cost,
        product_cost_activating AS ty_product_cost_activating,
        product_cost_nonactivating AS ty_product_cost_nonactivating,
        product_cost_repeat AS ty_product_cost_repeat,
        product_cost_guest AS ty_product_cost_guest,
        total_product_cost_c AS ty_total_product_cost_c,
        product_cost_activating_c AS ty_product_cost_activating_c,
        product_cost_nonactivating_c AS ty_product_cost_nonactivating_c,
        product_cost_repeat_c AS ty_product_cost_repeat_c,
        product_cost_guest_c AS ty_product_cost_guest_c,
        total_non_reduced_vip_price AS ty_total_non_reduced_vip_price,
        non_reduced_vip_price_activating AS ty_non_reduced_vip_price_activating,
        non_reduced_vip_price_nonactivating AS ty_non_reduced_vip_price_nonactivating,
        non_reduced_vip_price_repeat AS ty_non_reduced_vip_price_repeat,
        non_reduced_vip_price_guest AS ty_non_reduced_vip_price_guest,
        total_return_unit_count AS ty_total_return_unit_count,
        return_unit_count_activating AS ty_return_unit_count_activating,
        return_unit_count_nonactivating AS ty_return_unit_count_nonactivating,
        return_unit_count_repeat AS ty_return_unit_count_repeat,
        return_unit_count_guest AS ty_return_unit_count_guest,
        total_returned_product_gross_rev_excluding_shipping AS ty_total_returned_product_gross_rev_excluding_shipping,
        returned_product_gross_rev_excluding_shipping_activating AS ty_returned_product_gross_rev_excluding_shipping_activating,
        returned_product_gross_rev_excluding_shipping_nonactivating AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
        returned_product_gross_rev_excluding_shipping_repeat AS ty_returned_product_gross_rev_excluding_shipping_repeat,
        returned_product_gross_rev_excluding_shipping_guest AS ty_returned_product_gross_rev_excluding_shipping_guest,
        bop_onhand_qty AS ty_bop_onhand_qty,
        bop_available_to_sell_qty AS ty_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ty_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ty_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ty_bop_retail_reserve,
        bop_inventory_cost AS ty_bop_inventory_cost,
        eop_onhand_qty AS ty_eop_onhand_qty,
        eop_available_to_sell_qty AS ty_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ty_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ty_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ty_eop_retail_reserve,
        eop_inventory_cost AS ty_eop_inventory_cost,
        0 AS ly_day_total_unit_count,
        0 AS ly_day_unit_count_activating,
        0 AS ly_day_unit_count_nonactivating,
        0 AS ly_day_unit_count_repeat,
        0 AS ly_day_unit_count_guest,
        0 AS ly_day_total_product_subtotal,
        0 AS ly_day_product_subtotal_activating,
        0 AS ly_day_product_subtotal_nonactivating,
        0 AS ly_day_product_subtotal_repeat,
        0 AS ly_day_product_subtotal_guest,
        0 AS ly_day_total_product_discount,
        0 AS ly_day_product_discount_activating,
        0 AS ly_day_product_discount_nonactivating,
        0 AS ly_day_product_discount_repeat,
        0 AS ly_day_product_discount_guest,
        0 AS ly_day_total_product_gross_revenue_excl_shipping,
        0 AS ly_day_product_gross_revenue_excl_shipping_activating,
        0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
        0 AS ly_day_product_gross_revenue_excl_shipping_guest,
        0 AS ly_day_total_product_margin_pre_return_excl_shipping,
        0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
        0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
        0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
        0 AS ly_day_total_product_cost,
        0 AS ly_day_product_cost_activating,
        0 AS ly_day_product_cost_nonactivating,
        0 AS ly_day_product_cost_repeat,
        0 AS ly_day_product_cost_guest,
        0 AS ly_day_total_product_cost_c,
        0 AS ly_day_product_cost_activating_c,
        0 AS ly_day_product_cost_nonactivating_c,
        0 AS ly_day_product_cost_repeat_c,
        0 AS ly_day_product_cost_guest_c,
        0 AS ly_day_total_non_reduced_vip_price,
        0 AS ly_day_non_reduced_vip_price_activating,
        0 AS ly_day_non_reduced_vip_price_nonactivating,
        0 AS ly_day_non_reduced_vip_price_repeat,
        0 AS ly_day_non_reduced_vip_price_guest,
        0 AS ly_day_total_return_unit_count,
        0 AS ly_day_return_unit_count_activating,
        0 AS ly_day_return_unit_count_nonactivating,
        0 AS ly_day_return_unit_count_repeat,
        0 AS ly_day_return_unit_count_guest,
        0 AS ly_day_total_returned_product_gross_rev_excluding_shipping,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ly_day_bop_onhand_qty,
        0 AS ly_day_bop_available_to_sell_qty,
        0 AS ly_day_bop_open_to_buy_qty,
        0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_bop_retail_reserve,
        0 AS ly_day_bop_inventory_cost,
        0 AS ly_day_eop_onhand_qty,
        0 AS ly_day_eop_available_to_sell_qty,
        0 AS ly_day_eop_open_to_buy_qty,
        0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_eop_retail_reserve,
        0 AS ly_day_eop_inventory_cost,
        0 AS ly_date_total_unit_count,
        0 AS ly_date_unit_count_activating,
        0 AS ly_date_unit_count_nonactivating,
        0 AS ly_date_unit_count_repeat,
        0 AS ly_date_unit_count_guest,
        0 AS ly_date_total_product_subtotal,
        0 AS ly_date_product_subtotal_activating,
        0 AS ly_date_product_subtotal_nonactivating,
        0 AS ly_date_product_subtotal_repeat,
        0 AS ly_date_product_subtotal_guest,
        0 AS ly_date_total_product_discount,
        0 AS ly_date_product_discount_activating,
        0 AS ly_date_product_discount_nonactivating,
        0 AS ly_date_product_discount_repeat,
        0 AS ly_date_product_discount_guest,
        0 AS ly_date_total_product_gross_revenue_excl_shipping,
        0 AS ly_date_product_gross_revenue_excl_shipping_activating,
        0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
        0 AS ly_date_product_gross_revenue_excl_shipping_guest,
        0 AS ly_date_total_product_margin_pre_return_excl_shipping,
        0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
        0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
        0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
        0 AS ly_date_total_product_cost,
        0 AS ly_date_product_cost_activating,
        0 AS ly_date_product_cost_nonactivating,
        0 AS ly_date_product_cost_repeat,
        0 AS ly_date_product_cost_guest,
        0 AS ly_date_total_product_cost_c,
        0 AS ly_date_product_cost_activating_c,
        0 AS ly_date_product_cost_nonactivating_c,
        0 AS ly_date_product_cost_repeat_c,
        0 AS ly_date_product_cost_guest_c,
        0 AS ly_date_total_non_reduced_vip_price,
        0 AS ly_date_non_reduced_vip_price_activating,
        0 AS ly_date_non_reduced_vip_price_nonactivating,
        0 AS ly_date_non_reduced_vip_price_repeat,
        0 AS ly_date_non_reduced_vip_price_guest,
        0 AS ly_date_total_return_unit_count,
        0 AS ly_date_return_unit_count_activating,
        0 AS ly_date_return_unit_count_nonactivating,
        0 AS ly_date_return_unit_count_repeat,
        0 AS ly_date_return_unit_count_guest,
        0 AS ly_date_total_returned_product_gross_rev_excluding_shipping,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ly_date_bop_onhand_qty,
        0 AS ly_date_bop_available_to_sell_qty,
        0 AS ly_date_bop_open_to_buy_qty,
        0 AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_bop_retail_reserve,
        0 AS ly_date_bop_inventory_cost,
        0 AS ly_date_eop_onhand_qty,
        0 AS ly_date_eop_available_to_sell_qty,
        0 AS ly_date_eop_open_to_buy_qty,
        0 AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_eop_retail_reserve,
        0 AS ly_date_eop_inventory_cost
    FROM _basic_aggregation

    UNION ALL

    SELECT date + 364 AS date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        store_brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS ty_total_unit_count,
        0 AS ty_unit_count_activating,
        0 AS ty_unit_count_nonactivating,
        0 AS ty_unit_count_repeat,
        0 AS ty_unit_count_guest,
        0 AS ty_total_product_subtotal,
        0 AS ty_product_subtotal_activating,
        0 AS ty_product_subtotal_nonactivating,
        0 AS ty_product_subtotal_repeat,
        0 AS ty_product_subtotal_guest,
        0 AS ty_total_product_discount,
        0 AS ty_product_discount_activating,
        0 AS ty_product_discount_nonactivating,
        0 AS ty_product_discount_repeat,
        0 AS ty_product_discount_guest,
        0 AS ty_total_product_gross_revenue_excl_shipping,
        0 AS ty_product_gross_revenue_excl_shipping_activating,
        0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ty_product_gross_revenue_excl_shipping_repeat,
        0 AS ty_product_gross_revenue_excl_shipping_guest,
        0 AS ty_total_product_margin_pre_return_excl_shipping,
        0 AS ty_product_margin_pre_return_excl_shipping_activating,
        0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ty_product_margin_pre_return_excl_shipping_repeat,
        0 AS ty_product_margin_pre_return_excl_shipping_guest,
        0 AS ty_total_product_cost,
        0 AS ty_product_cost_activating,
        0 AS ty_product_cost_nonactivating,
        0 AS ty_product_cost_repeat,
        0 AS ty_product_cost_guest,
        0 AS ty_total_product_cost_c,
        0 AS ty_product_cost_activating_c,
        0 AS ty_product_cost_nonactivating_c,
        0 AS ty_product_cost_repeat_c,
        0 AS ty_product_cost_guest_c,
        0 AS ty_total_non_reduced_vip_price,
        0 AS ty_non_reduced_vip_price_activating,
        0 AS ty_non_reduced_vip_price_nonactivating,
        0 AS ty_non_reduced_vip_price_repeat,
        0 AS ty_non_reduced_vip_price_guest,
        0 AS ty_total_return_unit_count,
        0 AS ty_return_unit_count_activating,
        0 AS ty_return_unit_count_nonactivating,
        0 AS ty_return_unit_count_repeat,
        0 AS ty_return_unit_count_guest,
        0 AS ty_total_returned_product_gross_rev_excluding_shipping,
        0 AS ty_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ty_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ty_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ty_bop_onhand_qty,
        0 AS ty_bop_available_to_sell_qty,
        0 AS ty_bop_open_to_buy_qty,
        0 AS ty_bop_open_to_buy_qty_incl_in_transit,
        0 AS ty_bop_retail_reserve,
        0 AS ty_bop_inventory_cost,
        0 AS ty_eop_onhand_qty,
        0 AS ty_eop_available_to_sell_qty,
        0 AS ty_eop_open_to_buy_qty,
        0 AS ty_eop_open_to_buy_qty_incl_in_transit,
        0 AS ty_eop_retail_reserve,
        0 AS ty_eop_inventory_cost,
        total_unit_count AS ly_day_total_unit_count,
        unit_count_activating AS ly_day_unit_count_activating,
        unit_count_nonactivating AS ly_day_unit_count_nonactivating,
        unit_count_repeat AS ly_day_unit_count_repeat,
        unit_count_guest AS ly_day_unit_count_guest,
        total_product_subtotal AS ly_day_total_product_subtotal,
        product_subtotal_activating AS ly_day_product_subtotal_activating,
        product_subtotal_nonactivating AS ly_day_product_subtotal_nonactivating,
        product_subtotal_repeat AS ly_day_product_subtotal_repeat,
        product_subtotal_guest AS ly_day_product_subtotal_guest,
        total_product_discount AS ly_day_total_product_discount,
        product_discount_activating AS ly_day_product_discount_activating,
        product_discount_nonactivating AS ly_day_product_discount_nonactivating,
        product_discount_repeat AS ly_day_product_discount_repeat,
        product_discount_guest AS ly_day_product_discount_guest,
        total_product_gross_revenue_excl_shipping AS ly_day_total_product_gross_revenue_excl_shipping,
        product_gross_revenue_excl_shipping_activating AS ly_day_product_gross_revenue_excl_shipping_activating,
        product_gross_revenue_excl_shipping_nonactivating AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
        product_gross_revenue_excl_shipping_repeat AS ly_day_product_gross_revenue_excl_shipping_repeat,
        product_gross_revenue_excl_shipping_guest AS ly_day_product_gross_revenue_excl_shipping_guest,
        total_product_margin_pre_return_excl_shipping AS ly_day_total_product_margin_pre_return_excl_shipping,
        product_margin_pre_return_excl_shipping_activating AS ly_day_product_margin_pre_return_excl_shipping_activating,
        product_margin_pre_return_excl_shipping_nonactivating AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
        product_margin_pre_return_excl_shipping_repeat AS ly_day_product_margin_pre_return_excl_shipping_repeat,
        product_margin_pre_return_excl_shipping_guest AS ly_day_product_margin_pre_return_excl_shipping_guest,
        total_product_cost AS ly_day_total_product_cost,
        product_cost_activating AS ly_day_product_cost_activating,
        product_cost_nonactivating AS ly_day_product_cost_nonactivating,
        product_cost_repeat AS ly_day_product_cost_repeat,
        product_cost_guest AS ly_day_product_cost_guest,
        total_product_cost_c AS ly_day_total_product_cost_c,
        product_cost_activating_c AS ly_day_product_cost_activating_c,
        product_cost_nonactivating_c AS ly_day_product_cost_nonactivating_c,
        product_cost_repeat_c AS ly_day_product_cost_repeat_c,
        product_cost_guest_c AS ly_day_product_cost_guest_c,
        total_non_reduced_vip_price AS ly_day_total_non_reduced_vip_price,
        non_reduced_vip_price_activating AS ly_day_non_reduced_vip_price_activating,
        non_reduced_vip_price_nonactivating AS ly_day_non_reduced_vip_price_nonactivating,
        non_reduced_vip_price_repeat AS ly_day_non_reduced_vip_price_repeat,
        non_reduced_vip_price_guest AS ly_day_non_reduced_vip_price_guest,
        total_return_unit_count AS ly_day_total_return_unit_count,
        return_unit_count_activating AS ly_day_return_unit_count_activating,
        return_unit_count_nonactivating AS ly_day_return_unit_count_nonactivating,
        return_unit_count_repeat AS ly_day_return_unit_count_repeat,
        return_unit_count_guest AS ly_day_return_unit_count_guest,
        total_returned_product_gross_rev_excluding_shipping AS ly_day_total_returned_product_gross_rev_excluding_shipping,
        returned_product_gross_rev_excluding_shipping_activating AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
        returned_product_gross_rev_excluding_shipping_nonactivating AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
        returned_product_gross_rev_excluding_shipping_repeat AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
        returned_product_gross_rev_excluding_shipping_guest AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
        bop_onhand_qty AS ly_day_bop_onhand_qty,
        bop_available_to_sell_qty AS ly_day_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ly_day_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ly_day_bop_retail_reserve,
        bop_inventory_cost AS ly_day_bop_inventory_cost,
        eop_onhand_qty AS ly_day_eop_onhand_qty,
        eop_available_to_sell_qty AS ly_day_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ly_day_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ly_day_eop_retail_reserve,
        eop_inventory_cost AS ly_day_eop_inventory_cost,
        0 AS ly_date_total_unit_count,
        0 AS ly_date_unit_count_activating,
        0 AS ly_date_unit_count_nonactivating,
        0 AS ly_date_unit_count_repeat,
        0 AS ly_date_unit_count_guest,
        0 AS ly_date_total_product_subtotal,
        0 AS ly_date_product_subtotal_activating,
        0 AS ly_date_product_subtotal_nonactivating,
        0 AS ly_date_product_subtotal_repeat,
        0 AS ly_date_product_subtotal_guest,
        0 AS ly_date_total_product_discount,
        0 AS ly_date_product_discount_activating,
        0 AS ly_date_product_discount_nonactivating,
        0 AS ly_date_product_discount_repeat,
        0 AS ly_date_product_discount_guest,
        0 AS ly_date_total_product_gross_revenue_excl_shipping,
        0 AS ly_date_product_gross_revenue_excl_shipping_activating,
        0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
        0 AS ly_date_product_gross_revenue_excl_shipping_guest,
        0 AS ly_date_total_product_margin_pre_return_excl_shipping,
        0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
        0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
        0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
        0 AS ly_date_total_product_cost,
        0 AS ly_date_product_cost_activating,
        0 AS ly_date_product_cost_nonactivating,
        0 AS ly_date_product_cost_repeat,
        0 AS ly_date_product_cost_guest,
        0 AS ly_date_total_product_cost_c,
        0 AS ly_date_product_cost_activating_c,
        0 AS ly_date_product_cost_nonactivating_c,
        0 AS ly_date_product_cost_repeat_c,
        0 AS ly_date_product_cost_guest_c,
        0 AS ly_date_total_non_reduced_vip_price,
        0 AS ly_date_non_reduced_vip_price_activating,
        0 AS ly_date_non_reduced_vip_price_nonactivating,
        0 AS ly_date_non_reduced_vip_price_repeat,
        0 AS ly_date_non_reduced_vip_price_guest,
        0 AS ly_date_total_return_unit_count,
        0 AS ly_date_return_unit_count_activating,
        0 AS ly_date_return_unit_count_nonactivating,
        0 AS ly_date_return_unit_count_repeat,
        0 AS ly_date_return_unit_count_guest,
        0 AS ly_date_total_returned_product_gross_rev_excluding_shipping,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ly_date_bop_onhand_qty,
        0 AS ly_date_bop_available_to_sell_qty,
        0 AS ly_date_bop_open_to_buy_qty,
        0 AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_bop_retail_reserve,
        0 AS ly_date_bop_inventory_cost,
        0 AS ly_date_eop_onhand_qty,
        0 AS ly_date_eop_available_to_sell_qty,
        0 AS ly_date_eop_open_to_buy_qty,
        0 AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_eop_retail_reserve,
        0 AS ly_date_eop_inventory_cost
    FROM _basic_aggregation

    UNION ALL

    SELECT DATEADD('YEAR', 1, date) AS date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        store_brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS ty_total_unit_count,
        0 AS ty_unit_count_activating,
        0 AS ty_unit_count_nonactivating,
        0 AS ty_unit_count_repeat,
        0 AS ty_unit_count_guest,
        0 AS ty_total_product_subtotal,
        0 AS ty_product_subtotal_activating,
        0 AS ty_product_subtotal_nonactivating,
        0 AS ty_product_subtotal_repeat,
        0 AS ty_product_subtotal_guest,
        0 AS ty_total_product_discount,
        0 AS ty_product_discount_activating,
        0 AS ty_product_discount_nonactivating,
        0 AS ty_product_discount_repeat,
        0 AS ty_product_discount_guest,
        0 AS ty_total_product_gross_revenue_excl_shipping,
        0 AS ty_product_gross_revenue_excl_shipping_activating,
        0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ty_product_gross_revenue_excl_shipping_repeat,
        0 AS ty_product_gross_revenue_excl_shipping_guest,
        0 AS ty_total_product_margin_pre_return_excl_shipping,
        0 AS ty_product_margin_pre_return_excl_shipping_activating,
        0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ty_product_margin_pre_return_excl_shipping_repeat,
        0 AS ty_product_margin_pre_return_excl_shipping_guest,
        0 AS ty_total_product_cost,
        0 AS ty_product_cost_activating,
        0 AS ty_product_cost_nonactivating,
        0 AS ty_product_cost_repeat,
        0 AS ty_product_cost_guest,
        0 AS ty_total_product_cost_c,
        0 AS ty_product_cost_activating_c,
        0 AS ty_product_cost_nonactivating_c,
        0 AS ty_product_cost_repeat_c,
        0 AS ty_product_cost_guest_c,
        0 AS ty_total_non_reduced_vip_price,
        0 AS ty_non_reduced_vip_price_activating,
        0 AS ty_non_reduced_vip_price_nonactivating,
        0 AS ty_non_reduced_vip_price_repeat,
        0 AS ty_non_reduced_vip_price_guest,
        0 AS ty_total_return_unit_count,
        0 AS ty_return_unit_count_activating,
        0 AS ty_return_unit_count_nonactivating,
        0 AS ty_return_unit_count_repeat,
        0 AS ty_return_unit_count_guest,
        0 AS ty_total_returned_product_gross_rev_excluding_shipping,
        0 AS ty_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ty_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ty_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ty_bop_onhand_qty,
        0 AS ty_bop_available_to_sell_qty,
        0 AS ty_bop_open_to_buy_qty,
        0 AS ty_bop_open_to_buy_qty_incl_in_transit,
        0 AS ty_bop_retail_reserve,
        0 AS ty_bop_inventory_cost,
        0 AS ty_eop_onhand_qty,
        0 AS ty_eop_available_to_sell_qty,
        0 AS ty_eop_open_to_buy_qty,
        0 AS ty_eop_open_to_buy_qty_incl_in_transit,
        0 AS ty_eop_retail_reserve,
        0 AS ty_eop_inventory_cost,
        0 AS ly_day_total_unit_count,
        0 AS ly_day_unit_count_activating,
        0 AS ly_day_unit_count_nonactivating,
        0 AS ly_day_unit_count_repeat,
        0 AS ly_day_unit_count_guest,
        0 AS ly_day_total_product_subtotal,
        0 AS ly_day_product_subtotal_activating,
        0 AS ly_day_product_subtotal_nonactivating,
        0 AS ly_day_product_subtotal_repeat,
        0 AS ly_day_product_subtotal_guest,
        0 AS ly_day_total_product_discount,
        0 AS ly_day_product_discount_activating,
        0 AS ly_day_product_discount_nonactivating,
        0 AS ly_day_product_discount_repeat,
        0 AS ly_day_product_discount_guest,
        0 AS ly_day_total_product_gross_revenue_excl_shipping,
        0 AS ly_day_product_gross_revenue_excl_shipping_activating,
        0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
        0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
        0 AS ly_day_product_gross_revenue_excl_shipping_guest,
        0 AS ly_day_total_product_margin_pre_return_excl_shipping,
        0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
        0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
        0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
        0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
        0 AS ly_day_total_product_cost,
        0 AS ly_day_product_cost_activating,
        0 AS ly_day_product_cost_nonactivating,
        0 AS ly_day_product_cost_repeat,
        0 AS ly_day_product_cost_guest,
        0 AS ly_day_total_product_cost_c,
        0 AS ly_day_product_cost_activating_c,
        0 AS ly_day_product_cost_nonactivating_c,
        0 AS ly_day_product_cost_repeat_c,
        0 AS ly_day_product_cost_guest_c,
        0 AS ly_day_total_non_reduced_vip_price,
        0 AS ly_day_non_reduced_vip_price_activating,
        0 AS ly_day_non_reduced_vip_price_nonactivating,
        0 AS ly_day_non_reduced_vip_price_repeat,
        0 AS ly_day_non_reduced_vip_price_guest,
        0 AS ly_day_total_return_unit_count,
        0 AS ly_day_return_unit_count_activating,
        0 AS ly_day_return_unit_count_nonactivating,
        0 AS ly_day_return_unit_count_repeat,
        0 AS ly_day_return_unit_count_guest,
        0 AS ly_day_total_returned_product_gross_rev_excluding_shipping,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
        0 AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
        0 AS ly_day_bop_onhand_qty,
        0 AS ly_day_bop_available_to_sell_qty,
        0 AS ly_day_bop_open_to_buy_qty,
        0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_bop_retail_reserve,
        0 AS ly_day_bop_inventory_cost,
        0 AS ly_day_eop_onhand_qty,
        0 AS ly_day_eop_available_to_sell_qty,
        0 AS ly_day_eop_open_to_buy_qty,
        0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_eop_retail_reserve,
        0 AS ly_day_eop_inventory_cost,
        total_unit_count AS ly_date_total_unit_count,
        unit_count_activating AS ly_date_unit_count_activating,
        unit_count_nonactivating AS ly_date_unit_count_nonactivating,
        unit_count_repeat AS ly_date_unit_count_repeat,
        unit_count_guest AS ly_date_unit_count_guest,
        total_product_subtotal AS ly_date_total_product_subtotal,
        product_subtotal_activating AS ly_date_product_subtotal_activating,
        product_subtotal_nonactivating AS ly_date_product_subtotal_nonactivating,
        product_subtotal_repeat AS ly_date_product_subtotal_repeat,
        product_subtotal_guest AS ly_date_product_subtotal_guest,
        total_product_discount AS ly_date_total_product_discount,
        product_discount_activating AS ly_date_product_discount_activating,
        product_discount_nonactivating AS ly_date_product_discount_nonactivating,
        product_discount_repeat AS ly_date_product_discount_repeat,
        product_discount_guest AS ly_date_product_discount_guest,
        total_product_gross_revenue_excl_shipping AS ly_date_total_product_gross_revenue_excl_shipping,
        product_gross_revenue_excl_shipping_activating AS ly_date_product_gross_revenue_excl_shipping_activating,
        product_gross_revenue_excl_shipping_nonactivating AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
        product_gross_revenue_excl_shipping_repeat AS ly_date_product_gross_revenue_excl_shipping_repeat,
        product_gross_revenue_excl_shipping_guest AS ly_date_product_gross_revenue_excl_shipping_guest,
        total_product_margin_pre_return_excl_shipping AS ly_date_total_product_margin_pre_return_excl_shipping,
        product_margin_pre_return_excl_shipping_activating AS ly_date_product_margin_pre_return_excl_shipping_activating,
        product_margin_pre_return_excl_shipping_nonactivating AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
        product_margin_pre_return_excl_shipping_repeat AS ly_date_product_margin_pre_return_excl_shipping_repeat,
        product_margin_pre_return_excl_shipping_guest AS ly_date_product_margin_pre_return_excl_shipping_guest,
        total_product_cost AS ly_date_total_product_cost,
        product_cost_activating AS ly_date_product_cost_activating,
        product_cost_nonactivating AS ly_date_product_cost_nonactivating,
        product_cost_repeat AS ly_date_product_cost_repeat,
        product_cost_guest AS ly_date_product_cost_guest,
        total_product_cost_c AS ly_date_total_product_cost_c,
        product_cost_activating_c AS ly_date_product_cost_activating_c,
        product_cost_nonactivating_c AS ly_date_product_cost_nonactivating_c,
        product_cost_repeat_c AS ly_date_product_cost_repeat_c,
        product_cost_guest_c AS ly_date_product_cost_guest_c,
        total_non_reduced_vip_price AS ly_date_total_non_reduced_vip_price,
        non_reduced_vip_price_activating AS ly_date_non_reduced_vip_price_activating,
        non_reduced_vip_price_nonactivating AS ly_date_non_reduced_vip_price_nonactivating,
        non_reduced_vip_price_repeat AS ly_date_non_reduced_vip_price_repeat,
        non_reduced_vip_price_guest AS ly_date_non_reduced_vip_price_guest,
        total_return_unit_count AS ly_date_total_return_unit_count,
        return_unit_count_activating AS ly_date_return_unit_count_activating,
        return_unit_count_nonactivating AS ly_date_return_unit_count_nonactivating,
        return_unit_count_repeat AS ly_date_return_unit_count_repeat,
        return_unit_count_guest AS ly_date_return_unit_count_guest,
        total_returned_product_gross_rev_excluding_shipping AS ly_date_total_returned_product_gross_rev_excluding_shipping,
        returned_product_gross_rev_excluding_shipping_activating AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
        returned_product_gross_rev_excluding_shipping_nonactivating AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
        returned_product_gross_rev_excluding_shipping_repeat AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
        returned_product_gross_rev_excluding_shipping_guest AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
        bop_onhand_qty AS ly_date_bop_onhand_qty,
        bop_available_to_sell_qty AS ly_date_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ly_date_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ly_date_bop_retail_reserve,
        bop_inventory_cost AS ly_date_bop_inventory_cost,
        eop_onhand_qty AS ly_date_eop_onhand_qty,
        eop_available_to_sell_qty AS ly_date_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ly_date_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ly_date_eop_retail_reserve,
        eop_inventory_cost AS ly_date_eop_inventory_cost
    FROM _basic_aggregation
)
SELECT date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    SUM(ty_total_unit_count) AS ty_total_unit_count,
    SUM(ty_unit_count_activating) AS ty_unit_count_activating,
    SUM(ty_unit_count_nonactivating) AS ty_unit_count_nonactivating,
    SUM(ty_unit_count_repeat) AS ty_unit_count_repeat,
    SUM(ty_unit_count_guest) AS ty_unit_count_guest,
    SUM(ty_total_product_subtotal) AS ty_total_product_subtotal,
    SUM(ty_product_subtotal_activating) AS ty_product_subtotal_activating,
    SUM(ty_product_subtotal_nonactivating) AS ty_product_subtotal_nonactivating,
    SUM(ty_product_subtotal_repeat) AS ty_product_subtotal_repeat,
    SUM(ty_product_subtotal_guest) AS ty_product_subtotal_guest,
    SUM(ty_total_product_discount) AS ty_total_product_discount,
    SUM(ty_product_discount_activating) AS ty_product_discount_activating,
    SUM(ty_product_discount_nonactivating) AS ty_product_discount_nonactivating,
    SUM(ty_product_discount_repeat) AS ty_product_discount_repeat,
    SUM(ty_product_discount_guest) AS ty_product_discount_guest,
    SUM(ty_total_product_gross_revenue_excl_shipping) AS ty_total_product_gross_revenue_excl_shipping,
    SUM(ty_product_gross_revenue_excl_shipping_activating) AS ty_product_gross_revenue_excl_shipping_activating,
    SUM(ty_product_gross_revenue_excl_shipping_nonactivating) AS ty_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ty_product_gross_revenue_excl_shipping_repeat) AS ty_product_gross_revenue_excl_shipping_repeat,
    SUM(ty_product_gross_revenue_excl_shipping_guest) AS ty_product_gross_revenue_excl_shipping_guest,
    SUM(ty_total_product_margin_pre_return_excl_shipping) AS ty_total_product_margin_pre_return_excl_shipping,
    SUM(ty_product_margin_pre_return_excl_shipping_activating) AS ty_product_margin_pre_return_excl_shipping_activating,
    SUM(ty_product_margin_pre_return_excl_shipping_nonactivating) AS ty_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ty_product_margin_pre_return_excl_shipping_repeat) AS ty_product_margin_pre_return_excl_shipping_repeat,
    SUM(ty_product_margin_pre_return_excl_shipping_guest) AS ty_product_margin_pre_return_excl_shipping_guest,
    SUM(ty_total_product_cost) AS ty_total_product_cost,
    SUM(ty_product_cost_activating) AS ty_product_cost_activating,
    SUM(ty_product_cost_nonactivating) AS ty_product_cost_nonactivating,
    SUM(ty_product_cost_repeat) AS ty_product_cost_repeat,
    SUM(ty_product_cost_guest) AS ty_product_cost_guest,
    SUM(ty_total_product_cost_c) AS ty_total_product_cost_c,
    SUM(ty_product_cost_activating_c) AS ty_product_cost_activating_c,
    SUM(ty_product_cost_nonactivating_c) AS ty_product_cost_nonactivating_c,
    SUM(ty_product_cost_repeat_c) AS ty_product_cost_repeat_c,
    SUM(ty_product_cost_guest_c) AS ty_product_cost_guest_c,
    SUM(ty_total_non_reduced_vip_price) AS ty_total_non_reduced_vip_price,
    SUM(ty_non_reduced_vip_price_activating) AS ty_non_reduced_vip_price_activating,
    SUM(ty_non_reduced_vip_price_nonactivating) AS ty_non_reduced_vip_price_nonactivating,
    SUM(ty_non_reduced_vip_price_repeat) AS ty_non_reduced_vip_price_repeat,
    SUM(ty_non_reduced_vip_price_guest) AS ty_non_reduced_vip_price_guest,
    SUM(ty_total_return_unit_count) AS ty_total_return_unit_count,
    SUM(ty_return_unit_count_activating) AS ty_return_unit_count_activating,
    SUM(ty_return_unit_count_nonactivating) AS ty_return_unit_count_nonactivating,
    SUM(ty_return_unit_count_repeat) AS ty_return_unit_count_repeat,
    SUM(ty_return_unit_count_guest) AS ty_return_unit_count_guest,
    SUM(ty_total_returned_product_gross_rev_excluding_shipping) AS ty_total_returned_product_gross_rev_excluding_shipping,
    SUM(ty_returned_product_gross_rev_excluding_shipping_activating) AS ty_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_nonactivating) AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ty_returned_product_gross_rev_excluding_shipping_repeat) AS ty_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ty_returned_product_gross_rev_excluding_shipping_guest) AS ty_returned_product_gross_rev_excluding_shipping_guest,
    SUM(ty_bop_onhand_qty) AS ty_bop_onhand_qty,
    SUM(ty_bop_available_to_sell_qty) AS ty_bop_available_to_sell_qty,
    SUM(ty_bop_open_to_buy_qty) AS ty_bop_open_to_buy_qty,
    SUM(ty_bop_open_to_buy_qty_incl_in_transit) AS ty_bop_open_to_buy_qty_incl_in_transit,
    SUM(ty_bop_retail_reserve) AS ty_bop_retail_reserve,
    SUM(ty_bop_inventory_cost) AS ty_bop_inventory_cost,
    SUM(ty_eop_onhand_qty) AS ty_eop_onhand_qty,
    SUM(ty_eop_available_to_sell_qty) AS ty_eop_available_to_sell_qty,
    SUM(ty_eop_open_to_buy_qty) AS ty_eop_open_to_buy_qty,
    SUM(ty_eop_open_to_buy_qty_incl_in_transit) AS ty_eop_open_to_buy_qty_incl_in_transit,
    SUM(ty_eop_retail_reserve) AS ty_eop_retail_reserve,
    SUM(ty_eop_inventory_cost) AS ty_eop_inventory_cost,
    SUM(ly_day_total_unit_count) AS ly_day_total_unit_count,
    SUM(ly_day_unit_count_activating) AS ly_day_unit_count_activating,
    SUM(ly_day_unit_count_nonactivating) AS ly_day_unit_count_nonactivating,
    SUM(ly_day_unit_count_repeat) AS ly_day_unit_count_repeat,
    SUM(ly_day_unit_count_guest) AS ly_day_unit_count_guest,
    SUM(ly_day_total_product_subtotal) AS ly_day_total_product_subtotal,
    SUM(ly_day_product_subtotal_activating) AS ly_day_product_subtotal_activating,
    SUM(ly_day_product_subtotal_nonactivating) AS ly_day_product_subtotal_nonactivating,
    SUM(ly_day_product_subtotal_repeat) AS ly_day_product_subtotal_repeat,
    SUM(ly_day_product_subtotal_guest) AS ly_day_product_subtotal_guest,
    SUM(ly_day_total_product_discount) AS ly_day_total_product_discount,
    SUM(ly_day_product_discount_activating) AS ly_day_product_discount_activating,
    SUM(ly_day_product_discount_nonactivating) AS ly_day_product_discount_nonactivating,
    SUM(ly_day_product_discount_repeat) AS ly_day_product_discount_repeat,
    SUM(ly_day_product_discount_guest) AS ly_day_product_discount_guest,
    SUM(ly_day_total_product_gross_revenue_excl_shipping) AS ly_day_total_product_gross_revenue_excl_shipping,
    SUM(ly_day_product_gross_revenue_excl_shipping_activating) AS ly_day_product_gross_revenue_excl_shipping_activating,
    SUM(ly_day_product_gross_revenue_excl_shipping_nonactivating) AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ly_day_product_gross_revenue_excl_shipping_repeat) AS ly_day_product_gross_revenue_excl_shipping_repeat,
    SUM(ly_day_product_gross_revenue_excl_shipping_guest) AS ly_day_product_gross_revenue_excl_shipping_guest,
    SUM(ly_day_total_product_margin_pre_return_excl_shipping) AS ly_day_total_product_margin_pre_return_excl_shipping,
    SUM(ly_day_product_margin_pre_return_excl_shipping_activating) AS ly_day_product_margin_pre_return_excl_shipping_activating,
    SUM(ly_day_product_margin_pre_return_excl_shipping_nonactivating) AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ly_day_product_margin_pre_return_excl_shipping_repeat) AS ly_day_product_margin_pre_return_excl_shipping_repeat,
    SUM(ly_day_product_margin_pre_return_excl_shipping_guest) AS ly_day_product_margin_pre_return_excl_shipping_guest,
    SUM(ly_day_total_product_cost) AS ly_day_total_product_cost,
    SUM(ly_day_product_cost_activating) AS ly_day_product_cost_activating,
    SUM(ly_day_product_cost_nonactivating) AS ly_day_product_cost_nonactivating,
    SUM(ly_day_product_cost_repeat) AS ly_day_product_cost_repeat,
    SUM(ly_day_product_cost_guest) AS ly_day_product_cost_guest,
    SUM(ly_day_total_product_cost_c) AS ly_day_total_product_cost_c,
    SUM(ly_day_product_cost_activating_c) AS ly_day_product_cost_activating_c,
    SUM(ly_day_product_cost_nonactivating_c) AS ly_day_product_cost_nonactivating_c,
    SUM(ly_day_product_cost_repeat_c) AS ly_day_product_cost_repeat_c,
    SUM(ly_day_product_cost_guest_c) AS ly_day_product_cost_guest_c,
    SUM(ly_day_total_non_reduced_vip_price) AS ly_day_total_non_reduced_vip_price,
    SUM(ly_day_non_reduced_vip_price_activating) AS ly_day_non_reduced_vip_price_activating,
    SUM(ly_day_non_reduced_vip_price_nonactivating) AS ly_day_non_reduced_vip_price_nonactivating,
    SUM(ly_day_non_reduced_vip_price_repeat) AS ly_day_non_reduced_vip_price_repeat,
    SUM(ly_day_non_reduced_vip_price_guest) AS ly_day_non_reduced_vip_price_guest,
    SUM(ly_day_total_return_unit_count) AS ly_day_total_return_unit_count,
    SUM(ly_day_return_unit_count_activating) AS ly_day_return_unit_count_activating,
    SUM(ly_day_return_unit_count_nonactivating) AS ly_day_return_unit_count_nonactivating,
    SUM(ly_day_return_unit_count_repeat) AS ly_day_return_unit_count_repeat,
    SUM(ly_day_return_unit_count_guest) AS ly_day_return_unit_count_guest,
    SUM(ly_day_total_returned_product_gross_rev_excluding_shipping) AS ly_day_total_returned_product_gross_rev_excluding_shipping,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_activating) AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_nonactivating) AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_repeat) AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ly_day_returned_product_gross_rev_excluding_shipping_guest) AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
    SUM(ly_day_bop_onhand_qty) AS ly_day_bop_onhand_qty,
    SUM(ly_day_bop_available_to_sell_qty) AS ly_day_bop_available_to_sell_qty,
    SUM(ly_day_bop_open_to_buy_qty) AS ly_day_bop_open_to_buy_qty,
    SUM(ly_day_bop_open_to_buy_qty_incl_in_transit) AS ly_day_bop_open_to_buy_qty_incl_in_transit,
    SUM(ly_day_bop_retail_reserve) AS ly_day_bop_retail_reserve,
    SUM(ly_day_bop_inventory_cost) AS ly_day_bop_inventory_cost,
    SUM(ly_day_eop_onhand_qty) AS ly_day_eop_onhand_qty,
    SUM(ly_day_eop_available_to_sell_qty) AS ly_day_eop_available_to_sell_qty,
    SUM(ly_day_eop_open_to_buy_qty) AS ly_day_eop_open_to_buy_qty,
    SUM(ly_day_eop_open_to_buy_qty_incl_in_transit) AS ly_day_eop_open_to_buy_qty_incl_in_transit,
    SUM(ly_day_eop_retail_reserve) AS ly_day_eop_retail_reserve,
    SUM(ly_day_eop_inventory_cost) AS ly_day_eop_inventory_cost,
    SUM(ly_date_total_unit_count) AS ly_date_total_unit_count,
    SUM(ly_date_unit_count_activating) AS ly_date_unit_count_activating,
    SUM(ly_date_unit_count_nonactivating) AS ly_date_unit_count_nonactivating,
    SUM(ly_date_unit_count_repeat) AS ly_date_unit_count_repeat,
    SUM(ly_date_unit_count_guest) AS ly_date_unit_count_guest,
    SUM(ly_date_total_product_subtotal) AS ly_date_total_product_subtotal,
    SUM(ly_date_product_subtotal_activating) AS ly_date_product_subtotal_activating,
    SUM(ly_date_product_subtotal_nonactivating) AS ly_date_product_subtotal_nonactivating,
    SUM(ly_date_product_subtotal_repeat) AS ly_date_product_subtotal_repeat,
    SUM(ly_date_product_subtotal_guest) AS ly_date_product_subtotal_guest,
    SUM(ly_date_total_product_discount) AS ly_date_total_product_discount,
    SUM(ly_date_product_discount_activating) AS ly_date_product_discount_activating,
    SUM(ly_date_product_discount_nonactivating) AS ly_date_product_discount_nonactivating,
    SUM(ly_date_product_discount_repeat) AS ly_date_product_discount_repeat,
    SUM(ly_date_product_discount_guest) AS ly_date_product_discount_guest,
    SUM(ly_date_total_product_gross_revenue_excl_shipping) AS ly_date_total_product_gross_revenue_excl_shipping,
    SUM(ly_date_product_gross_revenue_excl_shipping_activating) AS ly_date_product_gross_revenue_excl_shipping_activating,
    SUM(ly_date_product_gross_revenue_excl_shipping_nonactivating) AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
    SUM(ly_date_product_gross_revenue_excl_shipping_repeat) AS ly_date_product_gross_revenue_excl_shipping_repeat,
    SUM(ly_date_product_gross_revenue_excl_shipping_guest) AS ly_date_product_gross_revenue_excl_shipping_guest,
    SUM(ly_date_total_product_margin_pre_return_excl_shipping) AS ly_date_total_product_margin_pre_return_excl_shipping,
    SUM(ly_date_product_margin_pre_return_excl_shipping_activating) AS ly_date_product_margin_pre_return_excl_shipping_activating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_nonactivating) AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    SUM(ly_date_product_margin_pre_return_excl_shipping_repeat) AS ly_date_product_margin_pre_return_excl_shipping_repeat,
    SUM(ly_date_product_margin_pre_return_excl_shipping_guest) AS ly_date_product_margin_pre_return_excl_shipping_guest,
    SUM(ly_date_total_product_cost) AS ly_date_total_product_cost,
    SUM(ly_date_product_cost_activating) AS ly_date_product_cost_activating,
    SUM(ly_date_product_cost_nonactivating) AS ly_date_product_cost_nonactivating,
    SUM(ly_date_product_cost_repeat) AS ly_date_product_cost_repeat,
    SUM(ly_date_product_cost_guest) AS ly_date_product_cost_guest,
    SUM(ly_date_total_product_cost_c) AS ly_date_total_product_cost_c,
    SUM(ly_date_product_cost_activating_c) AS ly_date_product_cost_activating_c,
    SUM(ly_date_product_cost_nonactivating_c) AS ly_date_product_cost_nonactivating_c,
    SUM(ly_date_product_cost_repeat_c) AS ly_date_product_cost_repeat_c,
    SUM(ly_date_product_cost_guest_c) AS ly_date_product_cost_guest_c,
    SUM(ly_date_total_non_reduced_vip_price) AS ly_date_total_non_reduced_vip_price,
    SUM(ly_date_non_reduced_vip_price_activating) AS ly_date_non_reduced_vip_price_activating,
    SUM(ly_date_non_reduced_vip_price_nonactivating) AS ly_date_non_reduced_vip_price_nonactivating,
    SUM(ly_date_non_reduced_vip_price_repeat) AS ly_date_non_reduced_vip_price_repeat,
    SUM(ly_date_non_reduced_vip_price_guest) AS ly_date_non_reduced_vip_price_guest,
    SUM(ly_date_total_return_unit_count) AS ly_date_total_return_unit_count,
    SUM(ly_date_return_unit_count_activating) AS ly_date_return_unit_count_activating,
    SUM(ly_date_return_unit_count_nonactivating) AS ly_date_return_unit_count_nonactivating,
    SUM(ly_date_return_unit_count_repeat) AS ly_date_return_unit_count_repeat,
    SUM(ly_date_return_unit_count_guest) AS ly_date_return_unit_count_guest,
    SUM(ly_date_total_returned_product_gross_rev_excluding_shipping) AS ly_date_total_returned_product_gross_rev_excluding_shipping,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_activating) AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_nonactivating) AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_repeat) AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    SUM(ly_date_returned_product_gross_rev_excluding_shipping_guest) AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
    SUM(ly_date_bop_onhand_qty) AS ly_date_bop_onhand_qty,
    SUM(ly_date_bop_available_to_sell_qty) AS ly_date_bop_available_to_sell_qty,
    SUM(ly_date_bop_open_to_buy_qty) AS ly_date_bop_open_to_buy_qty,
    SUM(ly_date_bop_open_to_buy_qty_incl_in_transit) AS ly_date_bop_open_to_buy_qty_incl_in_transit,
    SUM(ly_date_bop_retail_reserve) AS ly_date_bop_retail_reserve,
    SUM(ly_date_bop_inventory_cost) AS ly_date_bop_inventory_cost,
    SUM(ly_date_eop_onhand_qty) AS ly_date_eop_onhand_qty,
    SUM(ly_date_eop_available_to_sell_qty) AS ly_date_eop_available_to_sell_qty,
    SUM(ly_date_eop_open_to_buy_qty) AS ly_date_eop_open_to_buy_qty,
    SUM(ly_date_eop_open_to_buy_qty_incl_in_transit) AS ly_date_eop_open_to_buy_qty_incl_in_transit,
    SUM(ly_date_eop_retail_reserve) AS ly_date_eop_retail_reserve,
    SUM(ly_date_eop_inventory_cost) AS ly_date_eop_inventory_cost,
    $execution_start_time AS meta_create_datetime,
    $execution_start_time AS meta_update_datetime
FROM _ly_ty_metrics
WHERE date >= $process_from_date
    AND date < CURRENT_DATE()
GROUP BY date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail;

CREATE OR REPLACE TEMPORARY TABLE _sku_store AS
SELECT DISTINCT ds.store_id, dp.sku
FROM data_model.dim_product dp
JOIN data_model.dim_store ds ON dp.store_id = ds.store_id
WHERE ds.store_type = 'Online'
    AND dp.sku != 'Unknown'
    AND dp.category NOT IN ('Nail Polish Duo Bundles', 'Nail Polish Looks')
    AND dp.product_type NOT IN ('Membership Gift', 'Gift Certificate', 'Free Third Party Subscription', 'Directed Insert')
    AND ds.store_full_name NOT ILIKE '%(DM)%'
    AND ds.store_full_name NOT ILIKE '%Sample Request%'
    AND ds.store_full_name NOT ILIKE '%G-SWAG%'
    AND ds.store_full_name NOT ILIKE '%heels.com%'
    AND ds.store_full_name NOT ILIKE '%wholesale%'
    AND ds.store_full_name NOT ILIKE '%ret%'
    AND ds.store_full_name NOT ILIKE '%MEN%'
    AND ds.store_full_name NOT IN ('PS by JustFab', 'Fabletics BB', 'Fabletics CC', 'Fabletics DD', 'Fabletics EE')

UNION

SELECT ds.store_id, item_number AS sku
FROM data_model.dim_store ds
JOIN lake_view.ultra_warehouse.company c ON IFF(c.label = 'Shoe Dazzle', 'ShoeDazzle', c.label) = ds.store_brand
JOIN lake_view.ultra_warehouse.item i ON i.company_id = c.company_id
WHERE COALESCE(UPPER(wms_class),'NA') NOT IN ('CONSUMABLE', '', 'NONE')
    AND ds.store_type = 'Online'
    AND ds.store_full_name NOT ILIKE '%(DM)%'
    AND ds.store_full_name NOT ILIKE '%Sample Request%'
    AND ds.store_full_name NOT ILIKE '%G-SWAG%'
    AND ds.store_full_name NOT ILIKE '%heels.com%'
    AND ds.store_full_name NOT ILIKE '%wholesale%'
    AND ds.store_full_name NOT ILIKE '%ret%'
    AND ds.store_full_name NOT ILIKE '%MEN%'
    AND ds.store_full_name NOT IN ('PS by JustFab', 'Fabletics BB', 'Fabletics CC', 'Fabletics DD', 'Fabletics EE');

-- CREATE OR REPLACE TEMPORARY TABLE _savage_skus_on_fl AS
-- SELECT DISTINCT dp.sku
-- FROM data_model.dim_product dp
-- JOIN data_model.dim_store ds ON ds.store_id = dp.store_id
-- WHERE ds.store_brand = 'Fabletics'
--     AND product_category ILIKE 'Savage';

-- store_warehouse_map
/*
EU Inventory Logic
    1. All Savage X EU stores are pulling the inventory from 221 (Netherlands) except SX UK
    2. SX UK is pulling inventory from 221 (Netherlands) till 2021-03-17 and from 2021-03-18 it is pulling from 366 (UK)
    3. We hardcoded the dates for SX UK. We will refactor this along with incremental logic
    4. We are not duplicating the inventory for the remaining brands.
*/
CREATE OR REPLACE TEMPORARY TABLE _store_warehouse_mapping AS
SELECT sw.store_id,
    ds.store_name,
    ds.store_full_name,
    ds.store_brand,
    ds.store_type,
    ds.store_country AS country,
    ds.store_region AS region,
    dw.warehouse_id,
    IFF(ds.store_type = 'Retail', 1, 0) AS is_retail,
    CASE WHEN ds.store_brand = 'Savage X' AND ds.store_country = 'UK' THEN '2021-03-18'::DATE
        WHEN dw.warehouse_id = 465 THEN '2021-06-05'::DATE
        WHEN dw.warehouse_id = 466 THEN '2022-03-19'::DATE
        WHEN dw.warehouse_id = 467 THEN '2021-10-05'::DATE
        ELSE '2018-01-01'::DATE END AS from_date,
    CURRENT_DATE() AS to_date
FROM reference.store_warehouse sw
JOIN data_model.dim_store ds ON ds.store_id = sw.store_id
JOIN data_model.dim_warehouse dw ON sw.warehouse_id = dw.warehouse_id
    AND dw.is_active = 'true'
    AND dw.is_consignment = 'false'
    AND dw.warehouse_type = 'We Ship'

UNION

SELECT 133 AS store_id,
    'Savage X UK' AS store_name,
    'Savage X UK' AS store_full_name,
    'Savage X' AS store_brand,
    'Online' AS store_type,
    'UK' AS country,
    'EU' AS region,
    221 AS warehouse_id,
    0 AS is_retail,
    '2018-01-01'::DATE AS from_date,
    '2021-03-17'::DATE AS to_date;

INSERT INTO reporting.merch_planning_item_sku(
    date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    ty_total_unit_count,
    ty_unit_count_activating,
    ty_unit_count_nonactivating,
    ty_unit_count_repeat,
    ty_unit_count_guest,
    ty_total_product_subtotal,
    ty_product_subtotal_activating,
    ty_product_subtotal_nonactivating,
    ty_product_subtotal_repeat,
    ty_product_subtotal_guest,
    ty_total_product_discount,
    ty_product_discount_activating,
    ty_product_discount_nonactivating,
    ty_product_discount_repeat,
    ty_product_discount_guest,
    ty_total_product_gross_revenue_excl_shipping,
    ty_product_gross_revenue_excl_shipping_activating,
    ty_product_gross_revenue_excl_shipping_nonactivating,
    ty_product_gross_revenue_excl_shipping_repeat,
    ty_product_gross_revenue_excl_shipping_guest,
    ty_total_product_margin_pre_return_excl_shipping,
    ty_product_margin_pre_return_excl_shipping_activating,
    ty_product_margin_pre_return_excl_shipping_nonactivating,
    ty_product_margin_pre_return_excl_shipping_repeat,
    ty_product_margin_pre_return_excl_shipping_guest,
    ty_total_product_cost,
    ty_product_cost_activating,
    ty_product_cost_nonactivating,
    ty_product_cost_repeat,
    ty_product_cost_guest,
    ty_total_product_cost_c,
    ty_product_cost_activating_c,
    ty_product_cost_nonactivating_c,
    ty_product_cost_repeat_c,
    ty_product_cost_guest_c,
    ty_total_non_reduced_vip_price,
    ty_non_reduced_vip_price_activating,
    ty_non_reduced_vip_price_nonactivating,
    ty_non_reduced_vip_price_repeat,
    ty_non_reduced_vip_price_guest,
    ty_total_return_unit_count,
    ty_return_unit_count_activating,
    ty_return_unit_count_nonactivating,
    ty_return_unit_count_repeat,
    ty_return_unit_count_guest,
    ty_total_returned_product_gross_rev_excluding_shipping,
    ty_returned_product_gross_rev_excluding_shipping_activating,
    ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    ty_returned_product_gross_rev_excluding_shipping_repeat,
    ty_returned_product_gross_rev_excluding_shipping_guest,
    ty_bop_onhand_qty,
    ty_bop_available_to_sell_qty,
    ty_bop_open_to_buy_qty,
    ty_bop_open_to_buy_qty_incl_in_transit,
    ty_bop_retail_reserve,
    ty_bop_inventory_cost,
    ty_eop_onhand_qty,
    ty_eop_available_to_sell_qty,
    ty_eop_open_to_buy_qty,
    ty_eop_open_to_buy_qty_incl_in_transit,
    ty_eop_retail_reserve,
    ty_eop_inventory_cost,
    ly_day_total_unit_count,
    ly_day_unit_count_activating,
    ly_day_unit_count_nonactivating,
    ly_day_unit_count_repeat,
    ly_day_unit_count_guest,
    ly_day_total_product_subtotal,
    ly_day_product_subtotal_activating,
    ly_day_product_subtotal_nonactivating,
    ly_day_product_subtotal_repeat,
    ly_day_product_subtotal_guest,
    ly_day_total_product_discount,
    ly_day_product_discount_activating,
    ly_day_product_discount_nonactivating,
    ly_day_product_discount_repeat,
    ly_day_product_discount_guest,
    ly_day_total_product_gross_revenue_excl_shipping,
    ly_day_product_gross_revenue_excl_shipping_activating,
    ly_day_product_gross_revenue_excl_shipping_nonactivating,
    ly_day_product_gross_revenue_excl_shipping_repeat,
    ly_day_product_gross_revenue_excl_shipping_guest,
    ly_day_total_product_margin_pre_return_excl_shipping,
    ly_day_product_margin_pre_return_excl_shipping_activating,
    ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    ly_day_product_margin_pre_return_excl_shipping_repeat,
    ly_day_product_margin_pre_return_excl_shipping_guest,
    ly_day_total_product_cost,
    ly_day_product_cost_activating,
    ly_day_product_cost_nonactivating,
    ly_day_product_cost_repeat,
    ly_day_product_cost_guest,
    ly_day_total_product_cost_c,
    ly_day_product_cost_activating_c,
    ly_day_product_cost_nonactivating_c,
    ly_day_product_cost_repeat_c,
    ly_day_product_cost_guest_c,
    ly_day_total_non_reduced_vip_price,
    ly_day_non_reduced_vip_price_activating,
    ly_day_non_reduced_vip_price_nonactivating,
    ly_day_non_reduced_vip_price_repeat,
    ly_day_non_reduced_vip_price_guest,
    ly_day_total_return_unit_count,
    ly_day_return_unit_count_activating,
    ly_day_return_unit_count_nonactivating,
    ly_day_return_unit_count_repeat,
    ly_day_return_unit_count_guest,
    ly_day_total_returned_product_gross_rev_excluding_shipping,
    ly_day_returned_product_gross_rev_excluding_shipping_activating,
    ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    ly_day_returned_product_gross_rev_excluding_shipping_guest,
    ly_day_bop_onhand_qty,
    ly_day_bop_available_to_sell_qty,
    ly_day_bop_open_to_buy_qty,
    ly_day_bop_open_to_buy_qty_incl_in_transit,
    ly_day_bop_retail_reserve,
    ly_day_bop_inventory_cost,
    ly_day_eop_onhand_qty,
    ly_day_eop_available_to_sell_qty,
    ly_day_eop_open_to_buy_qty,
    ly_day_eop_open_to_buy_qty_incl_in_transit,
    ly_day_eop_retail_reserve,
    ly_day_eop_inventory_cost,
    ly_date_total_unit_count,
    ly_date_unit_count_activating,
    ly_date_unit_count_nonactivating,
    ly_date_unit_count_repeat,
    ly_date_unit_count_guest,
    ly_date_total_product_subtotal,
    ly_date_product_subtotal_activating,
    ly_date_product_subtotal_nonactivating,
    ly_date_product_subtotal_repeat,
    ly_date_product_subtotal_guest,
    ly_date_total_product_discount,
    ly_date_product_discount_activating,
    ly_date_product_discount_nonactivating,
    ly_date_product_discount_repeat,
    ly_date_product_discount_guest,
    ly_date_total_product_gross_revenue_excl_shipping,
    ly_date_product_gross_revenue_excl_shipping_activating,
    ly_date_product_gross_revenue_excl_shipping_nonactivating,
    ly_date_product_gross_revenue_excl_shipping_repeat,
    ly_date_product_gross_revenue_excl_shipping_guest,
    ly_date_total_product_margin_pre_return_excl_shipping,
    ly_date_product_margin_pre_return_excl_shipping_activating,
    ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    ly_date_product_margin_pre_return_excl_shipping_repeat,
    ly_date_product_margin_pre_return_excl_shipping_guest,
    ly_date_total_product_cost,
    ly_date_product_cost_activating,
    ly_date_product_cost_nonactivating,
    ly_date_product_cost_repeat,
    ly_date_product_cost_guest,
    ly_date_total_product_cost_c,
    ly_date_product_cost_activating_c,
    ly_date_product_cost_nonactivating_c,
    ly_date_product_cost_repeat_c,
    ly_date_product_cost_guest_c,
    ly_date_total_non_reduced_vip_price,
    ly_date_non_reduced_vip_price_activating,
    ly_date_non_reduced_vip_price_nonactivating,
    ly_date_non_reduced_vip_price_repeat,
    ly_date_non_reduced_vip_price_guest,
    ly_date_total_return_unit_count,
    ly_date_return_unit_count_activating,
    ly_date_return_unit_count_nonactivating,
    ly_date_return_unit_count_repeat,
    ly_date_return_unit_count_guest,
    ly_date_total_returned_product_gross_rev_excluding_shipping,
    ly_date_returned_product_gross_rev_excluding_shipping_activating,
    ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    ly_date_returned_product_gross_rev_excluding_shipping_guest,
    ly_date_bop_onhand_qty,
    ly_date_bop_available_to_sell_qty,
    ly_date_bop_open_to_buy_qty,
    ly_date_bop_open_to_buy_qty_incl_in_transit,
    ly_date_bop_retail_reserve,
    ly_date_bop_inventory_cost,
    ly_date_eop_onhand_qty,
    ly_date_eop_available_to_sell_qty,
    ly_date_eop_open_to_buy_qty,
    ly_date_eop_open_to_buy_qty_incl_in_transit,
    ly_date_eop_retail_reserve,
    ly_date_eop_inventory_cost,
    meta_create_datetime,
    meta_update_datetime
)
-- inventory
WITH _inventory_base AS (
    SELECT fih.local_date AS date,
        'Inventory' AS date_type,
        swm.store_id,
        UPPER(swm.store_name) AS store_name,
        UPPER(swm.store_full_name) AS store_full_name,
        UPPER(trim(swm.store_brand)) AS brand,
        swm.store_type,
        swm.country,
        'None' AS finance_specialty_store,
        swm.region,
        fih.sku,
        pb.product_brand,
        dsku.product_sku,
        dsku.base_sku,
        swm.is_retail,
        CASE
            WHEN swm.store_id = 241 AND fih.warehouse_id IN (154,231,466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0 -- Targets Wholesale Store ID
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0 -- Targets FL SKUs sold under JFB Store ID
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            ELSE SUM(COALESCE(fih.onhand_quantity, 0))
        END AS onhand_qty,
        CASE
            WHEN swm.store_id = 241 AND fih.warehouse_id IN (154, 231, 466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            ELSE
                SUM(COALESCE(
                        CASE
                            WHEN UPPER(swm.store_brand) IN ('FABLETICS', 'YITTY') THEN fih.ecom_available_to_sell_quantity
                            ELSE fih.available_to_sell_quantity
                        END, 0)
                    )
        END AS available_to_sell_qty,
        CASE
            WHEN swm.store_id = 241 AND fih.warehouse_id IN (154,231,466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            ELSE SUM(COALESCE(fih.open_to_buy_quantity, 0))
        END AS open_to_buy_qty,
        CASE
            WHEN swm.store_id = 241 AND fih.warehouse_id  IN (154,231,466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            ELSE SUM(COALESCE(fih.open_to_buy_quantity, 0) + COALESCE(fih.intransit_quantity, 0))
        END AS open_to_buy_qty_incl_in_transit,
        CASE
            WHEN swm.store_id = 241 AND fih.warehouse_id IN (154,231,466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            ELSE SUM(COALESCE(fih.manual_stock_reserve_quantity, 0))
        END AS retail_reserve,
        CASE
            -- To de-dupe the cost from Yitty due to store warehouse mapping
            WHEN swm.store_id = 241 AND fih.warehouse_id IN (154,231,466) AND swm.store_type <> 'Retail' THEN 0
            WHEN swm.store_id = 315 THEN 0
--             WHEN swm.store_id in (38,48) AND fih.warehouse_id in (221,366) THEN 0
            WHEN upper(TRIM(swm.store_brand)) = 'JUSTFAB' AND upper(trim(pb.product_brand)) = 'FABLETICS' THEN 0
            -- FL only to match OTB Dashboard, if SxF wants this we can implement for them as well
            WHEN UPPER(trim(swm.store_brand)) in ('FABLETICS','YITTY') THEN SUM((COALESCE(fih.open_to_buy_quantity,0) + COALESCE(fih.intransit_quantity, 0)) * COALESCE(fih.landed_cost_per_unit,0))
            -- SxF still uses this logic
            ELSE SUM(COALESCE(fih.total_onhand_landed_cost, 0) + (COALESCE(fih.landed_cost_per_unit, 0) * COALESCE(fih.intransit_quantity, 0)))
        END AS inventory_cost
    FROM _store_warehouse_mapping swm
    LEFT JOIN data_model.fact_inventory_history fih
        ON swm.warehouse_id = fih.warehouse_id
        AND fih.local_date BETWEEN swm.from_date AND swm.to_date
    LEFT JOIN data_model.fact_inventory_in_transit_from_history AS fit
        ON fit.item_id = fih.item_id AND fit.from_warehouse_id = fih.warehouse_id
        AND fih.local_date BETWEEN fit.effective_from_date AND fit.effective_to_date
    LEFT JOIN _sku_store ss
        ON fih.sku = ss.sku
        AND ss.store_id = swm.store_id
    LEFT JOIN data_model.dim_sku dsku
        ON fih.sku = dsku.sku
    LEFT JOIN (SELECT DISTINCT i.item_number,
                CASE
                    WHEN UPPER(label) = 'FABLETICS' AND UPPER(department) = 'SHAPEWEAR' THEN 'YITTY'
                    WHEN upper(label) = 'SHOE DAZZLE' THEN 'SHOEDAZZLE'
                    ELSE UPPER(label)
                END AS product_brand
                FROM lake_view.ultra_warehouse.item i
                JOIN lake_view.ultra_warehouse.company c
                    ON i.company_id = c.company_id) pb
        ON fih.sku = pb.item_number
    WHERE (
          swm.is_retail = 1 OR
            ss.sku IS NOT NULL
        )
        AND fih.local_date IN (
            WITH _processing_dates AS (
                    SELECT full_date
                    FROM data_model.dim_date
                    WHERE full_date >= $inventory_date
                        AND full_date <= CURRENT_DATE()
                    UNION
                    SELECT full_date
                    FROM data_model.dim_date
                    WHERE full_date >= $inventory_date - 364
                        AND full_date <= CURRENT_DATE() - 364
                    UNION
                    SELECT full_date
                    FROM data_model.dim_date
                    WHERE full_date >= DATEADD(YEAR, -1, $inventory_date)
                        AND full_date <= DATEADD(YEAR, -1, CURRENT_DATE())
                )
                SELECT full_date
                FROM _processing_dates
                UNION
                SELECT full_date + 1 AS full_date
                FROM _processing_dates
            )
        AND fih.local_date <= CURRENT_DATE()
    GROUP BY fih.local_date,
        swm.store_id,
        UPPER(swm.store_name),
        UPPER(swm.store_full_name),
        UPPER(trim(swm.store_brand)),
        swm.store_type,
        swm.country,
        swm.region,
        fih.sku,
        pb.product_brand,
        dsku.product_sku,
        dsku.base_sku,
        swm.is_retail,
        fih.warehouse_id
),
_bop_eop AS (
    SELECT date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        onhand_qty AS bop_onhand_qty,
        available_to_sell_qty AS bop_available_to_sell_qty,
        open_to_buy_qty AS bop_open_to_buy_qty,
        open_to_buy_qty_incl_in_transit AS bop_open_to_buy_qty_incl_in_transit,
        retail_reserve AS bop_retail_reserve,
        inventory_cost AS bop_inventory_cost,
        0 AS eop_onhand_qty,
        0 AS eop_available_to_sell_qty,
        0 AS eop_open_to_buy_qty,
        0 AS eop_open_to_buy_qty_incl_in_transit,
        0 AS eop_retail_reserve,
        0 AS eop_inventory_cost
    FROM _inventory_base

    UNION ALL

    SELECT date - 1 AS date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS bop_onhand_qty,
        0 AS bop_available_to_sell_qty,
        0 AS bop_open_to_buy_qty,
        0 AS bop_open_to_buy_qty_incl_in_transit,
        0 AS bop_retail_reserve,
        0 AS bop_inventory_cost,
        onhand_qty AS eop_onhand_qty,
        available_to_sell_qty AS eop_available_to_sell_qty,
        open_to_buy_qty AS eop_open_to_buy_qty,
        open_to_buy_qty_incl_in_transit AS eop_open_to_buy_qty_incl_in_transit,
        retail_reserve AS eop_retail_reserve,
        inventory_cost AS eop_inventory_cost
    FROM _inventory_base
),
_inventory AS(
    SELECT date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        be.sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        SUM(COALESCE(bop_onhand_qty, 0)) AS bop_onhand_qty,
        SUM(COALESCE(bop_available_to_sell_qty, 0)) AS bop_available_to_sell_qty,
        SUM(COALESCE(bop_open_to_buy_qty, 0)) AS bop_open_to_buy_qty,
        SUM(COALESCE(bop_open_to_buy_qty_incl_in_transit, 0)) AS bop_open_to_buy_qty_incl_in_transit,
        SUM(COALESCE(bop_retail_reserve, 0)) AS bop_retail_reserve,
        SUM(COALESCE(bop_inventory_cost, 0)) AS bop_inventory_cost,
        SUM(COALESCE(eop_onhand_qty, 0)) AS eop_onhand_qty,
        SUM(COALESCE(eop_available_to_sell_qty, 0)) AS eop_available_to_sell_qty,
        SUM(COALESCE(eop_open_to_buy_qty, 0)) AS eop_open_to_buy_qty,
        SUM(COALESCE(eop_open_to_buy_qty_incl_in_transit, 0)) AS eop_open_to_buy_qty_incl_in_transit,
        SUM(COALESCE(eop_retail_reserve, 0)) AS eop_retail_reserve,
        SUM(COALESCE(eop_inventory_cost, 0)) AS eop_inventory_cost
    FROM _bop_eop be
--     LEFT JOIN _savage_skus_on_fl ssof ON ssof.sku = be.sku
--         AND UPPER(be.brand) = 'FABLETICS'
--     WHERE ssof.sku IS NULL
    GROUP BY date,
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        be.sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail
),
_ty_ly_inventory AS(
    SELECT date AS date_label, -- TY
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        bop_onhand_qty AS ty_bop_onhand_qty,
        bop_available_to_sell_qty AS ty_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ty_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ty_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ty_bop_retail_reserve,
        bop_inventory_cost AS ty_bop_inventory_cost,
        eop_onhand_qty AS ty_eop_onhand_qty,
        eop_available_to_sell_qty AS ty_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ty_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ty_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ty_eop_retail_reserve,
        eop_inventory_cost AS ty_eop_inventory_cost,
        0 AS ly_day_bop_onhand_qty,
        0 AS ly_day_bop_available_to_sell_qty,
        0 AS ly_day_bop_open_to_buy_qty,
        0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_bop_retail_reserve,
        0 AS ly_day_bop_inventory_cost,
        0 AS ly_day_eop_onhand_qty,
        0 AS ly_day_eop_available_to_sell_qty,
        0 AS ly_day_eop_open_to_buy_qty,
        0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_eop_retail_reserve,
        0 AS ly_day_eop_inventory_cost,
        0 AS ly_date_bop_onhand_qty,
        0 AS ly_date_bop_available_to_sell_qty,
        0 AS ly_date_bop_open_to_buy_qty,
        0 AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_bop_retail_reserve,
        0 AS ly_date_bop_inventory_cost,
        0 AS ly_date_eop_onhand_qty,
        0 AS ly_date_eop_available_to_sell_qty,
        0 AS ly_date_eop_open_to_buy_qty,
        0 AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_eop_retail_reserve,
        0 AS ly_date_eop_inventory_cost
    FROM _inventory
    UNION ALL
    SELECT date + 364 AS date_label, -- LY_DAY
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS ty_bop_onhand_qty,
        0 AS ty_bop_available_to_sell_qty,
        0 AS ty_bop_open_to_buy_qty,
        0 AS ty_bop_open_to_buy_qty_incl_in_transit,
        0 AS ty_bop_retail_reserve,
        0 AS ty_bop_inventory_cost,
        0 AS ty_eop_onhand_qty,
        0 AS ty_eop_available_to_sell_qty,
        0 AS ty_eop_open_to_buy_qty,
        0 AS ty_eop_open_to_buy_qty_incl_in_transit,
        0 AS ty_eop_retail_reserve,
        0 AS ty_eop_inventory_cost,
        bop_onhand_qty AS ly_day_bop_onhand_qty,
        bop_available_to_sell_qty AS ly_day_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ly_day_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ly_day_bop_retail_reserve,
        bop_inventory_cost AS ly_day_bop_inventory_cost,
        eop_onhand_qty AS ly_day_eop_onhand_qty,
        eop_available_to_sell_qty AS ly_day_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ly_day_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ly_day_eop_retail_reserve,
        eop_inventory_cost AS ly_day_eop_inventory_cost,
        0 AS ly_date_bop_onhand_qty,
        0 AS ly_date_bop_available_to_sell_qty,
        0 AS ly_date_bop_open_to_buy_qty,
        0 AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_bop_retail_reserve,
        0 AS ly_date_bop_inventory_cost,
        0 AS ly_date_eop_onhand_qty,
        0 AS ly_date_eop_available_to_sell_qty,
        0 AS ly_date_eop_open_to_buy_qty,
        0 AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_date_eop_retail_reserve,
        0 AS ly_date_eop_inventory_cost
    FROM _inventory
    UNION ALL
    SELECT DATEADD('YEAR', 1, date) AS date_label, --LY_DATE
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS ty_bop_onhand_qty,
        0 AS ty_bop_available_to_sell_qty,
        0 AS ty_bop_open_to_buy_qty,
        0 AS ty_bop_open_to_buy_qty_incl_in_transit,
        0 AS ty_bop_retail_reserve,
        0 AS ty_bop_inventory_cost,
        0 AS ty_eop_onhand_qty,
        0 AS ty_eop_available_to_sell_qty,
        0 AS ty_eop_open_to_buy_qty,
        0 AS ty_eop_open_to_buy_qty_incl_in_transit,
        0 AS ty_eop_retail_reserve,
        0 AS ty_eop_inventory_cost,
        0 AS ly_day_bop_onhand_qty,
        0 AS ly_day_bop_available_to_sell_qty,
        0 AS ly_day_bop_open_to_buy_qty,
        0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_bop_retail_reserve,
        0 AS ly_day_bop_inventory_cost,
        0 AS ly_day_eop_onhand_qty,
        0 AS ly_day_eop_available_to_sell_qty,
        0 AS ly_day_eop_open_to_buy_qty,
        0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_eop_retail_reserve,
        0 AS ly_day_eop_inventory_cost,
        bop_onhand_qty AS ly_date_bop_onhand_qty,
        bop_available_to_sell_qty AS ly_date_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ly_date_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ly_date_bop_retail_reserve,
        bop_inventory_cost AS ly_date_bop_inventory_cost,
        eop_onhand_qty AS ly_date_eop_onhand_qty,
        eop_available_to_sell_qty AS ly_date_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ly_date_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ly_date_eop_retail_reserve,
        eop_inventory_cost AS ly_date_eop_inventory_cost
    FROM _inventory
    WHERE NOT (MONTH(date) = 2 AND DAY(date) = 29)
    UNION ALL
    SELECT DATEADD('YEAR', 1, date) + 1 date_label, -- LEAP YEAR LY_DATE; Only for Feb 29
        date_type,
        store_id,
        store_name,
        store_full_name,
        brand,
        store_type,
        country,
        finance_specialty_store,
        region,
        sku,
        product_brand,
        product_sku,
        base_sku,
        is_retail,
        0 AS ty_bop_onhand_qty,
        0 AS ty_bop_available_to_sell_qty,
        0 AS ty_bop_open_to_buy_qty,
        0 AS ty_bop_open_to_buy_qty_incl_in_transit,
        0 AS ty_bop_retail_reserve,
        0 AS ty_bop_inventory_cost,
        0 AS ty_eop_onhand_qty,
        0 AS ty_eop_available_to_sell_qty,
        0 AS ty_eop_open_to_buy_qty,
        0 AS ty_eop_open_to_buy_qty_incl_in_transit,
        0 AS ty_eop_retail_reserve,
        0 AS ty_eop_inventory_cost,
        0 AS ly_day_bop_onhand_qty,
        0 AS ly_day_bop_available_to_sell_qty,
        0 AS ly_day_bop_open_to_buy_qty,
        0 AS ly_day_bop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_bop_retail_reserve,
        0 AS ly_day_bop_inventory_cost,
        0 AS ly_day_eop_onhand_qty,
        0 AS ly_day_eop_available_to_sell_qty,
        0 AS ly_day_eop_open_to_buy_qty,
        0 AS ly_day_eop_open_to_buy_qty_incl_in_transit,
        0 AS ly_day_eop_retail_reserve,
        0 AS ly_day_eop_inventory_cost,
        bop_onhand_qty AS ly_date_bop_onhand_qty,
        bop_available_to_sell_qty AS ly_date_bop_available_to_sell_qty,
        bop_open_to_buy_qty AS ly_date_bop_open_to_buy_qty,
        bop_open_to_buy_qty_incl_in_transit AS ly_date_bop_open_to_buy_qty_incl_in_transit,
        bop_retail_reserve AS ly_date_bop_retail_reserve,
        bop_inventory_cost AS ly_date_bop_inventory_cost,
        eop_onhand_qty AS ly_date_eop_onhand_qty,
        eop_available_to_sell_qty AS ly_date_eop_available_to_sell_qty,
        eop_open_to_buy_qty AS ly_date_eop_open_to_buy_qty,
        eop_open_to_buy_qty_incl_in_transit AS ly_date_eop_open_to_buy_qty_incl_in_transit,
        eop_retail_reserve AS ly_date_eop_retail_reserve,
        eop_inventory_cost AS ly_date_eop_inventory_cost
    FROM _inventory
    WHERE MONTH(date) = 2 AND DAY(date) = 28 AND DAY(DATEADD('YEAR', 1, date) + 1) = 29
)
SELECT date_label AS date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    brand AS store_brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail,
    0 AS ty_total_unit_count,
    0 AS ty_unit_count_activating,
    0 AS ty_unit_count_nonactivating,
    0 AS ty_unit_count_repeat,
    0 AS ty_unit_count_guest,
    0 AS ty_total_product_subtotal,
    0 AS ty_product_subtotal_activating,
    0 AS ty_product_subtotal_nonactivating,
    0 AS ty_product_subtotal_repeat,
    0 AS ty_product_subtotal_guest,
    0 AS ty_total_product_discount,
    0 AS ty_product_discount_activating,
    0 AS ty_product_discount_nonactivating,
    0 AS ty_product_discount_repeat,
    0 AS ty_product_discount_guest,
    0 AS ty_total_product_gross_revenue_excl_shipping,
    0 AS ty_product_gross_revenue_excl_shipping_activating,
    0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ty_product_gross_revenue_excl_shipping_repeat,
    0 AS ty_product_gross_revenue_excl_shipping_guest,
    0 AS ty_total_product_margin_pre_return_excl_shipping,
    0 AS ty_product_margin_pre_return_excl_shipping_activating,
    0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ty_product_margin_pre_return_excl_shipping_repeat,
    0 AS ty_product_margin_pre_return_excl_shipping_guest,
    0 AS ty_total_product_cost,
    0 AS ty_product_cost_activating,
    0 AS ty_product_cost_nonactivating,
    0 AS ty_product_cost_repeat,
    0 AS ty_product_cost_guest,
    0 AS ty_total_product_cost_c,
    0 AS ty_product_cost_activating_c,
    0 AS ty_product_cost_nonactivating_c,
    0 AS ty_product_cost_repeat_c,
    0 AS ty_product_cost_guest_c,
    0 AS ty_total_non_reduced_vip_price,
    0 AS ty_non_reduced_vip_price_activating,
    0 AS ty_non_reduced_vip_price_nonactivating,
    0 AS ty_non_reduced_vip_price_repeat,
    0 AS ty_non_reduced_vip_price_guest,
    0 AS ty_total_return_unit_count,
    0 AS ty_return_unit_count_activating,
    0 AS ty_return_unit_count_nonactivating,
    0 AS ty_return_unit_count_repeat,
    0 AS ty_return_unit_count_guest,
    0 AS ty_total_returned_product_gross_rev_excluding_shipping,
    0 AS ty_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ty_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ty_returned_product_gross_rev_excluding_shipping_guest,
    SUM(COALESCE(ty_bop_onhand_qty, 0)) AS ty_bop_onhand_qty,
    SUM(COALESCE(ty_bop_available_to_sell_qty, 0)) AS ty_bop_available_to_sell_qty,
    SUM(COALESCE(ty_bop_open_to_buy_qty, 0)) AS ty_bop_open_to_buy_qty,
    SUM(COALESCE(ty_bop_open_to_buy_qty_incl_in_transit, 0)) AS ty_bop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ty_bop_retail_reserve, 0)) AS ty_bop_retail_reserve,
    SUM(COALESCE(ty_bop_inventory_cost, 0)) AS ty_bop_inventory_cost,
    SUM(COALESCE(ty_eop_onhand_qty, 0)) AS ty_eop_onhand_qty,
    SUM(COALESCE(ty_eop_available_to_sell_qty, 0)) AS ty_eop_available_to_sell_qty,
    SUM(COALESCE(ty_eop_open_to_buy_qty, 0)) AS ty_eop_open_to_buy_qty,
    SUM(COALESCE(ty_eop_open_to_buy_qty_incl_in_transit, 0)) AS ty_eop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ty_eop_retail_reserve, 0)) AS ty_eop_retail_reserve,
    SUM(COALESCE(ty_eop_inventory_cost, 0)) AS ty_eop_inventory_cost,
    0 AS ly_day_total_unit_count,
    0 AS ly_day_unit_count_activating,
    0 AS ly_day_unit_count_nonactivating,
    0 AS ly_day_unit_count_repeat,
    0 AS ly_day_unit_count_guest,
    0 AS ly_day_total_product_subtotal,
    0 AS ly_day_product_subtotal_activating,
    0 AS ly_day_product_subtotal_nonactivating,
    0 AS ly_day_product_subtotal_repeat,
    0 AS ly_day_product_subtotal_guest,
    0 AS ly_day_total_product_discount,
    0 AS ly_day_product_discount_activating,
    0 AS ly_day_product_discount_nonactivating,
    0 AS ly_day_product_discount_repeat,
    0 AS ly_day_product_discount_guest,
    0 AS ly_day_total_product_gross_revenue_excl_shipping,
    0 AS ly_day_product_gross_revenue_excl_shipping_activating,
    0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_day_product_gross_revenue_excl_shipping_guest,
    0 AS ly_day_total_product_margin_pre_return_excl_shipping,
    0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_day_total_product_cost,
    0 AS ly_day_product_cost_activating,
    0 AS ly_day_product_cost_nonactivating,
    0 AS ly_day_product_cost_repeat,
    0 AS ly_day_product_cost_guest,
    0 AS ly_day_total_product_cost_c,
    0 AS ly_day_product_cost_activating_c,
    0 AS ly_day_product_cost_nonactivating_c,
    0 AS ly_day_product_cost_repeat_c,
    0 AS ly_day_product_cost_guest_c,
    0 AS ly_day_total_non_reduced_vip_price,
    0 AS ly_day_non_reduced_vip_price_activating,
    0 AS ly_day_non_reduced_vip_price_nonactivating,
    0 AS ly_day_non_reduced_vip_price_repeat,
    0 AS ly_day_non_reduced_vip_price_guest,
    0 AS ly_day_total_return_unit_count,
    0 AS ly_day_return_unit_count_activating,
    0 AS ly_day_return_unit_count_nonactivating,
    0 AS ly_day_return_unit_count_repeat,
    0 AS ly_day_return_unit_count_guest,
    0 AS ly_day_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_day_returned_product_gross_rev_excluding_shipping_guest,
    SUM(COALESCE(ly_day_bop_onhand_qty, 0)) AS ly_day_bop_onhand_qty,
    SUM(COALESCE(ly_day_bop_available_to_sell_qty, 0)) AS ly_day_bop_available_to_sell_qty,
    SUM(COALESCE(ly_day_bop_open_to_buy_qty, 0)) AS ly_day_bop_open_to_buy_qty,
    SUM(COALESCE(ly_day_bop_open_to_buy_qty_incl_in_transit, 0)) AS ly_day_bop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ly_day_bop_retail_reserve, 0)) AS ly_day_bop_retail_reserve,
    SUM(COALESCE(ly_day_bop_inventory_cost, 0)) AS ly_day_bop_inventory_cost,
    SUM(COALESCE(ly_day_eop_onhand_qty, 0)) AS ly_day_eop_onhand_qty,
    SUM(COALESCE(ly_day_eop_available_to_sell_qty, 0)) AS ly_day_eop_available_to_sell_qty,
    SUM(COALESCE(ly_day_eop_open_to_buy_qty, 0)) AS ly_day_eop_open_to_buy_qty,
    SUM(COALESCE(ly_day_eop_open_to_buy_qty_incl_in_transit, 0)) AS ly_day_eop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ly_day_eop_retail_reserve, 0)) AS ly_day_eop_retail_reserve,
    SUM(COALESCE(ly_day_eop_inventory_cost, 0)) AS ly_day_eop_inventory_cost,
    0 AS ly_date_total_unit_count,
    0 AS ly_date_unit_count_activating,
    0 AS ly_date_unit_count_nonactivating,
    0 AS ly_date_unit_count_repeat,
    0 AS ly_date_unit_count_guest,
    0 AS ly_date_total_product_subtotal,
    0 AS ly_date_product_subtotal_activating,
    0 AS ly_date_product_subtotal_nonactivating,
    0 AS ly_date_product_subtotal_repeat,
    0 AS ly_date_product_subtotal_guest,
    0 AS ly_date_total_product_discount,
    0 AS ly_date_product_discount_activating,
    0 AS ly_date_product_discount_nonactivating,
    0 AS ly_date_product_discount_repeat,
    0 AS ly_date_product_discount_guest,
    0 AS ly_date_total_product_gross_revenue_excl_shipping,
    0 AS ly_date_product_gross_revenue_excl_shipping_activating,
    0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
    0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
    0 AS ly_date_product_gross_revenue_excl_shipping_guest,
    0 AS ly_date_total_product_margin_pre_return_excl_shipping,
    0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
    0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
    0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
    0 AS ly_date_total_product_cost,
    0 AS ly_date_product_cost_activating,
    0 AS ly_date_product_cost_nonactivating,
    0 AS ly_date_product_cost_repeat,
    0 AS ly_date_product_cost_guest,
    0 AS ly_date_total_product_cost_c,
    0 AS ly_date_product_cost_activating_c,
    0 AS ly_date_product_cost_nonactivating_c,
    0 AS ly_date_product_cost_repeat_c,
    0 AS ly_date_product_cost_guest_c,
    0 AS ly_date_total_non_reduced_vip_price,
    0 AS ly_date_non_reduced_vip_price_activating,
    0 AS ly_date_non_reduced_vip_price_nonactivating,
    0 AS ly_date_non_reduced_vip_price_repeat,
    0 AS ly_date_non_reduced_vip_price_guest,
    0 AS ly_date_total_return_unit_count,
    0 AS ly_date_return_unit_count_activating,
    0 AS ly_date_return_unit_count_nonactivating,
    0 AS ly_date_return_unit_count_repeat,
    0 AS ly_date_return_unit_count_guest,
    0 AS ly_date_total_returned_product_gross_rev_excluding_shipping,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_activating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_nonactivating,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_repeat,
    0 AS ly_date_returned_product_gross_rev_excluding_shipping_guest,
    SUM(COALESCE(ly_date_bop_onhand_qty, 0)) AS ly_date_bop_onhand_qty,
    SUM(COALESCE(ly_date_bop_available_to_sell_qty, 0)) AS ly_date_bop_available_to_sell_qty,
    SUM(COALESCE(ly_date_bop_open_to_buy_qty, 0)) AS ly_date_bop_open_to_buy_qty,
    SUM(COALESCE(ly_date_bop_open_to_buy_qty_incl_in_transit, 0)) AS ly_date_bop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ly_date_bop_retail_reserve, 0)) AS ly_date_bop_retail_reserve,
    SUM(COALESCE(ly_date_bop_inventory_cost, 0)) AS ly_date_bop_inventory_cost,
    SUM(COALESCE(ly_date_eop_onhand_qty, 0)) AS ly_date_eop_onhand_qty,
    SUM(COALESCE(ly_date_eop_available_to_sell_qty, 0)) AS ly_date_eop_available_to_sell_qty,
    SUM(COALESCE(ly_date_eop_open_to_buy_qty, 0)) AS ly_date_eop_open_to_buy_qty,
    SUM(COALESCE(ly_date_eop_open_to_buy_qty_incl_in_transit, 0)) AS ly_date_eop_open_to_buy_qty_incl_in_transit,
    SUM(COALESCE(ly_date_eop_retail_reserve, 0)) AS ly_date_eop_retail_reserve,
    SUM(COALESCE(ly_date_eop_inventory_cost, 0)) AS ly_date_eop_inventory_cost,
    $execution_start_time AS meta_create_datetime,
    $execution_start_time AS meta_update_datetime
FROM _ty_ly_inventory
WHERE date >= $inventory_date
    AND date < CURRENT_DATE()
GROUP BY date,
    date_type,
    store_id,
    store_name,
    store_full_name,
    brand,
    store_type,
    country,
    finance_specialty_store,
    region,
    sku,
    product_brand,
    product_sku,
    base_sku,
    is_retail;

COMMIT;

UPDATE stg.meta_table_dependency_watermark
SET high_watermark_datetime = IFF(dependent_table_name IS NOT NULL, new_high_watermark_datetime,
        (SELECT MAX(meta_update_datetime) AS new_high_watermark_datetime FROM reporting.merch_planning_item_sku)),
    meta_update_datetime = CURRENT_TIMESTAMP()
WHERE table_name = $target_table;
