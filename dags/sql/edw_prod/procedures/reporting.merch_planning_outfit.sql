SET execution_start_time = CURRENT_TIMESTAMP :: TIMESTAMP_LTZ(3);

CREATE OR REPLACE TEMPORARY TABLE _bundle_name AS
SELECT fol.order_line_id,
       dp.product_name  AS bundle_name,
       dp.product_alias AS bundle_alias
FROM data_model.fact_order_line fol
         JOIN lake_consolidated.ultra_merchant.order_line ol ON fol.bundle_order_line_id = ol.order_line_id
         JOIN data_model.dim_product dp ON dp.product_id = ol.product_id;

-- Product Brand
CREATE OR REPLACE TEMPORARY TABLE _product_brand AS
SELECT DISTINCT i.item_number,
                CASE WHEN UPPER(label) = 'FABLETICS' AND UPPER(department) = 'SHAPEWEAR' THEN 'YITTY' ELSE UPPER(label) END AS product_brand
FROM lake_view.ultra_warehouse.item i
         JOIN lake_view.ultra_warehouse.company c ON i.company_id = c.company_id ;

CREATE OR REPLACE TEMPORARY TABLE _bundle_base_calculation AS
SELECT CAST(fol.order_local_datetime AS DATE)               AS date,
       'Placed'                                             AS date_type,
       ds.store_id,
       UPPER(ds.store_name)                                 AS store_name,
       UPPER(ds.store_full_name)                            AS store_full_name,
       UPPER(ds.store_brand)                                AS store_brand,
       pb.product_brand,
       ds.store_type                                        AS store_type,
       ds.store_region                                      AS region,
       ds.store_country                                     AS country,
       dc.finance_specialty_store,
       CASE WHEN ds.store_type = 'Retail' THEN 1 ELSE 0 END AS is_retail,
       bn.bundle_name,
       bn.bundle_alias,
       COUNT(DISTINCT fol.bundle_order_line_id)             AS total_bundle_count,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 = 'Activating VIP', fol.bundle_order_line_id,
                          NULL))                            AS bundle_count_activating,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'), fol.bundle_order_line_id,
                          NULL))                            AS bundle_count_nonactivating,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 IN ('Repeat VIP'), fol.bundle_order_line_id,
                          NULL))                            AS bundle_count_repeat,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 = 'Guest', fol.bundle_order_line_id,
                          NULL))                            AS bundle_count_guest,
       SUM(COALESCE(fol.product_subtotal_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_subtotal,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_subtotal_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_subtotal_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_subtotal_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_subtotal_guest,
       SUM(COALESCE(fol.product_discount_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_discount,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_discount_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_discount_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_discount_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_discount_guest,
       SUM(COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_gross_revenue_excl_shipping,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_gross_revenue_excl_shipping_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_gross_revenue_excl_shipping_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_gross_revenue_excl_shipping_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_gross_revenue_excl_shipping_guest,
       SUM(COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_margin_pre_return_excl_shipping,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_margin_pre_return_excl_shipping_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_margin_pre_return_excl_shipping_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_margin_pre_return_excl_shipping_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_margin_pre_return_excl_shipping_guest,
       SUM(COALESCE(fol.estimated_landed_cost_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_cost,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_guest,


       SUM(COALESCE(fol.reporting_landed_cost_local_amount, 0) *
           COALESCE(fol.order_date_usd_conversion_rate, 1)) AS total_product_cost_c,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_activating_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_nonactivating_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_repeat_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.order_date_usd_conversion_rate, 1),
               0))                                          AS product_cost_guest_c,


       SUM(
                   (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
                   COALESCE(fol.order_date_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)))
                                                            AS total_non_reduced_vip_price,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                          AS non_reduced_vip_price_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                          AS non_reduced_vip_price_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                          AS non_reduced_vip_price_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.order_date_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                          AS non_reduced_vip_price_guest
FROM data_model.fact_order_line fol
         JOIN _bundle_name bn ON fol.order_line_id = bn.order_line_id
         JOIN data_model.dim_product dp ON fol.product_id = dp.product_id
         JOIN data_model.dim_item_price dip ON fol.item_price_key = dip.item_price_key
         JOIN _product_brand pb ON IFF(dip.sku = 'Unknown',dp.sku,dip.sku) = pb.item_number
         JOIN data_model.dim_store ds ON fol.store_id = ds.store_id
         JOIN data_model.fact_order fo ON fol.order_id = fo.order_id
         JOIN data_model.dim_order_processing_status dops
              ON fo.order_processing_status_key = dops.order_processing_status_key
         JOIN data_model.dim_product_type dpt ON fol.product_type_key = dpt.product_type_key
    AND dpt.is_free = 'FALSE'
    AND dpt.product_type_name NOT IN (
                                      'Offer Gift',
                                      'Gift Certificate',
                                      'Membership Gift',
                                      'Membership Reward Points Item'
        )
         JOIN data_model.dim_order_line_status dols ON fol.order_line_status_key = dols.order_line_status_key
         JOIN data_model.dim_order_status dos ON fol.order_status_key = dos.order_status_key
         JOIN data_model.dim_order_membership_classification domc
              ON fol.order_membership_classification_key = domc.order_membership_classification_key
         JOIN data_model.dim_order_sales_channel dosc ON fol.order_sales_channel_key = dosc.order_sales_channel_key
    AND dosc.order_classification_l1 = 'Product Order'
    AND dosc.is_ps_order = 'FALSE'
         JOIN data_model.dim_product_price_history dpph
              ON dpph.product_price_history_key = fol.product_price_history_key
         JOIN data_model.dim_customer dc ON dc.customer_id = fo.customer_id
WHERE dos.order_status IN ('Success', 'Pending')
  AND fol.order_local_datetime >= '2008-01-01'
  AND dols.order_line_status != 'Cancelled'
  AND fol.product_type_key = 15
GROUP BY CAST(fol.order_local_datetime AS DATE),
    ds.store_id,
    UPPER(ds.store_name),
    UPPER(ds.store_full_name),
    UPPER(ds.store_brand),
    pb.product_brand,
    ds.store_type,
    ds.store_region,
    ds.store_country,
    dc.finance_specialty_store,
    CASE WHEN ds.store_type = 'Retail' THEN 1 ELSE 0 END,
    bn.bundle_name,
    bn.bundle_alias

UNION ALL

SELECT CAST(fol.order_completion_local_datetime AS DATE)           AS date,
       'Shipped'                                                   AS date_type,
       ds.store_id,
       UPPER(ds.store_name)                                        AS store_name,
       UPPER(ds.store_full_name)                                   AS store_full_name,
       UPPER(ds.store_brand)                                       AS store_brand,
       pb.product_brand,
       ds.store_type                                               AS store_type,
       ds.store_region                                             AS region,
       ds.store_country                                            AS country,
       dc.finance_specialty_store,
       CASE WHEN ds.store_type = 'Retail' THEN 1 ELSE 0 END        AS is_retail,
       bn.bundle_name,
       bn.bundle_alias,
       COUNT(DISTINCT fol.bundle_order_line_id)                    AS total_bundle_count,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 = 'Activating VIP', fol.bundle_order_line_id,
                          NULL))                                   AS bundle_count_activating,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'), fol.bundle_order_line_id,
                          NULL))                                   AS bundle_count_nonactivating,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 IN ('Repeat VIP'), fol.bundle_order_line_id,
                          NULL))                                   AS bundle_count_repeat,
       COUNT(DISTINCT IFF(domc.membership_order_type_l2 = 'Guest', fol.bundle_order_line_id,
                          NULL))                                   AS bundle_count_guest,
       SUM(COALESCE(fol.product_subtotal_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))         AS total_product_subtotal,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_subtotal_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_subtotal_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_subtotal_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_subtotal_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_subtotal_guest,
       SUM(COALESCE(fol.product_discount_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))         AS total_product_discount,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_discount_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_discount_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_discount_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_discount_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_discount_guest,
       SUM(COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))         AS total_product_gross_revenue_excl_shipping,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_gross_revenue_excl_shipping_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_gross_revenue_excl_shipping_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_gross_revenue_excl_shipping_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_gross_revenue_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_gross_revenue_excl_shipping_guest,
       SUM(COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))
                                                                   AS total_product_margin_pre_return_excl_shipping,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_margin_pre_return_excl_shipping_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_margin_pre_return_excl_shipping_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_margin_pre_return_excl_shipping_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.product_margin_pre_return_excl_shipping_local_amount, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_margin_pre_return_excl_shipping_guest,
       SUM(COALESCE(fol.estimated_landed_cost_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))         AS total_product_cost,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               COALESCE(fol.estimated_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_guest,


       SUM(COALESCE(fol.reporting_landed_cost_local_amount, 0) *
           COALESCE(fol.reporting_usd_conversion_rate, 1))         AS total_product_cost_c,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_activating_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_nonactivating_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_repeat_c,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
           COALESCE(fol.reporting_landed_cost_local_amount, 0) * COALESCE(fol.reporting_usd_conversion_rate, 1),
               0))                                                 AS product_cost_guest_c,


       SUM(
                   (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
                   COALESCE(fol.reporting_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0))) AS total_non_reduced_vip_price,
       SUM(IFF(domc.membership_order_type_l2 = 'Activating VIP',
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                                 AS non_reduced_vip_price_activating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP', 'Guest'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                                 AS non_reduced_vip_price_nonactivating,
       SUM(IFF(domc.membership_order_type_l2 IN ('Repeat VIP'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                                 AS non_reduced_vip_price_repeat,
       SUM(IFF(domc.membership_order_type_l2 IN ('Guest'),
               (COALESCE(fol.item_quantity, 0) * COALESCE(dpph.vip_unit_price, 0) *
               COALESCE(fol.reporting_usd_conversion_rate, 1)) / (1 + COALESCE(fo.effective_vat_rate,0)),
               0))                                                 AS non_reduced_vip_price_guest
FROM data_model.fact_order_line fol
         JOIN _bundle_name bn ON fol.order_line_id = bn.order_line_id
         JOIN data_model.dim_product dp ON fol.product_id = dp.product_id
         JOIN data_model.dim_item_price dip ON fol.item_price_key = dip.item_price_key
         JOIN _product_brand pb ON IFF(dip.sku = 'Unknown',dp.sku,dip.sku) = pb.item_number
         JOIN data_model.dim_store ds ON fol.store_id = ds.store_id
         JOIN data_model.fact_order fo ON fol.order_id = fo.order_id
         JOIN data_model.dim_order_processing_status dops
              ON fo.order_processing_status_key = dops.order_processing_status_key
         JOIN data_model.dim_product_type dpt ON fol.product_type_key = dpt.product_type_key
    AND dpt.is_free = 'FALSE'
    AND dpt.product_type_name NOT IN (
                                      'Offer Gift',
                                      'Gift Certificate',
                                      'Membership Gift',
                                      'Membership Reward Points Item'
        )
         JOIN data_model.dim_order_line_status dols ON fol.order_line_status_key = dols.order_line_status_key
         JOIN data_model.dim_order_status dos ON fol.order_status_key = dos.order_status_key
         JOIN data_model.dim_order_membership_classification domc
              ON fol.order_membership_classification_key = domc.order_membership_classification_key
         JOIN data_model.dim_order_sales_channel dosc ON fol.order_sales_channel_key = dosc.order_sales_channel_key
    AND dosc.order_classification_l1 = 'Product Order'
    AND dosc.is_ps_order = 'FALSE'
         JOIN data_model.dim_product_price_history dpph
              ON dpph.product_price_history_key = fol.product_price_history_key
         JOIN data_model.dim_customer dc ON dc.customer_id = fo.customer_id
WHERE dos.order_status IN ('Success', 'Pending')
  AND fol.order_completion_local_datetime >= '2008-01-01'
  AND dols.order_line_status != 'Cancelled'
  AND fol.product_type_key = 15
GROUP BY CAST(fol.order_completion_local_datetime AS DATE),
    ds.store_id,
    UPPER(ds.store_name),
    UPPER(ds.store_full_name),
    UPPER(ds.store_brand),
    pb.product_brand,
    ds.store_type,
    ds.store_region,
    ds.store_country,
    dc.finance_specialty_store,
    CASE WHEN ds.store_type = 'Retail' THEN 1 ELSE 0 END,
    bn.bundle_name,
    bn.bundle_alias;

CREATE OR REPLACE TEMPORARY TABLE _ly_ty_sales_agg AS
WITH _ly_ty_sales AS (
    SELECT date,
           date_type,
           store_id,
           store_name,
           store_full_name,
           store_brand,
           product_brand,
           store_type,
           country,
           region,
           finance_specialty_store,
           is_retail,
           bundle_name,
           bundle_alias,
           total_bundle_count                                 AS ty_total_bundle_count,
           bundle_count_activating                            AS ty_bundle_count_activating,
           bundle_count_nonactivating                         AS ty_bundle_count_nonactivating,
           bundle_count_repeat                                AS ty_bundle_count_repeat,
           bundle_count_guest                                 AS ty_bundle_count_guest,
           total_product_subtotal                             AS ty_total_product_subtotal,
           product_subtotal_activating                        AS ty_product_subtotal_activating,
           product_subtotal_nonactivating                     AS ty_product_subtotal_nonactivating,
           product_subtotal_repeat                            AS ty_product_subtotal_repeat,
           product_subtotal_guest                             AS ty_product_subtotal_guest,
           total_product_discount                             AS ty_total_product_discount,
           product_discount_activating                        AS ty_product_discount_activating,
           product_discount_nonactivating                     AS ty_product_discount_nonactivating,
           product_discount_repeat                            AS ty_product_discount_repeat,
           product_discount_guest                             AS ty_product_discount_guest,
           total_product_gross_revenue_excl_shipping          AS ty_total_product_gross_revenue_excl_shipping,
           product_gross_revenue_excl_shipping_activating     AS ty_product_gross_revenue_excl_shipping_activating,
           product_gross_revenue_excl_shipping_nonactivating  AS ty_product_gross_revenue_excl_shipping_nonactivating,
           product_gross_revenue_excl_shipping_repeat         AS ty_product_gross_revenue_excl_shipping_repeat,
           product_gross_revenue_excl_shipping_guest          AS ty_product_gross_revenue_excl_shipping_guest,
           total_product_margin_pre_return_excl_shipping      AS ty_total_product_margin_pre_return_excl_shipping,
           product_margin_pre_return_excl_shipping_activating AS ty_product_margin_pre_return_excl_shipping_activating,
           product_margin_pre_return_excl_shipping_nonactivating AS ty_product_margin_pre_return_excl_shipping_nonactivating,
           product_margin_pre_return_excl_shipping_repeat     AS ty_product_margin_pre_return_excl_shipping_repeat,
           product_margin_pre_return_excl_shipping_guest      AS ty_product_margin_pre_return_excl_shipping_guest,
           total_product_cost                                 AS ty_total_product_cost,
           product_cost_activating                            AS ty_product_cost_activating,
           product_cost_nonactivating                         AS ty_product_cost_nonactivating,
           product_cost_repeat                                AS ty_product_cost_repeat,
           product_cost_guest                                 AS ty_product_cost_guest,
           total_product_cost_c                                 AS ty_total_product_cost_c,
           product_cost_activating_c                            AS ty_product_cost_activating_c,
           product_cost_nonactivating_c                         AS ty_product_cost_nonactivating_c,
           product_cost_repeat_c                                AS ty_product_cost_repeat_c,
           product_cost_guest_c                                 AS ty_product_cost_guest_c,
           total_non_reduced_vip_price                        AS ty_total_non_reduced_vip_price,
           non_reduced_vip_price_activating                   AS ty_non_reduced_vip_price_activating,
           non_reduced_vip_price_nonactivating                AS ty_non_reduced_vip_price_nonactivating,
           non_reduced_vip_price_repeat                       AS ty_non_reduced_vip_price_repeat,
           non_reduced_vip_price_guest                        AS ty_non_reduced_vip_price_guest,
           0                                                  AS ly_day_total_bundle_count,
           0                                                  AS ly_day_bundle_count_activating,
           0                                                  AS ly_day_bundle_count_nonactivating,
           0                                                  AS ly_day_bundle_count_repeat,
           0                                                  AS ly_day_bundle_count_guest,
           0                                                  AS ly_day_total_product_subtotal,
           0                                                  AS ly_day_product_subtotal_activating,
           0                                                  AS ly_day_product_subtotal_nonactivating,
           0                                                  AS ly_day_product_subtotal_repeat,
           0                                                  AS ly_day_product_subtotal_guest,
           0                                                  AS ly_day_total_product_discount,
           0                                                  AS ly_day_product_discount_activating,
           0                                                  AS ly_day_product_discount_nonactivating,
           0                                                  AS ly_day_product_discount_repeat,
           0                                                  AS ly_day_product_discount_guest,
           0                                                  AS ly_day_total_product_gross_revenue_excl_shipping,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ly_day_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ly_day_total_product_cost,
           0                                                  AS ly_day_product_cost_activating,
           0                                                  AS ly_day_product_cost_nonactivating,
           0                                                  AS ly_day_product_cost_repeat,
           0                                                  AS ly_day_product_cost_guest,
           0                                                  AS ly_day_total_product_cost_c,
           0                                                  AS ly_day_product_cost_activating_c,
           0                                                  AS ly_day_product_cost_nonactivating_c,
           0                                                  AS ly_day_product_cost_repeat_c,
           0                                                  AS ly_day_product_cost_guest_c,
           0                                                  AS ly_day_total_non_reduced_vip_price,
           0                                                  AS ly_day_non_reduced_vip_price_activating,
           0                                                  AS ly_day_non_reduced_vip_price_nonactivating,
           0                                                  AS ly_day_non_reduced_vip_price_repeat,
           0                                                  AS ly_day_non_reduced_vip_price_guest,
           0                                                  AS ly_date_total_bundle_count,
           0                                                  AS ly_date_bundle_count_activating,
           0                                                  AS ly_date_bundle_count_nonactivating,
           0                                                  AS ly_date_bundle_count_repeat,
           0                                                  AS ly_date_bundle_count_guest,
           0                                                  AS ly_date_total_product_subtotal,
           0                                                  AS ly_date_product_subtotal_activating,
           0                                                  AS ly_date_product_subtotal_nonactivating,
           0                                                  AS ly_date_product_subtotal_repeat,
           0                                                  AS ly_date_product_subtotal_guest,
           0                                                  AS ly_date_total_product_discount,
           0                                                  AS ly_date_product_discount_activating,
           0                                                  AS ly_date_product_discount_nonactivating,
           0                                                  AS ly_date_product_discount_repeat,
           0                                                  AS ly_date_product_discount_guest,
           0                                                  AS ly_date_total_product_gross_revenue_excl_shipping,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ly_date_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ly_date_total_product_cost,
           0                                                  AS ly_date_product_cost_activating,
           0                                                  AS ly_date_product_cost_nonactivating,
           0                                                  AS ly_date_product_cost_repeat,
           0                                                  AS ly_date_product_cost_guest,
           0                                                  AS ly_date_total_product_cost_c,
           0                                                  AS ly_date_product_cost_activating_c,
           0                                                  AS ly_date_product_cost_nonactivating_c,
           0                                                  AS ly_date_product_cost_repeat_c,
           0                                                  AS ly_date_product_cost_guest_c,
           0                                                  AS ly_date_total_non_reduced_vip_price,
           0                                                  AS ly_date_non_reduced_vip_price_activating,
           0                                                  AS ly_date_non_reduced_vip_price_nonactivating,
           0                                                  AS ly_date_non_reduced_vip_price_repeat,
           0                                                  AS ly_date_non_reduced_vip_price_guest
    FROM _bundle_base_calculation

    UNION ALL

    SELECT date + 364,
           date_type,
           store_id,
           store_name,
           store_full_name,
           store_brand,
           product_brand,
           store_type,
           country,
           region,
           finance_specialty_store,
           is_retail,
           bundle_name,
           bundle_alias,
           0                                                  AS ty_total_bundle_count,
           0                                                  AS ty_bundle_count_activating,
           0                                                  AS ty_bundle_count_nonactivating,
           0                                                  AS ty_bundle_count_repeat,
           0                                                  AS ty_bundle_count_guest,
           0                                                  AS ty_total_product_subtotal,
           0                                                  AS ty_product_subtotal_activating,
           0                                                  AS ty_product_subtotal_nonactivating,
           0                                                  AS ty_product_subtotal_repeat,
           0                                                  AS ty_product_subtotal_guest,
           0                                                  AS ty_total_product_discount,
           0                                                  AS ty_product_discount_activating,
           0                                                  AS ty_product_discount_nonactivating,
           0                                                  AS ty_product_discount_repeat,
           0                                                  AS ty_product_discount_guest,
           0                                                  AS ty_total_product_gross_revenue_excl_shipping,
           0                                                  AS ty_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ty_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ty_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ty_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ty_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ty_total_product_cost,
           0                                                  AS ty_product_cost_activating,
           0                                                  AS ty_product_cost_nonactivating,
           0                                                  AS ty_product_cost_repeat,
           0                                                  AS ty_product_cost_guest,
           0                                                  AS ty_total_product_cost_c,
           0                                                  AS ty_product_cost_activating_c,
           0                                                  AS ty_product_cost_nonactivating_c,
           0                                                  AS ty_product_cost_repeat_c,
           0                                                  AS ty_product_cost_guest_c,
           0                                                  AS ty_total_non_reduced_vip_price,
           0                                                  AS ty_non_reduced_vip_price_activating,
           0                                                  AS ty_non_reduced_vip_price_nonactivating,
           0                                                  AS ty_non_reduced_vip_price_repeat,
           0                                                  AS ty_non_reduced_vip_price_guest,
           total_bundle_count                                 AS ly_day_total_bundle_count,
           bundle_count_activating                            AS ly_day_bundle_count_activating,
           bundle_count_nonactivating                         AS ly_day_bundle_count_nonactivating,
           bundle_count_repeat                                AS ly_day_bundle_count_repeat,
           bundle_count_guest                                 AS ly_day_bundle_count_guest,
           total_product_subtotal                             AS ly_day_total_product_subtotal,
           product_subtotal_activating                        AS ly_day_product_subtotal_activating,
           product_subtotal_nonactivating                     AS ly_day_product_subtotal_nonactivating,
           product_subtotal_repeat                            AS ly_day_product_subtotal_repeat,
           product_subtotal_guest                             AS ly_day_product_subtotal_guest,
           total_product_discount                             AS ly_day_total_product_discount,
           product_discount_activating                        AS ly_day_product_discount_activating,
           product_discount_nonactivating                     AS ly_day_product_discount_nonactivating,
           product_discount_repeat                            AS ly_day_product_discount_repeat,
           product_discount_guest                             AS ly_day_product_discount_guest,
           total_product_gross_revenue_excl_shipping          AS ly_day_total_product_gross_revenue_excl_shipping,
           product_gross_revenue_excl_shipping_activating     AS ly_day_product_gross_revenue_excl_shipping_activating,
           product_gross_revenue_excl_shipping_nonactivating  AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
           product_gross_revenue_excl_shipping_repeat         AS ly_day_product_gross_revenue_excl_shipping_repeat,
           product_gross_revenue_excl_shipping_guest          AS ly_day_product_gross_revenue_excl_shipping_guest,
           total_product_margin_pre_return_excl_shipping      AS ly_day_total_product_margin_pre_return_excl_shipping,
           product_margin_pre_return_excl_shipping_activating AS ly_day_product_margin_pre_return_excl_shipping_activating,
           product_margin_pre_return_excl_shipping_nonactivating AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
           product_margin_pre_return_excl_shipping_repeat     AS ly_day_product_margin_pre_return_excl_shipping_repeat,
           product_margin_pre_return_excl_shipping_guest      AS ly_day_product_margin_pre_return_excl_shipping_guest,
           total_product_cost                                 AS ly_day_total_product_cost,
           product_cost_activating                            AS ly_day_product_cost_activating,
           product_cost_nonactivating                         AS ly_day_product_cost_nonactivating,
           product_cost_repeat                                AS ly_day_product_cost_repeat,
           product_cost_guest                                 AS ly_day_product_cost_guest,
           total_product_cost_c                                 AS ly_day_total_product_cost_c,
           product_cost_activating_c                            AS ly_day_product_cost_activating_c,
           product_cost_nonactivating_c                         AS ly_day_product_cost_nonactivating_c,
           product_cost_repeat_c                                AS ly_day_product_cost_repeat_c,
           product_cost_guest_c                                 AS ly_day_product_cost_guest_c,
           total_non_reduced_vip_price                        AS ly_day_total_non_reduced_vip_price,
           non_reduced_vip_price_activating                   AS ly_day_non_reduced_vip_price_activating,
           non_reduced_vip_price_nonactivating                AS ly_day_non_reduced_vip_price_nonactivating,
           non_reduced_vip_price_repeat                       AS ly_day_non_reduced_vip_price_repeat,
           non_reduced_vip_price_guest                        AS ly_day_non_reduced_vip_price_guest,
           0                                                  AS ly_date_total_bundle_count,
           0                                                  AS ly_date_bundle_count_activating,
           0                                                  AS ly_date_bundle_count_nonactivating,
           0                                                  AS ly_date_bundle_count_repeat,
           0                                                  AS ly_date_bundle_count_guest,
           0                                                  AS ly_date_total_product_subtotal,
           0                                                  AS ly_date_product_subtotal_activating,
           0                                                  AS ly_date_product_subtotal_nonactivating,
           0                                                  AS ly_date_product_subtotal_repeat,
           0                                                  AS ly_date_product_subtotal_guest,
           0                                                  AS ly_date_total_product_discount,
           0                                                  AS ly_date_product_discount_activating,
           0                                                  AS ly_date_product_discount_nonactivating,
           0                                                  AS ly_date_product_discount_repeat,
           0                                                  AS ly_date_product_discount_guest,
           0                                                  AS ly_date_total_product_gross_revenue_excl_shipping,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ly_date_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ly_date_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ly_date_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ly_date_total_product_cost,
           0                                                  AS ly_date_product_cost_activating,
           0                                                  AS ly_date_product_cost_nonactivating,
           0                                                  AS ly_date_product_cost_repeat,
           0                                                  AS ly_date_product_cost_guest,
           0                                                  AS ly_date_total_product_cost_c,
           0                                                  AS ly_date_product_cost_activating_c,
           0                                                  AS ly_date_product_cost_nonactivating_c,
           0                                                  AS ly_date_product_cost_repeat_c,
           0                                                  AS ly_date_product_cost_guest_c,
           0                                                  AS ly_date_total_non_reduced_vip_price,
           0                                                  AS ly_date_non_reduced_vip_price_activating,
           0                                                  AS ly_date_non_reduced_vip_price_nonactivating,
           0                                                  AS ly_date_non_reduced_vip_price_repeat,
           0                                                  AS ly_date_non_reduced_vip_price_guest
    FROM _bundle_base_calculation

    UNION ALL

    SELECT DATEADD('YEAR', 1, date)                           AS date,
           date_type,
           store_id,
           store_name,
           store_full_name,
           store_brand,
           product_brand,
           store_type,
           country,
           region,
           finance_specialty_store,
           is_retail,
           bundle_name,
           bundle_alias,
           0                                                  AS ty_total_bundle_count,
           0                                                  AS ty_bundle_count_activating,
           0                                                  AS ty_bundle_count_nonactivating,
           0                                                  AS ty_bundle_count_repeat,
           0                                                  AS ty_bundle_count_guest,
           0                                                  AS ty_total_product_subtotal,
           0                                                  AS ty_product_subtotal_activating,
           0                                                  AS ty_product_subtotal_nonactivating,
           0                                                  AS ty_product_subtotal_repeat,
           0                                                  AS ty_product_subtotal_guest,
           0                                                  AS ty_total_product_discount,
           0                                                  AS ty_product_discount_activating,
           0                                                  AS ty_product_discount_nonactivating,
           0                                                  AS ty_product_discount_repeat,
           0                                                  AS ty_product_discount_guest,
           0                                                  AS ty_total_product_gross_revenue_excl_shipping,
           0                                                  AS ty_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ty_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ty_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ty_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ty_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ty_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ty_total_product_cost,
           0                                                  AS ty_product_cost_activating,
           0                                                  AS ty_product_cost_nonactivating,
           0                                                  AS ty_product_cost_repeat,
           0                                                  AS ty_product_cost_guest,
           0                                                  AS ty_total_product_cost_c,
           0                                                  AS ty_product_cost_activating_c,
           0                                                  AS ty_product_cost_nonactivating_c,
           0                                                  AS ty_product_cost_repeat_c,
           0                                                  AS ty_product_cost_guest_c,
           0                                                  AS ty_total_non_reduced_vip_price,
           0                                                  AS ty_non_reduced_vip_price_activating,
           0                                                  AS ty_non_reduced_vip_price_nonactivating,
           0                                                  AS ty_non_reduced_vip_price_repeat,
           0                                                  AS ty_non_reduced_vip_price_guest,
           0                                                  AS ly_day_total_bundle_count,
           0                                                  AS ly_day_bundle_count_activating,
           0                                                  AS ly_day_bundle_count_nonactivating,
           0                                                  AS ly_day_bundle_count_repeat,
           0                                                  AS ly_day_bundle_count_guest,
           0                                                  AS ly_day_total_product_subtotal,
           0                                                  AS ly_day_product_subtotal_activating,
           0                                                  AS ly_day_product_subtotal_nonactivating,
           0                                                  AS ly_day_product_subtotal_repeat,
           0                                                  AS ly_day_product_subtotal_guest,
           0                                                  AS ly_day_total_product_discount,
           0                                                  AS ly_day_product_discount_activating,
           0                                                  AS ly_day_product_discount_bobactivating,
           0                                                  AS ly_day_product_discount_repeat,
           0                                                  AS ly_day_product_discount_guest,
           0                                                  AS ly_day_total_product_gross_revenue_excl_shipping,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_activating,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_repeat,
           0                                                  AS ly_day_product_gross_revenue_excl_shipping_guest,
           0                                                  AS ly_day_total_product_margin_pre_return_excl_shipping,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_activating,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_repeat,
           0                                                  AS ly_day_product_margin_pre_return_excl_shipping_guest,
           0                                                  AS ly_day_total_product_cost,
           0                                                  AS ly_day_product_cost_activating,
           0                                                  AS ly_day_product_cost_nonactivating,
           0                                                  AS ly_day_product_cost_repeat,
           0                                                  AS ly_day_product_cost_guest,
           0                                                  AS ly_day_total_product_cost_c,
           0                                                  AS ly_day_product_cost_activating_c,
           0                                                  AS ly_day_product_cost_nonactivating_c,
           0                                                  AS ly_day_product_cost_repeat_c,
           0                                                  AS ly_day_product_cost_guest_c,
           0                                                  AS ly_day_total_non_reduced_vip_price,
           0                                                  AS ly_day_non_reduced_vip_price_activating,
           0                                                  AS ly_day_non_reduced_vip_price_nonactivating,
           0                                                  AS ly_day_non_reduced_vip_price_repeat,
           0                                                  AS ly_day_non_reduced_vip_price_guest,
           total_bundle_count                                 AS ly_date_total_bundle_count,
           bundle_count_activating                            AS ly_date_bundle_count_activating,
           bundle_count_nonactivating                         AS ly_date_bundle_count_nonactivating,
           bundle_count_repeat                                AS ly_date_bundle_count_repeat,
           bundle_count_guest                                 AS ly_date_bundle_count_guest,
           total_product_subtotal                             AS ly_date_total_product_subtotal,
           product_subtotal_activating                        AS ly_date_product_subtotal_activating,
           product_subtotal_nonactivating                     AS ly_date_product_subtotal_nonactivating,
           product_subtotal_repeat                            AS ly_date_product_subtotal_repeat,
           product_subtotal_guest                             AS ly_date_product_subtotal_guest,
           total_product_discount                             AS ly_date_total_product_discount,
           product_discount_activating                        AS ly_date_product_discount_activating,
           product_discount_nonactivating                     AS ly_date_product_discount_nonactivating,
           product_discount_repeat                            AS ly_date_product_discount_repeat,
           product_discount_guest                             AS ly_date_product_discount_guest,
           total_product_gross_revenue_excl_shipping          AS ly_date_total_product_gross_revenue_excl_shipping,
           product_gross_revenue_excl_shipping_activating     AS ly_date_product_gross_revenue_excl_shipping_activating,
           product_gross_revenue_excl_shipping_nonactivating  AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
           product_gross_revenue_excl_shipping_repeat         AS ly_date_product_gross_revenue_excl_shipping_repeat,
           product_gross_revenue_excl_shipping_guest          AS ly_date_product_gross_revenue_excl_shipping_guest,
           total_product_margin_pre_return_excl_shipping      AS ly_date_total_product_margin_pre_return_excl_shipping,
           product_margin_pre_return_excl_shipping_activating AS ly_date_product_margin_pre_return_excl_shipping_activating,
           product_margin_pre_return_excl_shipping_nonactivating AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
           product_margin_pre_return_excl_shipping_repeat     AS ly_date_product_margin_pre_return_excl_shipping_repeat,
           product_margin_pre_return_excl_shipping_guest      AS ly_date_product_margin_pre_return_excl_shipping_guest,
           total_product_cost                                 AS ly_date_total_product_cost,
           product_cost_activating                            AS ly_date_product_cost_activating,
           product_cost_nonactivating                         AS ly_date_product_cost_nonactivating,
           product_cost_repeat                                AS ly_date_product_cost_repeat,
           product_cost_guest                                 AS ly_date_product_cost_guest,
           total_product_cost_c                                 AS ly_date_total_product_cost_c,
           product_cost_activating_c                            AS ly_date_product_cost_activating_c,
           product_cost_nonactivating_c                         AS ly_date_product_cost_nonactivating_C,
           product_cost_repeat_C                                AS ly_date_product_cost_repeat_C,
           product_cost_guest_c                                 AS ly_date_product_cost_guest_c,
           total_non_reduced_vip_price                        AS ly_date_total_non_reduced_vip_price,
           non_reduced_vip_price_activating                   AS ly_date_non_reduced_vip_price_activating,
           non_reduced_vip_price_nonactivating                AS ly_date_non_reduced_vip_price_nonactivating,
           non_reduced_vip_price_repeat                       AS ly_date_non_reduced_vip_price_repeat,
           non_reduced_vip_price_guest                        AS ly_date_non_reduced_vip_price_guest
    FROM _bundle_base_calculation)
SELECT date,
       date_type,
       store_id,
       store_name,
       store_full_name,
       store_brand,
       product_brand,
       store_type,
       country,
       region,
       finance_specialty_store,
       is_retail,
       bundle_name,
       bundle_alias,
       SUM(ty_total_bundle_count)                                      AS ty_total_bundle_count,
       SUM(ty_bundle_count_activating)                                 AS ty_bundle_count_activating,
       SUM(ty_bundle_count_nonactivating)                              AS ty_bundle_count_nonactivating,
       SUM(ty_bundle_count_repeat)                                     AS ty_bundle_count_repeat,
       SUM(ty_bundle_count_guest)                                      AS ty_bundle_count_guest,
       SUM(ty_total_product_subtotal)                                  AS ty_total_product_subtotal,
       SUM(ty_product_subtotal_activating)                             AS ty_product_subtotal_activating,
       SUM(ty_product_subtotal_nonactivating)                          AS ty_product_subtotal_nonactivating,
       SUM(ty_product_subtotal_repeat)                                 AS ty_product_subtotal_repeat,
       SUM(ty_product_subtotal_guest)                                  AS ty_product_subtotal_guest,
       SUM(ty_total_product_discount)                                  AS ty_total_product_discount,
       SUM(ty_product_discount_activating)                             AS ty_product_discount_activating,
       SUM(ty_product_discount_nonactivating)                          AS ty_product_discount_nonactivating,
       SUM(ty_product_discount_repeat)                                 AS ty_product_discount_repeat,
       SUM(ty_product_discount_guest)                                  AS ty_product_discount_guest,
       SUM(ty_total_product_gross_revenue_excl_shipping)               AS ty_total_product_gross_revenue_excl_shipping,
       SUM(ty_product_gross_revenue_excl_shipping_activating)          AS ty_product_gross_revenue_excl_shipping_activating,
       SUM(ty_product_gross_revenue_excl_shipping_nonactivating)       AS ty_product_gross_revenue_excl_shipping_nonactivating,
       SUM(ty_product_gross_revenue_excl_shipping_repeat)              AS ty_product_gross_revenue_excl_shipping_repeat,
       SUM(ty_product_gross_revenue_excl_shipping_guest)               AS ty_product_gross_revenue_excl_shipping_guest,
       SUM(ty_total_product_margin_pre_return_excl_shipping)           AS ty_total_product_margin_pre_return_excl_shipping,
       SUM(ty_product_margin_pre_return_excl_shipping_activating)      AS ty_product_margin_pre_return_excl_shipping_activating,
       SUM(ty_product_margin_pre_return_excl_shipping_nonactivating)   AS ty_product_margin_pre_return_excl_shipping_nonactivating,
       SUM(ty_product_margin_pre_return_excl_shipping_repeat)          AS ty_product_margin_pre_return_excl_shipping_repeat,
       SUM(ty_product_margin_pre_return_excl_shipping_guest)           AS ty_product_margin_pre_return_excl_shipping_guest,
       SUM(ty_total_product_cost)                                      AS ty_total_product_cost,
       SUM(ty_product_cost_activating)                                 AS ty_product_cost_activating,
       SUM(ty_product_cost_nonactivating)                              AS ty_product_cost_nonactivating,
       SUM(ty_product_cost_repeat)                                     AS ty_product_cost_repeat,
       SUM(ty_product_cost_guest)                                      AS ty_product_cost_guest,
       SUM(ty_total_product_cost_c)                                      AS ty_total_product_cost_c,
       SUM(ty_product_cost_activating_c)                                 AS ty_product_cost_activating_c,
       SUM(ty_product_cost_nonactivating_c)                              AS ty_product_cost_nonactivating_c,
       SUM(ty_product_cost_repeat_c)                                     AS ty_product_cost_repeat_c,
       SUM(ty_product_cost_guest_c)                                      AS ty_product_cost_guest_c,
       SUM(ty_total_non_reduced_vip_price)                             AS ty_total_non_reduced_vip_price,
       SUM(ty_non_reduced_vip_price_activating)                        AS ty_non_reduced_vip_price_activating,
       SUM(ty_non_reduced_vip_price_nonactivating)                     AS ty_non_reduced_vip_price_nonactivating,
       SUM(ty_non_reduced_vip_price_repeat)                            AS ty_non_reduced_vip_price_repeat,
       SUM(ty_non_reduced_vip_price_guest)                             AS ty_non_reduced_vip_price_guest,
       SUM(ly_day_total_bundle_count)                                  AS ly_day_total_bundle_count,
       SUM(ly_day_bundle_count_activating)                             AS ly_day_bundle_count_activating,
       SUM(ly_day_bundle_count_nonactivating)                          AS ly_day_bundle_count_nonactivating,
       SUM(ly_day_bundle_count_repeat)                                 AS ly_day_bundle_count_repeat,
       SUM(ly_day_bundle_count_guest)                                  AS ly_day_bundle_count_guest,
       SUM(ly_day_total_product_subtotal)                              AS ly_day_total_product_subtotal,
       SUM(ly_day_product_subtotal_activating)                         AS ly_day_product_subtotal_activating,
       SUM(ly_day_product_subtotal_nonactivating)                      AS ly_day_product_subtotal_nonactivating,
       SUM(ly_day_product_subtotal_repeat)                             AS ly_day_product_subtotal_repeat,
       SUM(ly_day_product_subtotal_guest)                              AS ly_day_product_subtotal_guest,
       SUM(ly_day_total_product_discount)                              AS ly_day_total_product_discount,
       SUM(ly_day_product_discount_activating)                         AS ly_day_product_discount_activating,
       SUM(ly_day_product_discount_nonactivating)                      AS ly_day_product_discount_nonactivating,
       SUM(ly_day_product_discount_repeat)                             AS ly_day_product_discount_repeat,
       SUM(ly_day_product_discount_guest)                              AS ly_day_product_discount_guest,
       SUM(ly_day_total_product_gross_revenue_excl_shipping)           AS ly_day_total_product_gross_revenue_excl_shipping,
       SUM(ly_day_product_gross_revenue_excl_shipping_activating)      AS ly_day_product_gross_revenue_excl_shipping_activating,
       SUM(ly_day_product_gross_revenue_excl_shipping_nonactivating)   AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
       SUM(ly_day_product_gross_revenue_excl_shipping_repeat)          AS ly_day_product_gross_revenue_excl_shipping_repeat,
       SUM(ly_day_product_gross_revenue_excl_shipping_guest)           AS ly_day_product_gross_revenue_excl_shipping_guest,
       SUM(ly_day_total_product_margin_pre_return_excl_shipping)       AS ly_day_total_product_margin_pre_return_excl_shipping,
       SUM(ly_day_product_margin_pre_return_excl_shipping_activating)  AS ly_day_product_margin_pre_return_excl_shipping_activating,
       SUM(ly_day_product_margin_pre_return_excl_shipping_nonactivating)  AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
       SUM(ly_day_product_margin_pre_return_excl_shipping_repeat)      AS ly_day_product_margin_pre_return_excl_shipping_repeat,
       SUM(ly_day_product_margin_pre_return_excl_shipping_guest)       AS ly_day_product_margin_pre_return_excl_shipping_guest,
       SUM(ly_day_total_product_cost)                                  AS ly_day_total_product_cost,
       SUM(ly_day_product_cost_activating)                             AS ly_day_product_cost_activating,
       SUM(ly_day_product_cost_nonactivating)                          AS ly_day_product_cost_nonactivating,
       SUM(ly_day_product_cost_repeat)                                 AS ly_day_product_cost_repeat,
       SUM(ly_day_product_cost_guest)                                  AS ly_day_product_cost_guest,
       SUM(ly_day_total_product_cost_c)                                  AS ly_day_total_product_cost_c,
       SUM(ly_day_product_cost_activating_c)                             AS ly_day_product_cost_activating_c,
       SUM(ly_day_product_cost_nonactivating_c)                          AS ly_day_product_cost_nonactivating_c,
       SUM(ly_day_product_cost_repeat_c)                                 AS ly_day_product_cost_repeat_c,
       SUM(ly_day_product_cost_guest_c)                                  AS ly_day_product_cost_guest_c,
       SUM(ly_day_total_non_reduced_vip_price)                         AS ly_day_total_non_reduced_vip_price,
       SUM(ly_day_non_reduced_vip_price_activating)                    AS ly_day_non_reduced_vip_price_activating,
       SUM(ly_day_non_reduced_vip_price_nonactivating)                 AS ly_day_non_reduced_vip_price_nonactivating,
       SUM(ly_day_non_reduced_vip_price_repeat)                        AS ly_day_non_reduced_vip_price_repeat,
       SUM(ly_day_non_reduced_vip_price_guest)                         AS ly_day_non_reduced_vip_price_guest,
       SUM(ly_date_total_bundle_count)                                 AS ly_date_total_bundle_count,
       SUM(ly_date_bundle_count_activating)                            AS ly_date_bundle_count_activating,
       SUM(ly_date_bundle_count_nonactivating)                         AS ly_date_bundle_count_nonactivating,
       SUM(ly_date_bundle_count_repeat)                                AS ly_date_bundle_count_repeat,
       SUM(ly_date_bundle_count_guest)                                 AS ly_date_bundle_count_guest,
       SUM(ly_date_total_product_subtotal)                             AS ly_date_total_product_subtotal,
       SUM(ly_date_product_subtotal_activating)                        AS ly_date_product_subtotal_activating,
       SUM(ly_date_product_subtotal_nonactivating)                     AS ly_date_product_subtotal_nonactivating,
       SUM(ly_date_product_subtotal_repeat)                            AS ly_date_product_subtotal_repeat,
       SUM(ly_date_product_subtotal_guest)                             AS ly_date_product_subtotal_guest,
       SUM(ly_date_total_product_discount)                             AS ly_date_total_product_discount,
       SUM(ly_date_product_discount_activating)                        AS ly_date_product_discount_activating,
       SUM(ly_date_product_discount_nonactivating)                     AS ly_date_product_discount_nonactivating,
       SUM(ly_date_product_discount_repeat)                            AS ly_date_product_discount_repeat,
       SUM(ly_date_product_discount_guest)                             AS ly_date_product_discount_guest,
       SUM(ly_date_total_product_gross_revenue_excl_shipping)          AS ly_date_total_product_gross_revenue_excl_shipping,
       SUM(ly_date_product_gross_revenue_excl_shipping_activating)     AS ly_date_product_gross_revenue_excl_shipping_activating,
       SUM(ly_date_product_gross_revenue_excl_shipping_nonactivating)  AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
       SUM(ly_date_product_gross_revenue_excl_shipping_repeat)         AS ly_date_product_gross_revenue_excl_shipping_repeat,
       SUM(ly_date_product_gross_revenue_excl_shipping_guest)          AS ly_date_product_gross_revenue_excl_shipping_guest,
       SUM(ly_date_total_product_margin_pre_return_excl_shipping)      AS ly_date_total_product_margin_pre_return_excl_shipping,
       SUM(ly_date_product_margin_pre_return_excl_shipping_activating) AS ly_date_product_margin_pre_return_excl_shipping_activating,
       SUM(ly_date_product_margin_pre_return_excl_shipping_nonactivating) AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
       SUM(ly_date_product_margin_pre_return_excl_shipping_repeat)     AS ly_date_product_margin_pre_return_excl_shipping_repeat,
       SUM(ly_date_product_margin_pre_return_excl_shipping_guest)      AS ly_date_product_margin_pre_return_excl_shipping_guest,
       SUM(ly_date_total_product_cost)                                 AS ly_date_total_product_cost,
       SUM(ly_date_product_cost_activating)                            AS ly_date_product_cost_activating,
       SUM(ly_date_product_cost_nonactivating)                         AS ly_date_product_cost_nonactivating,
       SUM(ly_date_product_cost_repeat)                                AS ly_date_product_cost_repeat,
       SUM(ly_date_product_cost_guest)                                 AS ly_date_product_cost_guest,
       SUM(ly_date_total_product_cost_c)                                 AS ly_date_total_product_cost_c,
       SUM(ly_date_product_cost_activating_c)                            AS ly_date_product_cost_activating_c,
       SUM(ly_date_product_cost_nonactivating_c)                         AS ly_date_product_cost_nonactivating_c,
       SUM(ly_date_product_cost_repeat_c)                                AS ly_date_product_cost_repeat_c,
       SUM(ly_date_product_cost_guest_c)                                 AS ly_date_product_cost_guest_c,
       SUM(ly_date_total_non_reduced_vip_price)                        AS ly_date_total_non_reduced_vip_price,
       SUM(ly_date_non_reduced_vip_price_activating)                   AS ly_date_non_reduced_vip_price_activating,
       SUM(ly_date_non_reduced_vip_price_nonactivating)                AS ly_date_non_reduced_vip_price_nonactivating,
       SUM(ly_date_non_reduced_vip_price_repeat)                       AS ly_date_non_reduced_vip_price_repeat,
       SUM(ly_date_non_reduced_vip_price_guest)                        AS ly_date_non_reduced_vip_price_guest
FROM _ly_ty_sales
GROUP BY date,
       date_type,
       store_id,
       store_name,
       store_full_name,
       store_brand,
       product_brand,
       store_type,
       country,
       region,
       finance_specialty_store,
       is_retail,
       bundle_name,
       bundle_alias;

CREATE OR REPLACE TEMPORARY TABLE _missing_week_data AS
SELECT IFF(DATEADD('day', 5, DATE_TRUNC('week', date)) > CURRENT_DATE() - 1, CURRENT_DATE() - 1,
                    DATEADD('day', 5, DATE_TRUNC('week', date))) AS date,
                date_type,
                store_id,
                store_name,
                store_full_name,
                store_brand,
                product_brand,
                store_type,
                country,
                region,
                finance_specialty_store,
                is_retail,
                bundle_name,
                bundle_alias
FROM _ly_ty_sales_agg

UNION

SELECT LAST_DAY(IFF(DATE_TRUNC('MONTH', date) > CURRENT_DATE() - 1, CURRENT_DATE() - 1,
                DATE_TRUNC('MONTH', date)), 'MONTH') AS date,
                date_type,
                store_id,
                store_name,
                store_full_name,
                store_brand,
                product_brand,
                store_type,
                country,
                region,
                finance_specialty_store,
                is_retail,
                bundle_name,
                bundle_alias
FROM _ly_ty_sales_agg;

CREATE OR REPLACE TEMPORARY TABLE _final_data AS
SELECT date,
       date_type,
       store_id,
       store_name,
       store_full_name,
       store_brand,
       product_brand,
       store_type,
       country,
       region,
       finance_specialty_store,
       is_retail,
       bundle_name,
       bundle_alias,
       ty_total_bundle_count,
       ty_bundle_count_activating,
       ty_bundle_count_nonactivating,
       ty_bundle_count_repeat,
       ty_bundle_count_guest,
       ty_total_product_subtotal,
       ty_product_subtotal_activating,
       ty_product_subtotal_nonactivating,
       ty_product_subtotal_repeat,
       ty_product_subtotal_guest,
       ty_total_product_discount,
       ty_product_discount_activating,
       ty_product_discount_nonactivating,
       ty_product_discount_repeat,
       ty_product_discount_guest,
       ty_total_product_gross_revenue_excl_shipping,
       ty_product_gross_revenue_excl_shipping_activating,
       ty_product_gross_revenue_excl_shipping_nonactivating,
       ty_product_gross_revenue_excl_shipping_repeat,
       ty_product_gross_revenue_excl_shipping_guest,
       ty_total_product_margin_pre_return_excl_shipping,
       ty_product_margin_pre_return_excl_shipping_activating,
       ty_product_margin_pre_return_excl_shipping_nonactivating,
       ty_product_margin_pre_return_excl_shipping_repeat,
       ty_product_margin_pre_return_excl_shipping_guest,
       ty_total_product_cost,
       ty_product_cost_activating,
       ty_product_cost_nonactivating,
       ty_product_cost_repeat,
       ty_product_cost_guest,
       ty_total_product_cost_c,
       ty_product_cost_activating_c,
       ty_product_cost_nonactivating_c,
       ty_product_cost_repeat_c,
       ty_product_cost_guest_c,
       ty_total_non_reduced_vip_price,
       ty_non_reduced_vip_price_activating,
       ty_non_reduced_vip_price_nonactivating,
       ty_non_reduced_vip_price_repeat,
       ty_non_reduced_vip_price_guest,
       ly_day_total_bundle_count,
       ly_day_bundle_count_activating,
       ly_day_bundle_count_nonactivating,
       ly_day_bundle_count_repeat,
       ly_day_bundle_count_guest,
       ly_day_total_product_subtotal,
       ly_day_product_subtotal_activating,
       ly_day_product_subtotal_nonactivating,
       ly_day_product_subtotal_repeat,
       ly_day_product_subtotal_guest,
       ly_day_total_product_discount,
       ly_day_product_discount_activating,
       ly_day_product_discount_nonactivating,
       ly_day_product_discount_repeat,
       ly_day_product_discount_guest,
       ly_day_total_product_gross_revenue_excl_shipping,
       ly_day_product_gross_revenue_excl_shipping_activating,
       ly_day_product_gross_revenue_excl_shipping_nonactivating,
       ly_day_product_gross_revenue_excl_shipping_repeat,
       ly_day_product_gross_revenue_excl_shipping_guest,
       ly_day_total_product_margin_pre_return_excl_shipping,
       ly_day_product_margin_pre_return_excl_shipping_activating,
       ly_day_product_margin_pre_return_excl_shipping_nonactivating,
       ly_day_product_margin_pre_return_excl_shipping_repeat,
       ly_day_product_margin_pre_return_excl_shipping_guest,
       ly_day_total_product_cost,
       ly_day_product_cost_activating,
       ly_day_product_cost_nonactivating,
       ly_day_product_cost_repeat,
       ly_day_product_cost_guest,
       ly_day_total_product_cost_c,
       ly_day_product_cost_activating_c,
       ly_day_product_cost_nonactivating_c,
       ly_day_product_cost_repeat_c,
       ly_day_product_cost_guest_c,
       ly_day_total_non_reduced_vip_price,
       ly_day_non_reduced_vip_price_activating,
       ly_day_non_reduced_vip_price_nonactivating,
       ly_day_non_reduced_vip_price_repeat,
       ly_day_non_reduced_vip_price_guest,
       ly_date_total_bundle_count,
       ly_date_bundle_count_activating,
       ly_date_bundle_count_nonactivating,
       ly_date_bundle_count_repeat,
       ly_date_bundle_count_guest,
       ly_date_total_product_subtotal,
       ly_date_product_subtotal_activating,
       ly_date_product_subtotal_nonactivating,
       ly_date_product_subtotal_repeat,
       ly_date_product_subtotal_guest,
       ly_date_total_product_discount,
       ly_date_product_discount_activating,
       ly_date_product_discount_nonactivating,
       ly_date_product_discount_repeat,
       ly_date_product_discount_guest,
       ly_date_total_product_gross_revenue_excl_shipping,
       ly_date_product_gross_revenue_excl_shipping_activating,
       ly_date_product_gross_revenue_excl_shipping_nonactivating,
       ly_date_product_gross_revenue_excl_shipping_repeat,
       ly_date_product_gross_revenue_excl_shipping_guest,
       ly_date_total_product_margin_pre_return_excl_shipping,
       ly_date_product_margin_pre_return_excl_shipping_activating,
       ly_date_product_margin_pre_return_excl_shipping_nonactivating,
       ly_date_product_margin_pre_return_excl_shipping_repeat,
       ly_date_product_margin_pre_return_excl_shipping_guest,
       ly_date_total_product_cost,
       ly_date_product_cost_activating,
       ly_date_product_cost_nonactivating,
       ly_date_product_cost_repeat,
       ly_date_product_cost_guest,
       ly_date_total_product_cost_c,
       ly_date_product_cost_activating_c,
       ly_date_product_cost_nonactivating_c,
       ly_date_product_cost_repeat_c,
       ly_date_product_cost_guest_c,
       ly_date_total_non_reduced_vip_price,
       ly_date_non_reduced_vip_price_activating,
       ly_date_non_reduced_vip_price_nonactivating,
       ly_date_non_reduced_vip_price_repeat,
       ly_date_non_reduced_vip_price_guest
FROM _ly_ty_sales_agg
WHERE NOT (bundle_alias LIKE 'YT%' AND product_brand <> 'YITTY')

UNION ALL

SELECT date,
       date_type,
       store_id,
       store_name,
       store_full_name,
       store_brand,
       product_brand,
       store_type,
       country,
       region,
       finance_specialty_store,
       is_retail,
       bundle_name,
       bundle_alias,
       0 AS ty_total_bundle_count,
       0 AS ty_bundle_count_activating,
       0 AS ty_bundle_count_nonactivating,
       0 AS ty_bundle_count_repeat,
       0 AS ty_bundle_count_guest,
       0 AS ty_total_product_subtotal,
       0 AS ty_product_subtotal_activating,
       0 AS ty_product_subtotal_nonactivating,
       0 AS ty_product_subtotal_repeat,
       0 AS ty_product_subtotal_guest,
       0 AS ty_total_product_discount,
       0 AS ty_product_discount_activating,
       0 AS ty_product_discount_nonactivating,
       0 AS ty_product_discount_repeat,
       0 AS ty_product_discount_guest,
       0 AS ty_total_product_gross_revenue_excl_shipping,
       0 AS ty_product_gross_revenue_excl_shipping_activating,
       0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ty_product_gross_revenue_excl_shipping_repeat,
       0 AS ty_product_gross_revenue_excl_shipping_guest,
       0 AS ty_total_product_margin_pre_return_excl_shipping,
       0 AS ty_product_margin_pre_return_excl_shipping_activating,
       0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ty_product_margin_pre_return_excl_shipping_repeat,
       0 AS ty_product_margin_pre_return_excl_shipping_guest,
       0 AS ty_total_product_cost,
       0 AS ty_product_cost_activating,
       0 AS ty_product_cost_nonactivating,
       0 AS ty_product_cost_repeat,
       0 AS ty_product_cost_guest,
       0 AS ty_total_product_cost_c,
       0 AS ty_product_cost_activating_c,
       0 AS ty_product_cost_nonactivating_c,
       0 AS ty_product_cost_repeat_c,
       0 AS ty_product_cost_guest_c,
       0 AS ty_total_non_reduced_vip_price,
       0 AS ty_non_reduced_vip_price_activating,
       0 AS ty_non_reduced_vip_price_nonactivating,
       0 AS ty_non_reduced_vip_price_repeat,
       0 AS ty_non_reduced_vip_price_guest,
       0 AS ly_day_total_bundle_count,
       0 AS ly_day_bundle_count_activating,
       0 AS ly_day_bundle_count_nonactivating,
       0 AS ly_day_bundle_count_repeat,
       0 AS ly_day_bundle_count_guest,
       0 AS ly_day_total_product_subtotal,
       0 AS ly_day_product_subtotal_activating,
       0 AS ly_day_product_subtotal_nonactivating,
       0 AS ly_day_product_subtotal_repeat,
       0 AS ly_day_product_subtotal_guest,
       0 AS ly_day_total_product_discount,
       0 AS ly_day_product_discount_activating,
       0 AS ly_day_product_discount_nonactivating,
       0 AS ly_day_product_discount_repeat,
       0 AS ly_day_product_discount_guest,
       0 AS ly_day_total_product_gross_revenue_excl_shipping,
       0 AS ly_day_product_gross_revenue_excl_shipping_activating,
       0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
       0 AS ly_day_product_gross_revenue_excl_shipping_guest,
       0 AS ly_day_total_product_margin_pre_return_excl_shipping,
       0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
       0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
       0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
       0 AS ly_day_total_product_cost,
       0 AS ly_day_product_cost_activating,
       0 AS ly_day_product_cost_nonactivating,
       0 AS ly_day_product_cost_repeat,
       0 AS ly_day_product_cost_guest,
       0 AS ly_day_total_product_cost_c,
       0 AS ly_day_product_cost_activating_c,
       0 AS ly_day_product_cost_nonactivating_c,
       0 AS ly_day_product_cost_repeat_c,
       0 AS ly_day_product_cost_guest_c,
       0 AS ly_day_total_non_reduced_vip_price,
       0 AS ly_day_non_reduced_vip_price_activating,
       0 AS ly_day_non_reduced_vip_price_nonactivating,
       0 AS ly_day_non_reduced_vip_price_repeat,
       0 AS ly_day_non_reduced_vip_price_guest,
       0 AS ly_date_total_bundle_count,
       0 AS ly_date_bundle_count_activating,
       0 AS ly_date_bundle_count_nonactivating,
       0 AS ly_date_bundle_count_repeat,
       0 AS ly_date_bundle_count_guest,
       0 AS ly_date_total_product_subtotal,
       0 AS ly_date_product_subtotal_activating,
       0 AS ly_date_product_subtotal_nonactivating,
       0 AS ly_date_product_subtotal_repeat,
       0 AS ly_date_product_subtotal_guest,
       0 AS ly_date_total_product_discount,
       0 AS ly_date_product_discount_activating,
       0 AS ly_date_product_discount_nonactivating,
       0 AS ly_date_product_discount_repeat,
       0 AS ly_date_product_discount_guest,
       0 AS ly_date_total_product_gross_revenue_excl_shipping,
       0 AS ly_date_product_gross_revenue_excl_shipping_activating,
       0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
       0 AS ly_date_product_gross_revenue_excl_shipping_guest,
       0 AS ly_date_total_product_margin_pre_return_excl_shipping,
       0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
       0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
       0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
       0 AS ly_date_total_product_cost,
       0 AS ly_date_product_cost_activating,
       0 AS ly_date_product_cost_nonactivating,
       0 AS ly_date_product_cost_repeat,
       0 AS ly_date_product_cost_guest,
       0 AS ly_date_total_product_cost_c,
       0 AS ly_date_product_cost_activating_c,
       0 AS ly_date_product_cost_nonactivating_c,
       0 AS ly_date_product_cost_repeat_c,
       0 AS ly_date_product_cost_guest_c,
       0 AS ly_date_total_non_reduced_vip_price,
       0 AS ly_date_non_reduced_vip_price_activating,
       0 AS ly_date_non_reduced_vip_price_nonactivating,
       0 AS ly_date_non_reduced_vip_price_repeat,
       0 AS ly_date_non_reduced_vip_price_guest
FROM _ly_ty_sales_agg
WHERE (bundle_alias LIKE 'YT%' AND product_brand <> 'YITTY')

UNION ALL

SELECT mwd.date,
       mwd.date_type,
       mwd.store_id,
       mwd.store_name,
       mwd.store_full_name,
       mwd.store_brand,
       mwd.product_brand,
       mwd.store_type,
       mwd.country,
       mwd.region,
       mwd.finance_specialty_store,
       mwd.is_retail,
       mwd.bundle_name,
       mwd.bundle_alias,
       0 AS ty_total_bundle_count,
       0 AS ty_bundle_count_activating,
       0 AS ty_bundle_count_nonactivating,
       0 AS ty_bundle_count_repeat,
       0 AS ty_bundle_count_guest,
       0 AS ty_total_product_subtotal,
       0 AS ty_product_subtotal_activating,
       0 AS ty_product_subtotal_nonactivating,
       0 AS ty_product_subtotal_repeat,
       0 AS ty_product_subtotal_guest,
       0 AS ty_total_product_discount,
       0 AS ty_product_discount_activating,
       0 AS ty_product_discount_nonactivating,
       0 AS ty_product_discount_repeat,
       0 AS ty_product_discount_guest,
       0 AS ty_total_product_gross_revenue_excl_shipping,
       0 AS ty_product_gross_revenue_excl_shipping_activating,
       0 AS ty_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ty_product_gross_revenue_excl_shipping_repeat,
       0 AS ty_product_gross_revenue_excl_shipping_guest,
       0 AS ty_total_product_margin_pre_return_excl_shipping,
       0 AS ty_product_margin_pre_return_excl_shipping_activating,
       0 AS ty_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ty_product_margin_pre_return_excl_shipping_repeat,
       0 AS ty_product_margin_pre_return_excl_shipping_guest,
       0 AS ty_total_product_cost,
       0 AS ty_product_cost_activating,
       0 AS ty_product_cost_nonactivating,
       0 AS ty_product_cost_repeat,
       0 AS ty_product_cost_guest,
       0 AS ty_total_product_cost_c,
       0 AS ty_product_cost_activating_c,
       0 AS ty_product_cost_nonactivating_c,
       0 AS ty_product_cost_repeat_c,
       0 AS ty_product_cost_guest_c,
       0 AS ty_total_non_reduced_vip_price,
       0 AS ty_non_reduced_vip_price_activating,
       0 AS ty_non_reduced_vip_price_nonactivating,
       0 AS ty_non_reduced_vip_price_repeat,
       0 AS ty_non_reduced_vip_price_guest,
       0 AS ly_day_total_bundle_count,
       0 AS ly_day_bundle_count_activating,
       0 AS ly_day_bundle_count_nonactivating,
       0 AS ly_day_bundle_count_repeat,
       0 AS ly_day_bundle_count_guest,
       0 AS ly_day_total_product_subtotal,
       0 AS ly_day_product_subtotal_activating,
       0 AS ly_day_product_subtotal_nonactivating,
       0 AS ly_day_product_subtotal_repeat,
       0 AS ly_day_product_subtotal_guest,
       0 AS ly_day_total_product_discount,
       0 AS ly_day_product_discount_activating,
       0 AS ly_day_product_discount_nonactivating,
       0 AS ly_day_product_discount_repeat,
       0 AS ly_day_product_discount_guest,
       0 AS ly_day_total_product_gross_revenue_excl_shipping,
       0 AS ly_day_product_gross_revenue_excl_shipping_activating,
       0 AS ly_day_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ly_day_product_gross_revenue_excl_shipping_repeat,
       0 AS ly_day_product_gross_revenue_excl_shipping_guest,
       0 AS ly_day_total_product_margin_pre_return_excl_shipping,
       0 AS ly_day_product_margin_pre_return_excl_shipping_activating,
       0 AS ly_day_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ly_day_product_margin_pre_return_excl_shipping_repeat,
       0 AS ly_day_product_margin_pre_return_excl_shipping_guest,
       0 AS ly_day_total_product_cost,
       0 AS ly_day_product_cost_activating,
       0 AS ly_day_product_cost_nonactivating,
       0 AS ly_day_product_cost_repeat,
       0 AS ly_day_product_cost_guest,
       0 AS ly_day_total_product_cost_c,
       0 AS ly_day_product_cost_activating_c,
       0 AS ly_day_product_cost_nonactivating_c,
       0 AS ly_day_product_cost_repeat_c,
       0 AS ly_day_product_cost_guest_c,
       0 AS ly_day_total_non_reduced_vip_price,
       0 AS ly_day_non_reduced_vip_price_activating,
       0 AS ly_day_non_reduced_vip_price_nonactivating,
       0 AS ly_day_non_reduced_vip_price_repeat,
       0 AS ly_day_non_reduced_vip_price_guest,
       0 AS ly_date_total_bundle_count,
       0 AS ly_date_bundle_count_activating,
       0 AS ly_date_bundle_count_nonactivating,
       0 AS ly_date_bundle_count_repeat,
       0 AS ly_date_bundle_count_guest,
       0 AS ly_date_total_product_subtotal,
       0 AS ly_date_product_subtotal_activating,
       0 AS ly_date_product_subtotal_nonactivating,
       0 AS ly_date_product_subtotal_repeat,
       0 AS ly_date_product_subtotal_guest,
       0 AS ly_date_total_product_discount,
       0 AS ly_date_product_discount_activating,
       0 AS ly_date_product_discount_nonactivating,
       0 AS ly_date_product_discount_repeat,
       0 AS ly_date_product_discount_guest,
       0 AS ly_date_total_product_gross_revenue_excl_shipping,
       0 AS ly_date_product_gross_revenue_excl_shipping_activating,
       0 AS ly_date_product_gross_revenue_excl_shipping_nonactivating,
       0 AS ly_date_product_gross_revenue_excl_shipping_repeat,
       0 AS ly_date_product_gross_revenue_excl_shipping_guest,
       0 AS ly_date_total_product_margin_pre_return_excl_shipping,
       0 AS ly_date_product_margin_pre_return_excl_shipping_activating,
       0 AS ly_date_product_margin_pre_return_excl_shipping_nonactivating,
       0 AS ly_date_product_margin_pre_return_excl_shipping_repeat,
       0 AS ly_date_product_margin_pre_return_excl_shipping_guest,
       0 AS ly_date_total_product_cost,
       0 AS ly_date_product_cost_activating,
       0 AS ly_date_product_cost_nonactivating,
       0 AS ly_date_product_cost_repeat,
       0 AS ly_date_product_cost_guest,
       0 AS ly_date_total_product_cost_c,
       0 AS ly_date_product_cost_activating_c,
       0 AS ly_date_product_cost_nonactivating_c,
       0 AS ly_date_product_cost_repeat_c,
       0 AS ly_date_product_cost_guest_c,
       0 AS ly_date_total_non_reduced_vip_price,
       0 AS ly_date_non_reduced_vip_price_activating,
       0 AS ly_date_non_reduced_vip_price_nonactivating,
       0 AS ly_date_non_reduced_vip_price_repeat,
       0 AS ly_date_non_reduced_vip_price_guest
FROM _missing_week_data mwd
         LEFT JOIN _ly_ty_sales_agg lts ON lts.date = mwd.date
    AND lts.date_type = mwd.date_type
    AND lts.store_id = mwd.store_id
    AND lts.finance_specialty_store = mwd.finance_specialty_store
    AND lts.bundle_name = mwd.bundle_name
    AND lts.bundle_alias = mwd.bundle_alias
    AND lts.is_retail = mwd.is_retail
WHERE lts.date IS NULL;

TRUNCATE TABLE reporting.merch_planning_outfit;

INSERT INTO reporting.merch_planning_outfit (date,
                                             date_type,
                                             store_id,
                                             store_name,
                                             store_full_name,
                                             store_brand,
                                             product_brand,
                                             store_type,
                                             country,
                                             region,
                                             finance_specialty_store,
                                             is_retail,
                                             bundle_name,
                                             bundle_alias,
                                             ty_total_bundle_count,
                                             ty_bundle_count_activating,
                                             ty_bundle_count_nonactivating,
                                             ty_bundle_count_repeat,
                                             ty_bundle_count_guest,
                                             ty_total_product_subtotal,
                                             ty_product_subtotal_activating,
                                             ty_product_subtotal_nonactivating,
                                             ty_product_subtotal_repeat,
                                             ty_product_subtotal_guest,
                                             ty_total_product_discount,
                                             ty_product_discount_activating,
                                             ty_product_discount_nonactivating,
                                             ty_product_discount_repeat,
                                             ty_product_discount_guest,
                                             ty_total_product_gross_revenue_excl_shipping,
                                             ty_product_gross_revenue_excl_shipping_activating,
                                             ty_product_gross_revenue_excl_shipping_nonactivating,
                                             ty_product_gross_revenue_excl_shipping_repeat,
                                             ty_product_gross_revenue_excl_shipping_guest,
                                             ty_total_product_margin_pre_return_excl_shipping,
                                             ty_product_margin_pre_return_excl_shipping_activating,
                                             ty_product_margin_pre_return_excl_shipping_nonactivating,
                                             ty_product_margin_pre_return_excl_shipping_repeat,
                                             ty_product_margin_pre_return_excl_shipping_guest,
                                             ty_total_product_cost,
                                             ty_product_cost_activating,
                                             ty_product_cost_nonactivating,
                                             ty_product_cost_repeat,
                                             ty_product_cost_guest,
                                             ty_total_product_cost_c,
                                             ty_product_cost_activating_c,
                                             ty_product_cost_nonactivating_c,
                                             ty_product_cost_repeat_c,
                                             ty_product_cost_guest_c,
                                             ty_total_non_reduced_vip_price,
                                             ty_non_reduced_vip_price_activating,
                                             ty_non_reduced_vip_price_nonactivating,
                                             ty_non_reduced_vip_price_repeat,
                                             ty_non_reduced_vip_price_guest,
                                             ltd_total_bundle_count,
                                             ltd_bundle_count_activating,
                                             ltd_bundle_count_nonactivating,
                                             ltd_bundle_count_repeat,
                                             ltd_bundle_count_guest,
                                             mtd_total_bundle_count,
                                             mtd_bundle_count_activating,
                                             mtd_bundle_count_nonactivating,
                                             mtd_bundle_count_repeat,
                                             mtd_bundle_count_guest,
                                             mtd_total_product_subtotal,
                                             mtd_product_subtotal_activating,
                                             mtd_product_subtotal_nonactivating,
                                             mtd_product_subtotal_repeat,
                                             mtd_product_subtotal_guest,
                                             mtd_total_product_discount,
                                             mtd_product_discount_activating,
                                             mtd_product_discount_nonactivating,
                                             mtd_product_discount_repeat,
                                             mtd_product_discount_guest,
                                             mtd_total_product_gross_revenue_excl_shipping,
                                             mtd_product_gross_revenue_excl_shipping_activating,
                                             mtd_product_gross_revenue_excl_shipping_nonactivating,
                                             mtd_product_gross_revenue_excl_shipping_repeat,
                                             mtd_product_gross_revenue_excl_shipping_guest,
                                             mtd_total_product_margin_pre_return_excl_shipping,
                                             mtd_product_margin_pre_return_excl_shipping_activating,
                                             mtd_product_margin_pre_return_excl_shipping_nonactivating,
                                             mtd_product_margin_pre_return_excl_shipping_repeat,
                                             mtd_product_margin_pre_return_excl_shipping_guest,
                                             mtd_total_product_cost,
                                             mtd_product_cost_activating,
                                             mtd_product_cost_nonactivating,
                                             mtd_product_cost_repeat,
                                             mtd_product_cost_guest,
                                             mtd_total_product_cost_c,
                                             mtd_product_cost_activating_c,
                                             mtd_product_cost_nonactivating_c,
                                             mtd_product_cost_repeat_c,
                                             mtd_product_cost_guest_c,
                                             mtd_total_non_reduced_vip_price,
                                             mtd_non_reduced_vip_price_activating,
                                             mtd_non_reduced_vip_price_nonactivating,
                                             mtd_non_reduced_vip_price_repeat,
                                             mtd_non_reduced_vip_price_guest,
                                             ly_day_total_bundle_count,
                                             ly_day_bundle_count_activating,
                                             ly_day_bundle_count_nonactivating,
                                             ly_day_bundle_count_repeat,
                                             ly_day_bundle_count_guest,
                                             ly_day_total_product_subtotal,
                                             ly_day_product_subtotal_activating,
                                             ly_day_product_subtotal_nonactivating,
                                             ly_day_product_subtotal_repeat,
                                             ly_day_product_subtotal_guest,
                                             ly_day_total_product_discount,
                                             ly_day_product_discount_activating,
                                             ly_day_product_discount_nonactivating,
                                             ly_day_product_discount_repeat,
                                             ly_day_product_discount_guest,
                                             ly_day_total_product_gross_revenue_excl_shipping,
                                             ly_day_product_gross_revenue_excl_shipping_activating,
                                             ly_day_product_gross_revenue_excl_shipping_nonactivating,
                                             ly_day_product_gross_revenue_excl_shipping_repeat,
                                             ly_day_product_gross_revenue_excl_shipping_guest,
                                             ly_day_total_product_margin_pre_return_excl_shipping,
                                             ly_day_product_margin_pre_return_excl_shipping_activating,
                                             ly_day_product_margin_pre_return_excl_shipping_nonactivating,
                                             ly_day_product_margin_pre_return_excl_shipping_repeat,
                                             ly_day_product_margin_pre_return_excl_shipping_guest,
                                             ly_day_total_product_cost,
                                             ly_day_product_cost_activating,
                                             ly_day_product_cost_nonactivating,
                                             ly_day_product_cost_repeat,
                                             ly_day_product_cost_guest,
                                             ly_day_total_product_cost_c,
                                             ly_day_product_cost_activating_c,
                                             ly_day_product_cost_nonactivating_c,
                                             ly_day_product_cost_repeat_c,
                                             ly_day_product_cost_guest_c,
                                             ly_day_total_non_reduced_vip_price,
                                             ly_day_non_reduced_vip_price_activating,
                                             ly_day_non_reduced_vip_price_nonactivating,
                                             ly_day_non_reduced_vip_price_repeat,
                                             ly_day_non_reduced_vip_price_guest,
                                             lymtd_day_total_bundle_count,
                                             lymtd_day_bundle_count_activating,
                                             lymtd_day_bundle_count_nonactivating,
                                             lymtd_day_bundle_count_repeat,
                                             lymtd_day_bundle_count_guest,
                                             lymtd_day_total_product_subtotal,
                                             lymtd_day_product_subtotal_activating,
                                             lymtd_day_product_subtotal_nonactivating,
                                             lymtd_day_product_subtotal_repeat,
                                             lymtd_day_product_subtotal_guest,
                                             lymtd_day_total_product_discount,
                                             lymtd_day_product_discount_activating,
                                             lymtd_day_product_discount_nonactivating,
                                             lymtd_day_product_discount_repeat,
                                             lymtd_day_product_discount_guest,
                                             lymtd_day_total_product_gross_revenue_excl_shipping,
                                             lymtd_day_product_gross_revenue_excl_shipping_activating,
                                             lymtd_day_product_gross_revenue_excl_shipping_nonactivating,
                                             lymtd_day_product_gross_revenue_excl_shipping_repeat,
                                             lymtd_day_product_gross_revenue_excl_shipping_guest,
                                             lymtd_day_total_product_margin_pre_return_excl_shipping,
                                             lymtd_day_product_margin_pre_return_excl_shipping_activating,
                                             lymtd_day_product_margin_pre_return_excl_shipping_nonactivating,
                                             lymtd_day_product_margin_pre_return_excl_shipping_repeat,
                                             lymtd_day_product_margin_pre_return_excl_shipping_guest,
                                             lymtd_day_total_product_cost,
                                             lymtd_day_product_cost_activating,
                                             lymtd_day_product_cost_nonactivating,
                                             lymtd_day_product_cost_repeat,
                                             lymtd_day_product_cost_guest,
                                             lymtd_day_total_product_cost_c,
                                             lymtd_day_product_cost_activating_c,
                                             lymtd_day_product_cost_nonactivating_c,
                                             lymtd_day_product_cost_repeat_c,
                                             lymtd_day_product_cost_guest_c,
                                             lymtd_day_total_non_reduced_vip_price,
                                             lymtd_day_non_reduced_vip_price_activating,
                                             lymtd_day_non_reduced_vip_price_nonactivating,
                                             lymtd_day_non_reduced_vip_price_repeat,
                                             lymtd_day_non_reduced_vip_price_guest,
                                             ly_date_total_bundle_count,
                                             ly_date_bundle_count_activating,
                                             ly_date_bundle_count_nonactivating,
                                             ly_date_bundle_count_repeat,
                                             ly_date_bundle_count_guest,
                                             ly_date_total_product_subtotal,
                                             ly_date_product_subtotal_activating,
                                             ly_date_product_subtotal_nonactivating,
                                             ly_date_product_subtotal_repeat,
                                             ly_date_product_subtotal_guest,
                                             ly_date_total_product_discount,
                                             ly_date_product_discount_activating,
                                             ly_date_product_discount_nonactivating,
                                             ly_date_product_discount_repeat,
                                             ly_date_product_discount_guest,
                                             ly_date_total_product_gross_revenue_excl_shipping,
                                             ly_date_product_gross_revenue_excl_shipping_activating,
                                             ly_date_product_gross_revenue_excl_shipping_nonactivating,
                                             ly_date_product_gross_revenue_excl_shipping_repeat,
                                             ly_date_product_gross_revenue_excl_shipping_guest,
                                             ly_date_total_product_margin_pre_return_excl_shipping,
                                             ly_date_product_margin_pre_return_excl_shipping_activating,
                                             ly_date_product_margin_pre_return_excl_shipping_nonactivating,
                                             ly_date_product_margin_pre_return_excl_shipping_repeat,
                                             ly_date_product_margin_pre_return_excl_shipping_guest,
                                             ly_date_total_product_cost,
                                             ly_date_product_cost_activating,
                                             ly_date_product_cost_nonactivating,
                                             ly_date_product_cost_repeat,
                                             ly_date_product_cost_guest,
                                             ly_date_total_product_cost_c,
                                             ly_date_product_cost_activating_c,
                                             ly_date_product_cost_nonactivating_c,
                                             ly_date_product_cost_repeat_c,
                                             ly_date_product_cost_guest_c,
                                             ly_date_total_non_reduced_vip_price,
                                             ly_date_non_reduced_vip_price_activating,
                                             ly_date_non_reduced_vip_price_nonactivating,
                                             ly_date_non_reduced_vip_price_repeat,
                                             ly_date_non_reduced_vip_price_guest,
                                             meta_create_datetime,
                                             meta_update_datetime)
SELECT date,
       date_type,
       store_id,
       store_name,
       store_full_name,
       store_brand,
       product_brand,
       store_type,
       country,
       region,
       finance_specialty_store,
       is_retail,
       bundle_name,
       bundle_alias,
       ty_total_bundle_count,
       ty_bundle_count_activating,
       ty_bundle_count_nonactivating,
       ty_bundle_count_repeat,
       ty_bundle_count_guest,
       ty_total_product_subtotal,
       ty_product_subtotal_activating,
       ty_product_subtotal_nonactivating,
       ty_product_subtotal_repeat,
       ty_product_subtotal_guest,
       ty_total_product_discount,
       ty_product_discount_activating,
       ty_product_discount_nonactivating,
       ty_product_discount_repeat,
       ty_product_discount_guest,
       ty_total_product_gross_revenue_excl_shipping,
       ty_product_gross_revenue_excl_shipping_activating,
       ty_product_gross_revenue_excl_shipping_nonactivating,
       ty_product_gross_revenue_excl_shipping_repeat,
       ty_product_gross_revenue_excl_shipping_guest,
       ty_total_product_margin_pre_return_excl_shipping,
       ty_product_margin_pre_return_excl_shipping_activating,
       ty_product_margin_pre_return_excl_shipping_nonactivating,
       ty_product_margin_pre_return_excl_shipping_repeat,
       ty_product_margin_pre_return_excl_shipping_guest,
       ty_total_product_cost,
       ty_product_cost_activating,
       ty_product_cost_nonactivating,
       ty_product_cost_repeat,
       ty_product_cost_guest,
       ty_total_product_cost_c,
       ty_product_cost_activating_c,
       ty_product_cost_nonactivating_c,
       ty_product_cost_repeat_c,
       ty_product_cost_guest_c,
       ty_total_non_reduced_vip_price,
       ty_non_reduced_vip_price_activating,
       ty_non_reduced_vip_price_nonactivating,
       ty_non_reduced_vip_price_repeat,
       ty_non_reduced_vip_price_guest,
       SUM(ty_total_bundle_count)
           OVER (PARTITION BY date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS ltd_total_bundle_count,
       SUM(ty_bundle_count_activating)
           OVER (PARTITION BY date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS ltd_bundle_count_activating,
       SUM(ty_bundle_count_nonactivating)
           OVER (PARTITION BY date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS ltd_bundle_count_nonactivating,
       SUM(ty_bundle_count_repeat)
           OVER (PARTITION BY date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS ltd_bundle_count_repeat,
       SUM(ty_bundle_count_guest)
           OVER (PARTITION BY date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS ltd_bundle_count_guest,
       SUM(ty_total_bundle_count)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_bundle_count,
       SUM(ty_bundle_count_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_bundle_count_activating,
       SUM(ty_bundle_count_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_bundle_count_nonactivating,
       SUM(ty_bundle_count_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_bundle_count_repeat,
       SUM(ty_bundle_count_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_bundle_count_guest,
       SUM(ty_total_product_subtotal)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_subtotal,
       SUM(ty_product_subtotal_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_subtotal_activating,
       SUM(ty_product_subtotal_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_subtotal_nonactivating,
       SUM(ty_product_subtotal_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_subtotal_repeat,
       SUM(ty_product_subtotal_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_subtotal_guest,
       SUM(ty_total_product_discount)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_discount,
       SUM(ty_product_discount_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_discount_activating,
       SUM(ty_product_discount_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_discount_nonactivating,
       SUM(ty_product_discount_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_discount_repeat,
       SUM(ty_product_discount_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_discount_guest,
       SUM(ty_total_product_gross_revenue_excl_shipping)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_gross_revenue_excl_shipping,
       SUM(ty_product_gross_revenue_excl_shipping_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_activating,
       SUM(ty_product_gross_revenue_excl_shipping_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_nonactivating,
       SUM(ty_product_gross_revenue_excl_shipping_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_repeat,
       SUM(ty_product_gross_revenue_excl_shipping_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_gross_revenue_excl_shipping_guest,
       SUM(ty_total_product_margin_pre_return_excl_shipping)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_margin_pre_return_excl_shipping,
       SUM(ty_product_margin_pre_return_excl_shipping_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_activating,
       SUM(ty_product_margin_pre_return_excl_shipping_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_nonactivating,
       SUM(ty_product_margin_pre_return_excl_shipping_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_repeat,
       SUM(ty_product_margin_pre_return_excl_shipping_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_margin_pre_return_excl_shipping_guest,
       SUM(ty_total_product_cost)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_cost,
       SUM(ty_product_cost_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_activating,
       SUM(ty_product_cost_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_nonactivating,
       SUM(ty_product_cost_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_repeat,
       SUM(ty_product_cost_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_guest,
       SUM(ty_total_product_cost_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_product_cost_c,
       SUM(ty_product_cost_activating_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_activating_c,
       SUM(ty_product_cost_nonactivating_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_nonactivating_c,
       SUM(ty_product_cost_repeat_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_repeat_c,
       SUM(ty_product_cost_guest_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_product_cost_guest_c,
       SUM(ty_total_non_reduced_vip_price)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_total_non_reduced_vip_price,
       SUM(ty_non_reduced_vip_price_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_non_reduced_vip_price_activating,
       SUM(ty_non_reduced_vip_price_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_non_reduced_vip_price_nonactivating,
       SUM(ty_non_reduced_vip_price_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_non_reduced_vip_price_repeat,
       SUM(ty_non_reduced_vip_price_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS mtd_non_reduced_vip_price_guest,
       ly_day_total_bundle_count,
       ly_day_bundle_count_activating,
       ly_day_bundle_count_nonactivating,
       ly_day_bundle_count_repeat,
       ly_day_bundle_count_guest,
       ly_day_total_product_subtotal,
       ly_day_product_subtotal_activating,
       ly_day_product_subtotal_nonactivating,
       ly_day_product_subtotal_repeat,
       ly_day_product_subtotal_guest,
       ly_day_total_product_discount,
       ly_day_product_discount_activating,
       ly_day_product_discount_nonactivating,
       ly_day_product_discount_repeat,
       ly_day_product_discount_guest,
       ly_day_total_product_gross_revenue_excl_shipping,
       ly_day_product_gross_revenue_excl_shipping_activating,
       ly_day_product_gross_revenue_excl_shipping_nonactivating,
       ly_day_product_gross_revenue_excl_shipping_repeat,
       ly_day_product_gross_revenue_excl_shipping_guest,
       ly_day_total_product_margin_pre_return_excl_shipping,
       ly_day_product_margin_pre_return_excl_shipping_activating,
       ly_day_product_margin_pre_return_excl_shipping_nonactivating,
       ly_day_product_margin_pre_return_excl_shipping_repeat,
       ly_day_product_margin_pre_return_excl_shipping_guest,
       ly_day_total_product_cost,
       ly_day_product_cost_activating,
       ly_day_product_cost_nonactivating,
       ly_day_product_cost_repeat,
       ly_day_product_cost_guest,
       ly_day_total_product_cost_c,
       ly_day_product_cost_activating_c,
       ly_day_product_cost_nonactivating_c,
       ly_day_product_cost_repeat_c,
       ly_day_product_cost_guest_c,
       ly_day_total_non_reduced_vip_price,
       ly_day_non_reduced_vip_price_activating,
       ly_day_non_reduced_vip_price_nonactivating,
       ly_day_non_reduced_vip_price_repeat,
       ly_day_non_reduced_vip_price_guest,
       SUM(ly_day_total_bundle_count)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_bundle_count,
       SUM(ly_day_bundle_count_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_bundle_count_activating,
       SUM(ly_day_bundle_count_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_bundle_count_nonactivating,
       SUM(ly_day_bundle_count_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_bundle_count_repeat,
       SUM(ly_day_bundle_count_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_bundle_count_guest,
       SUM(ly_day_total_product_subtotal)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_subtotal,
       SUM(ly_day_product_subtotal_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_subtotal_activating,
       SUM(ly_day_product_subtotal_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_subtotal_nonactivating,
       SUM(ly_day_product_subtotal_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_subtotal_repeat,
       SUM(ly_day_product_subtotal_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_subtotal_guest,
       SUM(ly_day_total_product_discount)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_discount,
       SUM(ly_day_product_discount_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_discount_activating,
       SUM(ly_day_product_discount_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_discount_nonactivating,
       SUM(ly_day_product_discount_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_discount_repeat,
       SUM(ly_day_product_discount_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_discount_guest,
       SUM(ly_day_total_product_gross_revenue_excl_shipping)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_gross_revenue_excl_shipping,
       SUM(ly_day_product_gross_revenue_excl_shipping_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_activating,
       SUM(ly_day_product_gross_revenue_excl_shipping_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_nonactivating,
       SUM(ly_day_product_gross_revenue_excl_shipping_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_repeat,
       SUM(ly_day_product_gross_revenue_excl_shipping_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_gross_revenue_excl_shipping_guest,
       SUM(ly_day_total_product_margin_pre_return_excl_shipping)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_margin_pre_return_excl_shipping,
       SUM(ly_day_product_margin_pre_return_excl_shipping_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_activating,
       SUM(ly_day_product_margin_pre_return_excl_shipping_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_nonactivating,
       SUM(ly_day_product_margin_pre_return_excl_shipping_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_repeat,
       SUM(ly_day_product_margin_pre_return_excl_shipping_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_margin_pre_return_excl_shipping_guest,
       SUM(ly_day_total_product_cost)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_cost,
       SUM(ly_day_product_cost_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_activating,
       SUM(ly_day_product_cost_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_nonactivating,
       SUM(ly_day_product_cost_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_repeat,
       SUM(ly_day_product_cost_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_guest,
       SUM(ly_day_total_product_cost_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_product_cost_c,
       SUM(ly_day_product_cost_activating_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_activating_c,
       SUM(ly_day_product_cost_nonactivating_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_nonactivating_c,
       SUM(ly_day_product_cost_repeat_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_repeat_c,
       SUM(ly_day_product_cost_guest_c)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_product_cost_guest_c,
       SUM(ly_day_total_non_reduced_vip_price)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_total_non_reduced_vip_price,
       SUM(ly_day_non_reduced_vip_price_activating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_non_reduced_vip_price_activating,
       SUM(ly_day_non_reduced_vip_price_nonactivating)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_non_reduced_vip_price_nonactivating,
       SUM(ly_day_non_reduced_vip_price_repeat)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_non_reduced_vip_price_repeat,
       SUM(ly_day_non_reduced_vip_price_guest)
           OVER (PARTITION BY DATE_TRUNC('month', date), date_type, store_id, store_name, store_full_name, store_brand, product_brand, store_type, country, finance_specialty_store, region, is_retail, bundle_name, bundle_alias ORDER BY date) AS lymtd_day_non_reduced_vip_price_guest,
       ly_date_total_bundle_count,
       ly_date_bundle_count_activating,
       ly_date_bundle_count_nonactivating,
       ly_date_bundle_count_repeat,
       ly_date_bundle_count_guest,
       ly_date_total_product_subtotal,
       ly_date_product_subtotal_activating,
       ly_date_product_subtotal_nonactivating,
       ly_date_product_subtotal_repeat,
       ly_date_product_subtotal_guest,
       ly_date_total_product_discount,
       ly_date_product_discount_activating,
       ly_date_product_discount_nonactivating,
       ly_date_product_discount_repeat,
       ly_date_product_discount_guest,
       ly_date_total_product_gross_revenue_excl_shipping,
       ly_date_product_gross_revenue_excl_shipping_activating,
       ly_date_product_gross_revenue_excl_shipping_nonactivating,
       ly_date_product_gross_revenue_excl_shipping_repeat,
       ly_date_product_gross_revenue_excl_shipping_guest,
       ly_date_total_product_margin_pre_return_excl_shipping,
       ly_date_product_margin_pre_return_excl_shipping_activating,
       ly_date_product_margin_pre_return_excl_shipping_nonactivating,
       ly_date_product_margin_pre_return_excl_shipping_repeat,
       ly_date_product_margin_pre_return_excl_shipping_guest,
       ly_date_total_product_cost,
       ly_date_product_cost_activating,
       ly_date_product_cost_nonactivating,
       ly_date_product_cost_repeat,
       ly_date_product_cost_guest,
       ly_date_total_product_cost_c,
       ly_date_product_cost_activating_c,
       ly_date_product_cost_nonactivating_c,
       ly_date_product_cost_repeat_c,
       ly_date_product_cost_guest_c,
       ly_date_total_non_reduced_vip_price,
       ly_date_non_reduced_vip_price_activating,
       ly_date_non_reduced_vip_price_nonactivating,
       ly_date_non_reduced_vip_price_repeat,
       ly_date_non_reduced_vip_price_guest,
       $execution_start_time                                                                                                                                                            AS meta_create_datetime,
       $execution_start_time                                                                                                                                                            AS meta_update_datetime
FROM _final_data
WHERE date < CURRENT_DATE();
