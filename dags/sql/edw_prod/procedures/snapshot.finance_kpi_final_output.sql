SET execution_start_time = CURRENT_TIMESTAMP :: TIMESTAMP_LTZ(3);

/*Snapshot process. Delete records older than a year and a half*/
INSERT INTO snapshot.finance_kpi_final_output (
	report_version,
	currency,
	report_mapping,
	business_unit,
	metric_type,
	vip_store_full_name,
	vip_store_id,
	is_retail_vip,
	event_store_brand,
	event_store_region,
	event_store_country,
	event_store_location,
	event_store_full_name,
	event_store_id,
	customer_gender,
	is_cross_promo,
	finance_specialty_store,
    is_scrubs_customer,
	date_object,
	date,
	currency_object,
	currency_type,
	membership_order_type_l1,
	membership_order_type_l2,
	membership_order_type_l3,
	product_order_count_excluding_reship_exch,
	product_order_count_including_reship_exch,
	product_order_reship_exch,
	unit_count_excluding_reship_exch,
	unit_count_including_reship_exch,
	unit_count_reship_exch,
	product_order_discount,
	outbound_shipping_costs,
	outbound_shipping_costs_reship_exch,
	return_shipping_cost,
	shipping_revenue,
	product_revenue_including_shipping,
	product_revenue_excluding_shipping,
	cash_gross_revenue,
	cash_gross_revenue_excluding_shipping,
	cash_refund_product_order,
	cash_refund_billing,
	cash_refund,
	store_credit_refund,
	chargebacks,
	chargebacks_credit_billings,
	shipping_cost,
	shipping_supplies_cost,
	shipping_cost_reship_exch,
	shipping_supplies_cost_reship_exch,
	product_cost_returned_resaleable,
	product_order_cost_product_returned_damaged_amount,
	return_unit_count,
	order_product_cost,
	order_product_cost_reship_exch,
	order_product_cost_reship,
	product_cost_net_returns,
	variable_warehouse_labor_cost,
	variable_gms_labor_cost,
	variable_payment_processing_cost,
	billed_credit_cash_transaction_amount,
	membership_fee_cash_transaction_amount,
	gift_card_transaction_amount,
	legacy_credit_cash_transaction_amount,
	billed_credit_cash_refund_chargeback_amount,
	membership_fee_cash_refund_chargeback_amount,
	gift_card_cash_refund_chargeback_amount,
	legacy_credit_cash_refund_chargeback_amount,
	billed_credit_issued_amount,
	billed_credit_redeemed_amount,
	billed_credit_cancelled_amount,
	billed_credit_expired_amount,
	billed_credit_issued_equivalent_counts,
	billed_credit_redeemed_equivalent_counts,
	billed_credit_cancelled_equivalent_counts,
	billed_credit_expired_equivalent_counts,
	billed_cash_credit_net_equivalent_count,
	refund_credit_issued_amount,
	refund_credit_redeemed_amount,
	refund_credit_cancelled_amount,
	refund_credit_expired_amount,
	other_cash_credit_issued_amount,
	other_cash_credit_redeemed_amount,
	other_cash_credit_cancelled_amount,
	other_cash_credit_expired_amount,
	noncash_credit_issued_amount,
	noncash_credit_cancelled_amount,
	noncash_credit_expired_amount,
	noncash_credit_redeemed_amount,
	billed_net_credit_billings,
	product_margin_pre_return,
	product_gross_profit,
	cash_gross_profit,
	cash_contribution_profit,
	misc_cogs_amount,
	total_cogs_amount,
	discount_rate_denom,
    product_net_revenue,
	leads,
    online_leads,
    retail_leads,
	reactivated_leads,
	new_vips,
	paid_vips,
	unpaid_vips,
	reactivated_vips,
	vips_from_reactivated_leads_m1,
	new_vips_m1,
	paid_vips_m1,
	cancels_positive,
	m1_cancels,
	bop_vips,
	media_spend,
	cumulative_leads,
    retail_attribution_retail_billed_credit_redeemed_amount,
	snapshot_datetime
)
SELECT report_version,
       currency,
       report_mapping,
       business_unit,
       metric_type,
       vip_store_full_name,
       vip_store_id,
       is_retail_vip,
       event_store_brand,
       event_store_region,
       event_store_country,
       event_store_location,
       event_store_full_name,
       event_store_id,
       customer_gender,
       is_cross_promo,
       finance_specialty_store,
       is_scrubs_customer,
       date_object,
       date,
       currency_object,
       currency_type,
       membership_order_type_l1,
       membership_order_type_l2,
       membership_order_type_l3,
       product_order_count_excluding_reship_exch,
       product_order_count_including_reship_exch,
       product_order_reship_exch,
       unit_count_excluding_reship_exch,
       unit_count_including_reship_exch,
       unit_count_reship_exch,
       product_order_discount,
       outbound_shipping_costs,
       outbound_shipping_costs_reship_exch,
       return_shipping_cost,
       shipping_revenue,
       product_revenue_including_shipping,
       product_revenue_excluding_shipping,
       cash_gross_revenue,
       cash_gross_revenue_excluding_shipping,
       cash_refund_product_order,
       cash_refund_billing,
       cash_refund,
       store_credit_refund,
       chargebacks,
       chargebacks_credit_billings,
       shipping_cost,
       shipping_supplies_cost,
       shipping_cost_reship_exch,
       shipping_supplies_cost_reship_exch,
       product_cost_returned_resaleable,
       product_order_cost_product_returned_damaged_amount,
       return_unit_count,
       order_product_cost,
       order_product_cost_reship_exch,
       order_product_cost_reship,
       product_cost_net_returns,
       variable_warehouse_labor_cost,
       variable_gms_labor_cost,
       variable_payment_processing_cost,
       billed_credit_cash_transaction_amount,
       membership_fee_cash_transaction_amount,
       gift_card_transaction_amount,
       legacy_credit_cash_transaction_amount,
       billed_credit_cash_refund_chargeback_amount,
       membership_fee_cash_refund_chargeback_amount,
       gift_card_cash_refund_chargeback_amount,
       legacy_credit_cash_refund_chargeback_amount,
       billed_credit_issued_amount,
       billed_credit_redeemed_amount,
       billed_credit_cancelled_amount,
       billed_credit_expired_amount,
       billed_credit_issued_equivalent_counts,
       billed_credit_redeemed_equivalent_counts,
       billed_credit_cancelled_equivalent_counts,
       billed_credit_expired_equivalent_counts,
       billed_cash_credit_net_equivalent_count,
       refund_credit_issued_amount,
       refund_credit_redeemed_amount,
       refund_credit_cancelled_amount,
       refund_credit_expired_amount,
       other_cash_credit_issued_amount,
       other_cash_credit_redeemed_amount,
       other_cash_credit_cancelled_amount,
       other_cash_credit_expired_amount,
       noncash_credit_issued_amount,
       noncash_credit_cancelled_amount,
       noncash_credit_expired_amount,
       noncash_credit_redeemed_amount,
       billed_net_credit_billings,
       product_margin_pre_return,
       product_gross_profit,
       cash_gross_profit,
       cash_contribution_profit,
       misc_cogs_amount,
       total_cogs_amount,
       discount_rate_denom,
       product_net_revenue,
       leads,
       online_leads,
       retail_leads,
       reactivated_leads,
       new_vips,
       paid_vips,
       unpaid_vips,
       reactivated_vips,
       vips_from_reactivated_leads_m1,
       new_vips_m1,
       paid_vips_m1,
       cancels_positive,
       m1_cancels,
       bop_vips,
       media_spend,
       cumulative_leads,
       retail_attribution_retail_billed_credit_redeemed_amount,
       $execution_start_time AS snapshot_datetime
FROM reporting.finance_kpi_final_output ddd;

DELETE FROM snapshot.finance_kpi_final_output
WHERE snapshot_datetime <  DATEADD(month, -18, GETDATE());
