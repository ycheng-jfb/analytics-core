TRUNCATE TABLE validation.fact_order_test_orders_count;
INSERT INTO validation.fact_order_test_orders_count
SELECT
    a.order_id,
    a.order_description
FROM validation.fact_order_test_orders AS a
JOIN (
    SELECT
        order_id,
        membership_event_type,
        membership_state,
        event_start_local_datetime,
        activation_local_datetime,
        membership_type,
        activation_channel_type,
        activation_channel,
        activation_subchannel,
        membership_id,
        dim_cust_hist_membership_event_type,
        membership_plan_id,
        currency_key,
        customer_id,
        store_id,
        master_order_id,
        order_payment_status_code,
        order_processing_status_code,
        order_membership_classification_key,
        is_cash,
        is_credit_billing_on_retry,
        shipping_address_id,
        billing_address_id,
        order_status_key,
        order_sales_channel_key,
        payment_method,
        raw_creditcard_type,
        session_id,
        order_local_datetime,
        payment_transaction_local_datetime,
        shipped_local_datetime,
        order_completion_local_datetime,
        unit_count,
        order_date_usd_conversion_rate,
        order_date_eur_conversion_rate,
        payment_transaction_date_usd_conversion_rate,
        payment_transaction_date_eur_conversion_rate,
        shipped_date_usd_conversion_rate,
        shipped_date_eur_conversion_rate,
        reporting_usd_conversion_rate,
        reporting_eur_conversion_rate,
        payment_transaction_local_amount,
        subtotal_excl_tariff_local_amount,
        effective_vat_rate,
        tax_local_amount,
        tax_cash_local_amount,
        tax_credit_local_amount,
        cash_credit_local_amount,
        cash_credit_count,
        cash_membership_credit_local_amount,
        cash_membership_credit_count,
        cash_refund_credit_local_amount,
        cash_refund_credit_count,
        cash_giftco_credit_local_amount,
        cash_giftco_credit_count,
        cash_giftcard_credit_local_amount,
        cash_giftcard_credit_count,
        non_cash_credit_local_amount,
        non_cash_credit_count,
        shipping_revenue_before_discount_local_amount,
        shipping_revenue_cash_local_amount,
        shipping_revenue_credit_local_amount,
        shipping_cost_local_amount,
        product_discount_local_amount,
        shipping_discount_local_amount,
        tariff_revenue_local_amount,
        token_local_amount,
        token_count,
        cash_token_local_amount,
        cash_token_count,
        non_cash_token_local_amount,
        non_cash_token_count,
        loyalty_unit_count,
        estimated_variable_gms_cost_local_amount,
        estimated_variable_warehouse_cost_local_amount,
        estimated_variable_payment_processing_pct_cash_revenue,
        estimated_shipping_cost_local_amount,
        estimated_shipping_supplies_cost_local_amount,
        estimated_landed_cost_local_amount,
        misc_cogs_local_amount,
        administrator_id,
        is_test_customer,
        bops_store_id,
        bops_pickup_local_datetime,
        customer_selected_shipping_service,
        reporting_landed_cost_local_amount,
        is_actual_landed_cost,
        membership_brand_id,
        cart_store_id
    FROM validation.fact_order_test_orders
    EXCEPT
    SELECT
       fo.order_id,
       fme.membership_event_type,
       fme.membership_state,
       fme.event_start_local_datetime,
       fa.activation_local_datetime,
       fa.membership_type,
       fa.activation_channel_type,
       fa.activation_channel,
       fa.activation_subchannel,
       dcdh.membership_id,
       dcdh.membership_event_type as dim_cust_hist_membership_event_type,
       dcdh.membership_plan_id,
       currency_key,
       fo.customer_id,
       fo.store_id,
       fo.master_order_id,
       dops.order_payment_status_code,
       dopos.order_processing_status_code,
       order_membership_classification_key,
       fo.is_cash,
       fo.is_credit_billing_on_retry,
       fo.shipping_address_id,
       billing_address_id,
       order_status_key,
       order_sales_channel_key,
       dp.payment_method,
       dp.raw_creditcard_type,
       fo.session_id,
       order_local_datetime,
       payment_transaction_local_datetime,
       shipped_local_datetime,
       order_completion_local_datetime,
       unit_count,
       order_date_usd_conversion_rate,
       order_date_eur_conversion_rate,
       payment_transaction_date_usd_conversion_rate,
       payment_transaction_date_eur_conversion_rate,
       shipped_date_usd_conversion_rate,
       shipped_date_eur_conversion_rate,
       reporting_usd_conversion_rate,
       reporting_eur_conversion_rate,
       payment_transaction_local_amount,
       subtotal_excl_tariff_local_amount,
       effective_vat_rate,
       tax_local_amount,
       tax_cash_local_amount,
       tax_credit_local_amount,
       cash_credit_local_amount,
       cash_credit_count,
       cash_membership_credit_local_amount,
       cash_membership_credit_count,
       cash_refund_credit_local_amount,
       cash_refund_credit_count,
       cash_giftco_credit_local_amount,
       cash_giftco_credit_count,
       cash_giftcard_credit_local_amount,
       cash_giftcard_credit_count,
       non_cash_credit_local_amount,
       non_cash_credit_count,
       shipping_revenue_before_discount_local_amount,
       shipping_revenue_cash_local_amount,
       shipping_revenue_credit_local_amount,
       shipping_cost_local_amount,
       product_discount_local_amount,
       shipping_discount_local_amount,
       tariff_revenue_local_amount,
       token_local_amount,
       token_count,
       cash_token_local_amount,
       cash_token_count,
       non_cash_token_local_amount,
       non_cash_token_count,
       loyalty_unit_count,
       estimated_variable_gms_cost_local_amount,
       estimated_variable_warehouse_cost_local_amount,
       estimated_variable_payment_processing_pct_cash_revenue,
       estimated_shipping_cost_local_amount,
       estimated_shipping_supplies_cost_local_amount,
       estimated_landed_cost_local_amount,
       misc_cogs_local_amount,
       administrator_id,
       fo.is_test_customer,
       bops_store_id,
       bops_pickup_local_datetime,
       customer_selected_shipping_service,
       reporting_landed_cost_local_amount,
       is_actual_landed_cost,
       membership_brand_id,
       cart_store_id
    FROM stg.fact_order fo
    JOIN stg.fact_membership_event fme ON fo.membership_event_key=fme.membership_event_key
    JOIN stg.fact_activation fa ON fo.activation_key=fa.activation_key
    JOIN stg.dim_customer_detail_history dcdh
        ON dcdh.customer_id = fo.customer_id
        AND fo.order_local_datetime BETWEEN dcdh.effective_start_datetime AND dcdh.effective_end_datetime
    JOIN stg.dim_order_payment_status dops ON fo.order_payment_status_key=dops.order_payment_status_key
    JOIN stg.dim_order_processing_status dopos ON fo.order_processing_status_key = dopos.order_processing_status_key
    JOIN stg.dim_payment dp ON fo.payment_key=dp.payment_key
    JOIN stg.dim_order_customer_selected_shipping docss ON fo.order_customer_selected_shipping_key = docss.order_customer_selected_shipping_key
    WHERE fo.order_id IN (SELECT order_id FROM validation.fact_order_test_orders)
    ) AS b
    ON a.order_id = b.order_id;
