use reporting_prod;
-- - Join SPI data to SAM data
create or replace TEMPORARY table _DM_IM_SPI AS
select
BRAND_ABBR, MPID, sum(TOTAL_IMPRESSIONS) as TOTAL_IMPRESSIONS, sum(TOTAL_SALES) as TOTAL_SALES
from reporting_prod.data_science.export_postreg_segment_spi_ranking
where
  IMPRESSIONS_DATE >= DATEADD(DAY, -10, CURRENT_DATE())
  and BRAND_ABBR='FL'
  and grid_name='all'
group by BRAND_ABBR, MPID
order by TOTAL_SALES DESC;
-- ELIMINATE GENDERED PRODUCTS
create or replace TEMPORARY table _DM_IM_SPI AS
select BRAND_ABBR,MPID,TOTAL_IMPRESSIONS,TOTAL_SALES from _DM_IM_SPI spi
WHERE --44170 43695
    NOT EXISTS (
        SELECT 1
        FROM lake_fl.ultra_merchant.product_tag AS pt
        JOIN lake_fl.ultra_merchant.tag AS t ON t.tag_id = pt.tag_id
        WHERE pt.product_id = spi.MPID
        AND pt.tag_id = 9885
        AND t.hvr_is_deleted = 0
        AND pt.hvr_is_deleted = 0
    );
create or replace TEMPORARY table _DM_IM_DP AS
SELECT distinct PRODUCT_SKU,MPID,STORE_ID,MEMBERSHIP_BRAND_ID,CURRENT_SHOWROOM_DATE FROM
(select DP.PRODUCT_SKU, --DP.MASTER_PRODUCT_ID AS MPID,
EDW_PROD.STG.UDF_UNCONCAT_BRAND(DP.MASTER_PRODUCT_ID) AS MPID,
DP.STORE_ID, DP.MEMBERSHIP_BRAND_ID, DP.current_showroom_date
from EDW_PROD.DATA_MODEL.DIM_PRODUCT as DP
where DP.MASTER_PRODUCT_ID>0
and  current_date>current_showroom_date
and
DP.STORE_ID in (52, 95, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 117, 118, 119, 120, 123, 124, 143, 151, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 189, 190, 191, 192, 193, 187, 188, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 246, 247)
);
create or replace TEMPORARY table _DM_IM_DP2 AS
SELECT DISTINCT PRODUCT_NAME,MPID,STORE_ID,PRODUCT_TYPE,MEMBERSHIP_BRAND_ID,CURRENT_SHOWROOM_DATE
FROM (
    SELECT
        DP.PRODUCT_SKU AS PRODUCT_NAME,
        EDW_PROD.STG.UDF_UNCONCAT_BRAND(DP.MASTER_PRODUCT_ID) AS MPID,
        DP.STORE_ID,
        DP.PRODUCT_TYPE,
        DP.MEMBERSHIP_BRAND_ID,
        DP.current_showroom_date
    FROM EDW_PROD.DATA_MODEL.DIM_PRODUCT AS DP
    WHERE DP.MASTER_PRODUCT_ID > 0
    and DP.PRODUCT_TYPE!='Bundle'
    AND DP.STORE_ID IN (
        52, 95, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 117, 118, 119, 120, 123, 124, 143, 151, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 189, 190, 191, 192, 193, 187, 188, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 246, 247
    )
    UNION ALL
    SELECT
        DP.PRODUCT_ALIAS AS PRODUCT_NAME,
        EDW_PROD.STG.UDF_UNCONCAT_BRAND(DP.PRODUCT_ID) AS MPID,
        DP.STORE_ID,
        DP.PRODUCT_TYPE,
        DP.MEMBERSHIP_BRAND_ID,
        DP.current_showroom_date
    FROM EDW_PROD.DATA_MODEL.DIM_PRODUCT DP
    WHERE DP.PRODUCT_TYPE='Bundle'
    AND DP.STORE_ID IN (
        52, 95, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 117, 118, 119, 120, 123, 124, 143, 151, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 189, 190, 191, 192, 193, 187, 188, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, 242, 243, 246, 247
    )
);
create or replace TEMPORARY table _DM_IM_SAM AS
SELECT DISTINCT IMAGE_ID,
SAM_ID,
AEM_UUID,
MEMBERSHIP_BRAND_ID,
MASTER_STORE_GROUP_ID,
PRODUCT_NAME,
IS_ECAT,
IS_PLUS,
SORT,
DATETIME_ADDED_SAM,
DATETIME_MODIFIED_SAM,
IS_TESTABLE,
JSON_BLOB,
_EFFECTIVE_FROM_DATE,
_EFFECTIVE_TO_DATE,
_IS_CURRENT,
_IS_DELETED,
META_CREATE_DATETIME,
META_UPDATE_DATETIME,
URL_LIST,
MPID,
STORE_ID,
PRODUCT_TYPE,
CURRENT_SHOWROOM_DATE
FROM (
SELECT T1.IMAGE_ID,
    LTRIM(T1.SAM_ID) AS SAM_ID,
    T1.AEM_UUID,
    T1.MEMBERSHIP_BRAND_ID,
    T1.MASTER_STORE_GROUP_ID,
    T1.PRODUCT_NAME,
    T1.IS_ECAT,
    T1.IS_PLUS,
    T1.SORT,
    T1.DATETIME_ADDED_SAM,
    T1.DATETIME_MODIFIED_SAM,
    --COALESCE(not TRIM(T1.JSON_BLOB:_source.exclude_from_image_test::TEXT),'true') as is_testable,
    T1.IS_TESTABLE,
    T1.JSON_BLOB,
    T1._EFFECTIVE_FROM_DATE,
    T1._EFFECTIVE_TO_DATE,
    T1._IS_CURRENT,
    T1._IS_DELETED,
    T1.META_CREATE_DATETIME,
    T1.META_UPDATE_DATETIME
    , JSON_EXTRACT_PATH_TEXT(T1.json_blob, '_source."sizes"') as url_list
    , dp.MPID
    , dp.STORE_ID, dp.PRODUCT_TYPE --DM_IM_DP2
    , DP.current_showroom_date
    FROM LAKE_VIEW.ELASTICSEARCH.SAM_TOOL T1
    left join _DM_IM_DP2 AS DP
    where T1._IS_CURRENT = TRUE
    AND T1.IS_ECAT = TRUE
    --AND COALESCE(not TRIM(T1.JSON_BLOB:_source.exclude_from_image_test::TEXT),'true')='true'
    --AND T1.IS_PLUS = 'True' 
    AND T1.IS_PLUS = 'False'
    and T1.MASTER_STORE_GROUP_ID = 16
    and json_blob like '%uuid%' -- ADDED THIS
    --and T1.PRODUCT_NAME = DP.PRODUCT_SKU   --DM_IM_DP
    and T1.PRODUCT_NAME = DP.PRODUCT_NAME --DM_IM_DP2
    );
    --AND T1.MEMBERSHIP_BRAND_ID = 1
create or replace transient table REPORTING_PROD.DATA_SCIENCE.IMAGE_TESTING_SAM_SPI AS
SELECT DISTINCT
IMAGE_ID,
SAM_ID,
AEM_UUID,
MEMBERSHIP_BRAND_ID,
MASTER_STORE_GROUP_ID,
PRODUCT_NAME,
IS_ECAT,
IS_PLUS,
SORT,
DATETIME_ADDED_SAM,
DATETIME_MODIFIED_SAM,
IS_TESTABLE,
JSON_BLOB,
_EFFECTIVE_FROM_DATE,
_EFFECTIVE_TO_DATE,
_IS_CURRENT,
_IS_DELETED,
META_CREATE_DATETIME,
META_UPDATE_DATETIME,
URL_LIST,
MPID,
STORE_ID,
PRODUCT_TYPE,
CURRENT_SHOWROOM_DATE,
URL_CORE,
TOTAL_IMPRESSIONS,
TOTAL_SALES
FROM (
SELECT
    SA.IMAGE_ID
    ,SA.SAM_ID
    ,SA.AEM_UUID
    ,SA.MEMBERSHIP_BRAND_ID
    ,SA.MASTER_STORE_GROUP_ID
    ,SA.PRODUCT_NAME
    ,SA.IS_ECAT
    ,SA.IS_PLUS
    ,SA.SORT
    ,SA.DATETIME_ADDED_SAM
    ,SA.DATETIME_MODIFIED_SAM
    ,SA.IS_TESTABLE
    ,SA.JSON_BLOB
    ,SA._EFFECTIVE_FROM_DATE
    ,SA._EFFECTIVE_TO_DATE
    ,SA._IS_CURRENT
    ,SA._IS_DELETED
    ,SA.META_CREATE_DATETIME
    ,SA.META_UPDATE_DATETIME
    ,SA.URL_LIST
    ,SA.MPID
    ,SA.STORE_ID
    ,SA.PRODUCT_TYPE
    ,SA.CURRENT_SHOWROOM_DATE
    ,SUBSTRING(SA.url_list
        ,POSITION('/media/images/products', SA.url_list)
        ,POSITION('_', SA.url_list) - POSITION('/media/images/products', SA.url_list)
      ) as url_core
    ,SPI.TOTAL_IMPRESSIONS
    ,SPI.TOTAL_SALES
    FROM _DM_IM_SAM SA
    left join _DM_IM_SPI AS SPI
    where SA.MPID = SPI.MPID
);
