BEGIN TRANSACTION NAME GSC_SHIPMENT_SHIPMENT;

TRUNCATE TABLE REPORTING_PROD.GSC.SHIPMENT_DATASET;

CREATE OR REPLACE TEMPORARY TABLE _SCRUB AS
SELECT DISTINCT IBI.INVOICE_BOX_ID
FROM REPORTING_BASE_PROD.GSC.PO_SKUS_DATA P
JOIN LAKE_VIEW.ULTRA_WAREHOUSE.ITEM I
    ON P.SKU = I.ITEM_NUMBER
JOIN LAKE_VIEW.ULTRA_WAREHOUSE.INVOICE_ITEM II
    ON I.ITEM_ID = II.ITEM_ID
JOIN LAKE_VIEW.ULTRA_WAREHOUSE.INVOICE_BOX_ITEM IBI
    ON II.INVOICE_ITEM_ID = IBI.INVOICE_ITEM_ID
WHERE 1=1
AND PO_STATUS_ID IN (3,4,8,12)
AND NVL(IS_CANCELLED, 0) = 0
AND CONTAINS(UPPER(p.class), 'SCRUB') = 'true';

CREATE OR REPLACE TEMP TABLE _ONLY_SHOES AS
WITH _has_shoes AS(
SELECT DISTINCT ibi.invoice_box_id,
    IFF(p.department ILIKE '%footwear%', 'Y', 'N') marking_shoes
FROM reporting_base_prod.gsc.po_skus_data p
     JOIN lake_view.ultra_warehouse.item i
          ON p.sku = i.item_number
     JOIN lake_view.ultra_warehouse.invoice_item ii
          ON i.item_id = ii.item_id
     JOIN lake_view.ultra_warehouse.invoice_box_item ibi
          ON ii.invoice_item_id = ibi.invoice_item_id
WHERE 1 = 1
  AND po_status_id IN (3, 4, 8, 12)
  AND NVL(is_cancelled, 0) = 0
      )
SELECT DISTINCT invoice_box_id,
                count(marking_shoes) anything_more_than_2_marks_is_no_good,
                sum(iff(marking_shoes='Y',1,0)) only_shoe_check,
                only_shoe_check/anything_more_than_2_marks_is_no_good AS package_only_contains_shoes_if_1
FROM _has_shoes
GROUP BY invoice_box_id
HAVING package_only_contains_shoes_if_1 = 1;

INSERT INTO REPORTING_PROD.GSC.SHIPMENT_DATASET (
    ORDER_ID,
    SCAC,
    FC,
    CARRIER_SERVICE_ID,
    SERVICE_TYPE,
    CARRIER,
    TRACKING_NUMBER,
    GENDER,
    UNITS,
    ESTIMATED_SHIPPED_DATE,
    ESTIMATED_DELIVERED_DATE,
    CARRIER_DELIVERED_DATETIME,
    ACTUAL_WEIGHT_WMS,
    IS_SUB_ONE_POUND,
    ZONE_RATE_SHOPPING,
    BASE_RATE_WMS,
    TOTAL_SURCHARGES_WMS,
    NET_CHARGE_AMOUNT_WMS,
    DISCOUNT_WMS,
    SHIPMENT_FREIGHT_CHARGE_BEFORE_DISCOUNT_WMS,
    FUEL_SURCHARGE_WMS,
    RESIDENTIAL_SURCHARGE_WMS,
    CARRIER_REGION,
    SHIP_TO_COUNTRY_CODE,
    SHIP_TO_STATE_REGION,
    SHIP_TO_ZIP,
    IS_SPLIT_ORDER,
    IS_OUT_OF_REGION_ORDER,
    ORDER_TYPE,
    SHIPMENT_TYPE,
    MANIFEST_RECEIPT_DATETIME,
    CARRIER_INGESTED_DATETIME,
    CONTAINS_SCRUB,
    PACKAGE_LENGTH,
    PACKAGE_WIDTH,
    PACKAGE_HEIGHT,
    PACKAGE_DIM_UNIT,
    ONLY_SHOES
)
SELECT DISTINCT
    I.FOREIGN_ORDER_ID AS ORDER_ID,
    LS.SCAC,
    W.AIRPORT_CODE AS FC,
    CS.CARRIER_SERVICE_ID,
    CS.LABEL AS SERVICE_TYPE,
    C.LABEL AS CARRIER,
    CASE
        WHEN ls.scac = 'FXSP' THEN right(ib.partial_tracking_number,20)
--         WHEN CS.LABEL = 'DHL SmartMail Parcel / Parcel Plus Expedited' AND c.label = 'DHL ECS' THEN right(ib.tracking_number,22)
        ELSE IB.TRACKING_NUMBER END
    AS TRACKING_NUMBER,
    GD.GENDER,
    UD.UNITS,
    IB.DATE_SHIPPED AS ESTIMATED_SHIPPED_DATE,
    DATEADD(DAY,CASE
                    WHEN CS.LABEL ilike '%Overnight%' THEN 1
                    WHEN CS.LABEL ilike '%2 Day%' THEN 2
                    ELSE 4 END,
                IB.DATE_SHIPPED) AS ESTIMATED_DELIVERED_DATE,
    COALESCE(IB.DATETIME_CARRIER_DELIVERED,to_timestamp_ltz(NCM.carrier_delivered_datetime),CM.DELIVERED_DATE_TIME) AS CARRIER_DELIVERED_DATETIME,
    IB.WEIGHT AS ACTUAL_WEIGHT_WMS,
    IFF(IB.WEIGHT < 1,'Y','N') AS IS_SUB_ONE_POUND,
    IB.ZONE AS ZONE_RATE_SHOPPING,
    IB.POSTAGE AS BASE_RATE_WMS,
    IB.SURCHARGE AS TOTAL_SURCHARGES_WMS,
    IB.NET_RATE AS NET_CHARGE_AMOUNT_WMS,
    IB.DISCOUNT_RATE AS DISCOUNT_WMS,
    IB.GROSS_RATE AS SHIPMENT_FREIGHT_CHARGE_BEFORE_DISCOUNT_WMS,
    IB.FUEL_SURCHARGE AS FUEL_SURCHARGE_WMS,
    IB.RESIDENTIAL_SURCHARGE AS RESIDENTIAL_SURCHARGE_WMS,
    CASE
        WHEN UPPER(A.COUNTRY_CODE) NOT IN ('US','CA','AU') THEN 'EU'
        ELSE UPPER(A.COUNTRY_CODE)
       END AS CARRIER_REGION,
    UPPER(A.COUNTRY_CODE) AS SHIP_TO_COUNTRY_CODE,
    CASE
         WHEN UPPER(A.COUNTRY_CODE) = 'US' THEN IFNULL(SZZ.STATE,'ZZ')
         ELSE UPPER(A.STATE)
        END AS SHIP_TO_STATE_REGION,
    CASE
         WHEN A.ZIP LIKE '%REMOVE%' THEN 'ZZZZZ'
         WHEN A.COUNTRY_CODE = 'US' THEN LEFT(A.ZIP,5)
         ELSE A.ZIP
        END AS SHIP_TO_ZIP,
    IFF(I2.INVOICE_ID IS NULL,'NO','YES') AS IS_SPLIT_ORDER,
    IFF(
    W.WAREHOUSE_ID IN (107,154,231,421,466)
    AND UPPER(A.COUNTRY_CODE) = 'US'
    AND (
        (
            ((A.ZIP > '58600' AND A.ZIP < '60000')
            OR (A.ZIP > '78500' AND A.ZIP < '78600')
            OR (A.ZIP > '79100' AND A.ZIP < '79600')
            OR (A.ZIP >= '79700'))
            AND I.WAREHOUSE_ID NOT IN (231,466)
        )
        OR
        (
            ((A.ZIP <= '58600')
            OR (A.ZIP >= '60000' AND A.ZIP <= '78500')
            OR (A.ZIP >= '78600' AND A.ZIP <= '79100')
            OR (A.ZIP >= '79600' AND A.ZIP < '79700'))
            AND I.WAREHOUSE_ID NOT IN (107,154,421)
        )
    ),
    'YES','NO') AS IS_OUT_OF_REGION_ORDER,
    CASE
         WHEN F.SOURCE = 'OMS-RETAIL' THEN 'Retail Replenishment'
         WHEN F.SOURCE = 'WMS' THEN 'Ecom'
         WHEN F.SOURCE = 'OMS-SAMPLE' THEN 'OMS'
         WHEN F.SOURCE = 'BORDERFREE' THEN 'Borderfree'
         ELSE 'Other'
        END AS ORDER_TYPE,
    'Outbound' AS shipment_type,
    CD.RECEIVED_DATE AS MANIFEST_RECEIPT_DATETIME,
    COALESCE(to_timestamp_ltz(ncm.carrier_ingestion_datetime),CM.INGESTED_INTO_NETWORK_DATE_TIME) AS CARRIER_INGESTED_DATETIME,
    IFF(NVL(SRB.INVOICE_BOX_ID, 0) > 0, 'YES','NO') AS CONTAINS_SCRUB,
    CU.LENGTH PACKAGE_LENGTH,
    CU.WIDTH PACKAGE_WIDTH,
    CU.HEIGHT PACKAGE_HEIGHT,
    CU.DIM_UNIT PACKAGE_DIM_UNIT,
    IFF(OS.INVOICE_BOX_ID IS not NULL, 'YES','NO') AS ONLY_SHOES
FROM LAKE_VIEW.ULTRA_WAREHOUSE.INVOICE I
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.INVOICE_BOX IB
    ON I.INVOICE_ID = IB.INVOICE_ID
    AND IB.STATUS_CODE_ID = 51
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.FULFILLMENT F
    ON I.WAREHOUSE_ID = F.WAREHOUSE_ID
    AND I.FOREIGN_ORDER_ID = F.FOREIGN_ORDER_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.ADDRESS A
    ON I.SHIPPING_ADDRESS_ID = A.ADDRESS_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.COMPANY_CARRIER_SERVICE CCS
    ON CCS.COMPANY_CARRIER_SERVICE_ID = IB.COMPANY_CARRIER_SERVICE_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.CARRIER_SERVICE CS
    ON CS.CARRIER_SERVICE_ID = CCS.CARRIER_SERVICE_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.CARRIER C
    ON C.CARRIER_ID = CS.CARRIER_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.WAREHOUSE W
    ON I.WAREHOUSE_ID = W.WAREHOUSE_ID
LEFT JOIN REPORTING_BASE_PROD.REFERENCE.LKP_SCAC LS
    ON LS.CARRIER_SERVICE_ID = CS.CARRIER_SERVICE_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.INVOICE I2
    ON I.FOREIGN_ORDER_ID = I2.FOREIGN_ORDER_ID
    AND I.WAREHOUSE_ID != I2.WAREHOUSE_ID
LEFT JOIN REPORTING_BASE_PROD.REFERENCE.LKP_STATE_ZIP_ZONE SZZ
    ON LEFT(A.ZIP,3) = SZZ.ZIP
LEFT JOIN REPORTING_BASE_PROD.GSC.CARRIER_MILESTONE_DATASET CM
    ON IB.TRACKING_NUMBER = CM.TRACKING_NUMBER
LEFT JOIN reporting_base_prod.gsc.narvar_consolidated_milestones NCM -- New JOIN to introduce milestones early in scripts and maintain FXSP tracking numbers
    ON NCM.tracking_number = IB.tracking_number
LEFT JOIN (SELECT CARRIER,
                  PARTIAL_TRACKING_NUMBER,
                  TRACKING_NUMBER,
                  LISTAGG(GENDER,' AND ') AS GENDER
           FROM REPORTING_BASE_PROD.GSC.SHIPMENT_DETAIL_GENDER G
           GROUP BY CARRIER, PARTIAL_TRACKING_NUMBER, TRACKING_NUMBER
           ) GD
    ON C.LABEL = GD.CARRIER
    AND IB.PARTIAL_TRACKING_NUMBER = GD.PARTIAL_TRACKING_NUMBER
    AND IB.TRACKING_NUMBER = GD.TRACKING_NUMBER
LEFT JOIN REPORTING_BASE_PROD.GSC.SHIPMENT_DETAIL_UNITS UD
    ON C.LABEL = UD.CARRIER
    AND IB.PARTIAL_TRACKING_NUMBER = UD.PARTIAL_TRACKING_NUMBER
    AND IB.TRACKING_NUMBER = UD.TRACKING_NUMBER
LEFT JOIN REPORTING_BASE_PROD.GFC.PACKAGE_CROSS_DOCK_RECEIVED_DATE CD
    ON IB.PACKAGE_ID = CD.PACKAGE_ID
LEFT JOIN LAKE_VIEW.ULTRA_WAREHOUSE.CUBE CU
    ON IB.CUBE_ID = CU.CUBE_ID
LEFT JOIN _scrub SRB
    ON IB.INVOICE_BOX_ID = SRB.INVOICE_BOX_ID
LEFT JOIN _only_shoes OS
    ON ib.invoice_box_id = os.invoice_box_id
WHERE
    I.DATETIME_ADDED >= '2019-01-01'
    AND I.STATUS_CODE_ID = 41
    AND (IB.TRACKING_NUMBER IS NOT NULL OR IB.PARTIAL_TRACKING_NUMBER IS NOT NULL);

COMMIT;
